<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000">
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top">
  
  
  <title>redis-trib.rb工具使用 | 求索</title>
  <meta name="description" content="redis-trib.rb是redis官方推出的管理redis集群的工具，集成在redis的源码src目录下，是基于redis提供的集群命令封装成简单、便捷、实用的操作工具。redis-trib.rb是redis作者用ruby完成的。 12345678910111213141516171819202122232425262728293031323334353637root@p-hsg-redis-">
<meta name="keywords" content="redis">
<meta property="og:type" content="article">
<meta property="og:title" content="redis-trib.rb工具使用">
<meta property="og:url" content="https://www.xiemx.com/2017/02/27/redis-trib-rb/index.html">
<meta property="og:site_name" content="求索">
<meta property="og:description" content="redis-trib.rb是redis官方推出的管理redis集群的工具，集成在redis的源码src目录下，是基于redis提供的集群命令封装成简单、便捷、实用的操作工具。redis-trib.rb是redis作者用ruby完成的。 12345678910111213141516171819202122232425262728293031323334353637root@p-hsg-redis-">
<meta property="og:locale" content="zh">
<meta property="og:updated_time" content="2019-10-21T06:57:42.989Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="redis-trib.rb工具使用">
<meta name="twitter:description" content="redis-trib.rb是redis官方推出的管理redis集群的工具，集成在redis的源码src目录下，是基于redis提供的集群命令封装成简单、便捷、实用的操作工具。redis-trib.rb是redis作者用ruby完成的。 12345678910111213141516171819202122232425262728293031323334353637root@p-hsg-redis-">
  <!-- Canonical links -->
  <link rel="canonical" href="https://www.xiemx.com/2017/02/27/redis-trib-rb/index.html">
  
  <link rel="alternate" href="/atom.xml" title="求索" type="application/atom+xml">
  
  
  <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
  
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.css">
  
</head>

<body class="main-center theme-purple" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/xiemx" target="_blank">
          <img class="img-circle img-rotate"
            src="https://www.gravatar.com/avatar/0c5c8c33820994ad4bd5f4d0645a482b?s=128" width="200"
            height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Mingxu.Xie</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">DevOps</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>
          Shanghai, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar"
        aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement"
      role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">Categories</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">Tags</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">Repository</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">Links</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tips">
          <a href="/tips">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">Tips</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">About</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/xiemx" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://weibo.com/xiemx1991" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://facebook.com/xiemx1991" target="_blank" title="Facebook" data-toggle=tooltip data-placement=top><i class="icon icon-facebook"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>
  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <font color="#C91406">尔</font><font color="#B60119">不</font><font color="#A3002C">必</font><font color="#90003F">求</font><font color="#7D0052">记</font><font color="#6A0065">，</font><font color="#570078">却</font><font color="#44008B">宜</font><font color="#31009E">求</font><font color="#1E00B1">个</font><font color="#0B00C4">明</font><font color="#0000D7">白</font><font color="#0000EA">！</font>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/CMS/" style="font-size: 13px;">CMS</a> <a href="/tags/acl/" style="font-size: 13px;">acl</a> <a href="/tags/amoeba/" style="font-size: 13px;">amoeba</a> <a href="/tags/apache/" style="font-size: 13.27px;">apache</a> <a href="/tags/arp/" style="font-size: 13px;">arp</a> <a href="/tags/aws/" style="font-size: 13px;">aws</a> <a href="/tags/bash/" style="font-size: 13px;">bash</a> <a href="/tags/binlog/" style="font-size: 13px;">binlog</a> <a href="/tags/cache/" style="font-size: 13px;">cache</a> <a href="/tags/cloudfront/" style="font-size: 13px;">cloudfront</a> <a href="/tags/cluster/" style="font-size: 13.64px;">cluster</a> <a href="/tags/command/" style="font-size: 13.64px;">command</a> <a href="/tags/commands/" style="font-size: 13px;">commands</a> <a href="/tags/cpulimit/" style="font-size: 13px;">cpulimit</a> <a href="/tags/database/" style="font-size: 13.45px;">database</a> <a href="/tags/debug/" style="font-size: 13.91px;">debug</a> <a href="/tags/dedecms/" style="font-size: 13px;">dedecms</a> <a href="/tags/deployment/" style="font-size: 13px;">deployment</a> <a href="/tags/django/" style="font-size: 13.09px;">django</a> <a href="/tags/dns/" style="font-size: 13.09px;">dns</a> <a href="/tags/domain/" style="font-size: 13px;">domain</a> <a href="/tags/graphite/" style="font-size: 13px;">graphite</a> <a href="/tags/http/" style="font-size: 13.55px;">http</a> <a href="/tags/iis/" style="font-size: 13.36px;">iis</a> <a href="/tags/ingress/" style="font-size: 13px;">ingress</a> <a href="/tags/iptables/" style="font-size: 13px;">iptables</a> <a href="/tags/iscsi/" style="font-size: 13px;">iscsi</a> <a href="/tags/issue/" style="font-size: 13.09px;">issue</a> <a href="/tags/k8s/" style="font-size: 13px;">k8s</a> <a href="/tags/keepalived/" style="font-size: 13.09px;">keepalived</a> <a href="/tags/kernal/" style="font-size: 13px;">kernal</a> <a href="/tags/kickstart/" style="font-size: 13px;">kickstart</a> <a href="/tags/lambda/" style="font-size: 13px;">lambda</a> <a href="/tags/linux/" style="font-size: 14px;">linux</a> <a href="/tags/lvm/" style="font-size: 13px;">lvm</a> <a href="/tags/lvs/" style="font-size: 13.18px;">lvs</a> <a href="/tags/magent/" style="font-size: 13px;">magent</a> <a href="/tags/mail/" style="font-size: 13px;">mail</a> <a href="/tags/memcache/" style="font-size: 13.09px;">memcache</a> <a href="/tags/memcached/" style="font-size: 13.18px;">memcached</a> <a href="/tags/mime-type/" style="font-size: 13px;">mime-type</a> <a href="/tags/mongo/" style="font-size: 13px;">mongo</a> <a href="/tags/monitor/" style="font-size: 13.09px;">monitor</a> <a href="/tags/mssql/" style="font-size: 13px;">mssql</a> <a href="/tags/mysql/" style="font-size: 13.73px;">mysql</a> <a href="/tags/mysql-proxy/" style="font-size: 13.09px;">mysql-proxy</a> <a href="/tags/mysqlcheck/" style="font-size: 13px;">mysqlcheck</a> <a href="/tags/nginx/" style="font-size: 13.36px;">nginx</a> <a href="/tags/ntp/" style="font-size: 13px;">ntp</a> <a href="/tags/php/" style="font-size: 13.36px;">php</a> <a href="/tags/phpmyadmin/" style="font-size: 13px;">phpmyadmin</a> <a href="/tags/postgresql/" style="font-size: 13px;">postgresql</a> <a href="/tags/pxe/" style="font-size: 13px;">pxe</a> <a href="/tags/python/" style="font-size: 13.45px;">python</a> <a href="/tags/rbash/" style="font-size: 13px;">rbash</a> <a href="/tags/redis/" style="font-size: 13.55px;">redis</a> <a href="/tags/repcache/" style="font-size: 13px;">repcache</a> <a href="/tags/rhcs/" style="font-size: 13px;">rhcs</a> <a href="/tags/scripts/" style="font-size: 13px;">scripts</a> <a href="/tags/shell/" style="font-size: 13.18px;">shell</a> <a href="/tags/socket/" style="font-size: 13px;">socket</a> <a href="/tags/ssh/" style="font-size: 13px;">ssh</a> <a href="/tags/statsd/" style="font-size: 13px;">statsd</a> <a href="/tags/statusCode/" style="font-size: 13px;">statusCode</a> <a href="/tags/store/" style="font-size: 13px;">store</a> <a href="/tags/tcp/" style="font-size: 13.09px;">tcp</a> <a href="/tags/tomcat/" style="font-size: 13.36px;">tomcat</a> <a href="/tags/tool/" style="font-size: 13.09px;">tool</a> <a href="/tags/twemproxy/" style="font-size: 13.09px;">twemproxy</a> <a href="/tags/udev/" style="font-size: 13px;">udev</a> <a href="/tags/uwsgi/" style="font-size: 13.09px;">uwsgi</a> <a href="/tags/vagrant/" style="font-size: 13.09px;">vagrant</a> <a href="/tags/vcenter/" style="font-size: 13.09px;">vcenter</a> <a href="/tags/view/" style="font-size: 13px;">view</a> <a href="/tags/webserver/" style="font-size: 13.82px;">webserver</a> <a href="/tags/websocket/" style="font-size: 13px;">websocket</a> <a href="/tags/windows/" style="font-size: 13.73px;">windows</a> <a href="/tags/yum/" style="font-size: 13px;">yum</a> <a href="/tags/zabbix/" style="font-size: 13.64px;">zabbix</a> <a href="/tags/zentaopms/" style="font-size: 13px;">zentaopms</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/k8s/">k8s</a>
              </p>
              <p class="item-title">
                <a href="/2019/09/16/k8s-ingress-nginx/" class="title">k8s ingress-nginx动态balance实现解析</a>
              </p>
              <p class="item-date">
                <time datetime="2019-09-15T23:09:52.000Z" itemprop="datePublished">2019-09-16</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/postgresql/">postgresql</a>
              </p>
              <p class="item-title">
                <a href="/2019/07/08/postgresql-replica-status/" class="title">PostgreSQL查看复制状态</a>
              </p>
              <p class="item-date">
                <time datetime="2019-07-08T03:07:36.000Z" itemprop="datePublished">2019-07-08</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/http/">http</a>
              </p>
              <p class="item-title">
                <a href="/2019/05/13/http-cache/" class="title">http cache</a>
              </p>
              <p class="item-date">
                <time datetime="2019-05-13T03:05:02.000Z" itemprop="datePublished">2019-05-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/mysql/">mysql</a>
              </p>
              <p class="item-title">
                <a href="/2019/05/06/mysqldump-error/" class="title">Mysqldump error</a>
              </p>
              <p class="item-date">
                <time datetime="2019-05-06T03:05:56.000Z" itemprop="datePublished">2019-05-06</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/redis/">redis</a>
              </p>
              <p class="item-title">
                <a href="/2019/05/06/redis-dump/" class="title">redis-dump使用</a>
              </p>
              <p class="item-date">
                <time datetime="2019-05-06T03:05:33.000Z" itemprop="datePublished">2019-05-06</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-redis-trib-rb" class="article article-type-post" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
      
  
    <h1 class="article-title" itemprop="name">
      redis-trib.rb工具使用
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2017/02/27/redis-trib-rb/" class="article-date">
	  <time datetime="2017-02-26T21:02:35.000Z" itemprop="datePublished">2017-02-27</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/redis/">redis</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/redis/">redis</a>
  </span>


        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>


        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2017/02/27/redis-trib-rb/#comments"
            class="article-comment-link">Comments</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
      <p>redis-trib.rb是redis官方推出的管理redis集群的工具，集成在redis的源码src目录下，是基于redis提供的集群命令封装成简单、便捷、实用的操作工具。redis-trib.rb是redis作者用ruby完成的。</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">root@</span><span class="string">p-hsg-</span><span class="string">redis-1:</span>~<span class="comment"># redis-trib.rb</span></span><br><span class="line"><span class="string">Usage:</span> <span class="string">redis-trib </span> </span><br><span class="line"></span><br><span class="line">  <span class="string">create </span>         <span class="string">host1:port1 </span>... <span class="string">hostN:portN</span></span><br><span class="line"><span class="string"> </span>                 <span class="built_in">--replicas</span> </span><br><span class="line">  <span class="string">check </span>          <span class="string">host:port</span></span><br><span class="line"><span class="string"> </span> <span class="string">info </span>           <span class="string">host:port</span></span><br><span class="line"><span class="string"> </span> <span class="string">fix </span>            <span class="string">host:port</span></span><br><span class="line"><span class="string"> </span>                 <span class="built_in">--timeout</span> </span><br><span class="line">  <span class="string">reshard </span>        <span class="string">host:port</span></span><br><span class="line"><span class="string"> </span>                 <span class="built_in">--from</span> </span><br><span class="line">                  <span class="built_in">--to</span> </span><br><span class="line">                  <span class="built_in">--slots</span> </span><br><span class="line">                  <span class="built_in">--yes</span></span><br><span class="line"><span class="built_in"></span>                  <span class="built_in">--timeout</span> </span><br><span class="line">                  <span class="built_in">--pipeline</span> </span><br><span class="line">  <span class="string">rebalance </span>      <span class="string">host:port</span></span><br><span class="line"><span class="string"> </span>                 <span class="built_in">--weight</span> </span><br><span class="line">                  <span class="built_in">--auto-weights</span></span><br><span class="line"><span class="built_in"></span>                  <span class="built_in">--use-empty-masters</span></span><br><span class="line"><span class="built_in"></span>                  <span class="built_in">--timeout</span> </span><br><span class="line">                  <span class="built_in">--simulate</span></span><br><span class="line"><span class="built_in"></span>                  <span class="built_in">--pipeline</span> </span><br><span class="line">                  <span class="built_in">--threshold</span> </span><br><span class="line">  <span class="string">add-node </span>       <span class="string">new_host:new_port </span><span class="string">existing_host:existing_port</span></span><br><span class="line"><span class="string"> </span>                 <span class="built_in">--slave</span></span><br><span class="line"><span class="built_in"></span>                  <span class="built_in">--master-id</span> </span><br><span class="line">  <span class="string">del-node </span>       <span class="string">host:port </span><span class="string">node_id</span></span><br><span class="line"><span class="string"> </span> <span class="built_in">set-timeout</span>     <span class="string">host:port </span><span class="string">milliseconds</span></span><br><span class="line"><span class="string"> </span> <span class="string">call </span>           <span class="string">host:port </span><span class="string">command </span><span class="string">arg </span><span class="string">arg </span>.. <span class="string">arg</span></span><br><span class="line"><span class="string"> </span> <span class="string">import </span>         <span class="string">host:port</span></span><br><span class="line"><span class="string"> </span>                 <span class="built_in">--from</span> </span><br><span class="line">                  <span class="built_in">--copy</span></span><br><span class="line"><span class="built_in"></span>                  <span class="built_in">--replace</span></span><br><span class="line"><span class="built_in"></span>  <span class="string">help </span>           (<span class="string">show </span><span class="string">this </span><span class="string">help)</span></span><br><span class="line"></span><br><span class="line"><span class="string">For </span><span class="string">check,</span> <span class="string">fix,</span> <span class="string">reshard,</span> <span class="string">del-node,</span> <span class="built_in">set-timeout</span> <span class="string">you </span><span class="string">can </span><span class="string">specify </span><span class="string">the </span><span class="string">host </span><span class="string">and </span><span class="string">port </span><span class="string">of </span><span class="string">any </span><span class="string">working </span><span class="string">node </span><span class="string">in </span><span class="string">the </span><span class="string">cluster.</span></span><br></pre></td></tr></table></figure>

<p>可以看到redis-trib.rb具有以下功能：</p>
<ul>
<li>create：创建集群</li>
<li>check：检查集群</li>
<li>info：查看集群信息</li>
<li>fix：修复集群</li>
<li>reshard：在线迁移slot</li>
<li>rebalance：平衡集群节点slot数量</li>
<li>add-node：将新节点加入集群</li>
<li>del-node：从集群中删除节点</li>
<li>set-timeout：设置集群节点间心跳连接的超时时间</li>
<li>call：在集群全部节点上执行命令</li>
<li>import：将外部redis数据导入集群</li>
</ul>
<h3 id="create创建集群"><a href="#create创建集群" class="headerlink" title="create创建集群"></a>create创建集群</h3><p>create命令可选replicas参数，replicas表示需要有几个slave。最简单命令使用如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ruby redis-trib.rb create <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br></pre></td></tr></table></figure>

<p>有一个slave的创建命令如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ruby redis-trib.rb create --replicas <span class="number">1</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span>  <span class="number">10.180</span><span class="number">.157</span><span class="number">.205</span>:<span class="number">6379</span>  <span class="number">10.180</span><span class="number">.157</span><span class="number">.208</span>:<span class="number">6379</span></span><br></pre></td></tr></table></figure>

<p>创建流程如下：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、首先为每个节点创建ClusterNode对象，包括连接每个节点。检查每个节点是否为独立且db为空的节点。执行load_<span class="literal">inf</span>o方法导入节点信息。</span><br><span class="line"><span class="number">2</span>、检查传入的<span class="literal">master</span>节点数量是否大于等于<span class="number">3</span>个。只有大于<span class="number">3</span>个节点才能组成集群。</span><br><span class="line"><span class="number">3</span>、计算每个<span class="literal">master</span>需要分配的slot数量，以及给<span class="literal">master</span>分配<span class="literal">slave</span>。分配的算法大致如下：</span><br><span class="line">先把节点按照host分类，这样保证<span class="literal">master</span>节点能分配到更多的主机中。</span><br><span class="line">不停遍历遍历host列表，从每个host列表中弹出一个节点，放入interleaved数组。直到所有的节点都弹出为止。</span><br><span class="line"><span class="literal">master</span>节点列表就是interleaved前面的<span class="literal">master</span>数量的节点列表。保存在masters数组。</span><br><span class="line">计算每个<span class="literal">master</span>节点负责的slot数量，保存在slots_per_node对象，用slot总数除以<span class="literal">master</span>数量取整即可。</span><br><span class="line">遍历masters数组，每个<span class="literal">master</span>分配slots_per_node个slot，最后一个<span class="literal">master</span>，分配到<span class="number">16384</span>个slot为止。</span><br><span class="line">接下来为<span class="literal">master</span>分配<span class="literal">slave</span>，分配算法会尽量保证<span class="literal">master</span>和<span class="literal">slave</span>节点不在同一台主机上。对于分配完指定<span class="literal">slave</span>数量的节点，还有多余的节点，也会为这些节点寻找<span class="literal">master</span>。分配算法会遍历两次masters数组。</span><br><span class="line">第一次遍历masters数组，在余下的节点列表找到replicas数量个<span class="literal">slave</span>。每个<span class="literal">slave</span>为第一个和<span class="literal">master</span>节点host不一样的节点，如果没有不一样的节点，则直接取出余下列表的第一个节点。</span><br><span class="line">第二次遍历是在对于节点数除以replicas不为整数，则会多余一部分节点。遍历的方式跟第一次一样，只是第一次会一次性给<span class="literal">master</span>分配replicas数量个<span class="literal">slave</span>，而第二次遍历只分配一个，直到余下的节点被全部分配出去。</span><br><span class="line"><span class="number">4</span>、打印出分配信息，并提示用户输入“yes”确认是否按照打印出来的分配方式创建集群。</span><br><span class="line"><span class="number">5</span>、输入“yes”后，会执行flush_nodes_config操作，该操作执行前面的分配结果，给<span class="literal">master</span>分配slot，让<span class="literal">slave</span>复制<span class="literal">master</span>，对于还没有握手（cluster meet）的节点，<span class="literal">slave</span>复制操作无法完成，不过没关系，flush_nodes_config操作出现异常会很快返回，后续握手后会再次执行flush_nodes_config。</span><br><span class="line"><span class="number">6</span>、给每个节点分配epoch，遍历节点，每个节点分配的epoch比之前节点大<span class="number">1</span>。</span><br><span class="line"><span class="number">7</span>、节点间开始相互握手，握手的方式为节点列表的其他节点跟第一个节点握手。</span><br><span class="line"><span class="number">8</span>、然后每隔<span class="number">1</span>秒检查一次各个节点是否已经消息同步完成，使用ClusterNode的get_config_signature方法，检查的算法为获取每个节点cluster nodes信息，排序每个节点，组装成node_id1:slots|node_id2:slot2|...的字符串。如果每个节点获得字符串都相同，即认为握手成功。</span><br><span class="line"><span class="number">9</span>、此后会再执行一次flush_nodes_config，这次主要是为了完成<span class="literal">slave</span>复制操作。</span><br><span class="line"><span class="number">10</span>、最后再执行check_cluster，全面检查一次集群状态。包括和前面握手时检查一样的方式再检查一遍。确认没有迁移的节点。确认所有的slot都被分配出去了。</span><br><span class="line"><span class="number">11</span>、至此完成了整个创建流程，返回[OK] All <span class="number">16384</span> slots covered.。</span><br></pre></td></tr></table></figure>

<h3 id="check检查集群"><a href="#check检查集群" class="headerlink" title="check检查集群"></a>check检查集群</h3><p>检查集群状态的命令，没有其他参数，只需要选择一个集群中的一个节点即可。执行命令以及结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">ruby redis-trib.rb check 10.180.157.199:6379</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing Cluster Check (using node 10.180.157.199:6379)</span></span><br><span class="line">M: b2506515b38e6bbd3034d540599f4cd2a5279ad1 10.180.157.199:6379</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: d376aaf80de0e01dde1f8cd4647d5ac3317a8641 10.180.157.205:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates e36c46dbe90960f30861af00786d4c2064e63df2</span><br><span class="line">M: 15126fb33796c2c26ea89e553418946f7443d5a5 10.180.157.201:6379</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 59fa6ee455f58a5076f6d6f83ddd74161fd7fb55 10.180.157.208:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 15126fb33796c2c26ea89e553418946f7443d5a5</span><br><span class="line">S: 460b3a11e296aafb2615043291b7dd98274bb351 10.180.157.202:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates b2506515b38e6bbd3034d540599f4cd2a5279ad1</span><br><span class="line">M: e36c46dbe90960f30861af00786d4c2064e63df2 10.180.157.200:6379</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>

<p>检查前会先执行load_cluster_info_from_node方法，把所有节点数据load进来。load的方式为通过自己的cluster nodes发现其他节点，然后连接每个节点，并加入nodes数组。接着生成节点间的复制关系。</p>
<p>load完数据后，开始检查数据，检查的方式也是调用创建时候使用的check_cluster。</p>
<h3 id="info查看集群信息"><a href="#info查看集群信息" class="headerlink" title="info查看集群信息"></a>info查看集群信息</h3><p>info命令用来查看集群的信息。info命令也是先执行load_cluster_info_from_node获取完整的集群信息。然后显示ClusterNode的info_string结果，示例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">ruby redis-trib.rb info 10.180.157.199:6379</span></span><br><span class="line">10.180.157.199:6379 (b2506515...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line">10.180.157.201:6379 (15126fb3...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line">10.180.157.200:6379 (e36c46db...) -&gt; 0 keys | 5462 slots | 1 slaves.</span><br><span class="line">[OK] 0 keys in 3 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br></pre></td></tr></table></figure>

<h3 id="fix修复集群"><a href="#fix修复集群" class="headerlink" title="fix修复集群"></a>fix修复集群</h3><p>fix命令的流程跟check的流程很像，显示加载集群信息，然后在check_cluster方法内传入fix为<br>true的变量，会在集群检查出现异常的时候执行修复流程。目前fix命令能修复两种异常，一种是集群有处于迁移中的slot的节点，一种是slot未完全分配的异常。</p>
<p>fix_open_slot方法是修复集群有处于迁移中的slot的节点异常。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、先检查该slot是谁负责的，迁移的源节点如果没完成迁移，owner还是该节点。没有owner的slot无法完成修复功能。</span><br><span class="line"><span class="number">2</span>、遍历每个节点，获取哪些节点标记该slot为migrating状态，哪些节点标记该slot为importing状态。对于owner不是该节点，但是通过cluster countkeysinslot获取到该节点有数据的情况，也认为该节点为importing状态。</span><br><span class="line"><span class="number">3</span>、如果migrating和importing状态的节点均只有<span class="number">1</span>个，这可能是迁移过程中redis-trib.rb被中断所致，直接执行move_slot继续完成迁移任务即可。传递dots和fix为<span class="literal">true</span>。</span><br><span class="line"><span class="number">4</span>、如果migrating为空，importing状态的节点大于<span class="number">0</span>，那么这种情况执行回滚流程，将importing状态的节点数据通过move_slot方法导给slot的owner节点，传递dots、fix和cold为<span class="literal">true</span>。接着对importing的节点执行cluster stable命令恢复稳定。</span><br><span class="line"><span class="number">5</span>、如果importing状态的节点为空，有一个migrating状态的节点，而且该节点在当前slot没有数据，那么可以直接把这个slot设为stable。</span><br><span class="line"><span class="number">6</span>、如果migrating和importing状态不是上述情况，目前redis-trib.rb工具无法修复，上述的三种情况也已经覆盖了通过redis-trib.rb工具迁移出现异常的各个方面，人为的异常情形太多，很难考虑完全。</span><br><span class="line">fix_slots_coverage方法能修复slot未完全分配的异常。未分配的slot有三种状态。</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、所有节点的该slot都没有数据。该状态redis-trib.rb工具直接采用随机分配的方式，并没有考虑节点的均衡。本人尝试对没有分配slot的集群通过fix修复集群，结果slot还是能比较平均的分配，但是没有了连续性，打印的slot信息非常离散。</span><br><span class="line"><span class="number">2</span>、有一个节点的该slot有数据。该状态下，直接把slot分配给该slot有数据的节点。</span><br><span class="line"><span class="number">3</span>、有多个节点的该slot有数据。此种情况目前还处于TODO状态，不过redis作者列出了修复的步骤，对这些节点，除第一个节点，执行cluster migrating命令，然后把这些节点的数据迁移到第一个节点上。清除migrating状态，然后把slot分配给第一个节点。</span><br></pre></td></tr></table></figure>

<h3 id="reshard在线迁移slot"><a href="#reshard在线迁移slot" class="headerlink" title="reshard在线迁移slot"></a>reshard在线迁移slot</h3><p>reshard命令可以在线把集群的一些slot从集群原来slot负责节点迁移到新的节点，利用reshard可以完成集群的在线横向扩容和缩容。</p>
<p>reshard的参数很多，下面来一一解释一番：</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">reshard</span>         host:<span class="keyword">port</span></span><br><span class="line">                <span class="comment">--from </span></span><br><span class="line">                <span class="comment">--to </span></span><br><span class="line">                <span class="comment">--slots </span></span><br><span class="line">                <span class="comment">--yes</span></span><br><span class="line">                <span class="comment">--timeout </span></span><br><span class="line">                <span class="comment">--pipeline </span></span><br><span class="line">host:<span class="keyword">port</span>：这个是必传参数，用来从一个节点获取整个集群信息，相当于获取集群信息的入口。</span><br><span class="line"><span class="comment">--from ：需要从哪些源节点上迁移slot，可从多个源节点完成迁移，以逗号隔开，传递的是节点的node id，还可以直接传递--from all，这样源节点就是集群的所有节点，不传递该参数的话，则会在迁移过程中提示用户输入。</span></span><br><span class="line"><span class="comment">--to ：slot需要迁移的目的节点的node id，目的节点只能填写一个，不传递该参数的话，则会在迁移过程中提示用户输入。</span></span><br><span class="line"><span class="comment">--slots ：需要迁移的slot数量，不传递该参数的话，则会在迁移过程中提示用户输入。</span></span><br><span class="line"><span class="comment">--yes：设置该参数，可以在打印执行reshard计划的时候，提示用户输入yes确认后再执行reshard。</span></span><br><span class="line"><span class="comment">--timeout ：设置migrate命令的超时时间。</span></span><br><span class="line"><span class="comment">--pipeline ：定义cluster getkeysinslot命令一次取出的key数量，不传的话使用默认值为10。</span></span><br></pre></td></tr></table></figure>

<p>迁移的流程如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、通过load_cluster_info_from_node方法装载集群信息。</span><br><span class="line"><span class="number">2</span>、执行check_cluster方法检查集群是否健康。只有健康的集群才能进行迁移。</span><br><span class="line"><span class="number">3</span>、获取需要迁移的slot数量，用户没传递--slots参数，则提示用户手动输入。</span><br><span class="line"><span class="number">4</span>、获取迁移的目的节点，用户没传递--to参数，则提示用户手动输入。此处会检查目的节点必须为master节点。</span><br><span class="line"><span class="number">5</span>、获取迁移的源节点，用户没传递--<span class="keyword">from</span>参数，则提示用户手动输入。此处会检查源节点必须为master节点。--<span class="keyword">from</span> all的话，源节点就是除了目的节点外的全部master节点。这里为了保证集群slot分配的平均，建议传递--<span class="keyword">from</span> all。</span><br><span class="line"><span class="number">6</span>、执行compute_reshard_table方法，计算需要迁移的slot数量如何分配到源节点列表，采用的算法是按照节点负责slot数量由多到少排序，计算每个节点需要迁移的slot的方法为：迁移slot数量 * (该源节点负责的slot数量 / 源节点列表负责的slot总数)。这样算出的数量可能不为整数，这里代码用了下面的方式处理：</span><br><span class="line"></span><br><span class="line">n = (numslots/source_tot_slots*s.slots.length)</span><br><span class="line"><span class="keyword">if</span> i == <span class="number">0</span></span><br><span class="line">    n = n.ceil</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    n = n.floor</span><br><span class="line">这样的处理方式会带来最终分配的slot与请求迁移的slot数量不一致，这个BUG已经在github上提给作者，https:<span class="comment">//github.com/antirez/redis/issues/2990。</span></span><br><span class="line"></span><br><span class="line"><span class="number">7</span>、打印出reshard计划，如果用户没传--yes，就提示用户确认计划。</span><br><span class="line"><span class="number">8</span>、根据reshard计划，一个个slot的迁移到新节点上，迁移使用move_slot方法，该方法被很多命令使用，具体可以参见下面的迁移流程。move_slot方法传递dots为<span class="literal">true</span>和pipeline数量。</span><br><span class="line"><span class="number">9</span>、至此，就完成了全部的迁移任务。</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">ruby redis-trib.rb reshard --<span class="keyword">from</span> all --to <span class="number">80</span>b661ecca260c89e3d8ea9b98f77edaeef43dcd --slots <span class="number">11</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span></span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span>)</span><br><span class="line">S: b2506515b38e6bbd3034d540599f4cd2a5279ad1 <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates <span class="number">460</span>b3a11e296aafb2615043291b7dd98274bb351</span><br><span class="line">S: d376aaf80de0e01dde1f8cd4647d5ac3317a8641 <span class="number">10.180</span><span class="number">.157</span><span class="number">.205</span>:<span class="number">6379</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates e36c46dbe90960f30861af00786d4c2064e63df2</span><br><span class="line">M: <span class="number">15126f</span>b33796c2c26ea89e553418946f7443d5a5 <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">10923</span><span class="number">-16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">S: <span class="number">59f</span>a6ee455f58a5076f6d6f83ddd74161fd7fb55 <span class="number">10.180</span><span class="number">.157</span><span class="number">.208</span>:<span class="number">6379</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates <span class="number">15126f</span>b33796c2c26ea89e553418946f7443d5a5</span><br><span class="line">M: <span class="number">460</span>b3a11e296aafb2615043291b7dd98274bb351 <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">0</span><span class="number">-5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">M: <span class="number">80</span>b661ecca260c89e3d8ea9b98f77edaeef43dcd <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">M: e36c46dbe90960f30861af00786d4c2064e63df2 <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">5461</span><span class="number">-10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All <span class="number">16384</span> slots covered.</span><br><span class="line"></span><br><span class="line">Ready to move <span class="number">11</span> slots.</span><br><span class="line">  Source nodes:</span><br><span class="line">    M: <span class="number">15126f</span>b33796c2c26ea89e553418946f7443d5a5 <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">10923</span><span class="number">-16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">    M: <span class="number">460</span>b3a11e296aafb2615043291b7dd98274bb351 <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">0</span><span class="number">-5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">    M: e36c46dbe90960f30861af00786d4c2064e63df2 <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">5461</span><span class="number">-10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">  Destination node:</span><br><span class="line">    M: <span class="number">80</span>b661ecca260c89e3d8ea9b98f77edaeef43dcd <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">  Resharding plan:</span><br><span class="line">    Moving slot <span class="number">5461</span> <span class="keyword">from</span> e36c46dbe90960f30861af00786d4c2064e63df2</span><br><span class="line">    Moving slot <span class="number">5462</span> <span class="keyword">from</span> e36c46dbe90960f30861af00786d4c2064e63df2</span><br><span class="line">    Moving slot <span class="number">5463</span> <span class="keyword">from</span> e36c46dbe90960f30861af00786d4c2064e63df2</span><br><span class="line">    Moving slot <span class="number">5464</span> <span class="keyword">from</span> e36c46dbe90960f30861af00786d4c2064e63df2</span><br><span class="line">    Moving slot <span class="number">0</span> <span class="keyword">from</span> <span class="number">460</span>b3a11e296aafb2615043291b7dd98274bb351</span><br><span class="line">    Moving slot <span class="number">1</span> <span class="keyword">from</span> <span class="number">460</span>b3a11e296aafb2615043291b7dd98274bb351</span><br><span class="line">    Moving slot <span class="number">2</span> <span class="keyword">from</span> <span class="number">460</span>b3a11e296aafb2615043291b7dd98274bb351</span><br><span class="line">    Moving slot <span class="number">10923</span> <span class="keyword">from</span> <span class="number">15126f</span>b33796c2c26ea89e553418946f7443d5a5</span><br><span class="line">    Moving slot <span class="number">10924</span> <span class="keyword">from</span> <span class="number">15126f</span>b33796c2c26ea89e553418946f7443d5a5</span><br><span class="line">    Moving slot <span class="number">10925</span> <span class="keyword">from</span> <span class="number">15126f</span>b33796c2c26ea89e553418946f7443d5a5</span><br><span class="line">Do you want to proceed with the proposed reshard plan (yes/no)? yes</span><br><span class="line">Moving slot <span class="number">5461</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">5462</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">5463</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">5464</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">0</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">1</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">2</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">10923</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">10924</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">10925</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br></pre></td></tr></table></figure>

<p>move_slot方法可以在线将一个slot的全部数据从源节点迁移到目的节点，fix、reshard、rebalance都需要调用该方法迁移slot。</p>
<p>move_slot接受下面几个参数，</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、pipeline：设置一次从slot上获取多少个<span class="type">key</span>。</span><br><span class="line"><span class="number">2</span>、quiet：迁移会打印相关信息，设置quiet参数，可以不用打印这些信息。</span><br><span class="line"><span class="number">3</span>、cold：设置cold，会忽略执行importing和migrating。</span><br><span class="line"><span class="number">4</span>、dots：设置dots，则会在迁移过程打印迁移<span class="type">key</span>数量的进度。</span><br><span class="line"><span class="number">5</span>、update：设置update，则会更新内存信息，方便以后的操作。</span><br></pre></td></tr></table></figure>

<p>move_slot流程如下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、如果没有设置cold，则对源节点执行cluster importing命令，对目的节点执行migrating命令。fix的时候有可能importing和migrating已经执行过来，所以此种场景会设置cold。</span><br><span class="line"><span class="number">2</span>、通过cluster getkeysinslot命令，一次性获取远节点迁移slot的pipeline个<span class="type">key</span>的数量.</span><br><span class="line"><span class="number">3</span>、对这些<span class="type">key</span>执行migrate命令，将数据从源节点迁移到目的节点。</span><br><span class="line"><span class="number">4</span>、如果migrate出现异常，在fix模式下，BUSYKEY的异常，会使用migrate的replace模式再执行一次，BUSYKEY表示目的节点已经有该<span class="type">key</span>了，replace模式可以强制替换目的节点的<span class="type">key</span>。不是fix模式就直接返回错误了。</span><br><span class="line"><span class="number">5</span>、循环执行cluster getkeysinslot命令，直到返回的<span class="type">key</span>数量为<span class="number">0</span>，就退出循环。</span><br><span class="line"><span class="number">6</span>、如果没有设置cold，对每个节点执行cluster setslot命令，把slot赋给目的节点。</span><br><span class="line"><span class="number">7</span>、如果设置update，则修改源节点和目的节点的slot信息。</span><br><span class="line"><span class="number">8</span>、至此完成了迁移slot的流程。</span><br></pre></td></tr></table></figure>

<h3 id="rebalance平衡集群节点slot数量"><a href="#rebalance平衡集群节点slot数量" class="headerlink" title="rebalance平衡集群节点slot数量"></a>rebalance平衡集群节点slot数量</h3><p>rebalance命令可以根据用户传入的参数平衡集群节点的slot数量，rebalance功能非常强大，可以传入的参数很多，以下是rebalance的参数列表和命令示例。</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">rebalance</span>       <span class="comment">host:port</span></span><br><span class="line"><span class="comment"></span>                <span class="literal">-</span><span class="literal">-</span><span class="comment">weight</span> </span><br><span class="line">                <span class="literal">-</span><span class="literal">-</span><span class="comment">auto</span><span class="literal">-</span><span class="comment">weights</span></span><br><span class="line"><span class="comment"></span>                <span class="literal">-</span><span class="literal">-</span><span class="comment">threshold</span> </span><br><span class="line">                <span class="literal">-</span><span class="literal">-</span><span class="comment">use</span><span class="literal">-</span><span class="comment">empty</span><span class="literal">-</span><span class="comment">masters</span></span><br><span class="line"><span class="comment"></span>                <span class="literal">-</span><span class="literal">-</span><span class="comment">timeout</span> </span><br><span class="line">                <span class="literal">-</span><span class="literal">-</span><span class="comment">simulate</span></span><br><span class="line"><span class="comment"></span>                <span class="literal">-</span><span class="literal">-</span><span class="comment">pipeline</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">$ruby</span> <span class="comment">redis</span><span class="literal">-</span><span class="comment">trib</span><span class="string">.</span><span class="comment">rb</span> <span class="comment">rebalance</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">threshold</span> <span class="comment">1</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">weight</span> <span class="comment">b31e3a2e=5</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">weight</span> <span class="comment">60b8e3a1=5</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">use</span><span class="literal">-</span><span class="comment">empty</span><span class="literal">-</span><span class="comment">masters</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">simulate</span> <span class="comment">10</span><span class="string">.</span><span class="comment">180</span><span class="string">.</span><span class="comment">157</span><span class="string">.</span><span class="comment">199:6379</span></span><br><span class="line"><span class="comment">下面也先一一解释下每个参数的用法：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">host:port：这个是必传参数，用来从一个节点获取整个集群信息，相当于获取集群信息的入口。</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="comment">weight</span> <span class="comment">：节点的权重，格式为node_id=weight，如果需要为多个节点分配权重的话，需要添加多个</span><span class="literal">-</span><span class="literal">-</span><span class="comment">weight</span> <span class="comment">参数，即</span><span class="literal">-</span><span class="literal">-</span><span class="comment">weight</span> <span class="comment">b31e3a2e=5</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">weight</span> <span class="comment">60b8e3a1=5，node_id可为节点名称的前缀，只要保证前缀位数能唯一区分该节点即可。没有传递–weight的节点的权重默认为1。</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="comment">auto</span><span class="literal">-</span><span class="comment">weights：这个参数在rebalance流程中并未用到。</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="comment">threshold</span> <span class="comment">：只有节点需要迁移的slot阈值超过threshold，才会执行rebalance操作。具体计算方法可以参考下面的rebalance命令流程的第四步。</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="comment">use</span><span class="literal">-</span><span class="comment">empty</span><span class="literal">-</span><span class="comment">masters：rebalance是否考虑没有节点的master，默认没有分配slot节点的master是不参与rebalance的，设置</span><span class="literal">-</span><span class="literal">-</span><span class="comment">use</span><span class="literal">-</span><span class="comment">empty</span><span class="literal">-</span><span class="comment">masters可以让没有分配slot的节点参与rebalance。</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="comment">timeout</span> <span class="comment">：设置migrate命令的超时时间。</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="comment">simulate：设置该参数，可以模拟rebalance操作，提示用户会迁移哪些slots，而不会真正执行迁移操作。</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="comment">pipeline</span> <span class="comment">：与reshar的pipeline参数一样，定义cluster</span> <span class="comment">getkeysinslot命令一次取出的key数量，不传的话使用默认值为10。</span></span><br></pre></td></tr></table></figure>

<p>rebalance命令流程如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、load_cluster_info_from_node方法先加载集群信息。</span><br><span class="line"><span class="number">2</span>、计算每个master的权重，根据参数--weight ，为每个设置的节点分配权重，没有设置的节点，则权重默认为<span class="number">1</span>。</span><br><span class="line"><span class="number">3</span>、根据每个master的权重，以及总的权重，计算自己期望被分配多少个slot。计算的方式为：总slot数量 * （自己的权重 / 总权重）。</span><br><span class="line"><span class="number">4</span>、计算每个master期望分配的slot是否超过设置的阈值，即--threshold 设置的阈值或者默认的阈值。计算的方式为：先计算期望移动节点的阈值，算法为：(<span class="number">100</span>-(<span class="number">100.0</span>*expected/n.slots.length)).abs，如果计算出的阈值没有超出设置阈值，则不需要为该节点移动slot。只要有一个master的移动节点超过阈值，就会触发rebalance操作。</span><br><span class="line"><span class="number">5</span>、如果触发了rebalance操作。那么就开始执行rebalance操作，先将每个节点当前分配的slots数量减去期望分配的slot数量获得balance值。将每个节点的balance从小到大进行排序获得sn数组。</span><br><span class="line"><span class="number">6</span>、用dst_idx和src_idx游标分别从sn数组的头部和尾部开始遍历。目的是为了把尾部节点的slot分配给头部节点。</span><br><span class="line"></span><br><span class="line">sn数组保存的balance列表排序后，负数在前面，正数在后面。负数表示需要有slot迁入，所以使用dst_idx游标，正数表示需要有slot迁出，所以使用src_idx游标。理论上sn数组各节点的balance值加起来应该为<span class="number">0</span>，不过由于在计算期望分配的slot的时候只是使用直接取整的方式，所以可能出现balance值之和不为<span class="number">0</span>的情况，balance值之和不为<span class="number">0</span>即为节点不平衡的slot数量，由于slot总数有<span class="number">16384</span>个，不平衡数量相对于总数，基数很小，所以对rebalance流程影响不大。</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>、获取sn[dst_idx]和sn[src_idx]的balance值较小的那个值，该值即为需要从sn[src_idx]节点迁移到sn[dst_idx]节点的slot数量。</span><br><span class="line"><span class="number">8</span>、接着通过compute_reshard_table方法计算源节点的slot如何分配到源节点列表。这个方法在reshard流程中也有调用，具体步骤可以参考reshard流程的第六步。</span><br><span class="line"><span class="number">9</span>、如果是simulate模式，则只是打印出迁移列表。</span><br><span class="line"><span class="number">10</span>、如果没有设置simulate，则执行move_slot操作，迁移slot，传入的参数为:quiet=&gt;<span class="literal">true</span>,:dots=&gt;<span class="literal">false</span>,:update=&gt;<span class="literal">true</span>。</span><br><span class="line"><span class="number">11</span>、迁移完成后更新sn[dst_idx]和sn[src_idx]的balance值。如果balance值为<span class="number">0</span>后，游标向前进<span class="number">1</span>。</span><br><span class="line"><span class="number">12</span>、直到dst_idx到达src_idx游标，完成整个rebalance操作。</span><br></pre></td></tr></table></figure>

<h3 id="add-node将新节点加入集群"><a href="#add-node将新节点加入集群" class="headerlink" title="add-node将新节点加入集群"></a>add-node将新节点加入集群</h3><p>add-node命令可以将新节点加入集群，节点可以为master，也可以为某个master节点的slave。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add-node    new_host:new_port existing_host:existing_port</span><br><span class="line">          --slave</span><br><span class="line">          --master-id </span><br><span class="line">add-node有两个可选参数：</span><br><span class="line"></span><br><span class="line">--slave：设置该参数，则新节点以slave的角色加入集群</span><br><span class="line">--master-id：这个参数需要设置了--slave才能生效，--master-id用来指定新节点的master节点。如果不设置该参数，则会随机为节点选择master节点。</span><br></pre></td></tr></table></figure>

<p>可以看下add-node命令的执行示例：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ruby redis-trib.rb add-node --slave --master-id dcb792b3e85726f012e83061bf237072dfc45f99 <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span></span><br><span class="line">&gt;&gt;&gt; Adding node <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span> to cluster <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span></span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span>)</span><br><span class="line">M: dcb792b3e85726f012e83061bf237072dfc45f99 <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">0</span><span class="number">-5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">M: <span class="number">464</span>d740bf48953ebcf826f4113c86f9db3a9baf3 <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">10923</span><span class="number">-16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">M: befa7e17b4e5f239e519bc74bfef3264a40f96ae <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">5461</span><span class="number">-10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All <span class="number">16384</span> slots covered.</span><br><span class="line">&gt;&gt;&gt; Send CLUSTER MEET to node <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span> to make it join the cluster.</span><br><span class="line">Waiting <span class="keyword">for</span> the cluster to join.</span><br><span class="line">&gt;&gt;&gt; Configure node as replica of <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379.</span></span><br><span class="line">[OK] New node added correctly.</span><br></pre></td></tr></table></figure>

<p>add-node流程如下：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、通过load_cluster_<span class="literal">inf</span>o_from_node方法转载集群信息，check_cluster方法检查集群是否健康。</span><br><span class="line"><span class="number">2</span>、如果设置了--<span class="literal">slave</span>，则需要为该节点寻找<span class="literal">master</span>节点。设置了--<span class="literal">master</span>-id，则以该节点作为新节点的<span class="literal">master</span>，如果没有设置--<span class="literal">master</span>-id，则调用get_master_with_least_replicas方法，寻找<span class="literal">slave</span>数量最少的<span class="literal">master</span>节点。如果<span class="literal">slave</span>数量一致，则选取load_cluster_<span class="literal">inf</span>o_from_node顺序发现的第一个节点。load_cluster_<span class="literal">inf</span>o_from_node顺序的第一个节点是add-<span class="keyword">node</span><span class="title">设置的existing_host</span>:existing_port节点，后面的顺序根据在该节点执行cluster nodes返回的结果返回的节点顺序。</span><br><span class="line"><span class="number">3</span>、连接新的节点并与集群第一个节点握手。</span><br><span class="line"><span class="number">4</span>、如果没设置–<span class="literal">slave</span>就直接返回ok，设置了–<span class="literal">slave</span>，则需要等待确认新节点加入集群，然后执行cluster replicate命令复制<span class="literal">master</span>节点。</span><br><span class="line"><span class="number">5</span>、至此，完成了全部的增加节点的流程。</span><br></pre></td></tr></table></figure>

<h3 id="del-node从集群中删除节点"><a href="#del-node从集群中删除节点" class="headerlink" title="del-node从集群中删除节点"></a>del-node从集群中删除节点</h3><p>del-node可以把某个节点从集群中删除。del-node只能删除没有分配slot的节点。删除命令传递两个参数：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">host:port：从该节点获取集群信息。</span><br><span class="line">node_id：需要删除的节点<span class="built_in">id</span>。</span><br></pre></td></tr></table></figure>

<p>del-node执行结果示例如下：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ruby redis-trib.rb del-<span class="keyword">node</span> <span class="title">10</span>.<span class="number">180.157</span>.<span class="number">199</span>:<span class="number">6379</span> d5f6d1d17426bd564a6e309f32d0f5b96962fe53</span><br><span class="line">&gt;&gt;&gt; Removing <span class="keyword">node</span> <span class="title">d5f6d1d17426bd564a6e309f32d0f5b96962fe53</span> from cluster <span class="number">10.180</span>.<span class="number">157.199</span>:<span class="number">6379</span></span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="line">&gt;&gt;&gt; SHUTDOWN the <span class="keyword">node</span>.<span class="title"></span></span><br></pre></td></tr></table></figure>

<p>del-node流程如下：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、通过load_cluster_<span class="literal">inf</span>o_from_node方法转载集群信息。</span><br><span class="line"><span class="number">2</span>、根据传入的<span class="keyword">node</span> <span class="title">id</span>获取节点，如果节点没找到，则直接提示错误并退出。</span><br><span class="line"><span class="number">3</span>、如果节点分配的slot不为空，则直接提示错误并退出。</span><br><span class="line"><span class="number">4</span>、遍历集群内的其他节点，执行cluster forget命令，从每个节点中去除该节点。如果删除的节点是<span class="literal">master</span>，而且它有<span class="literal">slave</span>的话，这些<span class="literal">slave</span>会去复制其他<span class="literal">master</span>，调用的方法是get_master_with_least_replicas，与add-<span class="keyword">node</span><span class="title">没设置--master-id</span>寻找<span class="literal">master</span>的方法一样。</span><br><span class="line"><span class="number">5</span>、然后关闭该节点。</span><br></pre></td></tr></table></figure>

<h3 id="set-timeout设置集群节点间心跳连接的超时时间"><a href="#set-timeout设置集群节点间心跳连接的超时时间" class="headerlink" title="set-timeout设置集群节点间心跳连接的超时时间"></a>set-timeout设置集群节点间心跳连接的超时时间</h3><p>set-timeout用来设置集群节点间心跳连接的超时时间，单位是毫秒，不得小于100毫秒，因为100毫秒对于心跳时间来说太短了。该命令修改是节点配置参数cluster-node-timeout，默认是15000毫秒。通过该命令，可以给每个节点设置超时时间，设置的方式使用config set命令动态设置，然后执行config rewrite命令将配置持久化保存到硬盘。以下是示例：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ruby redis-trib.rb <span class="keyword">set</span>-timeout <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span> <span class="number">30000</span></span><br><span class="line">&gt;&gt;&gt; Reconfiguring node timeout <span class="keyword">in</span> every cluster node...</span><br><span class="line">*** New timeout <span class="keyword">set</span> <span class="keyword">for</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span></span><br><span class="line">*** New timeout <span class="keyword">set</span> <span class="keyword">for</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.205</span>:<span class="number">6379</span></span><br><span class="line">*** New timeout <span class="keyword">set</span> <span class="keyword">for</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br><span class="line">*** New timeout <span class="keyword">set</span> <span class="keyword">for</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span></span><br><span class="line">*** New timeout <span class="keyword">set</span> <span class="keyword">for</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.208</span>:<span class="number">6379</span></span><br><span class="line">&gt;&gt;&gt; New node timeout <span class="keyword">set</span>. <span class="number">5</span> OK, <span class="number">0</span> ERR.</span><br></pre></td></tr></table></figure>

<h3 id="call在集群全部节点上执行命令"><a href="#call在集群全部节点上执行命令" class="headerlink" title="call在集群全部节点上执行命令"></a>call在集群全部节点上执行命令</h3><p>call命令可以用来在集群的全部节点执行相同的命令。call命令也是需要通过集群的一个节点地址，连上整个集群，然后在集群的每个节点执行该命令。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ruby redis-trib.rb call <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span> <span class="keyword">get</span> key</span><br><span class="line">&gt;&gt;&gt; Calling GET key</span><br><span class="line"><span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span>: MOVED <span class="number">12539</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br><span class="line"><span class="number">10.180</span><span class="number">.157</span><span class="number">.205</span>:<span class="number">6379</span>: MOVED <span class="number">12539</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br><span class="line"><span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span>:</span><br><span class="line"><span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span>: MOVED <span class="number">12539</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br><span class="line"><span class="number">10.180</span><span class="number">.157</span><span class="number">.208</span>:<span class="number">6379</span>: MOVED <span class="number">12539</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br></pre></td></tr></table></figure>

<h3 id="import将外部redis数据导入集群"><a href="#import将外部redis数据导入集群" class="headerlink" title="import将外部redis数据导入集群"></a>import将外部redis数据导入集群</h3><p>import命令可以把外部的redis节点数据导入集群。导入的流程如下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、通过load_cluster_info_from_node方法转载集群信息，check_cluster方法检查集群是否健康。</span><br><span class="line"><span class="number">2</span>、连接外部redis节点，如果外部节点开启了cluster_enabled，则提示错误。</span><br><span class="line"><span class="number">3</span>、通过scan命令遍历外部节点，一次获取<span class="number">1000</span>条数据。</span><br><span class="line"><span class="number">4</span>、遍历这些<span class="type">key</span>，计算出<span class="type">key</span>对应的slot。</span><br><span class="line"><span class="number">5</span>、执行migrate命令,源节点是外部节点,目的节点是集群slot对应的节点，如果设置了--copy参数，则传递copy参数，如果设置了--replace，则传递replace参数。</span><br><span class="line"><span class="number">6</span>、不停执行scan命令，直到遍历完全部的<span class="type">key</span>。</span><br><span class="line"><span class="number">7</span>、至此完成整个迁移流程</span><br><span class="line">这中间如果出现异常，程序就会停止。没使用--copy模式，则可以重新执行import命令，使用--copy的话，最好清空新的集群再导入一次。</span><br></pre></td></tr></table></figure>

<p>import命令更适合离线的把外部redis数据导入，在线导入的话最好使用更专业的导入工具，以slave的方式连接redis节点去同步节点数据应该是更好的方式。</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://www.xiemx.com/2017/02/27/redis-trib-rb/" title="redis-trib.rb工具使用" target="_blank" rel="external">https://www.xiemx.com/2017/02/27/redis-trib-rb/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客只是作者自己用来记录工作、学习中的笔记，如有版权问题请联系作者。另外，转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/xiemx" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://www.gravatar.com/avatar/0c5c8c33820994ad4bd5f4d0645a482b?s=128"
            class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/xiemx" target="_blank"><span
              class="text-dark">Mingxu.Xie</span><small class="ml-1x">DevOps</small></a>
        </h3>
        <div>一个普通devops。最近有点沉迷户外，可能逐渐驴化！</div>
      </div>
    </figure>
  </div>
</div>

    </div>
  </article>
  
  
  <section id="comments">
  	
           
    
  </section>


  
</div>

<nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2017/03/06/redis-repl_diskless_replication/" title="redis repl_diskless_replication"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2017/02/27/redis-trib-rb-create-cluster/" title="redis-trib.rb构建redis集群"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat" data-mobile-sites="weibo,qq"></div>
    
  </div>
  </div>
</nav>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
    
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/xiemx" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://weibo.com/xiemx1991" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://facebook.com/xiemx1991" target="_blank" title="Facebook" data-toggle=tooltip data-placement=top><i class="icon icon-facebook"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
        
        &copy; 2019 Mingxu.xie
        
        <!-- <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div> -->
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>

    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>





   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





   
    
  <!-- <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"> -->
  <script src="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script>
  <script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: 'ccf366da75afeaf5215a',
    clientSecret: 'ab4c80318537cc3fae0a62dcbd11fd206b57ac6e',
    repo: 'xray',
    owner: 'xiemx',
    admin: ['xiemx'],
    id: md5(location.pathname),
    distractionFreeMode: true
  })
  gitalk.render('comments')
  </script>

      





    <script defer type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-89045515-1', 'auto');
ga('send', 'pageview');

</script>



</body>
</html>