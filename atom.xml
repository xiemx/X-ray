<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>求索</title>
  
  <subtitle>尔不必求记，却宜求个明白！</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.xiemx.com/"/>
  <updated>2020-12-03T05:39:39.637Z</updated>
  <id>https://www.xiemx.com/</id>
  
  <author>
    <name>Mingxu.xie</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Ingress Controller V2 TargetGroupBinding使用方法</title>
    <link href="https://www.xiemx.com//2020/12/03/aws-targetgroupbinding/"/>
    <id>https://www.xiemx.com//2020/12/03/aws-targetgroupbinding/</id>
    <published>2020-12-03T02:52:00.000Z</published>
    <updated>2020-12-03T05:39:39.637Z</updated>
    
    <content type="html"><![CDATA[<p>Ingress Controller V2 TargetGroupBinding使用方法 场景<br>实现EC2到EKS的平滑过渡，想在暴露EKS Ingress的时候使用原来给EC2使用的ALB，因此可以使用Ingress Controller V2版本的TargetGroupBinding新功能。<br>Demo步骤</p><ul><li><p>安装ALBIngressControllerv2版本, 或将v1版本迁移至v2 </p><ul><li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/guide/controller/installation/" target="_blank" rel="noopener">https://kubernetes-sigs.github.io/aws-load-balancer-controller/guide/controller/installation/</a></li><li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/guide/upgrade/migrate_v1_v2/" target="_blank" rel="noopener">https://kubernetes-sigs.github.io/aws-load-balancer-controller/guide/upgrade/migrate_v1_v2/</a></li></ul></li><li><p>创建一个新的targetgroup，并记录下arn，后续要把该arn写到TargetGroupBinding的CR当中</p></li><li><p>在alb上配置到目标组的路由策略</p><ul><li><img src="/images/aws-tgbinding.jpg" alt="tgbinding-rule"></li></ul></li><li><p>赋予nodegroup上的iam role能够注册到目标组的权限</p></li><li><p>创建ns/deployment/services</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">wormhole</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">wormhole</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  progressDeadlineSeconds:</span> <span class="number">600</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">wormhole</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">wormhole</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxSurge:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">wormhole</span></span><br><span class="line"><span class="attr">        service:</span> <span class="string">wormhole</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - envFrom:</span></span><br><span class="line"><span class="attr">        - configMapRef:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">wormhole</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">wormhole</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">http-web</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">https-web</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line">        <span class="string">node.kubernetes.io/service-type:</span> <span class="string">product</span></span><br><span class="line">        <span class="string">node.kubernetes.io/workload-type:</span> <span class="string">stateless</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">wormhole-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  externalTrafficPolicy:</span> <span class="string">Local</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">http-web</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">https-web</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">wormhole</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure></li><li><p>service暴露完成之后，不再需要创建ingress了，直接和targetgroup进行绑定，（kubectl logs aws-load-balancer-controller-xxx -f -n kube-system可查看是否发生错误)，注册到目标组的方式通过targetType来指定，支持ip与instance两种方式，绑定后，实例或ip会自动注册到目标组中</p><ul><li><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">elbv2.k8s.aws/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">TargetGroupBinding</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line"><span class="attr">  name:</span> <span class="string">wormhole-tg-bind</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  targetType:</span> <span class="string">instance</span></span><br><span class="line"><span class="attr">serviceRef:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">wormhole-svc</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">targetGroupArn:</span> <span class="attr">arn:aws:elasticloadbalancer:xxxxxx:xxxxxxxx:targetgroup/tg-bind</span></span><br></pre></td></tr></table></figure></li><li><p><img src="/images/aws-tgbinding-ec2.jpg" alt="aws-tgbinding-ec2"></p></li></ul></li></ul><hr><p><strong>注意</strong></p><ul><li>和一般的ingress不同，路由策略要在alb侦听器上自行编辑</li><li>实例端口也不会自动在安全组中开放，需要在node使用的安全组上自行打开 </li><li>node需要有足够的权限注册到目标组中</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Ingress Controller V2 TargetGroupBinding使用方法 场景&lt;br&gt;实现EC2到EKS的平滑过渡，想在暴露EKS Ingress的时候使用原来给EC2使用的ALB，因此可以使用Ingress Controller V2版本的TargetGr
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>k8s services iptables规则探究</title>
    <link href="https://www.xiemx.com//2020/12/03/k8s-services-iptables/"/>
    <id>https://www.xiemx.com//2020/12/03/k8s-services-iptables/</id>
    <published>2020-12-03T02:52:00.000Z</published>
    <updated>2020-12-03T06:33:19.560Z</updated>
    
    <content type="html"><![CDATA[<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>本文只讨论iptables的services实现，ipvs实现有所不同，这里先说结论如下：</p><ul><li>service 使用iptables 来进行pod的dnat，services本身只是一条虚拟的iptables规则，不存在实体。</li><li>service 使用iptales 扩展模块来实现pod轮询策略故而无法实现最小链接数等负载算法<ul><li>多pod下的RR实现使用iptables statistic模块的random算法加权实现</li><li>sessionAffinity 使用iptables recent模块实现保持，功能主要依赖于nf_conntrack来实现连接标记</li></ul></li></ul><hr><h4 id="单pod时service-iptables-规则实现"><a href="#单pod时service-iptables-规则实现" class="headerlink" title="单pod时service iptables 规则实现"></a>单pod时service iptables 规则实现</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> nginx pod ip地址：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe pod nginx-fb8d45fxt-dcc1t | grep <span class="string">"IP"</span></span></span><br><span class="line"></span><br><span class="line">IP:             10.200.1.21</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Service服务，通过172.30.13.253:80则实际访问到10.200.1.21:80</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe svc nginx</span></span><br><span class="line">...</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                172.30.13.25</span><br><span class="line">Port:              &lt;unset&gt;  80/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:         10.200.1.21:80</span><br><span class="line">Session Affinity:  None</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables-save (选取部分关键规则)</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES</span><br><span class="line">-A OUTPUT -m comment --comment "kubernetes service portals" -j KUBE-SERVICES</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-A KUBE-SEP-UWNFTKZFYWNNNTK7 -s 10.200.1.21/32 -m comment --comment "demo/nginx:" \</span><br><span class="line">   -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-UWNFTKZFYWNNNTK7 -p tcp -m comment --comment "demo/nginx:" \</span><br><span class="line">   -m tcp -j DNAT --to-destination 10.200.1.21:80</span><br><span class="line">-A KUBE-SERVICES -d 172.30.13.25/32 -p tcp -m comment \</span><br><span class="line">   --comment "demo/nginx: cluster IP" -m tcp --dport 80 -j KUBE-SVC-1T7IBBNZDJ76</span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment "demo/nginx:" \</span><br><span class="line">   -j KUBE-SEP-UWNFTKZFYWNNNTK7</span><br></pre></td></tr></table></figure><h4 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h4><p>当访问 172.30.13.25/32 的80 端口时，iptables 规则会被第三条规则命中KUBE-SERVICES，在转发到 KUBE-SVC-1T7IBBNZDJ76 链 ，KUBE-SVC-1T7IBBNZDJ76链对流量进行comment标记之后 转发到 KUBE-SEP-UWNFTKZFYWNNNTK7<br>该链上实现了第一条访问外网的和一条对内的DNAT，此时是向内访问规则会命中第二条向内部进行DNAT 转发到pod地址上，进行路由寻址。</p><hr><h3 id="负载算法实现"><a href="#负载算法实现" class="headerlink" title="负载算法实现"></a>负载算法实现</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl scale deploy/nginx --replicas=3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables-save (选取部分规则)</span></span><br><span class="line">-A KUBE-SEP-BI123VOIAZZ5S7 -s 10.129.1.12/32 -m comment --comment "demo/nginx:" \</span><br><span class="line">   -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-BI123VOIAZZ5S7 -p tcp -m comment --comment "demo/nginx:" \</span><br><span class="line">   -m tcp -j DNAT --to-destination 10.129.1.12:80</span><br><span class="line"></span><br><span class="line">-A KUBE-SEP-CDQIKASRG66RK -s 10.129.1.13/32 -m comment --comment "demo/nginx:" \</span><br><span class="line">   -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-CDQIKASRG66RK -p tcp -m comment --comment "demo/nginx:" \</span><br><span class="line">   -m tcp -j DNAT --to-destination 10.129.1.13:80</span><br><span class="line"></span><br><span class="line">-A KUBE-SEP-W5HTO42ZVNHJQWBG -s 10.129.1.14/32 -m comment --comment "demo/nginx:" \</span><br><span class="line">   -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-W5HTO42ZVNHJQWBG -p tcp -m comment --comment "demo/nginx:" \</span><br><span class="line">   -m tcp -j DNAT --to-destination 10.129.1.14:80</span><br><span class="line"></span><br><span class="line">-A KUBE-SERVICES -d 172.30.13.25/32 -p tcp -m comment \</span><br><span class="line">   --comment "demo/nginx: cluster IP" -m tcp --dport 80 -j KUBE-SVC-1T7IBBNZDJ76</span><br><span class="line"></span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment "demo/nginx:" \</span><br><span class="line">   -m statistic --mode random --probability 0.33332999982 -j KUBE-SEP-BI123VOIAZZ5S7</span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment "demo/nginx:" \</span><br><span class="line">   -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-CDQIKASRG66RK</span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment "demo/nginx:" \</span><br><span class="line">   -j KUBE-SEP-W5HTO42ZVNHJQWBG</span><br></pre></td></tr></table></figure><h3 id="分析：-1"><a href="#分析：-1" class="headerlink" title="分析："></a>分析：</h3><p>iptable 在实现多pod 负载算法的时候使用了 statistic模块的random 加权算法 <code>-m statistic --mode random --probability 0.33332999982</code>来实现。具体模块用法可以参考：<a href="http://ipset.netfilter.org/iptables-extensions.man.html" target="_blank" rel="noopener">http://ipset.netfilter.org/iptables-extensions.man.html</a></p><hr><h3 id="会话保持"><a href="#会话保持" class="headerlink" title="会话保持"></a>会话保持</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl edit svc nginx</span></span><br><span class="line">...</span><br><span class="line">  sessionAffinity: ClientIP</span><br><span class="line">  sessionAffinityConfig:</span><br><span class="line">    clientIP:</span><br><span class="line">      timeoutSeconds: 3600</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables-save (选取部分规则) </span></span><br><span class="line">-A KUBE-SEP-BI123VOIAZZ5S7 -s 10.129.1.12/32 -m comment --comment "demo/nginx:" \</span><br><span class="line">   -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-BI123VOIAZZ5S7 -p tcp -m comment --comment "demo/nginx:" \</span><br><span class="line">   -m recent --set --name KUBE-SEP-BI123VOIAZZ5S7 --mask 255.255.255.255 \</span><br><span class="line">   --rsource -m tcp -j DNAT --to-destination 10.129.1.12:80</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-A KUBE-SERVICES -d 172.30.13.25/32 -p tcp -m comment \</span><br><span class="line">   --comment "demo/nginx: cluster IP" -m tcp --dport 80 -j KUBE-SVC-1T7IBBNZDJ76</span><br><span class="line"></span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment "demo/nginx:" \</span><br><span class="line">   -m recent --rcheck --seconds 3600 --reap --name KUBE-SEP-BI123VOIAZZ5S7 \</span><br><span class="line">   --mask 255.255.255.255 --rsource -j KUBE-SEP-BI123VOIAZZ5S7</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment "demo/nginx:" \</span><br><span class="line">   -m statistic --mode random --probability 0.33332999982 -j KUBE-SEP-BI123VOIAZZ5S7</span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment "demo/nginx:" \</span><br><span class="line">   -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-CDQIKASRG66RK</span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment "demo/nginx:" \</span><br><span class="line">   -j KUBE-SEP-W5HTO42ZVNHJQWBG</span><br></pre></td></tr></table></figure><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>iptables 主要使用recent 模块来标记追踪连接状态 <code>-m recent --rcheck --seconds 3600</code>来完成会话保持。具体recent模块用法可以参考：<a href="http://ipset.netfilter.org/iptables-extensions.man.html" target="_blank" rel="noopener">http://ipset.netfilter.org/iptables-extensions.man.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;结论&quot;&gt;&lt;a href=&quot;#结论&quot; class=&quot;headerlink&quot; title=&quot;结论&quot;&gt;&lt;/a&gt;结论&lt;/h3&gt;&lt;p&gt;本文只讨论iptables的services实现，ipvs实现有所不同，这里先说结论如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;service 使用i
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
      <category term="iptables" scheme="https://www.xiemx.com/categories/k8s/iptables/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="iptables" scheme="https://www.xiemx.com/tags/iptables/"/>
    
  </entry>
  
  <entry>
    <title>k8s cluster-autoscaler</title>
    <link href="https://www.xiemx.com//2020/12/02/k8s-cluster-autoscaler/"/>
    <id>https://www.xiemx.com//2020/12/02/k8s-cluster-autoscaler/</id>
    <published>2020-12-02T09:05:04.000Z</published>
    <updated>2020-12-07T08:42:20.644Z</updated>
    
    <content type="html"><![CDATA[<p>为了在集群中能够动态的根据pod的资源使用量来进行node的动态扩容，K8S cluster-autoscaler 提供了这样的功能，目前接入了大部分主流的厂商，由于我们使用的是aws eks，这里只进行aws 编排。</p><ul><li>项目地址：<a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler" target="_blank" rel="noopener">https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler</a></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-addon:</span> <span class="string">cluster-autoscaler.addons.k8s.io</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-addon:</span> <span class="string">cluster-autoscaler.addons.k8s.io</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["events",</span> <span class="string">"endpoints"</span><span class="string">]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create",</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["pods/eviction"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create"]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["pods/status"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["update"]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["endpoints"]</span></span><br><span class="line"><span class="attr">    resourceNames:</span> <span class="string">["cluster-autoscaler"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get",</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["nodes"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["watch",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"get"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"pods"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"services"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"replicationcontrollers"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"persistentvolumeclaims"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"persistentvolumes"</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["watch",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"get"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">["extensions"]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["replicasets",</span> <span class="string">"daemonsets"</span><span class="string">]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["watch",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"get"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">["policy"]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["poddisruptionbudgets"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["watch",</span> <span class="string">"list"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">["apps"]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["statefulsets",</span> <span class="string">"replicasets"</span><span class="string">,</span> <span class="string">"daemonsets"</span><span class="string">]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["watch",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"get"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">["storage.k8s.io"]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["storageclasses",</span> <span class="string">"csinodes"</span><span class="string">]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["watch",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"get"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">["batch",</span> <span class="string">"extensions"</span><span class="string">]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["jobs"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">["coordination.k8s.io"]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["leases"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create"]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">["coordination.k8s.io"]</span></span><br><span class="line"><span class="attr">    resourceNames:</span> <span class="string">["cluster-autoscaler"]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["leases"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get",</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-addon:</span> <span class="string">cluster-autoscaler.addons.k8s.io</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["configmaps"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create","list","watch"]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["configmaps"]</span></span><br><span class="line"><span class="attr">    resourceNames:</span> <span class="string">["cluster-autoscaler-status",</span> <span class="string">"cluster-autoscaler-priority-expander"</span><span class="string">]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["delete",</span> <span class="string">"get"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-addon:</span> <span class="string">cluster-autoscaler.addons.k8s.io</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">  - kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-addon:</span> <span class="string">cluster-autoscaler.addons.k8s.io</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">  - kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">cluster-autoscaler.kubernetes.io/safe-to-evict:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        <span class="string">prometheus.io/scrape:</span> <span class="string">'true'</span></span><br><span class="line">        <span class="string">prometheus.io/port:</span> <span class="string">'8085'</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line">        <span class="string">node.kubernetes.io/service-type:</span> <span class="string">auxiliary</span></span><br><span class="line">        <span class="string">node.kubernetes.io/workload-type:</span> <span class="string">stateless</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - image:</span> <span class="string">k8s.gcr.io/autoscaling/cluster-autoscaler:v1.17.3</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line"><span class="attr">            limits:</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">300</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">300</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">          command:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">./cluster-autoscaler</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--v=4</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--stderrthreshold=info</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--cloud-provider=aws</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--skip-nodes-with-local-storage=true</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--expander=least-waste</span></span><br><span class="line">            <span class="comment"># 我们这里使用自动发现模式，将底层的机器配置，spot/on-daemon机器比例等等逻辑放到aws autoscaling group中去，通过配置的tag寻找对应的asg组，建议使用此方法也可参考官网使用其它模式。</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--node-group-auto-discovery=asg:tag=k8s.io/cluster-autoscaler/enabled,kubernetes.io/cluster/aux-eks</span> </span><br><span class="line">            <span class="comment"># - --balance-similar-node-groups</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--skip-nodes-with-system-pods=false</span></span><br><span class="line">            <span class="comment"># - --aws-use-static-instance-list=true</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">ssl-certs</span></span><br><span class="line"><span class="attr">              mountPath:</span> <span class="string">/etc/ssl/certs/ca-certificates.crt</span></span><br><span class="line"><span class="attr">              readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">"Always"</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ssl-certs</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">"/etc/ssl/certs/ca-bundle.crt"</span></span><br></pre></td></tr></table></figure><h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  cluster-autoscaler git:(master) k get pod -A | grep auto</span><br><span class="line">kube-system              cluster-autoscaler-6f5dcc568c-xsbgc                          1/1     Running     1          66d</span><br><span class="line"></span><br><span class="line">➜  k logs -f -n kube-system cluster-autoscaler-6f5dcc568c-xsbgc</span><br><span class="line"></span><br><span class="line">I1203 07:59:42.152656       1 static_autoscaler.go:194] Starting main loop</span><br><span class="line">I1203 07:59:42.153624       1 clusterstate.go:252] Scale up in group aux-eks-product-stateless-20200814145032009600000010 finished successfully in 2m10.67671515s</span><br><span class="line">...</span><br><span class="line">I1203 08:00:02.185930       1 static_autoscaler.go:194] Starting main loop</span><br><span class="line">I1203 08:00:02.337720       1 auto_scaling_groups.go:351] Regenerating instance to ASG map for ASGs: [aux-eks-auxiliary-stateful-2020081414503199620000000e aux-eks-auxiliary-stateless-2020081414503200200000000f aux-eks-product-stateful-2020081414503199420000000d aux-eks-product-stateless-20200814145032009600000010]</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ul><li>cluster-autoscaler 通过计算node 上pod的request/limit来分析资源是否存在不足，因此建议对pod进行明确的资源限制</li><li>node 扩容时尽量选择同配置的机型，或CPU/Memory相同的机型。如果需要使用不同机型可以针对资源进行编组，扩容时按需选择不同的组进行扩容。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;为了在集群中能够动态的根据pod的资源使用量来进行node的动态扩容，K8S cluster-autoscaler 提供了这样的功能，目前接入了大部分主流的厂商，由于我们使用的是aws eks，这里只进行aws 编排。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;项目地址：&lt;a href=&quot;
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="cluster-autoscaler" scheme="https://www.xiemx.com/tags/cluster-autoscaler/"/>
    
  </entry>
  
  <entry>
    <title>k8s descheduler</title>
    <link href="https://www.xiemx.com//2020/12/01/k8s-descheduler/"/>
    <id>https://www.xiemx.com//2020/12/01/k8s-descheduler/</id>
    <published>2020-12-01T09:05:04.000Z</published>
    <updated>2020-12-07T08:35:42.859Z</updated>
    
    <content type="html"><![CDATA[<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p> kube-scheduler通过各种算法计算出最佳节点去运行Pod,当出现新的 Pod 进行调度时，调度程序会根据其当时对 Kubernetes 集群的资源做出调度决定。但Kubernetes集群发生变化，比如一个节点为了维护，执行了驱逐操作，这个节点的 Pod 会被驱逐到其他节点，但是当我们维护完成Pod 不会自动回到该节点上来，由此 Kubernetes 集群出现了不均衡的状态，可以使用descheduler进行在均衡。</p><ul><li>项目地址：<a href="https://github.com/kubernetes-sigs/descheduler" target="_blank" rel="noopener">https://github.com/kubernetes-sigs/descheduler</a></li></ul><h3 id="install-descheduler"><a href="#install-descheduler" class="headerlink" title="install descheduler"></a>install descheduler</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">descheduler-policy-configmap</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">policy.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string"></span><span class="attr">    apiVersion:</span> <span class="string">"descheduler/v1alpha1"</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">"DeschedulerPolicy"</span></span><br><span class="line"><span class="attr">    strategies:</span></span><br><span class="line"><span class="attr">      "RemoveDuplicates":</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        params:</span></span><br><span class="line"><span class="attr">          removeDuplicates:</span></span><br><span class="line"><span class="attr">            excludeOwnerKinds:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"DaemonSet"</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"StatefulSet"</span></span><br><span class="line"><span class="attr">            namespaces:</span></span><br><span class="line"><span class="attr">              include:</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">uat</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">uat2</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">uat3</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">aux</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">preprod</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">production</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">staging</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">qa</span></span><br><span class="line"><span class="attr">      "RemovePodsViolatingInterPodAntiAffinity":</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      "RemovePodsHavingTooManyRestarts":</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        params:</span></span><br><span class="line"><span class="attr">          podsHavingTooManyRestarts:</span></span><br><span class="line"><span class="attr">            podRestartThreshold:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">            includingInitContainers:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      "LowNodeUtilization":</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        params:</span></span><br><span class="line"><span class="attr">          nodeResourceUtilizationThresholds:</span></span><br><span class="line"><span class="attr">            thresholds:</span></span><br><span class="line">              <span class="string">"cpu"</span> <span class="string">:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">              "memory":</span> <span class="number">20</span></span><br><span class="line"><span class="attr">              "pods":</span> <span class="number">20</span></span><br><span class="line"><span class="attr">            targetThresholds:</span></span><br><span class="line">              <span class="string">"cpu"</span> <span class="string">:</span> <span class="number">70</span></span><br><span class="line"><span class="attr">              "memory":</span> <span class="number">70</span></span><br><span class="line"><span class="attr">              "pods":</span> <span class="number">40</span></span><br><span class="line"><span class="attr">      "PodLifeTime":</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">        params:</span></span><br><span class="line"><span class="attr">          podLifeTime:</span></span><br><span class="line"><span class="attr">            maxPodLifeTimeSeconds:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">            podStatusPhases:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"Pending"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">descheduler-cronjob</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  schedule:</span> <span class="string">"*/2 * * * *"</span></span><br><span class="line"><span class="attr">  concurrencyPolicy:</span> <span class="string">"Forbid"</span></span><br><span class="line"><span class="attr">  successfulJobsHistoryLimit:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  jobTemplate:</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      template:</span></span><br><span class="line"><span class="attr">        metadata:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">descheduler-pod</span></span><br><span class="line"><span class="attr">        spec:</span></span><br><span class="line"><span class="attr">          priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line"><span class="attr">          containers:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">descheduler</span></span><br><span class="line"><span class="attr">              image:</span> <span class="string">k8s.gcr.io/descheduler/descheduler:v0.19.0</span></span><br><span class="line"><span class="attr">              volumeMounts:</span></span><br><span class="line"><span class="attr">                - mountPath:</span> <span class="string">/policy-dir</span></span><br><span class="line"><span class="attr">                  name:</span> <span class="string">policy-volume</span></span><br><span class="line"><span class="attr">              command:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">"/bin/descheduler"</span></span><br><span class="line"><span class="attr">              args:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">"--policy-config-file"</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">"/policy-dir/policy.yaml"</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">"--v"</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">"3"</span></span><br><span class="line"><span class="attr">          restartPolicy:</span> <span class="string">"Never"</span></span><br><span class="line"><span class="attr">          serviceAccountName:</span> <span class="string">descheduler-sa</span></span><br><span class="line"><span class="attr">          volumes:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">policy-volume</span></span><br><span class="line"><span class="attr">              configMap:</span></span><br><span class="line"><span class="attr">                name:</span> <span class="string">descheduler-policy-configmap</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">descheduler-cluster-role</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["events"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["create",</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["nodes"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">]</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["namespaces"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">]</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["pods"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"delete"</span><span class="string">]</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["pods/eviction"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["create"]</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">["scheduling.k8s.io"]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["priorityclasses"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">descheduler-sa</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">descheduler-cluster-role-binding</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">descheduler-cluster-role</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">descheduler-sa</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure><h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">➜  descheduler git:(master) k get cronjob  -A</span><br><span class="line">NAMESPACE     NAME                  SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><br><span class="line">kube-system   descheduler-cronjob   */2 * * * *   True      0        3d2h            8d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">➜  descheduler git:(master) k get pod -A | grep desc</span><br><span class="line">kube-system   descheduler-cronjob-1606710120-np5xc               0/1     Completed   0          3d2h</span><br><span class="line"></span><br><span class="line">➜  descheduler git:(master) k logs -f descheduler-cronjob-1606710120-np5xc -n kube-system</span><br><span class="line">I1130 04:22:07.533753       1 node.go:45] node lister returned empty list, now fetch directly</span><br><span class="line">I1130 04:22:07.541476       1 toomanyrestarts.go:73] Processing node: cn-hongkong.10.0.3.20</span><br><span class="line">I1130 04:22:07.565399       1 toomanyrestarts.go:73] Processing node: cn-hongkong.10.0.3.21</span><br><span class="line">I1130 04:22:07.577738       1 duplicates.go:73] Processing node: "cn-hongkong.10.0.3.20"</span><br><span class="line">I1130 04:22:07.593279       1 duplicates.go:73] Processing node: "cn-hongkong.10.0.3.21"</span><br><span class="line">I1130 04:22:07.632923       1 lownodeutilization.go:203] Node "cn-hongkong.10.0.3.20" is appropriately utilized with usage: api.ResourceThresholds&#123;"cpu":32.5, "memory":29.3980074559352, "pods":17.1875&#125;</span><br><span class="line">I1130 04:22:07.632997       1 lownodeutilization.go:203] Node "cn-hongkong.10.0.3.21" is appropriately utilized with usage: api.ResourceThresholds&#123;"cpu":30, "memory":23.303233323623655, "pods":15.625&#125;</span><br><span class="line">I1130 04:22:07.633016       1 lownodeutilization.go:101] Criteria for a node under utilization: CPU: 20, Mem: 20, Pods: 20</span><br><span class="line">I1130 04:22:07.633028       1 lownodeutilization.go:105] No node is underutilized, nothing to do here, you might tune your thresholds further</span><br><span class="line">I1130 04:22:07.633042       1 pod_antiaffinity.go:72] Processing node: "cn-hongkong.10.0.3.20"</span><br><span class="line">I1130 04:22:07.647199       1 pod_antiaffinity.go:72] Processing node: "cn-hongkong.10.0.3.21"</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;原理&quot;&gt;&lt;a href=&quot;#原理&quot; class=&quot;headerlink&quot; title=&quot;原理&quot;&gt;&lt;/a&gt;原理&lt;/h3&gt;&lt;p&gt; kube-scheduler通过各种算法计算出最佳节点去运行Pod,当出现新的 Pod 进行调度时，调度程序会根据其当时对 Kuberne
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="descheduler" scheme="https://www.xiemx.com/tags/descheduler/"/>
    
  </entry>
  
  <entry>
    <title>nginx-ingress下使用ldap 实现ingress auth认证</title>
    <link href="https://www.xiemx.com//2020/11/21/nginx-ingress-ldap/"/>
    <id>https://www.xiemx.com//2020/11/21/nginx-ingress-ldap/</id>
    <published>2020-11-21T09:05:04.000Z</published>
    <updated>2020-12-03T07:07:47.285Z</updated>
    
    <content type="html"><![CDATA[<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>使用nginx subrequest在请求直线通过 ingress annotation注入一条规则去调用auth接口完成ldap认证。参考文档：</p><ul><li><a href="http://nginx.org/en/docs/http/ngx_http_auth_request_module.html" target="_blank" rel="noopener">http://nginx.org/en/docs/http/ngx_http_auth_request_module.html</a></li><li><a href="https://www.nginx.com/blog/nginx-plus-authenticate-users" target="_blank" rel="noopener">https://www.nginx.com/blog/nginx-plus-authenticate-users</a></li><li><a href="https://docs.foxpass.com/docs/ldap-overview-debugging" target="_blank" rel="noopener">https://docs.foxpass.com/docs/ldap-overview-debugging</a></li><li><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#external-authentication" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#external-authentication</a></li></ul><h3 id="创建ldap认证服务"><a href="#创建ldap认证服务" class="headerlink" title="创建ldap认证服务"></a>创建ldap认证服务</h3><p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-ldap-auth-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">foxpass.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    # define ldap server</span></span><br><span class="line"><span class="string">    ldap_server foxpass &#123;</span></span><br><span class="line"><span class="string">        url "ldaps://ldap.foxpass.com:636/dc=xiemx,dc=com?uid?sub?(objectClass=*)";</span></span><br><span class="line"><span class="string">        binddn "&#123;dn信息&#125;"; # cn=test,dc=xiemx,dc=com</span></span><br><span class="line"><span class="string">        binddn_passwd "xxxxxx";</span></span><br><span class="line"><span class="string">        group_attribute groups;</span></span><br><span class="line"><span class="string">        group_attribute_is_dn on;</span></span><br><span class="line"><span class="string">        require valid_user;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    server &#123;</span></span><br><span class="line"><span class="string">      listen 5555;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      location / &#123;</span></span><br><span class="line"><span class="string">        auth_ldap "foxpass";</span></span><br><span class="line"><span class="string">        auth_ldap_servers foxpass;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        try_files index.html,index.htm @auth;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      location @auth &#123;</span></span><br><span class="line"><span class="string">        return 200 "ldap auth";</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">configmaps</span></span><br><span class="line"><span class="attr">  resourceNames:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"nginx-ladp-auth-config"</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">5555</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">5555</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">"nginx-ldap-auth"</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - image:</span> <span class="string">weseek/nginx-auth-ldap:1.15.11-alpine</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">5555</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">200</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">200</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/nginx/conf.d</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">        configMap:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">nginx-ldap-auth-config</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">foxpass.i.xiemx.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">nginx-ldap-auth</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">5555</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure></p><h3 id="ingress-开启auth认证"><a href="#ingress-开启auth认证" class="headerlink" title="ingress 开启auth认证"></a>ingress 开启auth认证</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">      <span class="string">nginx.ingress.kubernetes.io/auth-url:</span> <span class="attr">https://foxpass.i.xiemx.com</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">kibana.i.xiemx.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">5601</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 测试</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">kibana</span> <span class="attr">git:(master)</span> <span class="string">curl</span> <span class="string">kibana.i.xiemx.com</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;&lt;title&gt;401</span> <span class="string">Authorization</span> <span class="string">Required&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;center&gt;&lt;h1&gt;401</span> <span class="string">Authorization</span> <span class="string">Required&lt;/h1&gt;&lt;/center&gt;</span></span><br><span class="line"><span class="string">&lt;hr&gt;&lt;center&gt;nginx/1.15.9&lt;/center&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">➜</span>  <span class="string">kibana</span> <span class="attr">git:(master)</span> <span class="string">curl</span> <span class="string">kibana.i.xiemx.com</span> <span class="bullet">--user</span> <span class="string">mingxu.xie</span></span><br><span class="line"><span class="string">Enter</span> <span class="string">host</span> <span class="string">password</span> <span class="string">for</span> <span class="string">user</span> <span class="string">'mingxu.xie'</span><span class="string">:</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;原理&quot;&gt;&lt;a href=&quot;#原理&quot; class=&quot;headerlink&quot; title=&quot;原理&quot;&gt;&lt;/a&gt;原理&lt;/h3&gt;&lt;p&gt;使用nginx subrequest在请求直线通过 ingress annotation注入一条规则去调用auth接口完成ldap认证。参考
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="nginx" scheme="https://www.xiemx.com/tags/nginx/"/>
    
      <category term="ldap" scheme="https://www.xiemx.com/tags/ldap/"/>
    
      <category term="ingress" scheme="https://www.xiemx.com/tags/ingress/"/>
    
  </entry>
  
  <entry>
    <title>kong 测试代码</title>
    <link href="https://www.xiemx.com//2020/11/03/kong-test-code/"/>
    <id>https://www.xiemx.com//2020/11/03/kong-test-code/</id>
    <published>2020-11-03T02:52:00.000Z</published>
    <updated>2020-12-07T03:15:37.776Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### docker-compose.yaml</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">kong</span> <span class="attr">git:(master)</span> <span class="string">✗</span> <span class="string">cat</span> <span class="string">docker-compose.yaml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  kong:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">kong:latest</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">KONG_ADMIN_LISTEN=0.0.0.0:8001,</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8444</span> <span class="string">ssl</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">KONG_DATABASE=off</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">KONG_DECLARATIVE_CONFIG=/usr/local/kong/declarative/kong.yml</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">KONG_PROXY_ACCESS_LOG=/dev/stdout</span> <span class="string">json</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">KONG_ADMIN_ACCESS_LOG=/dev/stdout</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">KONG_PROXY_ERROR_LOG=/dev/stderr</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">KONG_ADMIN_ERROR_LOG=/dev/stderr</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./kong.yaml:/usr/local/kong/declarative/kong.yml</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./nginx-template:/etc/kong/nginx-template.conf</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">8000</span><span class="string">:8000</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">8001</span><span class="string">:8001</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">8443</span><span class="string">:8443</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">8444</span><span class="string">:8444</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">8881</span><span class="string">:8881</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">["kong",</span> <span class="string">"docker-start"</span><span class="string">,</span> <span class="string">"--nginx-conf"</span><span class="string">,</span> <span class="string">"/etc/kong/nginx-template.conf"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###nginx template</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">kong</span> <span class="attr">git:(master)</span> <span class="string">✗</span> <span class="string">cat</span> <span class="string">nginx-template</span></span><br><span class="line"><span class="string">worker_processes</span> <span class="string">$&#123;&#123;NGINX_WORKER_PROCESSES&#125;&#125;;</span></span><br><span class="line"><span class="string">daemon</span> <span class="string">$&#123;&#123;NGINX_DAEMON&#125;&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="string">pid</span> <span class="string">pids/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">error_log</span> <span class="string">logs/error.log</span> <span class="string">$&#123;&#123;LOG_LEVEL&#125;&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="string">events</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="string">use</span> <span class="string">epoll;</span></span><br><span class="line">    <span class="string">multi_accept</span> <span class="string">on;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">http</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="string">log_format</span> <span class="string">json</span> <span class="string">'&#123; "timestamp": "$time_local", '</span></span><br><span class="line">                        <span class="string">'"server_name": "$host",'</span></span><br><span class="line">                        <span class="string">'"remote_addr": "$remote_addr", '</span></span><br><span class="line">                        <span class="string">'"ip": "$http_ip", '</span></span><br><span class="line">                        <span class="string">'"remote_user": "$remote_user", '</span></span><br><span class="line">                        <span class="string">'"body_bytes_sent": "$body_bytes_sent", '</span></span><br><span class="line">                        <span class="string">'"request_time": "$request_time", '</span></span><br><span class="line">                        <span class="string">'"status": "$status", '</span></span><br><span class="line">                        <span class="string">'"request": "$request", '</span></span><br><span class="line">                        <span class="string">'"request_method": "$request_method", '</span></span><br><span class="line">                        <span class="string">'"http_referrer": "$http_referer", '</span></span><br><span class="line">                        <span class="string">'"body_bytes_sent":"$body_bytes_sent", '</span></span><br><span class="line">                        <span class="string">'"http_x_forwarded_for": "$http_x_forwarded_for", '</span></span><br><span class="line">                        <span class="string">'"http_user_agent": "$http_user_agent" &#125;'</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">include</span> <span class="string">"nginx-kong.conf"</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">listen</span> <span class="number">8881</span><span class="string">;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">return</span> <span class="number">200</span> <span class="string">"1"</span><span class="string">;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### kong.yaml</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">kong</span> <span class="attr">git:(master)</span> <span class="string">✗</span> <span class="string">cat</span> <span class="string">kong.yaml</span></span><br><span class="line"><span class="attr">_format_version:</span> <span class="string">"1.1"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">xiemx.com-service</span></span><br><span class="line"><span class="attr">  retries:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  connect_timeout:</span> <span class="number">60000</span></span><br><span class="line"><span class="attr">  read_timeout:</span> <span class="number">60000</span></span><br><span class="line"><span class="attr">  write_timeout:</span> <span class="number">60000</span></span><br><span class="line">  <span class="comment"># url: http://xiemx.com</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">xiemx.com-upstream</span></span><br><span class="line">  <span class="comment"># port: 80</span></span><br><span class="line"><span class="attr">  protocol:</span> <span class="string">https</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">TCPService</span></span><br><span class="line"><span class="attr">  url:</span> <span class="attr">http://ifconfig.io</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">mockbin.org-service</span></span><br><span class="line"><span class="attr">  url:</span> <span class="attr">http://mockbin.org</span></span><br><span class="line"></span><br><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">HTTPRoute</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">xiemx.com-service</span></span><br><span class="line">  <span class="comment"># preserve_host: true</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">["xiemx.com"]</span></span><br><span class="line"><span class="attr">  methods:</span> <span class="string">["GET",</span> <span class="string">"POST"</span><span class="string">,</span> <span class="string">"HEAD"</span><span class="string">]</span></span><br><span class="line">  <span class="comment"># strip_path: true</span></span><br><span class="line"><span class="attr">  headers:</span> <span class="string">&#123;</span> <span class="string">"version"</span><span class="string">:</span> <span class="string">["v1","v2"]&#125;</span></span><br><span class="line"><span class="attr">  paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/v1/\d+</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/v2/\d+/status/\d+</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/v3</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/v4/any/</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/</span></span><br><span class="line"><span class="attr">  regex_priority:</span> <span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">mockbin.org-route</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">mockbin.org-service</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">["mockbin.org"]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">TCPRoute</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">TCPService</span></span><br><span class="line"><span class="attr">  protocols:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">tls</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">tcp</span></span><br><span class="line"><span class="attr">  sources:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">ip:</span> <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span><span class="string">/32,</span> <span class="attr">port:</span> <span class="number">1234</span> <span class="string">&#125;</span></span><br><span class="line"><span class="attr">    - ip:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br><span class="line"><span class="attr">  destinations:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">ip:</span> <span class="number">2.2</span><span class="number">.2</span><span class="number">.2</span><span class="string">/32,</span> <span class="attr">port:</span> <span class="number">1234</span> <span class="string">&#125;</span></span><br><span class="line"><span class="attr">    - ip:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">key-auth</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">mockbin.org-service</span></span><br><span class="line"><span class="attr">  consumer:</span> <span class="string">xiemx1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">consumers:</span></span><br><span class="line"><span class="attr">- username:</span> <span class="string">xiemx1</span></span><br><span class="line"><span class="attr">  keyauth-credentials:</span></span><br><span class="line"><span class="attr">  - key:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- username:</span> <span class="string">xiemx2</span></span><br><span class="line"><span class="attr">  keyauth-credentials:</span></span><br><span class="line"><span class="attr">  - key:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">upstreams:</span></span><br><span class="line"><span class="comment"># - name: mockbin.org-upstream</span></span><br><span class="line"><span class="comment">#   targets:</span></span><br><span class="line"><span class="comment">#     - target: mockbin.org</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">xiemx.com-upstream</span></span><br><span class="line"><span class="attr">  targets:</span></span><br><span class="line"><span class="attr">    - target:</span> <span class="string">www.xiemx.com:443</span></span><br><span class="line"><span class="attr">  algorithm:</span> <span class="string">"round-robin"</span></span><br><span class="line">  <span class="comment"># host_header: "baidu.com"  ### proxy_set_header host "xiemx.com"</span></span><br><span class="line"><span class="attr">  hash_on:</span> <span class="string">"none"</span></span><br><span class="line"><span class="attr">  hash_fallback:</span> <span class="string">"none"</span></span><br><span class="line"><span class="attr">  hash_on_cookie_path:</span> <span class="string">"/"</span></span><br><span class="line"><span class="attr">  slots:</span> <span class="number">10001</span></span><br><span class="line"><span class="attr">  healthchecks:</span></span><br><span class="line"><span class="attr">    active:</span></span><br><span class="line"><span class="attr">        https_verify_certificate:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        unhealthy:</span></span><br><span class="line"><span class="attr">            http_statuses:</span> <span class="string">[429,</span> <span class="number">404</span><span class="string">,</span> <span class="number">500</span><span class="string">,</span> <span class="number">501</span><span class="string">,</span> <span class="number">502</span><span class="string">,</span> <span class="number">503</span><span class="string">,</span> <span class="number">504</span><span class="string">,</span> <span class="number">505</span><span class="string">]</span></span><br><span class="line"><span class="attr">            tcp_failures:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">            timeouts:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">            http_failures:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">            interval:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        http_path:</span> <span class="string">"/"</span></span><br><span class="line"><span class="attr">        timeout:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        healthy:</span></span><br><span class="line"><span class="attr">            http_statuses:</span> <span class="string">[200,</span> <span class="number">302</span><span class="string">]</span></span><br><span class="line"><span class="attr">            interval:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">            successes:</span> <span class="number">0</span></span><br><span class="line">        <span class="comment"># https_sni: "example.com"</span></span><br><span class="line"><span class="attr">        concurrency:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">        type:</span> <span class="string">"http"</span></span><br><span class="line"><span class="attr">    passive:</span></span><br><span class="line"><span class="attr">        unhealthy:</span></span><br><span class="line"><span class="attr">            http_failures:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">            http_statuses:</span> <span class="string">[429,</span> <span class="number">500</span><span class="string">,</span> <span class="number">503</span><span class="string">]</span></span><br><span class="line"><span class="attr">            tcp_failures:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">            timeouts:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        type:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">        healthy:</span></span><br><span class="line"><span class="attr">            successes:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">            http_statuses:</span> <span class="string">[200,</span> <span class="number">201</span><span class="string">,</span> <span class="number">202</span><span class="string">,</span> <span class="number">203</span><span class="string">,</span> <span class="number">204</span><span class="string">,</span> <span class="number">205</span><span class="string">,</span> <span class="number">206</span><span class="string">,</span> <span class="number">207</span><span class="string">,</span> <span class="number">208</span><span class="string">,</span> <span class="number">226</span><span class="string">,</span> <span class="number">300</span><span class="string">,</span> <span class="number">301</span><span class="string">,</span> <span class="number">302</span><span class="string">,</span> <span class="number">303</span><span class="string">,</span> <span class="number">304</span><span class="string">,</span> <span class="number">305</span><span class="string">,</span> <span class="number">306</span><span class="string">,</span> <span class="number">307</span><span class="string">,</span> <span class="number">308</span><span class="string">]</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">xiemx</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=
      
    
    </summary>
    
    
      <category term="kong" scheme="https://www.xiemx.com/categories/kong/"/>
    
    
      <category term="docker" scheme="https://www.xiemx.com/tags/docker/"/>
    
      <category term="kong" scheme="https://www.xiemx.com/tags/kong/"/>
    
      <category term="nginx" scheme="https://www.xiemx.com/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>kong ingress</title>
    <link href="https://www.xiemx.com//2020/11/03/aws-alb-ingress/"/>
    <id>https://www.xiemx.com//2020/11/03/aws-alb-ingress/</id>
    <published>2020-11-03T02:52:00.000Z</published>
    <updated>2020-12-07T05:54:30.127Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Kong-Ingress"><a href="#Kong-Ingress" class="headerlink" title="Kong Ingress"></a>Kong Ingress</h2><p>项目地址：<a href="https://github.com/Kong/kubernetes-ingress-controller" target="_blank" rel="noopener">https://github.com/Kong/kubernetes-ingress-controller</a></p><p><img src="/images/kong-architecture.jpg" alt="kong-architecture"></p><p>结论：</p><ul><li>kongIngress和kongPlugin 可以看成是对原始ingress进行增强的补丁（个人理解）</li><li>kong ingress 可以原则上无缝接管nginx ingress</li><li>kong ingress 可以实现规则灵活挂接，可允许在<code>SVC</code>、<code>INGRESS</code> 上接入规则，可以基于ingress实现host 级别 global规则，也可基于path分别对于不同的svc进行管理</li></ul><hr><h4 id="install-controller"><a href="#install-controller" class="headerlink" title="install controller"></a>install controller</h4><details><summary>ingress-controller.yaml</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kongclusterplugins.configuration.konghq.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  additionalPrinterColumns:</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.plugin</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">plugin</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Plugin-Type</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.metadata.creationTimestamp</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Age</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Age</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">date</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.disabled</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Indicates</span> <span class="string">if</span> <span class="string">the</span> <span class="string">plugin</span> <span class="string">is</span> <span class="string">disabled</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Disabled</span></span><br><span class="line"><span class="attr">    priority:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">boolean</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.config</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Configuration</span> <span class="string">of</span> <span class="string">the</span> <span class="string">plugin</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">    priority:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">  group:</span> <span class="string">configuration.konghq.com</span></span><br><span class="line"><span class="attr">  names:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">KongClusterPlugin</span></span><br><span class="line"><span class="attr">    plural:</span> <span class="string">kongclusterplugins</span></span><br><span class="line"><span class="attr">    shortNames:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">kcp</span></span><br><span class="line"><span class="attr">  scope:</span> <span class="string">Cluster</span></span><br><span class="line"><span class="attr">  validation:</span></span><br><span class="line"><span class="attr">    openAPIV3Schema:</span></span><br><span class="line"><span class="attr">      properties:</span></span><br><span class="line"><span class="attr">        config:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">        configFrom:</span></span><br><span class="line"><span class="attr">          properties:</span></span><br><span class="line"><span class="attr">            secretKeyRef:</span></span><br><span class="line"><span class="attr">              properties:</span></span><br><span class="line"><span class="attr">                key:</span></span><br><span class="line"><span class="attr">                  type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">                name:</span></span><br><span class="line"><span class="attr">                  type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">                namespace:</span></span><br><span class="line"><span class="attr">                  type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">              required:</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">name</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">namespace</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">key</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">        disabled:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">boolean</span></span><br><span class="line"><span class="attr">        plugin:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">        protocols:</span></span><br><span class="line"><span class="attr">          items:</span></span><br><span class="line"><span class="attr">            enum:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">https</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">grpc</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">grpcs</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">tcp</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">tls</span></span><br><span class="line"><span class="attr">            type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">        run_on:</span></span><br><span class="line"><span class="attr">          enum:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">first</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">second</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">all</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">      required:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">plugin</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kongconsumers.configuration.konghq.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  additionalPrinterColumns:</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.username</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Username</span> <span class="string">of</span> <span class="string">a</span> <span class="string">Kong</span> <span class="string">Consumer</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Username</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.metadata.creationTimestamp</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Age</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Age</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">date</span></span><br><span class="line"><span class="attr">  group:</span> <span class="string">configuration.konghq.com</span></span><br><span class="line"><span class="attr">  names:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">KongConsumer</span></span><br><span class="line"><span class="attr">    plural:</span> <span class="string">kongconsumers</span></span><br><span class="line"><span class="attr">    shortNames:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">kc</span></span><br><span class="line"><span class="attr">  scope:</span> <span class="string">Namespaced</span></span><br><span class="line"><span class="attr">  validation:</span></span><br><span class="line"><span class="attr">    openAPIV3Schema:</span></span><br><span class="line"><span class="attr">      properties:</span></span><br><span class="line"><span class="attr">        credentials:</span></span><br><span class="line"><span class="attr">          items:</span></span><br><span class="line"><span class="attr">            type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">        custom_id:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">        username:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kongcredentials.configuration.konghq.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  additionalPrinterColumns:</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.type</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Type</span> <span class="string">of</span> <span class="string">credential</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Credential-type</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.metadata.creationTimestamp</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Age</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Age</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">date</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.consumerRef</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Owner</span> <span class="string">of</span> <span class="string">the</span> <span class="string">credential</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Consumer-Ref</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">  group:</span> <span class="string">configuration.konghq.com</span></span><br><span class="line"><span class="attr">  names:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">KongCredential</span></span><br><span class="line"><span class="attr">    plural:</span> <span class="string">kongcredentials</span></span><br><span class="line"><span class="attr">  scope:</span> <span class="string">Namespaced</span></span><br><span class="line"><span class="attr">  validation:</span></span><br><span class="line"><span class="attr">    openAPIV3Schema:</span></span><br><span class="line"><span class="attr">      properties:</span></span><br><span class="line"><span class="attr">        consumerRef:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">        type:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">      required:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">consumerRef</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">type</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kongingresses.configuration.konghq.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  group:</span> <span class="string">configuration.konghq.com</span></span><br><span class="line"><span class="attr">  names:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">KongIngress</span></span><br><span class="line"><span class="attr">    plural:</span> <span class="string">kongingresses</span></span><br><span class="line"><span class="attr">    shortNames:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ki</span></span><br><span class="line"><span class="attr">  scope:</span> <span class="string">Namespaced</span></span><br><span class="line"><span class="attr">  validation:</span></span><br><span class="line"><span class="attr">    openAPIV3Schema:</span></span><br><span class="line"><span class="attr">      properties:</span></span><br><span class="line"><span class="attr">        proxy:</span></span><br><span class="line"><span class="attr">          properties:</span></span><br><span class="line"><span class="attr">            connect_timeout:</span></span><br><span class="line"><span class="attr">              minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">            path:</span></span><br><span class="line"><span class="attr">              pattern:</span> <span class="string">^/.*$</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">            protocol:</span></span><br><span class="line"><span class="attr">              enum:</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">https</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">grpc</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">grpcs</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">tcp</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">tls</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">            read_timeout:</span></span><br><span class="line"><span class="attr">              minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">            retries:</span></span><br><span class="line"><span class="attr">              minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">            write_timeout:</span></span><br><span class="line"><span class="attr">              minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">        route:</span></span><br><span class="line"><span class="attr">          properties:</span></span><br><span class="line"><span class="attr">            headers:</span></span><br><span class="line"><span class="attr">              additionalProperties:</span></span><br><span class="line"><span class="attr">                items:</span></span><br><span class="line"><span class="attr">                  type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">                type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">            https_redirect_status_code:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">            methods:</span></span><br><span class="line"><span class="attr">              items:</span></span><br><span class="line"><span class="attr">                type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">            path_handling:</span></span><br><span class="line"><span class="attr">              enum:</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">v0</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">            preserve_host:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">boolean</span></span><br><span class="line"><span class="attr">            protocols:</span></span><br><span class="line"><span class="attr">              items:</span></span><br><span class="line"><span class="attr">                enum:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">https</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">grpc</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">grpcs</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">tcp</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">tls</span></span><br><span class="line"><span class="attr">                type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">            regex_priority:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">            strip_path:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">boolean</span></span><br><span class="line"><span class="attr">        upstream:</span></span><br><span class="line"><span class="attr">          properties:</span></span><br><span class="line"><span class="attr">            algorithm:</span></span><br><span class="line"><span class="attr">              enum:</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">round-robin</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">consistent-hashing</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">least-connections</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">            hash_fallback:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">            hash_fallback_header:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">            hash_on:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">            hash_on_cookie:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">            hash_on_cookie_path:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">            hash_on_header:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">            healthchecks:</span></span><br><span class="line"><span class="attr">              properties:</span></span><br><span class="line"><span class="attr">                active:</span></span><br><span class="line"><span class="attr">                  properties:</span></span><br><span class="line"><span class="attr">                    concurrency:</span></span><br><span class="line"><span class="attr">                      minimum:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">                      type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                    healthy:</span></span><br><span class="line"><span class="attr">                      properties:</span></span><br><span class="line"><span class="attr">                        http_statuses:</span></span><br><span class="line"><span class="attr">                          items:</span></span><br><span class="line"><span class="attr">                            type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">                        interval:</span></span><br><span class="line"><span class="attr">                          minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                        successes:</span></span><br><span class="line"><span class="attr">                          minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                      type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">                    http_path:</span></span><br><span class="line"><span class="attr">                      pattern:</span> <span class="string">^/.*$</span></span><br><span class="line"><span class="attr">                      type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">                    timeout:</span></span><br><span class="line"><span class="attr">                      minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                      type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                    unhealthy:</span></span><br><span class="line"><span class="attr">                      properties:</span></span><br><span class="line"><span class="attr">                        http_failures:</span></span><br><span class="line"><span class="attr">                          minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                        http_statuses:</span></span><br><span class="line"><span class="attr">                          items:</span></span><br><span class="line"><span class="attr">                            type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">                        interval:</span></span><br><span class="line"><span class="attr">                          minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                        tcp_failures:</span></span><br><span class="line"><span class="attr">                          minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                        timeout:</span></span><br><span class="line"><span class="attr">                          minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                      type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">                  type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">                passive:</span></span><br><span class="line"><span class="attr">                  properties:</span></span><br><span class="line"><span class="attr">                    healthy:</span></span><br><span class="line"><span class="attr">                      properties:</span></span><br><span class="line"><span class="attr">                        http_statuses:</span></span><br><span class="line"><span class="attr">                          items:</span></span><br><span class="line"><span class="attr">                            type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">                        interval:</span></span><br><span class="line"><span class="attr">                          minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                        successes:</span></span><br><span class="line"><span class="attr">                          minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                      type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">                    unhealthy:</span></span><br><span class="line"><span class="attr">                      properties:</span></span><br><span class="line"><span class="attr">                        http_failures:</span></span><br><span class="line"><span class="attr">                          minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                        http_statuses:</span></span><br><span class="line"><span class="attr">                          items:</span></span><br><span class="line"><span class="attr">                            type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">                        interval:</span></span><br><span class="line"><span class="attr">                          minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                        tcp_failures:</span></span><br><span class="line"><span class="attr">                          minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                        timeout:</span></span><br><span class="line"><span class="attr">                          minimum:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                          type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                      type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">                  type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">                threshold:</span></span><br><span class="line"><span class="attr">                  type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">            host_header:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">            slots:</span></span><br><span class="line"><span class="attr">              minimum:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kongplugins.configuration.konghq.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  additionalPrinterColumns:</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.plugin</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">plugin</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Plugin-Type</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.metadata.creationTimestamp</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Age</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Age</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">date</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.disabled</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Indicates</span> <span class="string">if</span> <span class="string">the</span> <span class="string">plugin</span> <span class="string">is</span> <span class="string">disabled</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Disabled</span></span><br><span class="line"><span class="attr">    priority:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">boolean</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.config</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Configuration</span> <span class="string">of</span> <span class="string">the</span> <span class="string">plugin</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">    priority:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">  group:</span> <span class="string">configuration.konghq.com</span></span><br><span class="line"><span class="attr">  names:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">    plural:</span> <span class="string">kongplugins</span></span><br><span class="line"><span class="attr">    shortNames:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">kp</span></span><br><span class="line"><span class="attr">  scope:</span> <span class="string">Namespaced</span></span><br><span class="line"><span class="attr">  validation:</span></span><br><span class="line"><span class="attr">    openAPIV3Schema:</span></span><br><span class="line"><span class="attr">      properties:</span></span><br><span class="line"><span class="attr">        config:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">        configFrom:</span></span><br><span class="line"><span class="attr">          properties:</span></span><br><span class="line"><span class="attr">            secretKeyRef:</span></span><br><span class="line"><span class="attr">              properties:</span></span><br><span class="line"><span class="attr">                key:</span></span><br><span class="line"><span class="attr">                  type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">                name:</span></span><br><span class="line"><span class="attr">                  type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">              required:</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">name</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">key</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">        disabled:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">boolean</span></span><br><span class="line"><span class="attr">        plugin:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">        protocols:</span></span><br><span class="line"><span class="attr">          items:</span></span><br><span class="line"><span class="attr">            enum:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">https</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">grpc</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">grpcs</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">tcp</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">tls</span></span><br><span class="line"><span class="attr">            type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">        run_on:</span></span><br><span class="line"><span class="attr">          enum:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">first</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">second</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">all</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">      required:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">plugin</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tcpingresses.configuration.konghq.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  additionalPrinterColumns:</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.status.loadBalancer.ingress[*].ip</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Address</span> <span class="string">of</span> <span class="string">the</span> <span class="string">load</span> <span class="string">balancer</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Address</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">  - JSONPath:</span> <span class="string">.metadata.creationTimestamp</span></span><br><span class="line"><span class="attr">    description:</span> <span class="string">Age</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Age</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">date</span></span><br><span class="line"><span class="attr">  group:</span> <span class="string">configuration.konghq.com</span></span><br><span class="line"><span class="attr">  names:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">TCPIngress</span></span><br><span class="line"><span class="attr">    plural:</span> <span class="string">tcpingresses</span></span><br><span class="line"><span class="attr">  scope:</span> <span class="string">Namespaced</span></span><br><span class="line"><span class="attr">  subresources:</span></span><br><span class="line"><span class="attr">    status:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  validation:</span></span><br><span class="line"><span class="attr">    openAPIV3Schema:</span></span><br><span class="line"><span class="attr">      properties:</span></span><br><span class="line"><span class="attr">        apiVersion:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">        kind:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">        metadata:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">        spec:</span></span><br><span class="line"><span class="attr">          properties:</span></span><br><span class="line"><span class="attr">            rules:</span></span><br><span class="line"><span class="attr">              items:</span></span><br><span class="line"><span class="attr">                properties:</span></span><br><span class="line"><span class="attr">                  backend:</span></span><br><span class="line"><span class="attr">                    properties:</span></span><br><span class="line"><span class="attr">                      serviceName:</span></span><br><span class="line"><span class="attr">                        type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">                      servicePort:</span></span><br><span class="line"><span class="attr">                        format:</span> <span class="string">int32</span></span><br><span class="line"><span class="attr">                        type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                    type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">                  host:</span></span><br><span class="line"><span class="attr">                    type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">                  port:</span></span><br><span class="line"><span class="attr">                    format:</span> <span class="string">int32</span></span><br><span class="line"><span class="attr">                    type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">                type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">            tls:</span></span><br><span class="line"><span class="attr">              items:</span></span><br><span class="line"><span class="attr">                properties:</span></span><br><span class="line"><span class="attr">                  hosts:</span></span><br><span class="line"><span class="attr">                    items:</span></span><br><span class="line"><span class="attr">                      type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">                    type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">                  secretName:</span></span><br><span class="line"><span class="attr">                    type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">                type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">        status:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">v1beta1</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line"><span class="attr">  acceptedNames:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    plural:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  conditions:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  storedVersions:</span> <span class="string">[]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-serviceaccount</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-clusterrole</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">endpoints</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">secrets</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">services</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">networking.k8s.io</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">extensions</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">networking.internal.knative.dev</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ingresses</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">events</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">create</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">patch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">networking.k8s.io</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">extensions</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">networking.internal.knative.dev</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ingresses/status</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">update</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">configuration.konghq.com</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">tcpingresses/status</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">update</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">configuration.konghq.com</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kongplugins</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kongclusterplugins</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kongcredentials</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kongconsumers</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kongingresses</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">tcpingresses</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">configmaps</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">create</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">update</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-clusterrole-nisa-binding</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-clusterrole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-serviceaccount</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="comment">#    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: tcp</span></span><br><span class="line">    <span class="comment">#    service.beta.kubernetes.io/aws-load-balancer-type: nlb</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">proxy</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">proxy-ssl</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">8443</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">LoadBalancer</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-validation-webhook</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">webhook</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        <span class="string">kuma.io/gateway:</span> <span class="string">enabled</span></span><br><span class="line">        <span class="string">prometheus.io/port:</span> <span class="string">"8100"</span></span><br><span class="line">        <span class="string">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line">        <span class="string">traffic.sidecar.istio.io/includeInboundPorts:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8000,</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8443</span> <span class="string">ssl</span> <span class="string">http2</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8444</span> <span class="string">ssl</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_STATUS_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8100</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_DATABASE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"off"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_NGINX_WORKER_PROCESSES</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"1"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">/dev/stdout</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">/dev/stderr</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">/dev/stderr</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">kong:2.0</span></span><br><span class="line"><span class="attr">        lifecycle:</span></span><br><span class="line"><span class="attr">          preStop:</span></span><br><span class="line"><span class="attr">            exec:</span></span><br><span class="line"><span class="attr">              command:</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">/bin/sh</span></span><br><span class="line"><span class="bullet">              -</span> <span class="bullet">-c</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">kong</span> <span class="string">quit</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/status</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8100</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">proxy</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">proxy</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8443</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">proxy-ssl</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8100</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">metrics</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/status</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8100</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        securityContext:</span></span><br><span class="line"><span class="attr">          runAsUser:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">      - env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">CONTROLLER_KONG_ADMIN_URL</span></span><br><span class="line"><span class="attr">          value:</span> <span class="attr">https://127.0.0.1:8444</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">CONTROLLER_KONG_ADMIN_TLS_SKIP_VERIFY</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">CONTROLLER_PUBLISH_SERVICE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">kong/kong-proxy</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">POD_NAME</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">kong-docker-kubernetes-ingress-controller.bintray.io/kong-ingress-controller:0.9.1</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/healthz</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">10254</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">ingress-controller</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">webhook</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/healthz</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">10254</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">kong-serviceaccount</span></span><br></pre></td></tr></table></figure></details><h4 id="部署测试服务"><a href="#部署测试服务" class="headerlink" title="部署测试服务"></a>部署测试服务</h4><details><summary>echo.yaml</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">echo</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">echo-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">high</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">low</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">echo</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">echo</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">echo-v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">high</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">low</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">echo</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">echo</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">echo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">echo</span></span><br><span class="line"><span class="attr">  strategy:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">echo</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - image:</span> <span class="string">gcr.io/kubernetes-e2e-test-images/echoserver:2.2</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">echo</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">NODE_NAME</span></span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              fieldRef:</span></span><br><span class="line"><span class="attr">                fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">POD_NAME</span></span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              fieldRef:</span></span><br><span class="line"><span class="attr">                fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              fieldRef:</span></span><br><span class="line"><span class="attr">                fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">POD_IP</span></span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              fieldRef:</span></span><br><span class="line"><span class="attr">                fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line"><span class="attr">        resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/v1</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">echo-v1</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/v2</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">echo-v2</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure></details><details><summary>KongPlugins.yaml</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">auth</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">key-auth</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    global:</span> <span class="string">'true'</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">global-rate-limit</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="attr">  limit_by:</span> <span class="string">consumer</span></span><br><span class="line"><span class="attr">  minute:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">  policy:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">rate-limiting</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">rate-limit</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="attr">  limit_by:</span> <span class="string">consumer</span></span><br><span class="line"><span class="attr">  minute:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  policy:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">rate-limiting</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">correlation-id</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="attr">  header_name:</span> <span class="string">X-Request-ID</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">request-id</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">response-header</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="attr">  add:</span></span><br><span class="line"><span class="attr">    headers:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'x-cust-resp-header: xiemx'</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">response-transformer</span></span><br></pre></td></tr></table></figure></details><details><summary>KongIngress.yaml</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongIngress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">custom-ingress</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line"><span class="attr">  methods:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">GET</span></span><br><span class="line">    <span class="comment">#strip_path: true</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongIngress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">custom-svc</span></span><br><span class="line"><span class="attr">upstream:</span></span><br><span class="line"><span class="attr">  hash_on:</span> <span class="string">ip</span></span><br><span class="line"><span class="attr">proxy:</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">/foo/</span></span><br></pre></td></tr></table></figure></details><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>本测试只使用少数几个plugin测试kong的ingress、svc规则生效，具体plugin可以另行测试，已附上对应具体yaml</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">➜  kong git:(master) ✗ kga</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/echo-85fb7989cc-pmjq7          1/1     Running   0          2d14h</span><br><span class="line">pod/ingress-kong-d7b5d68f4-8v9tk   2/2     Running   0          2d14h</span><br><span class="line"></span><br><span class="line">NAME                              TYPE           CLUSTER-IP       EXTERNAL-IP                                                                    PORT(S)                      AGE</span><br><span class="line">service/echo-v1                   ClusterIP      172.20.76.165    &lt;none&gt;                                                                         8080/TCP,80/TCP              2d21h</span><br><span class="line">service/echo-v2                   ClusterIP      172.20.198.164   &lt;none&gt;                                                                         8080/TCP,80/TCP              2d21h</span><br><span class="line">service/kong-proxy                LoadBalancer   172.20.113.185   a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com   80:31957/TCP,443:30218/TCP   2d21h</span><br><span class="line">service/kong-validation-webhook   ClusterIP      172.20.51.128    &lt;none&gt;                                                                         443/TCP                      2d21h</span><br><span class="line"></span><br><span class="line">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/echo           1/1     1            1           2d21h</span><br><span class="line">deployment.apps/ingress-kong   1/1     1            1           2d21h</span><br><span class="line"></span><br><span class="line">NAME                                     DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/echo-85fb7989cc          1         1         1       2d21h</span><br><span class="line">replicaset.apps/ingress-kong-d7b5d68f4   1         1         1       2d21h</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ k get kongingress</span><br><span class="line">NAME             AGE</span><br><span class="line">custom-ingress   2d21h</span><br><span class="line">custom-svc       2d21h</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ k get kongPlugin</span><br><span class="line">NAME              PLUGIN-TYPE            AGE</span><br><span class="line">rate-limit        rate-limiting          2d21h</span><br><span class="line">request-id        correlation-id         2d21h</span><br><span class="line">response-header   response-transformer   2d21h</span><br></pre></td></tr></table></figure><ul><li><p>测试ingress 规则注入</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 无注入访问/v1 和 /v2</span></span></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v2 -X POST -I</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/plain; charset=UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Date: Mon, 07 Dec 2020 03:53:09 GMT</span><br><span class="line">Server: echoserver</span><br><span class="line">X-Kong-Upstream-Latency: 0</span><br><span class="line">X-Kong-Proxy-Latency: 0</span><br><span class="line">Via: kong/2.0.5</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v1 -X POST -I</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/plain; charset=UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Date: Mon, 07 Dec 2020 03:53:16 GMT</span><br><span class="line">Server: echoserver</span><br><span class="line">X-Kong-Upstream-Latency: 0</span><br><span class="line">X-Kong-Proxy-Latency: 0</span><br><span class="line">Via: kong/2.0.5</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 注入ingress，限制请求方法为GET</span></span></span><br><span class="line">➜  kong git:(master) ✗ cat kongIngress/ingress.yaml</span><br><span class="line">apiVersion: configuration.konghq.com/v1</span><br><span class="line">kind: KongIngress</span><br><span class="line">metadata:</span><br><span class="line">  name: custom-ingress</span><br><span class="line">route:</span><br><span class="line">  methods:</span><br><span class="line">  - GET</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ k describe ingress demo</span><br><span class="line">Name:             demo</span><br><span class="line">Namespace:        kong</span><br><span class="line">Address:          a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com</span><br><span class="line">Default backend:  default-http-backend:80 (&lt;none&gt;)</span><br><span class="line">Rules:</span><br><span class="line">  Host  Path  Backends</span><br><span class="line">  ----  ----  --------</span><br><span class="line">  *</span><br><span class="line">        /v1   echo-v1:80 (10.200.1.88:8080)</span><br><span class="line">        /v2   echo-v2:80 (10.200.1.88:8080)</span><br><span class="line">Annotations:</span><br><span class="line">  konghq.com/override:                               custom-ingress</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v1 -X POST -I</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">Date: Mon, 07 Dec 2020 03:56:31 GMT</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 48</span><br><span class="line">X-Kong-Response-Latency: 1</span><br><span class="line">Server: kong/2.0.5</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v2 -X POST -I</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">Date: Mon, 07 Dec 2020 03:56:37 GMT</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 48</span><br><span class="line">X-Kong-Response-Latency: 0</span><br><span class="line">Server: kong/2.0.5</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v2 -X GET -I</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/plain; charset=UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Date: Mon, 07 Dec 2020 03:56:43 GMT</span><br><span class="line">Server: echoserver</span><br><span class="line">X-Kong-Upstream-Latency: 1</span><br><span class="line">X-Kong-Proxy-Latency: 0</span><br><span class="line">Via: kong/2.0.5</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v1 -X GET -I</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/plain; charset=UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Date: Mon, 07 Dec 2020 03:56:48 GMT</span><br><span class="line">Server: echoserver</span><br><span class="line">X-Kong-Upstream-Latency: 0</span><br><span class="line">X-Kong-Proxy-Latency: 0</span><br><span class="line">Via: kong/2.0.5</span><br></pre></td></tr></table></figure></li><li><p>测试svc 规则注入</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">➜  kong git:(master) ✗ cat kongIngress/ingress.yaml</span><br><span class="line">apiVersion: configuration.konghq.com/v1</span><br><span class="line">kind: KongIngress</span><br><span class="line">metadata:</span><br><span class="line">  name: custom-svc</span><br><span class="line">proxy:</span><br><span class="line">  path: /foo/</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ k describe svc echo-v1 echo-v2</span><br><span class="line">Name:              echo-v1</span><br><span class="line">Namespace:         kong</span><br><span class="line">Labels:            app=echo</span><br><span class="line">Annotations:       konghq.com/override: custom-svc</span><br><span class="line">                   kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                     &#123;"apiVersion":"v1","kind":"Service","metadata":&#123;"annotations":&#123;"configuration.konghq.com":"custom-svc"&#125;,"labels":&#123;"app":"echo"&#125;,"name":"ec...</span><br><span class="line">Selector:          app=echo</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                172.20.76.165</span><br><span class="line">Port:              high  8080/TCP</span><br><span class="line">TargetPort:        8080/TCP</span><br><span class="line">Endpoints:         10.200.1.88:8080</span><br><span class="line">Port:              low  80/TCP</span><br><span class="line">TargetPort:        8080/TCP</span><br><span class="line">Endpoints:         10.200.1.88:8080</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Name:              echo-v2</span><br><span class="line">Namespace:         kong</span><br><span class="line">Labels:            app=echo</span><br><span class="line">Annotations:       kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                     &#123;"apiVersion":"v1","kind":"Service","metadata":&#123;"annotations":&#123;&#125;,"labels":&#123;"app":"echo"&#125;,"name":"echo-v2","namespace":"kong"&#125;,"spec":&#123;"por...</span><br><span class="line">Selector:          app=echo</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                172.20.198.164</span><br><span class="line">Port:              high  8080/TCP</span><br><span class="line">TargetPort:        8080/TCP</span><br><span class="line">Endpoints:         10.200.1.88:8080</span><br><span class="line">Port:              low  80/TCP</span><br><span class="line">TargetPort:        8080/TCP</span><br><span class="line">Endpoints:         10.200.1.88:8080</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 测试</span></span></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v1 -X GET</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hostname: echo-85fb7989cc-pmjq7</span><br><span class="line"></span><br><span class="line">Pod Information:</span><br><span class="line">node name:ip-10-200-1-155.ap-northeast-1.compute.internal</span><br><span class="line">pod name:echo-85fb7989cc-pmjq7</span><br><span class="line">pod namespace:kong</span><br><span class="line">pod IP:10.200.1.88</span><br><span class="line"></span><br><span class="line">Server values:</span><br><span class="line">server_version=nginx: 1.12.2 - lua: 10010</span><br><span class="line"></span><br><span class="line">Request Information:</span><br><span class="line">client_address=10.200.1.189</span><br><span class="line">method=GET</span><br><span class="line">real path=/foo/v1</span><br><span class="line">query=</span><br><span class="line">request_version=1.1</span><br><span class="line">request_scheme=http</span><br><span class="line">request_uri=http://a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com:8080/foo/v1</span><br><span class="line"></span><br><span class="line">Request Headers:</span><br><span class="line">accept=*/*</span><br><span class="line">connection=keep-alive</span><br><span class="line">host=a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com</span><br><span class="line">user-agent=curl/7.54.0</span><br><span class="line">x-forwarded-for=10.200.2.91</span><br><span class="line">x-forwarded-host=a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com</span><br><span class="line">x-forwarded-port=8000</span><br><span class="line">x-forwarded-proto=http</span><br><span class="line">x-real-ip=10.200.2.91</span><br><span class="line"></span><br><span class="line">Request Body:</span><br><span class="line">-no body in request-</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v2 -X GET</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hostname: echo-85fb7989cc-pmjq7</span><br><span class="line"></span><br><span class="line">Pod Information:</span><br><span class="line">node name:ip-10-200-1-155.ap-northeast-1.compute.internal</span><br><span class="line">pod name:echo-85fb7989cc-pmjq7</span><br><span class="line">pod namespace:kong</span><br><span class="line">pod IP:10.200.1.88</span><br><span class="line"></span><br><span class="line">Server values:</span><br><span class="line">server_version=nginx: 1.12.2 - lua: 10010</span><br><span class="line"></span><br><span class="line">Request Information:</span><br><span class="line">client_address=10.200.1.189</span><br><span class="line">method=GET</span><br><span class="line">real path=/v2</span><br><span class="line">query=</span><br><span class="line">request_version=1.1</span><br><span class="line">request_scheme=http</span><br><span class="line">request_uri=http://a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com:8080/v2</span><br><span class="line"></span><br><span class="line">Request Headers:</span><br><span class="line">accept=*/*</span><br><span class="line">connection=keep-alive</span><br><span class="line">host=a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com</span><br><span class="line">user-agent=curl/7.54.0</span><br><span class="line">x-forwarded-for=10.200.1.234</span><br><span class="line">x-forwarded-host=a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com</span><br><span class="line">x-forwarded-port=8000</span><br><span class="line">x-forwarded-proto=http</span><br><span class="line">x-real-ip=10.200.1.234</span><br><span class="line"></span><br><span class="line">Request Body:</span><br><span class="line">-no body in request-</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Kong-Ingress&quot;&gt;&lt;a href=&quot;#Kong-Ingress&quot; class=&quot;headerlink&quot; title=&quot;Kong Ingress&quot;&gt;&lt;/a&gt;Kong Ingress&lt;/h2&gt;&lt;p&gt;项目地址：&lt;a href=&quot;https://github.c
      
    
    </summary>
    
    
      <category term="kong" scheme="https://www.xiemx.com/categories/kong/"/>
    
      <category term="ingress" scheme="https://www.xiemx.com/categories/kong/ingress/"/>
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/kong/ingress/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="kong" scheme="https://www.xiemx.com/tags/kong/"/>
    
      <category term="ingress" scheme="https://www.xiemx.com/tags/ingress/"/>
    
  </entry>
  
  <entry>
    <title>kong 学习随记</title>
    <link href="https://www.xiemx.com//2020/11/02/kong-notebook/"/>
    <id>https://www.xiemx.com//2020/11/02/kong-notebook/</id>
    <published>2020-11-02T02:52:00.000Z</published>
    <updated>2020-12-07T05:46:43.045Z</updated>
    
    <content type="html"><![CDATA[<h4 id="模式"><a href="#模式" class="headerlink" title="模式"></a>模式</h4><ul><li>db</li><li>dbless</li></ul><hr><h4 id="install"><a href="#install" class="headerlink" title="install"></a>install</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name kong \</span><br><span class="line">     -v "kong.yaml:/usr/local/kong/declarative" \</span><br><span class="line">     -e "KONG_DATABASE=off" \</span><br><span class="line">     -e "KONG_DECLARATIVE_CONFIG=/usr/local/kong/declarative/kong.yml" \</span><br><span class="line">     -e "KONG_PROXY_ACCESS_LOG=/dev/stdout" \</span><br><span class="line">     -e "KONG_ADMIN_ACCESS_LOG=/dev/stdout" \</span><br><span class="line">     -e "KONG_PROXY_ERROR_LOG=/dev/stderr" \</span><br><span class="line">     -e "KONG_ADMIN_ERROR_LOG=/dev/stderr" \</span><br><span class="line">     -e "KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl" \</span><br><span class="line">     -p 8000:8000 \</span><br><span class="line">     -p 8443:8443 \</span><br><span class="line">     -p 8001:8001 \</span><br><span class="line">     -p 8444:8444 \</span><br><span class="line">     kong:latest</span><br></pre></td></tr></table></figure><ul><li>plugins –&gt; module</li><li>comsumer –&gt; 消费者目前只看到用作auth认证用</li><li>services –&gt; upstream</li><li>routes –&gt; server</li></ul><hr><h4 id="debug-模式"><a href="#debug-模式" class="headerlink" title="debug 模式"></a>debug 模式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H "X-Kong-Debug: 1" http://localhost:8000</span><br></pre></td></tr></table></figure><h4 id="注入环境变量"><a href="#注入环境变量" class="headerlink" title="注入环境变量"></a>注入环境变量</h4><p>从配置文件中加载属性时，Kong还将寻找同名的环境变量。声明前缀<code>KONG_</code>并大写可以覆盖默认配置。<br>example:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="builtin-name">export</span> <span class="attribute">KONG_DATABASE</span>=off</span><br><span class="line">使用dbless 模式启动kong</span><br></pre></td></tr></table></figure><h4 id="注入nginx变量"><a href="#注入nginx变量" class="headerlink" title="注入nginx变量"></a>注入nginx变量</h4><p>前缀为的条目<code>nginx_http_</code>将注入到整体http 块指令中。</p><p>前缀为的条目<code>nginx_proxy_</code>将注入到server处理Kong代理端口的block指令中。</p><p>前缀为的条目<code>nginx_admin_</code>将注入到server处理Kong的Admin API端口的block指令中。</p><p>example：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="builtin-name">export</span> <span class="attribute">KONG_NGINX_HTTP_OUTPUT_BUFFERS</span>=<span class="string">"4 64k"</span></span><br><span class="line"></span><br><span class="line">将会在nginx的http 代码段中加入一条 </span><br><span class="line"><span class="attribute">output_buffers</span>=<span class="string">"4 64k"</span></span><br></pre></td></tr></table></figure><hr><h4 id="HOST传递"><a href="#HOST传递" class="headerlink" title="HOST传递"></a>HOST传递</h4><p><code>preserve_host: true</code> 将会传递request原始的host，相当于<code>proxy_set_header host $host</code></p><p>expamle:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">  preserve_host:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  url:</span> <span class="attr">http://mockbin.org</span></span><br></pre></td></tr></table></figure><hr><h4 id="request-header区分路由"><a href="#request-header区分路由" class="headerlink" title="request header区分路由"></a>request header区分路由</h4><p>注意：headers键是逻辑键AND，其值是逻辑键OR。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">["x.t.xiemx.com"]</span></span><br><span class="line"><span class="attr">  headers:</span> <span class="string">&#123;</span> <span class="string">"version"</span><span class="string">:</span> <span class="string">["v1","v2"]&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">➜</span>  <span class="string">Documents</span> <span class="string">curl</span> <span class="attr">localhost:8000</span> <span class="bullet">-H</span> <span class="attr">version:v1</span> <span class="bullet">-H</span> <span class="attr">host:x.t.xiemx.com</span> <span class="bullet">-I</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/html;</span> <span class="string">charset=utf-8</span></span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">10695</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">Cowboy</span></span><br><span class="line"><span class="attr">Etag:</span> <span class="string">W/"29c7-XG+PICJmz/J+UYWt5gkKqqAUXjc"</span></span><br><span class="line"><span class="attr">Vary:</span> <span class="string">Accept-Encoding</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Fri,</span> <span class="number">03</span> <span class="string">Jan</span> <span class="number">2020</span> <span class="number">03</span><span class="string">:19:08</span> <span class="string">GMT</span></span><br><span class="line"><span class="attr">Via:</span> <span class="string">kong/1.4.2</span></span><br><span class="line"><span class="attr">X-Kong-Upstream-Status:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">X-Kong-Upstream-Latency:</span> <span class="number">517</span></span><br><span class="line"><span class="attr">X-Kong-Proxy-Latency:</span> <span class="number">34</span></span><br><span class="line"><span class="attr">Kong-Cloud-Request-ID:</span> <span class="string">eeb277b4d0df3eb242e92dc0c669f8bc</span></span><br><span class="line"></span><br><span class="line"><span class="string">➜</span>  <span class="string">Documents</span> <span class="string">curl</span> <span class="attr">localhost:8000</span> <span class="bullet">-H</span> <span class="attr">version:v2</span> <span class="bullet">-H</span> <span class="attr">host:x.t.xiemx.com</span> <span class="bullet">-I</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/html;</span> <span class="string">charset=utf-8</span></span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">10695</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">Cowboy</span></span><br><span class="line"><span class="attr">Etag:</span> <span class="string">W/"29c7-XG+PICJmz/J+UYWt5gkKqqAUXjc"</span></span><br><span class="line"><span class="attr">Vary:</span> <span class="string">Accept-Encoding</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Fri,</span> <span class="number">03</span> <span class="string">Jan</span> <span class="number">2020</span> <span class="number">03</span><span class="string">:19:17</span> <span class="string">GMT</span></span><br><span class="line"><span class="attr">Via:</span> <span class="string">kong/1.4.2</span></span><br><span class="line"><span class="attr">X-Kong-Upstream-Status:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">X-Kong-Upstream-Latency:</span> <span class="number">566</span></span><br><span class="line"><span class="attr">X-Kong-Proxy-Latency:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">Kong-Cloud-Request-ID:</span> <span class="string">f3eaf8e27f3d3f9510f1c0c4619df035</span></span><br><span class="line"></span><br><span class="line"><span class="string">➜</span>  <span class="string">Documents</span> <span class="string">curl</span> <span class="attr">localhost:8000</span> <span class="bullet">-H</span> <span class="attr">version:v3</span> <span class="bullet">-H</span> <span class="attr">host:x.t.xiemx.com</span> <span class="bullet">-I</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">404</span> <span class="string">Not</span> <span class="string">Found</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Fri,</span> <span class="number">03</span> <span class="string">Jan</span> <span class="number">2020</span> <span class="number">03</span><span class="string">:19:23</span> <span class="string">GMT</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">application/json;</span> <span class="string">charset=utf-8</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">48</span></span><br><span class="line"><span class="attr">X-Kong-Response-Latency:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">kong/1.4.2</span></span><br></pre></td></tr></table></figure><hr><h4 id="path优先级"><a href="#path优先级" class="headerlink" title="path优先级"></a>path优先级</h4><ul><li>用路径前缀代理时，最长的路径将首先被评估</li><li>regex_priority 优先级</li></ul><h4 id="src-dest-ip白名单"><a href="#src-dest-ip白名单" class="headerlink" title="src/dest ip白名单"></a>src/dest ip白名单</h4><p>sources/destinations路由属性仅适用于TCP和TLS路线。它允许通过传入连接IP、网段或端口源的列表来匹配路由</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">service: TCPService</span><br><span class="line">protocols: </span><br><span class="line">  - tls</span><br><span class="line">  - tcp</span><br><span class="line">sources: </span><br><span class="line">  - &#123; ip: <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span>/<span class="number">32</span>, port: <span class="number">1234</span> &#125;</span><br><span class="line">  - ip: <span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">8</span></span><br><span class="line">destinations:</span><br><span class="line">  - &#123; ip: <span class="number">2.2</span><span class="number">.2</span><span class="number">.2</span>/<span class="number">32</span>, port: <span class="number">1234</span> &#125;</span><br><span class="line">  - ip: <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">8</span></span><br></pre></td></tr></table></figure><h4 id="strip-path-转发时删除路径"><a href="#strip-path-转发时删除路径" class="headerlink" title="strip_path 转发时删除路径"></a>strip_path 转发时删除路径</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"paths"</span>: [<span class="string">"/service"</span>],</span><br><span class="line">    <span class="string">"strip_path"</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">request_url<span class="function"> -&gt;</span> <span class="regexp">/service/1/</span></span><br><span class="line">proxy_url<span class="function"> -&gt;</span> <span class="regexp">/1/</span></span><br></pre></td></tr></table></figure><hr><h3 id="Kong-proxy时默认处理的HEADER"><a href="#Kong-proxy时默认处理的HEADER" class="headerlink" title="Kong proxy时默认处理的HEADER"></a>Kong proxy时默认处理的HEADER</h3><ul><li>Host: <your_upstream_host></your_upstream_host></li><li>Connection: keep-alive，以允许重用上游连接。</li><li>X-Real-IP: <remote_addr>，其中<code>$remote_addr</code>变量的名称与ngx_http_core_module提供的名称相同。<code>$remote_addr</code>可能被ngx_http_realip_module覆盖。</remote_addr></li><li>X-Forwarded-For: <ip>, 访问路径。</ip></li><li>X-Forwarded-Proto: <protocol>，客户端使用的协议。使用ngx_http_core_module <code>$scheme</code>提供的变量的值。</protocol></li><li>X-Forwarded-Host: <host>，客户端发送的主机名。</host></li><li>X-Forwarded-Port: <port>，服务器的端口。使用ngx_http_core_module <code>$server_port</code>变量的值。</port></li></ul><hr><h3 id="Kong-Response-headers"><a href="#Kong-Response-headers" class="headerlink" title="Kong Response headers"></a>Kong Response headers</h3><p>nginx 接收到upstream 的响应只会执行header-filter阶段将下面的header封装进header，后续会在执行body—filter阶段</p><ul><li>Via: kong/x.x.x，x.x.x使用的Kong版本在哪里</li><li>X-Kong-Proxy-Latency: <latency>，Kong从客户端接收请求到将请求发送到上游服务之间的时间（以毫秒为单位）。</latency></li><li>X-Kong-Upstream-Latency: <latency>，Kong等待上游服务响应的第一个字节的时间（以毫秒为单位）。</latency></li></ul><hr><h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><ul><li><h4 id="DNS负载均衡-ttl-0"><a href="#DNS负载均衡-ttl-0" class="headerlink" title="DNS负载均衡(ttl=0)"></a>DNS负载均衡(ttl=0)</h4><ul><li>SRV record</li><li>A record</li><li>CNAME record</li></ul><p><strong>优先级：</strong></p><ul><li>LAST(最后一次成功的类型) -&gt; SRV -&gt; A -&gt; CNAME</li><li>可以在Kong的配置文件中修改,默认<code>dns_order:LAST,SRV,A,CNAME</code></li></ul><p><strong>问题：</strong></p><ul><li>DNS可能不会返回所有的记录，导致下游服务器负载不均衡</li></ul></li><li><h4 id="Ring-balancer"><a href="#Ring-balancer" class="headerlink" title="Ring-balancer"></a>Ring-balancer</h4><ul><li><p>upstream</p><ul><li>service中host=”upstream_name”使用的名字，使用方法同nginx类似</li><li>upstream 需要预先分配一个slots，target会根据weight分配到slots上，默认upstream的slots=10000，范围（1 - 65536）。</li><li>插槽数越多，随机分布越好，但是更改的开销就越大（添加/删除目标）</li><li>当插槽数量更改时，将需要重建</li><li>which can be overwritten before proxying, using upstream’s property <code>host_header</code></li></ul></li><li><p>target</p><ul><li>实际upstream中使用的主机地址，等同于nginx upstream中的server指令，支持定义<code>weight</code></li><li>当target使用域名时，会将域名进行解析，然后将每条记录都设置到slots上，切遵循DNS TTL过期时间，去重复查询</li><li>如果存在SRV记录，会优先使用SRV 记录的weight/port</li></ul></li></ul></li><li><h4 id="负载均衡算法"><a href="#负载均衡算法" class="headerlink" title="负载均衡算法"></a>负载均衡算法</h4><ul><li><p>HASH（如下hash key）</p><ul><li>none 不使用哈希，而采用weighted-round-robin（默认值）。</li><li>cookie</li><li>ip</li><li>header</li><li>consumer</li></ul></li><li><p>WRR(weighted-round-robin)</p></li></ul><p><strong>PS</strong>: upstream 中的target 如未指定port则使用requst 请求中的port 不会使用，service中定义的port</p></li></ul><hr><h3 id="健康检测"><a href="#健康检测" class="headerlink" title="健康检测"></a>健康检测</h3><ul><li><p>active<br>主动发出http/https request轮询target</p></li><li><p>passive<br>分析backend response的状态码，不需要指定URL等参数</p><p>PS: interval=0时禁止，healthcheck可以同时开启被动检测，已实现断路功能，并开启主动检测中的unhealthcheck实现target故障自愈后自动加入</p></li></ul><hr><h3 id="kong-cluster"><a href="#kong-cluster" class="headerlink" title="kong cluster"></a>kong cluster</h3><ul><li><p>集群之间的节点流量不会自动负载均衡，需要在node前面有一个负载均衡器</p></li><li><p>由于性能的原因，node不会在proxy流量时去链接PG，而是将数据cache在内存中，多node集群中需要保证节点的数据同步更新</p><ul><li>db_update_frequency: 5 #node节点去db中同步数据的间隔，数据刷新间隔</li><li>db_update_propagation: 0 #如果后端是分布式数据库的话，则需要配置这个值。此值应该等于分布式数据库内部传播数据最终达到数据一致的时间。如果设置这个值，数据库更新时间将会为<code>db_update_frequency + db_update_propagation</code>，并且设置的节点也会等待一个propagation时间再去update cache</li><li>db_cache_ttl: 0 #防止invalid event事件node没有接收到而错过更新，可以设置一个主动过期时间</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;模式&quot;&gt;&lt;a href=&quot;#模式&quot; class=&quot;headerlink&quot; title=&quot;模式&quot;&gt;&lt;/a&gt;模式&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;db&lt;/li&gt;
&lt;li&gt;dbless&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h4 id=&quot;install&quot;&gt;&lt;a href=&quot;#in
      
    
    </summary>
    
    
      <category term="kong" scheme="https://www.xiemx.com/categories/kong/"/>
    
    
      <category term="kong" scheme="https://www.xiemx.com/tags/kong/"/>
    
  </entry>
  
  <entry>
    <title>aws alb ingress controller</title>
    <link href="https://www.xiemx.com//2020/10/03/kong-ingress/"/>
    <id>https://www.xiemx.com//2020/10/03/kong-ingress/</id>
    <published>2020-10-03T02:52:00.000Z</published>
    <updated>2020-12-07T08:00:06.980Z</updated>
    
    <content type="html"><![CDATA[<h2 id="AWS-alb-ingress-controller"><a href="#AWS-alb-ingress-controller" class="headerlink" title="AWS-alb-ingress-controller"></a>AWS-alb-ingress-controller</h2><p>项目：<a href="https://github.com/kubernetes-sigs/aws-load-balancer-controller" target="_blank" rel="noopener">https://github.com/kubernetes-sigs/aws-load-balancer-controller</a></p><p><img src="/images/aws-alb-ingress-controller.jpg" alt="aws-alb-ingress-controller"></p><ul><li><strong>步骤1</strong>: controller 监听api-services的event事件,当发现 Ingress 资源满足要求，则将开始创建 AWS 资源。</li><li><strong>步骤2</strong>: 为 Ingress 资源创建 ALB</li><li><strong>步骤3</strong>: 为 Ingress 资源中指定的每个后端创建目标组</li><li><strong>步骤4</strong>: 为 Ingress 资源注释中指定的每个端口创建侦听器</li><li><strong>步骤5</strong>: 为 Ingress 资源中指定的每个路径创建规则<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a><strong>注意</strong></h4><ul><li>ingress-controller 需要有权限访问aws创建资源，具体权限可参考：<code>iam-policy.json</code>。本例子中直接对eks worknode role进行授权。理论上也可以进行OIDC接入aws iam针对于pod级别进行权限管理（未测试）。</li><li>确保ingress annotation的资源存在，否则创建会失败，具体可看pod日志。</li><li><code>service</code> 的type为 <code>nodeport</code>。</li></ul></li></ul><hr><h3 id="Install-controller"><a href="#Install-controller" class="headerlink" title="Install controller"></a>Install controller</h3><details><summary>rbac+sa+ns.yaml</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">""</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">extensions</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">configmaps</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">endpoints</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">events</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ingresses</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ingresses/status</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">services</span></span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">create</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">patch</span></span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">""</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">extensions</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">nodes</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">pods</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">secrets</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">services</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">namespaces</span></span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">  - kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">alb-ingress</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">alb-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">alb-ingress-controller</span></span><br></pre></td></tr></table></figure></details><details><summary>controller.yaml</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line">  <span class="comment"># Namespace the ALB Ingress Controller should run in. Does not impact which</span></span><br><span class="line">  <span class="comment"># namespaces it's able to resolve ingress resource for. For limiting ingress</span></span><br><span class="line">  <span class="comment"># namespace scope, see --watch-namespace.</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxSurge:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - args:</span></span><br><span class="line">            <span class="comment"># Limit the namespace where this ALB Ingress Controller deployment will</span></span><br><span class="line">            <span class="comment"># resolve ingress resources. If left commented, all namespaces are used.</span></span><br><span class="line">            <span class="comment"># - --watch-namespace=uat</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Setting the ingress-class flag below ensures that only ingress resources with the</span></span><br><span class="line">            <span class="comment"># annotation kubernetes.io/ingress.class: "alb" are respected by the controller. You may</span></span><br><span class="line">            <span class="comment"># choose any class you'd like for this controller to respect.</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--ingress-class=alb</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Name of your cluster. Used when naming resources created</span></span><br><span class="line">            <span class="comment"># by the ALB Ingress Controller, providing distinction between</span></span><br><span class="line">            <span class="comment"># clusters.</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--cluster-name=aux-eks</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># AWS VPC ID this ingress controller will use to create AWS resources.</span></span><br><span class="line">            <span class="comment"># If unspecified, it will be discovered from ec2metadata.</span></span><br><span class="line">            <span class="comment"># - --aws-vpc-id=vpc-xxxxxx</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># AWS region this ingress controller will operate in.</span></span><br><span class="line">            <span class="comment"># If unspecified, it will be discovered from ec2metadata.</span></span><br><span class="line">            <span class="comment"># List of regions: http://docs.aws.amazon.com/general/latest/gr/rande.html#vpc_region</span></span><br><span class="line">            <span class="comment"># - --aws-region=us-west-1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Enables logging on all outbound requests sent to the AWS API.</span></span><br><span class="line">            <span class="comment"># If logging is desired, set to true.</span></span><br><span class="line">            <span class="comment"># - ---aws-api-debug</span></span><br><span class="line">            <span class="comment"># Maximum number of times to retry the aws calls.</span></span><br><span class="line">            <span class="comment"># defaults to 10.</span></span><br><span class="line">            <span class="comment"># - --aws-max-retries=10</span></span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line">            <span class="comment"># AWS key id for authenticating with the AWS API.</span></span><br><span class="line">            <span class="comment"># This is only here for examples. It's recommended you instead use</span></span><br><span class="line">            <span class="comment"># a project like kube2iam for granting access.</span></span><br><span class="line">            <span class="comment">#- name: AWS_ACCESS_KEY_ID</span></span><br><span class="line">            <span class="comment">#  value: KEYVALUE</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># AWS key secret for authenticating with the AWS API.</span></span><br><span class="line">            <span class="comment"># This is only here for examples. It's recommended you instead use</span></span><br><span class="line">            <span class="comment"># a project like kube2iam for granting access.</span></span><br><span class="line">            <span class="comment">#- name: AWS_SECRET_ACCESS_KEY</span></span><br><span class="line">            <span class="comment">#  value: SECRETVALUE</span></span><br><span class="line">          <span class="comment"># Repository location of the ALB Ingress Controller.</span></span><br><span class="line"><span class="attr">          image:</span> <span class="number">894847497797.</span><span class="string">dkr.ecr.us-west-2.amazonaws.com/aws-alb-ingress-controller:v1.0.0</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">server</span></span><br><span class="line"><span class="attr">          resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">          terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line"><span class="attr">      dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">      securityContext:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">alb-ingress</span></span><br><span class="line"><span class="attr">      serviceAccount:</span> <span class="string">alb-ingress</span></span><br></pre></td></tr></table></figure></details><details><summary>iam-policy.json</summary><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"acm:DescribeCertificate"</span>,</span><br><span class="line">        <span class="string">"acm:ListCertificates"</span>,</span><br><span class="line">        <span class="string">"acm:GetCertificate"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"ec2:AuthorizeSecurityGroupIngress"</span>,</span><br><span class="line">        <span class="string">"ec2:CreateSecurityGroup"</span>,</span><br><span class="line">        <span class="string">"ec2:CreateTags"</span>,</span><br><span class="line">        <span class="string">"ec2:DeleteTags"</span>,</span><br><span class="line">        <span class="string">"ec2:DeleteSecurityGroup"</span>,</span><br><span class="line">        <span class="string">"ec2:DescribeInstances"</span>,</span><br><span class="line">        <span class="string">"ec2:DescribeInstanceStatus"</span>,</span><br><span class="line">        <span class="string">"ec2:DescribeSecurityGroups"</span>,</span><br><span class="line">        <span class="string">"ec2:DescribeSubnets"</span>,</span><br><span class="line">        <span class="string">"ec2:DescribeTags"</span>,</span><br><span class="line">        <span class="string">"ec2:DescribeVpcs"</span>,</span><br><span class="line">        <span class="string">"ec2:ModifyInstanceAttribute"</span>,</span><br><span class="line">        <span class="string">"ec2:ModifyNetworkInterfaceAttribute"</span>,</span><br><span class="line">        <span class="string">"ec2:RevokeSecurityGroupIngress"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"elasticloadbalancing:AddTags"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:CreateListener"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:CreateLoadBalancer"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:CreateRule"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:CreateTargetGroup"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:DeleteListener"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:DeleteLoadBalancer"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:DeleteRule"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:DeleteTargetGroup"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:DeregisterTargets"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:DescribeListeners"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:DescribeLoadBalancers"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:DescribeLoadBalancerAttributes"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:DescribeRules"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:DescribeSSLPolicies"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:DescribeTags"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:DescribeTargetGroups"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:DescribeTargetGroupAttributes"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:DescribeTargetHealth"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:ModifyListener"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:ModifyLoadBalancerAttributes"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:ModifyRule"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:ModifyTargetGroup"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:ModifyTargetGroupAttributes"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:RegisterTargets"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:RemoveTags"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:SetIpAddressType"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:SetSecurityGroups"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:SetSubnets"</span>,</span><br><span class="line">        <span class="string">"elasticloadbalancing:SetWebACL"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"iam:GetServerCertificate"</span>,</span><br><span class="line">        <span class="string">"iam:ListServerCertificates"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"waf-regional:GetWebACLForResource"</span>,</span><br><span class="line">        <span class="string">"waf-regional:GetWebACL"</span>,</span><br><span class="line">        <span class="string">"waf-regional:AssociateWebACL"</span>,</span><br><span class="line">        <span class="string">"waf-regional:DisassociateWebACL"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"tag:GetResources"</span>,</span><br><span class="line">        <span class="string">"tag:TagResources"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"waf:GetWebACL"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><details><summary>ingress.yaml</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">alb.ingress.kubernetes.io/actions.ssl-redirect:</span> <span class="string">'&#123;"Type": "redirect", "RedirectConfig":</span></span><br><span class="line"><span class="string">      &#123; "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"&#125;&#125;'</span></span><br><span class="line">    <span class="string">alb.ingress.kubernetes.io/certificate-arn:</span> <span class="attr">arn:aws:acm:ap-northeast-1:xxxxxxxxx:certificate/281bee29-717c-4b50-bf8e-41a39748c548</span></span><br><span class="line">    <span class="string">alb.ingress.kubernetes.io/listen-ports:</span> <span class="string">'[&#123;"HTTP": 80, "HTTPS": 443&#125;]'</span></span><br><span class="line">    <span class="string">alb.ingress.kubernetes.io/scheme:</span> <span class="string">internet-facing</span></span><br><span class="line">    <span class="string">alb.ingress.kubernetes.io/subnets:</span> <span class="string">subnet-32ce5544,</span> <span class="string">subnet-41cf6c19</span></span><br><span class="line">    <span class="string">alb.ingress.kubernetes.io/security-groups:</span> <span class="string">sg-018347dc7a3ade5a2</span></span><br><span class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">alb</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">xiemx-web-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">www.xiemx.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">echo-v1</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">'*.xiemx.com'</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">ssl-redirect</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="string">use-annotation</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/*</span></span><br><span class="line"><span class="attr">      - backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">echo-v1</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/*</span></span><br></pre></td></tr></table></figure></details><hr><h4 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h4><ul><li><p>创建<code>alb-ingress-controller</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">➜  aws-alb-ingress-controller git:(master) ✗ k get all</span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/alb-ingress-controller-9596b67b9-d7p69   1/1     Running   0          80d</span><br><span class="line"></span><br><span class="line">NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/alb-ingress-controller   1/1     1            1           361d</span><br><span class="line"></span><br><span class="line">NAME                                               DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/alb-ingress-controller-9596b67b9   1         1         1       361d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">➜  aws-alb-ingress-controller git:(master) ✗ k logs -f pod/alb-ingress-controller-9596b67b9-d7p69</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">AWS ALB Ingress controller</span><br><span class="line">  Release:    v1.0.0</span><br><span class="line">  Build:      git-c25bc6c5</span><br><span class="line">  Repository: https://github.com/kubernetes-sigs/aws-alb-ingress-controller</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">W0917 09:50:21.934737       1 client_config.go:552] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.</span><br><span class="line">I0917 09:50:21.990251       1 :0] kubebuilder/controller "level"=0 "msg"="Starting EventSource"  "Controller"="alb-ingress-controller" "Source"=&#123;"Type":&#123;"metadata":&#123;"creationTimestamp":null&#125;,"spec":&#123;&#125;,"status":&#123;"loadBalancer":&#123;&#125;&#125;&#125;&#125;</span><br><span class="line">I0917 09:50:21.990434       1 :0] kubebuilder/controller "level"=0 "msg"="Starting EventSource"  "Controller"="alb-ingress-controller" "Source"=&#123;"Type":&#123;"metadata":&#123;"creationTimestamp":null&#125;,"spec":&#123;&#125;,"status":&#123;"loadBalancer":&#123;&#125;&#125;&#125;&#125;</span><br><span class="line">I0917 09:50:21.990555       1 :0] kubebuilder/controller "level"=0 "msg"="Starting EventSource"  "Controller"="alb-ingress-controller" "Source"=&#123;"Type":&#123;"metadata":&#123;"creationTimestamp":null&#125;&#125;&#125;</span><br><span class="line">I0917 09:50:21.990841       1 :0] kubebuilder/controller "level"=0 "msg"="Starting EventSource"  "Controller"="alb-ingress-controller" "Source"=&#123;"Type":&#123;"metadata":&#123;"creationTimestamp":null&#125;,"spec":&#123;&#125;,"status":&#123;"daemonEndpoints":&#123;"kubeletEndpoint":&#123;"Port":0&#125;&#125;,"nodeInfo":&#123;"machineID":"","systemUUID":"","bootID":"","kernelVersion":"","osImage":"","containerRuntimeVersion":"","kubeletVersion":"","kubeProxyVersion":"","operatingSystem":"","architecture":""&#125;&#125;&#125;&#125;</span><br><span class="line">I0917 09:50:21.993054       1 leaderelection.go:185] attempting to acquire leader lease  alb-ingress-controller/ingress-controller-leader-alb...</span><br><span class="line">I0917 09:50:38.515944       1 leaderelection.go:194] successfully acquired lease alb-ingress-controller/ingress-controller-leader-alb</span><br><span class="line">I0917 09:50:38.716164       1 :0] kubebuilder/controller "level"=0 "msg"="Starting Controller"  "Controller"="alb-ingress-controller"</span><br><span class="line">I0917 09:50:38.816322       1 :0] kubebuilder/controller "level"=0 "msg"="Starting workers"  "Controller"="alb-ingress-controller" "WorkerCount"=1</span><br></pre></td></tr></table></figure></li><li><p>创建<code>ingress</code>测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">➜  aws-alb-ingress-controller git:(master) ✗ k get ingress</span><br><span class="line">NAME                HOSTS                       ADDRESS                                                                      PORTS   AGE</span><br><span class="line">xiemx-web-ingress   www.xiemx.com,*.xiemx.com   71a14391-albingresscontrol-2ac6-648325502.ap-northeast-1.elb.amazonaws.com   80      14m</span><br><span class="line">➜  aws-alb-ingress-controller git:(master) ✗ curl 71a14391-albingresscontrol-2ac6-648325502.ap-northeast-1.elb.amazonaws.com -H host:www.xiemx.com -I</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Mon, 07 Dec 2020 06:39:29 GMT</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Server: echoserver</span><br><span class="line"></span><br><span class="line">➜  aws-alb-ingress-controller git:(master) ✗ curl 71a14391-albingresscontrol-2ac6-648325502.ap-northeast-1.elb.amazonaws.com -H host:www.xiemx.com -i</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Mon, 07 Dec 2020 06:39:37 GMT</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Server: echoserver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hostname: echo-85fb7989cc-d556c</span><br><span class="line"></span><br><span class="line">Pod Information:</span><br><span class="line">node name:ip-10-200-2-113.ap-northeast-1.compute.internal</span><br><span class="line">pod name:echo-85fb7989cc-d556c</span><br><span class="line">pod namespace:alb-ingress-controller</span><br><span class="line">pod IP:10.200.2.197</span><br><span class="line"></span><br><span class="line">Server values:</span><br><span class="line">server_version=nginx: 1.12.2 - lua: 10010</span><br><span class="line"></span><br><span class="line">Request Information:</span><br><span class="line">client_address=10.200.2.21</span><br><span class="line">method=GET</span><br><span class="line">real path=/</span><br><span class="line">query=</span><br><span class="line">request_version=1.1</span><br><span class="line">request_scheme=http</span><br><span class="line">request_uri=http://www.xiemx.com:8080/</span><br><span class="line"></span><br><span class="line">Request Headers:</span><br><span class="line">accept=*/*</span><br><span class="line">host=www.xiemx.com</span><br><span class="line">user-agent=curl/7.54.0</span><br><span class="line">x-amzn-trace-id=Root=1-5fcdce29-473e8ac375ce203f4961bec3</span><br><span class="line">x-forwarded-for=101.231.43.114</span><br><span class="line">x-forwarded-port=80</span><br><span class="line">x-forwarded-proto=http</span><br><span class="line"></span><br><span class="line">Request Body:</span><br><span class="line">-no body in request-</span><br><span class="line"></span><br><span class="line">➜  aws-alb-ingress-controller git:(master) ✗ curl 71a14391-albingresscontrol-2ac6-648325502.ap-northeast-1.elb.amazonaws.com -H host:blog.xiemx.com -I</span><br><span class="line">HTTP/1.1 301 Moved Permanently</span><br><span class="line">Server: awselb/2.0</span><br><span class="line">Date: Mon, 07 Dec 2020 06:39:44 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 134</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: https://blog.xiemx.com:443/</span><br></pre></td></tr></table></figure></li><li><h3 id="aws-alb-规则"><a href="#aws-alb-规则" class="headerlink" title="aws alb 规则"></a>aws alb 规则</h3><p><img src="/images/aws-alb-ingress-ex1.jpg" alt="aws-alb-ingress-ex1"><br><img src="/images/aws-alb-ingress-ex2.jpg" alt="aws-alb-ingress-ex2"><br><img src="/images/aws-alb-ingress-ex3.jpg" alt="aws-alb-ingress-ex3"><br><img src="/images/aws-alb-ingress-ex4.jpg" alt="aws-alb-ingress-ex4"></p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;AWS-alb-ingress-controller&quot;&gt;&lt;a href=&quot;#AWS-alb-ingress-controller&quot; class=&quot;headerlink&quot; title=&quot;AWS-alb-ingress-controller&quot;&gt;&lt;/a&gt;AWS-alb-
      
    
    </summary>
    
    
      <category term="ingress" scheme="https://www.xiemx.com/categories/ingress/"/>
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/ingress/k8s/"/>
    
    
      <category term="aws" scheme="https://www.xiemx.com/tags/aws/"/>
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="ingress" scheme="https://www.xiemx.com/tags/ingress/"/>
    
  </entry>
  
  <entry>
    <title>nginx/openresty 执行阶段</title>
    <link href="https://www.xiemx.com//2020/02/28/nginx-and-openresty-phases/"/>
    <id>https://www.xiemx.com//2020/02/28/nginx-and-openresty-phases/</id>
    <published>2020-02-27T17:12:43.000Z</published>
    <updated>2020-03-02T06:01:52.543Z</updated>
    
    <content type="html"><![CDATA[<h4 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h4><hr><p>nginx 官方文档：<a href="http://nginx.org/en/docs/dev/development_guide.html#http_phases" target="_blank" rel="noopener">http://nginx.org/en/docs/dev/development_guide.html#http_phases</a></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">NGX_HTTP_POST_READ_PHASE</span>:</span><br><span class="line">接收完请求头之后的第一个阶段，ngx_http_realip_module 注册在这个阶段</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_SERVER_REWRITE_PHASE</span>:</span><br><span class="line">server级别的uri重写阶段， ngx_http_rewrite_module 注册在这个阶段</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_FIND_CONFIG_PHASE</span>:</span><br><span class="line">寻找location配置阶段，该阶段使用重写之后的uri来查找对应的location</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_REWRITE_PHASE</span>:</span><br><span class="line">location级别的uri重写阶段</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_POST_REWRITE_PHASE</span>:</span><br><span class="line">location级别重写的后一阶段，用来检查上阶段是否有uri重写，并根据结果跳转到合适的阶段</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_PREACCESS_PHASE</span>:</span><br><span class="line">一般也用于访问控制，比如限制访问频率，并发等</span><br><span class="line">ngx_http_limit_conn_module/ngx_http_limit_req_module这两个模块注册在此阶段</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_ACCESS_PHASE</span>:</span><br><span class="line">访问权限控制阶段，比如基于ip黑白名单的权限控制，基于用户名密码的权限控制等， ngx_http_access_module/ngx_http_auth_basic_module 注册在此阶段</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_POST_ACCESS_PHASE</span>:</span><br><span class="line">问权限控制的后一阶段，该阶段根据权限控制阶段的执行结果进行相应处理 <span class="built_in">`satisfy`</span> 指令在此阶段生效。</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_TRY_FILES_PHASE</span>:</span><br><span class="line">try_files指令的处理阶段，如果没有配置try_files指令，则该阶段被跳过</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_CONTENT_PHASE</span>:</span><br><span class="line">内容生成阶段，该阶段产生响应，并发送到客户端</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_LOG_PHASE</span>:</span><br><span class="line">日志记录阶段，该阶段记录访问日志</span><br></pre></td></tr></table></figure><h4 id="openresty"><a href="#openresty" class="headerlink" title="openresty"></a>openresty</h4><hr><p>参考文档：<a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/ngx_lua/phase.html" target="_blank" rel="noopener">https://moonbingbing.gitbooks.io/openresty-best-practices/content/ngx_lua/phase.html</a><br><img src="/images/openresty_phases.png" alt="phase"></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set_by_lua*: 流程分支处理判断变量初始化</span><br><span class="line">rewrite_by_lua*: 转发、重定向、缓存等功能(例如特定请求代理到外网)</span><br><span class="line">access_by_lua*:<span class="built_in"> IP </span>准入、接口权限等情况集中处理(例如配合 iptable 完成简单防火墙)</span><br><span class="line">content_by_lua*: 内容生成</span><br><span class="line">header_filter_by_lua*: 响应头部过滤处理(例如添加头部信息)</span><br><span class="line">body_filter_by_lua*: 响应体过滤处理(例如完成应答内容统一成大写)</span><br><span class="line">log_by_lua*: 会话完成后本地异步完成日志记录(日志可以记录在本地，还可以同步到其他机器)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;nginx&quot;&gt;&lt;a href=&quot;#nginx&quot; class=&quot;headerlink&quot; title=&quot;nginx&quot;&gt;&lt;/a&gt;nginx&lt;/h4&gt;&lt;hr&gt;
&lt;p&gt;nginx 官方文档：&lt;a href=&quot;http://nginx.org/en/docs/dev/deve
      
    
    </summary>
    
    
      <category term="nginx" scheme="https://www.xiemx.com/categories/nginx/"/>
    
    
      <category term="nginx" scheme="https://www.xiemx.com/tags/nginx/"/>
    
      <category term="openresty" scheme="https://www.xiemx.com/tags/openresty/"/>
    
  </entry>
  
  <entry>
    <title>K8S initContainer</title>
    <link href="https://www.xiemx.com//2020/02/25/k8s-initContainer/"/>
    <id>https://www.xiemx.com//2020/02/25/k8s-initContainer/</id>
    <published>2020-02-25T03:52:00.000Z</published>
    <updated>2020-02-25T06:14:57.233Z</updated>
    
    <content type="html"><![CDATA[<p>k8s 可以通过init container来在容器启动之前执行一下初始化之类的操作，initContainers中的容器将按照顺序执行，并在上一个退出后执行下一个，所有容器安全运行结束后启动spec中的容器。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">xiemx</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">xiemx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">xiemx</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">['sh',</span> <span class="string">'-c'</span><span class="string">,</span> <span class="string">'echo running &amp;&amp; sleep 60'</span><span class="string">]</span></span><br><span class="line"><span class="attr">  initContainers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">init-1</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">['sh',</span> <span class="string">'-c'</span><span class="string">,</span> <span class="string">'echo init container 1'</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">init-2</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">['sh',</span> <span class="string">'-c'</span><span class="string">,</span> <span class="string">'echo init container 2'</span><span class="string">]</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;k8s 可以通过init container来在容器启动之前执行一下初始化之类的操作，initContainers中的容器将按照顺序执行，并在上一个退出后执行下一个，所有容器安全运行结束后启动spec中的容器。&lt;/p&gt;
&lt;figure class=&quot;highlight ya
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="initContainer" scheme="https://www.xiemx.com/tags/initContainer/"/>
    
  </entry>
  
  <entry>
    <title>K8S PDB</title>
    <link href="https://www.xiemx.com//2020/02/24/k8s-pdb/"/>
    <id>https://www.xiemx.com//2020/02/24/k8s-pdb/</id>
    <published>2020-02-24T03:08:14.000Z</published>
    <updated>2020-02-25T06:15:20.030Z</updated>
    
    <content type="html"><![CDATA[<p>pdb 控制pod自愿中断时，最大可用和不可用的pod数量，可能会在node drain时阻断维护进程。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">xiemx</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">xiemx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">xiemx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">xiemx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">["sleep",</span> <span class="string">"60"</span><span class="string">]</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">xiemx-PDB</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">xiemx</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  pdb git:(master) ✗ k get pdb</span><br><span class="line">NAME        MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE</span><br><span class="line">xiemx-PDB   N/A             1                 0                     7s</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;pdb 控制pod自愿中断时，最大可用和不可用的pod数量，可能会在node drain时阻断维护进程。&lt;/p&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;l
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="pdb" scheme="https://www.xiemx.com/tags/pdb/"/>
    
  </entry>
  
  <entry>
    <title>K8S LimitRange and ResourceQuota</title>
    <link href="https://www.xiemx.com//2020/02/22/k8s-limit-range/"/>
    <id>https://www.xiemx.com//2020/02/22/k8s-limit-range/</id>
    <published>2020-02-22T02:52:00.000Z</published>
    <updated>2020-02-25T06:15:52.085Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ResourceQuota"><a href="#ResourceQuota" class="headerlink" title="ResourceQuota"></a>ResourceQuota</h4><p>resourceQuota 可以限制一个ns下可以创建的资源数量和资源的limit</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">compute-resources</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hard:</span></span><br><span class="line"><span class="attr">    pods:</span> <span class="string">"4"</span></span><br><span class="line">    <span class="string">requests.cpu:</span> <span class="string">"1"</span></span><br><span class="line">    <span class="string">requests.memory:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line">    <span class="string">limits.cpu:</span> <span class="string">"2"</span></span><br><span class="line">    <span class="string">limits.memory:</span> <span class="number">2</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure><hr><h4 id="LimitRange"><a href="#LimitRange" class="headerlink" title="LimitRange"></a>LimitRange</h4><p>k8s 使用limit range开控制一个命名空间下的不同type(pod, container)类型资源限制，参考下面</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-limit-range</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">limit-mem-cpu-per-container</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  limits:</span></span><br><span class="line"><span class="attr">  - max:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="string">"800m"</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="string">"1Gi"</span></span><br><span class="line"><span class="attr">    min:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="string">"100m"</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="string">"100Mi"</span></span><br><span class="line"><span class="attr">    default:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="string">"700m"</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="string">"900Mi"</span></span><br><span class="line"><span class="attr">    defaultRequest:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="string">"110m"</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="string">"200Mi"</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">Container</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">t01</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">[</span> <span class="string">"sleep"</span><span class="string">,</span> <span class="string">"60"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">t02</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">[</span> <span class="string">"sleep"</span><span class="string">,</span> <span class="string">"60"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        limits:</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="string">"200m"</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="string">"300Mi"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">t03</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">[</span> <span class="string">"sleep"</span><span class="string">,</span> <span class="string">"60"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="string">"300m"</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="string">"400Mi"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">t04</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">[</span> <span class="string">"sleep"</span><span class="string">,</span> <span class="string">"60"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        limits:</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="string">"444m"</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="string">"444Mi"</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="string">"444m"</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="string">"444Mi"</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">➜  limitRange git:(master) ✗ k get pod</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE</span><br><span class="line">test   4/4     Running   0          20s</span><br><span class="line">➜  limitRange git:(master) ✗ k describe pod test</span><br><span class="line">Name:         test</span><br><span class="line">Namespace:    test-limit-range</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         ip-10-200-1-57.ap-northeast-1.compute.internal/10.200.1.57</span><br><span class="line">Start Time:   Mon, 24 Feb 2020 10:17:19 +0800</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                &#123;"apiVersion":"v1","kind":"Pod","metadata":&#123;"annotations":&#123;&#125;,"name":"test","namespace":"test-limit-range"&#125;,"spec":&#123;"containers":[&#123;"command...</span><br><span class="line">              kubernetes.io/limit-ranger:</span><br><span class="line">                LimitRanger plugin set: cpu, memory request for container t01; cpu, memory limit for container t01; cpu, memory limit for container t03</span><br><span class="line">              kubernetes.io/psp: eks.privileged</span><br><span class="line">Status:       Running</span><br><span class="line">IP:           10.200.1.207</span><br><span class="line">IPs:          &lt;none&gt;</span><br><span class="line">Containers:</span><br><span class="line">  t01:</span><br><span class="line">    Container ID:  docker://b3d8927e0654e7be5f9d826ae14244c9c191d9a9bdb505a9a0b552f8502730e9</span><br><span class="line">    Image:         busybox</span><br><span class="line">    Image ID:      docker-pullable://busybox@sha256:6915be4043561d64e0ab0f8f098dc2ac48e077fe23f488ac24b665166898115a</span><br><span class="line">    Port:          &lt;none&gt;</span><br><span class="line">    Host Port:     &lt;none&gt;</span><br><span class="line">    Command:</span><br><span class="line">      sleep</span><br><span class="line">      60</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Mon, 24 Feb 2020 10:17:23 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Limits:</span><br><span class="line">      cpu:     700m</span><br><span class="line">      memory:  900Mi</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:        110m</span><br><span class="line">      memory:     200Mi</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-vjjds (ro)</span><br><span class="line">  t02:</span><br><span class="line">    Container ID:  docker://ca64d1db5597e14e4009c34febd4fd97e0a2858605dbcee5d2f4fa6e0d98342b</span><br><span class="line">    Image:         busybox</span><br><span class="line">    Image ID:      docker-pullable://busybox@sha256:6915be4043561d64e0ab0f8f098dc2ac48e077fe23f488ac24b665166898115a</span><br><span class="line">    Port:          &lt;none&gt;</span><br><span class="line">    Host Port:     &lt;none&gt;</span><br><span class="line">    Command:</span><br><span class="line">      sleep</span><br><span class="line">      60</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Mon, 24 Feb 2020 10:17:27 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Limits:</span><br><span class="line">      cpu:     200m</span><br><span class="line">      memory:  300Mi</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:        200m</span><br><span class="line">      memory:     300Mi</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-vjjds (ro)</span><br><span class="line">  t03:</span><br><span class="line">    Container ID:  docker://21891b99b6ebd54eadc4ceed63c451e0eb58392dec19679793a141fbadf22491</span><br><span class="line">    Image:         busybox</span><br><span class="line">    Image ID:      docker-pullable://busybox@sha256:6915be4043561d64e0ab0f8f098dc2ac48e077fe23f488ac24b665166898115a</span><br><span class="line">    Port:          &lt;none&gt;</span><br><span class="line">    Host Port:     &lt;none&gt;</span><br><span class="line">    Command:</span><br><span class="line">      sleep</span><br><span class="line">      60</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Mon, 24 Feb 2020 10:17:30 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Limits:</span><br><span class="line">      cpu:     700m</span><br><span class="line">      memory:  900Mi</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:        300m</span><br><span class="line">      memory:     400Mi</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-vjjds (ro)</span><br><span class="line">  t04:</span><br><span class="line">    Container ID:  docker://21e59b648db7aec5d345fc1d6b9998de3c924070c18fcc4e4627a45703401b9c</span><br><span class="line">    Image:         busybox</span><br><span class="line">    Image ID:      docker-pullable://busybox@sha256:6915be4043561d64e0ab0f8f098dc2ac48e077fe23f488ac24b665166898115a</span><br><span class="line">    Port:          &lt;none&gt;</span><br><span class="line">    Host Port:     &lt;none&gt;</span><br><span class="line">    Command:</span><br><span class="line">      sleep</span><br><span class="line">      60</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Mon, 24 Feb 2020 10:17:33 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Limits:</span><br><span class="line">      cpu:     444m</span><br><span class="line">      memory:  444Mi</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:        444m</span><br><span class="line">      memory:     444Mi</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-vjjds (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-vjjds:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-vjjds</span><br><span class="line">    Optional:    false</span><br><span class="line">QoS Class:       Burstable</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From                                                     Message</span><br><span class="line">  ----    ------     ----  ----                                                     -------</span><br><span class="line">  Normal  Scheduled  29s   default-scheduler                                        Successfully assigned test-limit-range/test to ip-10-200-1-57.ap-northeast-1.compute.internal</span><br><span class="line">  Normal  Pulling    28s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  pulling image "busybox"</span><br><span class="line">  Normal  Created    25s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  Created container</span><br><span class="line">  Normal  Started    25s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  Started container</span><br><span class="line">  Normal  Pulled     25s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  Successfully pulled image "busybox"</span><br><span class="line">  Normal  Pulling    24s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  pulling image "busybox"</span><br><span class="line">  Normal  Pulling    21s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  pulling image "busybox"</span><br><span class="line">  Normal  Pulled     21s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  Successfully pulled image "busybox"</span><br><span class="line">  Normal  Created    21s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  Created container</span><br><span class="line">  Normal  Started    21s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  Started container</span><br><span class="line">  Normal  Pulled     19s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  Successfully pulled image "busybox"</span><br><span class="line">  Normal  Created    19s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  Created container</span><br><span class="line">  Normal  Started    18s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  Started container</span><br><span class="line">  Normal  Pulling    18s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  pulling image "busybox"</span><br><span class="line">  Normal  Pulled     16s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  Successfully pulled image "busybox"</span><br><span class="line">  Normal  Created    16s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  Created container</span><br><span class="line">  Normal  Started    15s   kubelet, ip-10-200-1-57.ap-northeast-1.compute.internal  Started container</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;ResourceQuota&quot;&gt;&lt;a href=&quot;#ResourceQuota&quot; class=&quot;headerlink&quot; title=&quot;ResourceQuota&quot;&gt;&lt;/a&gt;ResourceQuota&lt;/h4&gt;&lt;p&gt;resourceQuota 可以限制一个ns下可以创
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="limitRange" scheme="https://www.xiemx.com/tags/limitRange/"/>
    
      <category term="ResourceQuota" scheme="https://www.xiemx.com/tags/ResourceQuota/"/>
    
  </entry>
  
  <entry>
    <title>K8S HPA</title>
    <link href="https://www.xiemx.com//2020/01/25/k8s-hpa/"/>
    <id>https://www.xiemx.com//2020/01/25/k8s-hpa/</id>
    <published>2020-01-25T02:35:00.000Z</published>
    <updated>2020-02-25T02:35:58.721Z</updated>
    
    <content type="html"><![CDATA[<p>k8s hpa当前有3个版本分别支持, v1和v2/beta1版本只能使用CPU使用情况来进行扩容，v2beta2版本可以使用自定义指标来定义<br>使用v2beta2需要使用的metrics-server + prometheus, 使用另外的版本只需要metrics-server</p><p>metrics-server：<a href="https://github.com/kubernetes-sigs/metrics-server" target="_blank" rel="noopener">https://github.com/kubernetes-sigs/metrics-server</a><br>prometheus：<a href="https://github.com/coreos/prometheus-operator" target="_blank" rel="noopener">https://github.com/coreos/prometheus-operator</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  metrics-server git:(master) ✗ k api-versions | grep autoscaling</span><br><span class="line">autoscaling/v1</span><br><span class="line">autoscaling/v2beta1</span><br><span class="line">autoscaling/v2beta2</span><br></pre></td></tr></table></figure><h4 id="explame"><a href="#explame" class="headerlink" title="explame"></a>explame</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">test-hpa</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-hpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">test-hpa</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">test-hpa</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - args:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">-cpus</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"2"</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">vish/stress</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">0.01</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">25</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">0.05</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">60</span><span class="string">Mi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-hpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  scaleTargetRef:</span></span><br><span class="line"><span class="attr">    apiVersion:</span> <span class="string">apps/v1</span> </span><br><span class="line"><span class="attr">    kind:</span> <span class="string">Deployment</span> </span><br><span class="line"><span class="attr">    name:</span> <span class="string">test-hpa</span></span><br><span class="line"><span class="attr">  minReplicas:</span> <span class="number">1</span> </span><br><span class="line"><span class="attr">  maxReplicas:</span> <span class="number">10</span> </span><br><span class="line"><span class="attr">  metrics:</span></span><br><span class="line"><span class="attr">  - type:</span> <span class="string">Resource</span></span><br><span class="line"><span class="attr">    resource:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">cpu</span></span><br><span class="line"><span class="attr">      targetAverageUtilization:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  metrics-server git:(master) ✗ k get hpa</span><br><span class="line">NAME       REFERENCE             TARGETS    MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">test-hpa   Deployment/test-hpa   485%/10%   1         10        10         22h</span><br><span class="line">➜  metrics-server git:(master) ✗ kgp</span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">test-hpa-6b9dd99d-22db4   1/1     Running   0          29m</span><br><span class="line">test-hpa-6b9dd99d-2dnt5   1/1     Running   0          30m</span><br><span class="line">test-hpa-6b9dd99d-68vnv   1/1     Running   0          29m</span><br><span class="line">test-hpa-6b9dd99d-8l59h   1/1     Running   0          29m</span><br><span class="line">test-hpa-6b9dd99d-hqbwf   1/1     Running   0          30m</span><br><span class="line">test-hpa-6b9dd99d-jx7s8   1/1     Running   0          30m</span><br><span class="line">test-hpa-6b9dd99d-qsw4n   1/1     Running   0          22h</span><br><span class="line">test-hpa-6b9dd99d-rvxw4   1/1     Running   0          29m</span><br><span class="line">test-hpa-6b9dd99d-sq4vz   1/1     Running   0          29m</span><br><span class="line">test-hpa-6b9dd99d-wppjm   1/1     Running   0          29m</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;k8s hpa当前有3个版本分别支持, v1和v2/beta1版本只能使用CPU使用情况来进行扩容，v2beta2版本可以使用自定义指标来定义&lt;br&gt;使用v2beta2需要使用的metrics-server + prometheus, 使用另外的版本只需要metrics-s
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="HPA" scheme="https://www.xiemx.com/tags/HPA/"/>
    
  </entry>
  
  <entry>
    <title>K8S 预选优选</title>
    <link href="https://www.xiemx.com//2020/01/25/k8s-predicate-and-priority/"/>
    <id>https://www.xiemx.com//2020/01/25/k8s-predicate-and-priority/</id>
    <published>2020-01-25T02:35:00.000Z</published>
    <updated>2020-06-19T03:17:51.155Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/predicate.jpg" alt="predicate.jpg"></p><h4 id="predicate"><a href="#predicate" class="headerlink" title="predicate"></a>predicate</h4><hr><ul><li>NoDiskConflict：pod所需的卷是否和节点已存在的卷冲突</li><li>NoVolumeZoneConflict：检查给定的zone限制前提下，检查如果在此主机上部署Pod是否存在卷冲突。云厂商可用区限制。</li><li>PodFitsResources：检查节点是否有足够资源</li><li>PodFitsHostPorts：检查Pod容器所需的Port是否已被占用</li><li>HostName：检查节点是否满足PodSpec的NodeName字段中指定节点主机名，不满足节点的全部会被过滤掉。</li><li>MatchNodeSelector：检查节点标签（label）是否匹配Pod的nodeSelector属性要求</li><li>MaxEBSVolumeCount：确保已挂载的EBS存储卷不超过设置的最大值（默认值：39。Amazon推荐最大卷数量为40）</li><li>MaxGCEPDVolumeCount：确保已挂载的GCE存储卷不超过预设的最大值（默认值：16）</li><li>MaxAzureDiskVolumeCount : 确保已挂载的Azure存储卷不超过设置的最大值（默认值：16）</li><li>CheckNodeMemoryPressure : 判断节点是否已经进入到内存压力状态，如果是则只允许调度内存为0标记的Pod。检查Pod能否调度到内存有压力的节点上。如有节点存在内存压力， Guaranteed类型的Pod（例如，requests与limit均指定且值相等） 不能调度到节点上</li><li>CheckNodeDiskPressure : 判断节点是否已经进入到磁盘压力状态，如果是，则不调度新的Pod。</li><li>PodToleratesNodeTaints : 根据 taints 和 toleration 的关系判断Pod是否可以调度到节点上Pod是否满足节点容忍的一些条件。</li><li>MatchInterPodAffinity : 节点亲和性筛选。</li><li>GeneralPredicates：包含一些基本的筛选规则，主要考虑 Kubernetes 资源是否充足，比如 CPU 和 内存 是否足够，端口是否冲突、selector 是否匹配等：<ul><li>PodFitsResources：检查主机上的资源是否满足Pod的需求。资源的计算是根据主机上运行Pod请求的资源作为参考的，而不是以实际运行的资源数量</li><li>PodFitsHost：如果Pod指定了spec.NodeName，看节点的名字是否何它匹配，只有匹配的节点才能运行Pod</li><li>PodFitsHostPorts：检查Pod申请的主机端口是否已经被其他Pod占用，如果是，则不能调度</li><li>PodSelectorMatches：检查主机的标签是否满足Pod的 selector。包括NodeAffinity和nodeSelector中定义的标签。</li></ul></li></ul><h4 id="priority"><a href="#priority" class="headerlink" title="priority"></a>priority</h4><hr><ul><li>LeastRequestedPriority：节点的优先级就由节点空闲资源与节点总容量的比值，即由（总容量-节点上Pod的容量总和-新Pod的容量）/总容量）来决定。CPU和内存具有相同权重，资源空闲比越高的节点得分越高。需要注意的是，这个优先级函数起到了按照资源消耗来跨节点分配Pod的作用。详细的计算规则如下：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpu((capacity – sum(requested)) * 10 / capacity) + memory((capacity – sum(requested)) * 10 / capacity) / 2</span><br></pre></td></tr></table></figure><ul><li><p>LeastRequestedPriority举例说明：例如CPU的可用资源为100，运行容器申请的资源为15，则cpu分值为8.5分，内存可用资源为100，运行容器申请资源为20，则内存分支为8分。则此评价规则在此节点的分数为(8.5 +8) / 2 = 8.25分。</p></li><li><p>BalancedResourceAllocation：CPU和内存使用率越接近的节点权重越高，该策略不能单独使用，必须和LeastRequestedPriority组合使用，尽量选择在部署Pod后各项资源更均衡的机器。如果请求的资源（CPU或者内存）大于节点的capacity，那么该节点永远不会被调度到。</p></li><li><p>BalancedResourceAllocation举例说明：该调度策略是出于平衡度的考虑，避免出现CPU，内存消耗不均匀的事情。例如某节点的CPU剩余资源还比较充裕，假如为100，申请10，则cpuFraction为0.1，而内存剩余资源不多，假如为20，申请10，则memoryFraction为0.5，这样由于CPU和内存使用不均衡，此节点的得分为10-abs ( 0.1 - 0.5 ) * 10 = 6 分。假如CPU和内存资源比较均衡，例如两者都为0.5，那么代入公式，则得分为10分。</p></li><li><p>InterPodAffinityPriority：通过迭代 weightedPodAffinityTerm 的元素计算和，并且如果对该节点满足相应的PodAffinityTerm，则将 “weight” 加到和中，具有最高和的节点是最优选的。 `</p></li><li><p>SelectorSpreadPriority：为了更好的容灾，对同属于一个service、replication controller或者replica的多个Pod副本，尽量调度到多个不同的节点上。如果指定了区域，调度器则会尽量把Pod分散在不同区域的不同节点上。当一个Pod的被调度时，会先查找Pod对于的service或者replication controller，然后查找service或replication controller中已存在的Pod，运行Pod越少的节点的得分越高。</p></li><li><p>SelectorSpreadPriority举例说明：这里主要针对多实例的情况下使用。例如，某一个服务，可能存在5个实例，例如当前节点已经分配了2个实例了，则本节点的得分为10*（（5-2）/ 5）=6分，而没有分配实例的节点，则得分为10 * （（5-0） / 5）=10分。没有分配实例的节点得分越高。</p></li><li><p>NodePreferAvoidPodsPriority（权重1W）：如果 节点的 Anotation 没有设置 key-value:scheduler. alpha.kubernetes.io/ preferAvoidPods = “…”，则节点对该 policy 的得分就是10分，加上权重10000，那么该node对该policy的得分至少10W分。如果Node的Anotation设置了，scheduler.alpha.kubernetes.io/preferAvoidPods = “…” ，如果该 pod 对应的 Controller 是 ReplicationController 或 ReplicaSet，则该 node 对该 policy 的得分就是0分。</p></li><li><p>TaintTolerationPriority : 使用 Pod 中 tolerationList 与 节点 Taint 进行匹配，配对成功的项越多，则得分越低。</p></li></ul><hr><p>搬运自：<a href="http://dockone.io/article/2885" target="_blank" rel="noopener">http://dockone.io/article/2885</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/images/predicate.jpg&quot; alt=&quot;predicate.jpg&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;predicate&quot;&gt;&lt;a href=&quot;#predicate&quot; class=&quot;headerlink&quot; title=&quot;predicate&quot;&gt;&lt;/
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>zombie/orphan process</title>
    <link href="https://www.xiemx.com//2020/01/22/zombie-and-orphan-process/"/>
    <id>https://www.xiemx.com//2020/01/22/zombie-and-orphan-process/</id>
    <published>2020-01-22T02:52:00.000Z</published>
    <updated>2020-01-22T03:02:33.828Z</updated>
    
    <content type="html"><![CDATA[<h3 id="zombie-process-orphan-process"><a href="#zombie-process-orphan-process" class="headerlink" title="zombie process / orphan process"></a>zombie process / orphan process</h3><p>父进程通过fork()函数来创建子进程。子进程会copy 当前父进程的状态和运行代码，独立运行，子进程和父进程的的运行和结束是一个异步的过程，fork出来之后运行的先后顺序也取决于系统的调度，不存在绝对的顺序。linux 为了进程退出能被正确回收，会维护一张进程的映射表，当进程结束时，系统会将进程的信息存储起来，等待父进程去处理回收子进程，处于退出状态且父进程没有调用wait()获取状态信息的进程就会陷入<code>Z</code> 状态，理论上所有的进程都会有一个短暂的<code>Z</code> 状态。</p><ul><li><p>orphan process：一个父进程退出，而子进程还在运行，这些子进程将成为孤儿进程，被init进程所收养，并由init进程对它们完成状态收集工作。</p></li><li><p>zombie process：进程使用fork创建子进程，如果子进程退出，而父进程并没有调用wait或waitpid获取子进程的状态信息，那么子进程的进程描述符仍然保存在系统中。这种进程称之为僵死进程。</p></li></ul><h4 id="如何处理僵尸进程-孤儿进程"><a href="#如何处理僵尸进程-孤儿进程" class="headerlink" title="如何处理僵尸进程/孤儿进程"></a>如何处理僵尸进程/孤儿进程</h4><ul><li>orphan process<br>  理论上孤儿进程不会对系统有影响，init 进程会接管成为父进程，负责进程回收，linux中也会有很多主动的操作来避免子进程被主动回收，比如说<code>nohup</code>、<code>disown</code> ，都是通过屏蔽信号来使子进程成为orphan process最终被init接收，实现终端关闭但是进程不退出</li><li>zombie process<br>  理论上zombie process是由于父进程不wait(), 可以直接干掉父进程，让init接手来处理</li></ul><h4 id="fork"><a href="#fork" class="headerlink" title="fork()"></a>fork()</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pid = fork()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> pid &gt; <span class="number">0</span> &#123; printf "this is father"&#125;</span><br><span class="line"><span class="keyword">if</span> pid = <span class="number">0</span> &#123; printf "this is child" &#125;</span><br><span class="line"><span class="keyword">if</span> pid &lt; <span class="number">0</span> &#123; printf "fork error" &#125;</span><br><span class="line"></span><br><span class="line">fork()后会<span class="keyword">copy</span>一个进程出来，fork后的代码会分布在子进程和当前进程中独立运行。也就是会有<span class="number">2</span>次输出。</span><br><span class="line">linux man page的说明：</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       The fork <span class="keyword">extension</span> adds three <span class="keyword">functions</span>, <span class="keyword">as</span> follows.</span><br><span class="line"></span><br><span class="line">       fork() This  <span class="keyword">function</span>  creates  a <span class="built_in">new</span> process. The <span class="keyword">return</span> <span class="keyword">value</span> <span class="keyword">is</span> the zero <span class="keyword">in</span> the child <span class="keyword">and</span> the process-id number <span class="keyword">of</span> the</span><br><span class="line">              child <span class="keyword">in</span> the parent, <span class="keyword">or</span> <span class="number">-1</span> upon  error.  <span class="keyword">In</span>  the  latter  <span class="keyword">case</span>,  ERRNO  indicates  the  problem.   <span class="keyword">In</span>  the  child,</span><br><span class="line">              PROCINFO["pid"] <span class="keyword">and</span> PROCINFO["ppid"] are updated <span class="keyword">to</span> reflect the correct <span class="keyword">values</span>.</span><br><span class="line"></span><br><span class="line">       waitpid()</span><br><span class="line">              This <span class="keyword">function</span> takes a <span class="type">numeric</span> argument, which <span class="keyword">is</span> the process-id <span class="keyword">to</span> wait <span class="keyword">for</span>. The <span class="keyword">return</span> <span class="keyword">value</span> <span class="keyword">is</span> that <span class="keyword">of</span> the wait-</span><br><span class="line">              pid(<span class="number">2</span>) <span class="keyword">system</span> <span class="keyword">call</span>.</span><br><span class="line"></span><br><span class="line">       wait() This <span class="keyword">function</span> waits <span class="keyword">for</span> the first child <span class="keyword">to</span> die.  The <span class="keyword">return</span> <span class="keyword">value</span> <span class="keyword">is</span> that <span class="keyword">of</span> the wait(<span class="number">2</span>) <span class="keyword">system</span> <span class="keyword">call</span>.</span><br></pre></td></tr></table></figure><p>参考：<a href="https://www.cnblogs.com/anker/p/3271773.html" target="_blank" rel="noopener">https://www.cnblogs.com/anker/p/3271773.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;zombie-process-orphan-process&quot;&gt;&lt;a href=&quot;#zombie-process-orphan-process&quot; class=&quot;headerlink&quot; title=&quot;zombie process / orphan process&quot;&gt;&lt;
      
    
    </summary>
    
    
      <category term="linux" scheme="https://www.xiemx.com/categories/linux/"/>
    
    
      <category term="linux" scheme="https://www.xiemx.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>《nginx 变量漫谈》随记</title>
    <link href="https://www.xiemx.com//2020/01/22/nginx-tick/"/>
    <id>https://www.xiemx.com//2020/01/22/nginx-tick/</id>
    <published>2020-01-22T02:52:00.000Z</published>
    <updated>2020-03-02T05:59:40.760Z</updated>
    
    <content type="html"><![CDATA[<h4 id="agentzh-nginx变量漫谈随手记"><a href="#agentzh-nginx变量漫谈随手记" class="headerlink" title="agentzh nginx变量漫谈随手记"></a>agentzh nginx变量漫谈随手记</h4><p>文章地址:<a href="https://openresty.org/download/agentzh-nginx-tutorials-zhcn.html" target="_blank" rel="noopener">https://openresty.org/download/agentzh-nginx-tutorials-zhcn.html</a>  </p><ol><li><p>Nginx 变量名前面有一个 $ 符号</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span> <span class="variable">$a</span> <span class="string">"b"</span>;</span><br><span class="line"><span class="builtin-name">set</span> <span class="variable">$b</span> <span class="string">"<span class="variable">$a</span>, <span class="variable">$a</span>"</span>;</span><br></pre></td></tr></table></figure></li><li><p>有没有办法把特殊的 <code>$</code>字符给转义掉呢？</p></li></ol><ul><li>答案是否定的, 不过幸运的是，我们可以绕过这个限制，比如通过不支持“变量插值”的模块配置指令专门构造出取值为 $ 的 Nginx 变量，然后再在 echo 中使用这个变量<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">geo <span class="variable">$dollar</span> &#123;</span><br><span class="line">    <span class="built_in"> default </span><span class="string">"$"</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in"> server </span>&#123;</span><br><span class="line">     listen 8080;</span><br><span class="line"></span><br><span class="line">     location /test &#123;</span><br><span class="line">         echo <span class="string">"This is a dollar sign: <span class="variable">$dollar</span>"</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li></ul><ol start="3"><li><p>在“变量插值”的上下文中，还有一种特殊情况，即当引用的变量名之后紧跟着变量名的构成字符时（比如后跟字母、数字以及下划线），我们就需要使用特别的记法来消除歧义，例如：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /test &#123;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$first</span> <span class="string">"hello "</span>;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">"<span class="variable">$&#123;first&#125;</span>world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>变量创建和加载</p><ul><li>Nginx 变量的创建和赋值操作发生在全然不同的时间阶段。</li><li>Nginx 变量的创建只能发生在 Nginx 配置加载的时候</li><li>而赋值操作则只会发生在请求实际处理的时候。</li><li>这意味着不创建而直接使用变量会导致启动失败。</li><li>无法在请求处理时动态地创建新的 Nginx 变量。</li><li>Nginx 变量一旦创建可见范围就是整个Nginx配置，跨越不同虚拟主机的 server 配置块。</li></ul></li><li><p>内部跳转</p></li></ol><p>使用第三方模块 ngx_echo 提供的 echo_exec 配置指令，发起到 location /bar 的“内部跳转”。所谓“内部跳转”，就是在处理请求的过程中，于服务器内部，从一个 location 跳转到另一个 location 的过程。不同于 301 和 302 会发生二次请求。 exec类似于linux中的exec 请求发出后不会在回到原理的location，而是直接接管。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /foo &#123;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$a</span> hello;</span><br><span class="line">        <span class="attribute">echo_exec</span> /bar;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /bar &#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">"a = [<span class="variable">$a</span>]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 效果等同于rewrite实现</span></span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /foo &#123;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$a</span> hello;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^</span> /bar;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /bar &#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">"a = [<span class="variable">$a</span>]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="6"><li>内置变量获取request参数</li></ol><ul><li>取 arg 值的 <code>$arg_XXX</code></li><li>取 cookie 值的 <code>$cookie_XXX</code> </li><li>取请求头的 <code>$http_XXX</code> </li><li>取响应头的 <code>$sent_http_XXX</code> <figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">location /test &#123;</span><br><span class="line">    echo <span class="string">"name: $arg_name"</span>;</span><br><span class="line">    echo <span class="string">"class: $arg_class"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ curl <span class="string">'http://localhost:8080/test'</span></span><br><span class="line">name: </span><br><span class="line"><span class="keyword">class</span>: </span><br><span class="line"></span><br><span class="line">$ <span class="symbol">curl</span> '<span class="symbol">http:</span>//<span class="symbol">localhost:<span class="symbol">8080</span></span>/<span class="symbol">test</span>?<span class="symbol">name</span>=<span class="symbol">Tom</span>&amp;<span class="symbol">class</span>=<span class="symbol">3</span>'</span><br><span class="line"><span class="symbol">name: <span class="symbol">Tom</span></span></span><br><span class="line"><span class="symbol">class: <span class="symbol">3</span></span></span><br><span class="line"></span><br><span class="line">$ <span class="symbol">curl</span> '<span class="symbol">http:</span>//<span class="symbol">localhost:<span class="symbol">8080</span></span>/<span class="symbol">test</span>?<span class="symbol">name</span>=<span class="symbol">hello</span>%<span class="symbol">20world</span>&amp;<span class="symbol">class</span>=<span class="symbol">9</span>'</span><br><span class="line"><span class="symbol">name: <span class="symbol">hello</span></span>%<span class="symbol">20world</span></span><br><span class="line"><span class="symbol">class: <span class="symbol">9</span></span></span><br><span class="line"></span><br><span class="line">###<span class="symbol">Nginx</span> 会在匹配参数名之前，自动把原始请求中的参数名调整为全部小写的形式</span><br><span class="line"></span><br><span class="line">$ <span class="symbol">curl</span> '<span class="symbol">http:</span>//<span class="symbol">localhost:<span class="symbol">8080</span></span>/<span class="symbol">test</span>?<span class="symbol">NAME</span>=<span class="symbol">Marry</span>'</span><br><span class="line"><span class="symbol">name: <span class="symbol">Marry</span></span></span><br><span class="line"><span class="symbol">class: </span></span><br><span class="line"></span><br><span class="line">$ <span class="symbol">curl</span> '<span class="symbol">http:</span>//<span class="symbol">localhost:<span class="symbol">8080</span></span>/<span class="symbol">test</span>?<span class="symbol">Name</span>=<span class="symbol">Jimmy</span>'</span><br><span class="line"><span class="symbol">name: <span class="symbol">Jimmy</span></span></span><br><span class="line"><span class="symbol">class:</span></span><br></pre></td></tr></table></figure></li></ul><ol start="7"><li><code>%XX</code> 字符解码</li></ol><ul><li>可以使用第三方 ngx_set_misc 模块提供的 set_unescape_uri 配置指令：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">location /<span class="built_in">test</span> &#123;</span><br><span class="line">    set_unescape_uri <span class="variable">$name</span> <span class="variable">$arg_name</span>;</span><br><span class="line">    set_unescape_uri <span class="variable">$class</span> <span class="variable">$arg_class</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"name: <span class="variable">$name</span>"</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"class: <span class="variable">$class</span>"</span>;</span><br><span class="line">&#125;</span><br><span class="line">现在我们再看一下效果：</span><br><span class="line"></span><br><span class="line">$ curl <span class="string">'http://localhost:8080/test?name=hello%20world&amp;class=9'</span></span><br><span class="line">name: hello world</span><br><span class="line">class: 9</span><br></pre></td></tr></table></figure></li></ul><ol start="8"><li><p>内建变量都是只读的，如 <code>$uri</code> 和 <code>$request_uri</code>. 应当避免对只读变量进行赋值。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /bad &#123;</span><br><span class="line">  <span class="attribute">set</span> <span class="variable">$uri</span> /blah;</span><br><span class="line">  <span class="attribute">echo</span> <span class="variable">$uri</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">Nginx</span> 在启动的时候报出错误：</span><br><span class="line">[emerg] the duplicate <span class="string">"uri"</span> variable in ...</span><br></pre></td></tr></table></figure></li><li><p>多个同名arg变量取值</p></li></ol><ul><li>$arg_XXX 变量在请求 URL 中有多个同名 XXX 参数时，就只会返回最先出现的那个 XXX 参数的值，而默默忽略掉其他实例：<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">location /test &#123;</span><br><span class="line">    content_by_lua '</span><br><span class="line">        <span class="keyword">if</span> ngx.<span class="keyword">var</span>.arg_name == <span class="keyword">nil</span> then</span><br><span class="line">            ngx.say(<span class="string">"name: missing"</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            ngx.say(<span class="string">"name: ["</span>, ngx.<span class="keyword">var</span>.arg_name, <span class="string">"]"</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    ';</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ curl 'http://localhost:<span class="number">8080</span>/test?name=<span class="type">Tom</span>&amp;name=<span class="type">Jim</span>&amp;name=<span class="type">Bob</span>'</span><br><span class="line">name: [<span class="type">Tom</span>]</span><br><span class="line">要解决这些局限，可以直接在 <span class="type">Lua</span> 代码中使用 ngx_lua 模块提供的 ngx.req.get_uri_args 函数。</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;agentzh-nginx变量漫谈随手记&quot;&gt;&lt;a href=&quot;#agentzh-nginx变量漫谈随手记&quot; class=&quot;headerlink&quot; title=&quot;agentzh nginx变量漫谈随手记&quot;&gt;&lt;/a&gt;agentzh nginx变量漫谈随手记&lt;/h4&gt;&lt;
      
    
    </summary>
    
    
      <category term="nginx" scheme="https://www.xiemx.com/categories/nginx/"/>
    
    
      <category term="nginx" scheme="https://www.xiemx.com/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>character-varying vs character vs text</title>
    <link href="https://www.xiemx.com//2020/01/22/character-varying/"/>
    <id>https://www.xiemx.com//2020/01/22/character-varying/</id>
    <published>2020-01-22T02:52:00.000Z</published>
    <updated>2020-02-24T01:53:57.621Z</updated>
    
    <content type="html"><![CDATA[<h4 id="字符串类型"><a href="#字符串类型" class="headerlink" title="字符串类型"></a>字符串类型</h4><table><thead><tr><th>名字</th><th>描述</th></tr></thead><tbody><tr><td>character varying(n), varchar(n)</td><td>变长，有长度限制</td></tr><tr><td>character(n), char(n)</td><td>定长，不足补空白</td></tr><tr><td>text</td><td>变长，无长度限制</td></tr></tbody></table><h4 id="类型区别"><a href="#类型区别" class="headerlink" title="类型区别"></a>类型区别</h4><ul><li><p>SQL定义了两种基本的字符类型：<code>character varying(n)</code> 和<code>character(n)</code>，这里的n是一个正整数。两种类型都可以存储最多n个字符的字符串。 试图存储更长的字符串到这些类型的字段里会产生一个错误， 除非超出长度的字符都是空白，这种情况下该字符串将被截断为最大长度。</p><ul><li><p><code>varchar(n)</code>和<code>char(n)</code>分别是<code>character varying(n)</code>和<code>character(n)</code>的别名。</p></li><li><p>如果要存储的字符串比声明的长度短，类型为<code>character</code>的数值将会用空白填满； 而类型为<code>character varying</code>的数值将只是存储短些的字符串。</p></li><li><p>如果我们明确地把一个数值转换成<code>character varying(n)</code>或<code>character(n)</code>，那么超长的数值将被截断成n 个字符，且不会抛出错误。这也是SQL标准的要求。</p></li><li><p>没有声明长度的<code>character</code>等于<code>character(1)</code>, 如果不带长度使用<code>character varying</code>， 那么该类型接受任何长度的字符串。后者是PostgreSQL的扩展。</p></li><li><p>character类型的数值物理上都用空白填充到指定的长度n， 并且以这种方式存储和显示。不过，在比较两个character 类型的值时，尾随的空白不需要理会。 在空白比较重要的排序规则中，这个行为会导致意想不到的结果， 比如<code>SELECT &#39;a &#39;::CHAR(2) collate &quot;C&quot; &lt; &#39;a\n&#39;::CHAR(2)</code>返回<code>true</code>。 在将<code>character</code>值转换成其它字符串类型的时候， 它后面的空白会被删除。请注意， 在<code>character varying</code>和<code>text</code>数值里， 结尾的空白是有语意的。 并且当使用模式匹配时，如LIKE，使用正则表达式。</p></li></ul></li></ul><h4 id="官方提示"><a href="#官方提示" class="headerlink" title="官方提示"></a>官方提示</h4><ul><li><p>三种类型<strong>没有性能差别</strong>，除了当使用填充空白类型时的增加存储空间和当存储长度约束的列时一些检查存入时长度的额外的CPU周期。 某些其它的数据库系统里，character(n) 有一定的性能优势，但在PostgreSQL里没有。 事实上，character(n)通常是这三个中最慢的， 因为额外存储成本。在大多数情况下，应该使用text 或character varying。</p></li><li><p>不管怎样，允许存储的最长字符串大概是<code>1GB</code> 。允许在数据类型声明中出现的n 的最大值比这还小。修改这个行为没有什么意义，因为在多字节编码下字符和字节的数目可能差别很大。 如果你想存储没有特定上限的长字符串，那么使用text 或没有长度声明的character varying，而不要选择一个任意长度限制。</p></li></ul><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test1 (a <span class="built_in">character</span>(<span class="number">4</span>));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test1 <span class="keyword">VALUES</span> (<span class="string">'ok'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> a, <span class="keyword">char_length</span>(a) <span class="keyword">FROM</span> test1; <span class="comment">-- (1)</span></span><br><span class="line">  a   | char_length</span><br><span class="line"><span class="comment">------+-------------</span></span><br><span class="line"> ok   |           2</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test2 (b <span class="built_in">varchar</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test2 <span class="keyword">VALUES</span> (<span class="string">'ok'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test2 <span class="keyword">VALUES</span> (<span class="string">'good      '</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test2 <span class="keyword">VALUES</span> (<span class="string">'too long'</span>);</span><br><span class="line">ERROR:  value too long for type character varying(5)</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test2 <span class="keyword">VALUES</span> (<span class="string">'too long'</span>::<span class="built_in">varchar</span>(<span class="number">5</span>)); <span class="comment">-- 明确截断</span></span><br><span class="line"><span class="keyword">SELECT</span> b, <span class="keyword">char_length</span>(b) <span class="keyword">FROM</span> test2;</span><br><span class="line">   b   | char_length</span><br><span class="line"><span class="comment">-------+-------------</span></span><br><span class="line"> ok    |           2</span><br><span class="line"> good  |           5</span><br><span class="line"> too l |           5</span><br></pre></td></tr></table></figure><hr><p>postgresql字符串类型比较，参考：<br><a href="https://www.postgresql.org/docs/9.1/datatype-character.html" target="_blank" rel="noopener">https://www.postgresql.org/docs/9.1/datatype-character.html</a><br><a href="http://www.postgres.cn/docs/9.4/datatype-character.html" target="_blank" rel="noopener">http://www.postgres.cn/docs/9.4/datatype-character.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;字符串类型&quot;&gt;&lt;a href=&quot;#字符串类型&quot; class=&quot;headerlink&quot; title=&quot;字符串类型&quot;&gt;&lt;/a&gt;字符串类型&lt;/h4&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;名字&lt;/th&gt;
&lt;th&gt;描述&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;
      
    
    </summary>
    
    
      <category term="database" scheme="https://www.xiemx.com/categories/database/"/>
    
    
      <category term="database" scheme="https://www.xiemx.com/tags/database/"/>
    
      <category term="postgresql" scheme="https://www.xiemx.com/tags/postgresql/"/>
    
  </entry>
  
  <entry>
    <title>K8S QOS</title>
    <link href="https://www.xiemx.com//2020/01/22/k8s-qos/"/>
    <id>https://www.xiemx.com//2020/01/22/k8s-qos/</id>
    <published>2020-01-22T02:52:00.000Z</published>
    <updated>2020-02-25T06:16:05.532Z</updated>
    
    <content type="html"><![CDATA[<p>对于一个 pod 来说，服务质量体现在两个具体的指标：CPU 和内存。当节点上内存资源紧张时，kubernetes 会根据预先设置的不同 QoS 类别进行相应处理。</p><ul><li><p>guaranteed （有保证的）</p></li><li><p>burstable （不稳定的）</p></li><li><p>Best-Effort （尽力而为）</p><h4 id="Guaranteed"><a href="#Guaranteed" class="headerlink" title="Guaranteed"></a>Guaranteed</h4><ul><li>Pod中的所有容器都且仅设置了 CPU 和内存的 limits</li><li>pod中的所有容器都设置了 CPU 和内存的 requests 和 limits ，且单个容器内的requests==limits（requests不等于0）</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### set limit</span></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="attr"> name:</span> <span class="string">xiemx1</span></span><br><span class="line"><span class="attr">   resources:</span></span><br><span class="line"><span class="attr">     limits:</span></span><br><span class="line"><span class="attr">       cpu:</span> <span class="string">"10m"</span></span><br><span class="line"><span class="attr">       memory:</span> <span class="string">"1Gi"</span></span><br><span class="line"><span class="attr"> name:</span> <span class="string">xiemx2</span></span><br><span class="line"><span class="attr">   resources:</span></span><br><span class="line"><span class="attr">     limits:</span></span><br><span class="line"><span class="attr">       cpu:</span> <span class="string">"100m"</span></span><br><span class="line"><span class="attr">       memory:</span> <span class="string">"100Mi"</span></span><br><span class="line">       </span><br><span class="line"><span class="comment">#### request=limit</span></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="attr"> name:</span> <span class="string">xiemx1</span></span><br><span class="line"><span class="attr">   resources:</span></span><br><span class="line"><span class="attr">     limits:</span></span><br><span class="line"><span class="attr">       cpu:</span> <span class="string">"10m"</span></span><br><span class="line"><span class="attr">       memory:</span> <span class="string">"1Gi"</span></span><br><span class="line"><span class="attr">     requests:</span></span><br><span class="line"><span class="attr">       cpu:</span> <span class="string">"10m"</span></span><br><span class="line"><span class="attr">       memory:</span> <span class="string">"1Gi"</span></span><br><span class="line"></span><br><span class="line"><span class="attr"> name:</span> <span class="string">xiemx2</span></span><br><span class="line"><span class="attr">   resources:</span></span><br><span class="line"><span class="attr">     limits:</span></span><br><span class="line"><span class="attr">       cpu:</span> <span class="string">"100m"</span></span><br><span class="line"><span class="attr">       memory:</span> <span class="string">"100Mi"</span></span><br><span class="line"><span class="attr">     requests:</span></span><br><span class="line"><span class="attr">       cpu:</span> <span class="string">"100m"</span></span><br><span class="line"><span class="attr">       memory:</span> <span class="string">"100Mi"</span></span><br></pre></td></tr></table></figure><h4 id="Burstable"><a href="#Burstable" class="headerlink" title="Burstable"></a>Burstable</h4></li><li><p>pod中只要有一个容器的requests和limits的设置不相同</p></li><li><p>pod中只要有一个容器的cpu or memory 没有设置limits</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">xiemx1</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="string">"1Gi"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  name:</span> <span class="string">xiemx2</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="string">"100m"</span></span><br></pre></td></tr></table></figure><h4 id="Best-Effort"><a href="#Best-Effort" class="headerlink" title="Best-Effort"></a>Best-Effort</h4><ul><li>Pod中所有容器的resources均未设置requests与limits</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">xiemx1</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">xiemx2</span></span><br><span class="line"><span class="attr">    resources:</span></span><br></pre></td></tr></table></figure><h4 id="不同策略的QOS回收策略实现"><a href="#不同策略的QOS回收策略实现" class="headerlink" title="不同策略的QOS回收策略实现"></a>不同策略的QOS回收策略实现</h4><p>Kubernetes 通过cgroup给pod设置QoS级别，当资源不足时先kill优先级低的pod，通过OOM_ADJ参数计算分数值来实现，OOM分数值范围为0-1000。计算出来的OOM分数越高，表明该pod优先级就越低，当出现资源竞争时会越早被kill掉</p><ul><li>Guaranteed级别的 Pod，OOM_ADJ参数设置成了-998</li><li>Best-Effort级别的 Pod，OOM_ADJ参数设置成了1000</li><li>对于Burstable级别的 Pod，OOM_ADJ参数取值从2到999</li><li>kuberntes 保留资源，比如kubelet，docker，OOM_ADJ参数设置成了-999，表示不会被OOM kill掉</li></ul><h4 id="QoS-pods被kill掉场景与顺序"><a href="#QoS-pods被kill掉场景与顺序" class="headerlink" title="QoS pods被kill掉场景与顺序"></a>QoS pods被kill掉场景与顺序</h4><ul><li>Best-Effort pods：系统用完了全部内存时，该类型 pods 会最先被kill掉。</li><li>Burstable pods：系统用完了全部内存，且没有 Best-Effort 类型的容器可以被 kill 时，该类型的 pods 会被 kill 掉。</li><li>Guaranteed pods：系统用完了全部内存，且没有 Burstable 与 Best-Effort 类型的容器可以被 kill 时，该类型的 pods 会被 kill 掉。</li></ul><p>参考：<a href="https://www.qikqiak.com/post/kubernetes-qos-usage/" target="_blank" rel="noopener">https://www.qikqiak.com/post/kubernetes-qos-usage/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;对于一个 pod 来说，服务质量体现在两个具体的指标：CPU 和内存。当节点上内存资源紧张时，kubernetes 会根据预先设置的不同 QoS 类别进行相应处理。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;guaranteed （有保证的）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;bur
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="QOS" scheme="https://www.xiemx.com/tags/QOS/"/>
    
  </entry>
  
  <entry>
    <title>k8s pod lifecycle</title>
    <link href="https://www.xiemx.com//2020/01/21/k8s-pod-lifecycle/"/>
    <id>https://www.xiemx.com//2020/01/21/k8s-pod-lifecycle/</id>
    <published>2020-01-21T09:08:14.000Z</published>
    <updated>2020-01-21T09:08:08.899Z</updated>
    
    <content type="html"><![CDATA[<h4 id="pod-phase"><a href="#pod-phase" class="headerlink" title="pod phase"></a>pod phase</h4><hr><ul><li>pending:  Pod 已被 Kubernetes 系统接受，但有一个或者多个容器镜像尚未创建。等待时间包括调度 Pod 的时间和通过网络下载镜像</li><li>running: 该 Pod 已经绑定到了一个节点上，Pod 中所有的容器都已被创建。至少有一个容器正在运行，或者正处于启动或重启状态。</li><li>successed: Pod 中的所有容器都被成功终止，并且不会再重启。</li><li>Failed: Pod 中的所有容器都已终止了，并且至少有一个容器是因为失败终止。也就是说，容器以非0状态退出或者被系统终止。</li><li>unkown: 某些原因无法取得 Pod 的状态，通常是因为与 Pod 所在主机通信失败。</li></ul><h4 id="探针"><a href="#探针" class="headerlink" title="探针"></a>探针</h4><hr><ul><li><code>livenessProbe</code>：指示容器是否正在运行。如果存活探测失败，则 kubelet 会杀死容器，并且容器将受到其 <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy" target="_blank" rel="noopener">重启策略</a> 的影响。如果容器不提供存活探针，则默认状态为 <code>Success</code>。</li><li><code>readinessProbe</code>：指示容器是否准备好服务请求。如果就绪探测失败，端点控制器将从与 Pod 匹配的所有 Service 的端点中删除该 Pod 的 IP 地址。初始延迟之前的就绪状态默认为 <code>Failure</code>。如果容器不提供就绪探针，则默认状态为 <code>Success</code>。</li><li>探针支持的3种action事件<ul><li><a href="https://kubernetes.io/docs/resources-reference/v1.7/#execaction-v1-core" target="_blank" rel="noopener">ExecAction</a>：在容器内执行指定命令。如果命令退出时返回码为 0 则认为诊断成功。</li><li><a href="https://kubernetes.io/docs/resources-reference/v1.7/#tcpsocketaction-v1-core" target="_blank" rel="noopener">TCPSocketAction</a>：对指定端口上的容器的 IP 地址进行 TCP 检查。如果端口打开，则诊断被认为是成功的。</li><li><a href="https://kubernetes.io/docs/resources-reference/v1.7/#httpgetaction-v1-core" target="_blank" rel="noopener">HTTPGetAction</a>：对指定的端口和路径上的容器的 IP 地址执行 HTTP Get 请求。如果响应的状态码大于等于200 且小于 400，则诊断被认为是成功的。</li></ul></li></ul><h4 id="restart-policy"><a href="#restart-policy" class="headerlink" title="restart policy"></a>restart policy</h4><hr><ul><li>pod的spec中restartPolicy 有三种模式<pre><code>* Always* Never* OnFailure</code></pre></li><li>job 的spec中有2种<ul><li>OnFailure</li><li>Never</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;pod-phase&quot;&gt;&lt;a href=&quot;#pod-phase&quot; class=&quot;headerlink&quot; title=&quot;pod phase&quot;&gt;&lt;/a&gt;pod phase&lt;/h4&gt;&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;pending:  Pod 已被 Kubernetes 系统接
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="pod" scheme="https://www.xiemx.com/tags/pod/"/>
    
  </entry>
  
</feed>
