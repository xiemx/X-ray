<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>求索</title>
  
  <subtitle>尔不必求记，却宜求个明白！</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.xiemx.com/"/>
  <updated>2021-03-17T10:57:54.568Z</updated>
  <id>https://www.xiemx.com/</id>
  
  <author>
    <name>Mingxu.xie</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>vue axios</title>
    <link href="https://www.xiemx.com//2021/02/15/vue-axios/"/>
    <id>https://www.xiemx.com//2021/02/15/vue-axios/</id>
    <published>2021-02-15T06:01:04.000Z</published>
    <updated>2021-03-17T10:57:54.568Z</updated>
    
    <content type="html"><![CDATA[<p>vue 基础知识和用法</p><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p><img src="/images/vue-axios.jpg" alt="vue-axios"></p><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vue.JS<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;style.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue/dist/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;handlerClick&quot;</span>&gt;</span>Click<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;(value,key) in dataObj&quot;</span>&gt;</span></span><br><span class="line">                &#123;&#123; key&#125;&#125; = &#123;&#123;value&#125;&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">        el: <span class="string">&quot;#box&quot;</span>,</span></span><br><span class="line">        data: &#123;</span><br><span class="line">            dataObj: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line"><span class="javascript">            handlerClick: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                axios.get(<span class="string">&#x27;https://mockbin.org/request&#x27;</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.log(res.data.headers)</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">this</span>.dataObj = res.data</span></span><br><span class="line"><span class="javascript">                &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.error(err)</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;vue 基础知识和用法&lt;/p&gt;
&lt;h3 id=&quot;效果&quot;&gt;&lt;a href=&quot;#效果&quot; class=&quot;headerlink&quot; title=&quot;效果&quot;&gt;&lt;/a&gt;效果&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/vue-axios.jpg&quot; alt=&quot;vue-axios&quot;&gt;&lt;/
      
    
    </summary>
    
    
      <category term="vue" scheme="https://www.xiemx.com/categories/vue/"/>
    
    
      <category term="vue" scheme="https://www.xiemx.com/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>vue fetch</title>
    <link href="https://www.xiemx.com//2021/02/15/vue-fetch/"/>
    <id>https://www.xiemx.com//2021/02/15/vue-fetch/</id>
    <published>2021-02-15T06:01:04.000Z</published>
    <updated>2021-03-17T11:10:08.803Z</updated>
    
    <content type="html"><![CDATA[<p>vue 基础知识和用法</p><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p><img src="/images/vue-fetch.jpg" alt="vue"></p><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vue.JS<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;style.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue/dist/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;handlerClick&quot;</span>&gt;</span>Click<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;(value,key) in dataObj&quot;</span>&gt;</span></span><br><span class="line">                &#123;&#123; key&#125;&#125; = &#123;&#123;value&#125;&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">        el: <span class="string">&quot;#box&quot;</span>,</span></span><br><span class="line">        data: &#123;</span><br><span class="line">            dataObj: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line"><span class="javascript">            handlerClick: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                fetch(<span class="string">&#x27;https://mockbin.org/request&#x27;</span>).then(</span></span><br><span class="line"><span class="javascript">                    <span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> response.json()</span></span><br><span class="line">                    &#125;</span><br><span class="line"><span class="javascript">                ).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.log(res.headers)</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">this</span>.dataObj = res.headers</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;vue 基础知识和用法&lt;/p&gt;
&lt;h3 id=&quot;效果&quot;&gt;&lt;a href=&quot;#效果&quot; class=&quot;headerlink&quot; title=&quot;效果&quot;&gt;&lt;/a&gt;效果&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/vue-fetch.jpg&quot; alt=&quot;vue&quot;&gt;&lt;/p&gt;
&lt;h3
      
    
    </summary>
    
    
      <category term="vue" scheme="https://www.xiemx.com/categories/vue/"/>
    
    
      <category term="vue" scheme="https://www.xiemx.com/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>vue ref</title>
    <link href="https://www.xiemx.com//2021/02/15/vue-ref/"/>
    <id>https://www.xiemx.com//2021/02/15/vue-ref/</id>
    <published>2021-02-15T06:01:04.000Z</published>
    <updated>2021-03-17T11:14:13.607Z</updated>
    
    <content type="html"><![CDATA[<p>vue 通过ref 获取子组件属性</p><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p><img src="/images/vue-ref.jpg" alt="vue"></p><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vue.js ref<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;style.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue/dist/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;handlerClick&quot;</span>&gt;</span>Click<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        INPUT</span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;mytext&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        子组件</span><br><span class="line">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">ref</span>=<span class="string">&quot;mychild&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">child</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    Vue.component(<span class="string">&quot;child&quot;</span>, &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        template: `<span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span></span><br><span class="line">            </span><br><span class="line">            child 属性</span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span>`</span></span></span><br><span class="line">        ,</span><br><span class="line"><span class="javascript">        <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line">                myvalue: 123123</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">        el: <span class="string">&quot;#box&quot;</span>,</span></span><br><span class="line">        data: &#123;</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line"><span class="javascript">            <span class="function"><span class="title">handlerClick</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&quot;输入的值为：&quot;</span>, <span class="built_in">this</span>.$refs.mytext.value)</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&quot;子组件值为:&quot;</span>, <span class="built_in">this</span>.$refs.mychild.myvalue)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;vue 通过ref 获取子组件属性&lt;/p&gt;
&lt;h3 id=&quot;效果&quot;&gt;&lt;a href=&quot;#效果&quot; class=&quot;headerlink&quot; title=&quot;效果&quot;&gt;&lt;/a&gt;效果&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/vue-ref.jpg&quot; alt=&quot;vue&quot;&gt;&lt;/p&gt;
      
    
    </summary>
    
    
      <category term="vue" scheme="https://www.xiemx.com/categories/vue/"/>
    
    
      <category term="vue" scheme="https://www.xiemx.com/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>vue component slot</title>
    <link href="https://www.xiemx.com//2021/02/13/vue-slot/"/>
    <id>https://www.xiemx.com//2021/02/13/vue-slot/</id>
    <published>2021-02-13T07:01:04.000Z</published>
    <updated>2021-03-17T11:27:58.907Z</updated>
    
    <content type="html"><![CDATA[<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vue.js slot<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;style.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue/dist/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sidebar1</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;isShow=!isShow&quot;</span>&gt;</span>侧边栏<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sidebar1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sidebar2</span> <span class="attr">v-show</span>=<span class="string">&quot;isShow&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">slot</span>=<span class="string">&quot;a&quot;</span>&gt;</span>slot A <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">slot</span>=<span class="string">&quot;a&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;data in datalist&quot;</span>&gt;</span> &#123;&#123;data&#125;&#125; <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">slot</span>=<span class="string">&quot;b&quot;</span>&gt;</span>slot B <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sidebar2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="javascript">    Vue.component(<span class="string">&#x27;sidebar1&#x27;</span>, &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        template: `<span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span>`,</span></span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    Vue.component(<span class="string">&#x27;sidebar2&#x27;</span>, &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        template: `<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;background:red;width:200px&quot;</span>&gt;</span></span></span></span><br><span class="line">      </span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">&quot;a&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">&quot;b&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span>`</span></span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">        el: <span class="string">&quot;#box&quot;</span>,</span></span><br><span class="line">        data: &#123;</span><br><span class="line"><span class="javascript">            isShow: <span class="literal">false</span>,</span></span><br><span class="line">            datalist: [1111, 2222, 3333, 4444, 5555, 6666, 7777, 8888, 9999, 0000]</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;源码&quot;&gt;&lt;a href=&quot;#源码&quot; class=&quot;headerlink&quot; title=&quot;源码&quot;&gt;&lt;/a&gt;源码&lt;/h3&gt;&lt;figure class=&quot;highlight html&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span c
      
    
    </summary>
    
    
      <category term="vue" scheme="https://www.xiemx.com/categories/vue/"/>
    
    
      <category term="vue" scheme="https://www.xiemx.com/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>vue bus</title>
    <link href="https://www.xiemx.com//2021/02/13/vue-bus/"/>
    <id>https://www.xiemx.com//2021/02/13/vue-bus/</id>
    <published>2021-02-13T06:01:04.000Z</published>
    <updated>2021-03-17T11:07:39.693Z</updated>
    
    <content type="html"><![CDATA[<p>vue 基础知识和用法</p><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p><img src="/images/vue-bus.jpg" alt="vue"></p><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vue.js bus<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;style.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue/dist/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Author<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">author</span>&gt;</span><span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Subscriber<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">describe</span>&gt;</span><span class="tag">&lt;/<span class="name">describe</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> bus = <span class="keyword">new</span> Vue()</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    Vue.component(<span class="string">&quot;author&quot;</span>, &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        template: `<span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;mytext&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;handlerClick&quot;</span>&gt;</span>发布<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span>`</span></span></span><br><span class="line">        ,</span><br><span class="line">        methods: &#123;</span><br><span class="line"><span class="javascript">            <span class="function"><span class="title">handlerClick</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&quot;发布文章&quot;</span>, <span class="built_in">this</span>.$refs.mytext.value)</span></span><br><span class="line"><span class="javascript">                bus.$emit(<span class="string">&quot;t-message&quot;</span>, <span class="built_in">this</span>.$refs.mytext.value)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    Vue.component(<span class="string">&#x27;describe&#x27;</span>, &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        template: `<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;background:red;width=200px&quot;</span>&gt;</span></span></span></span><br><span class="line">            订阅者</span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span>`</span></span></span><br><span class="line">        ,</span><br><span class="line"><span class="javascript">        <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">            bus.$on(<span class="string">&quot;t-message&quot;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&quot;收到文章&quot;</span>, data)</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">        el: <span class="string">&quot;#box&quot;</span>,</span></span><br><span class="line">        data: &#123;</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;vue 基础知识和用法&lt;/p&gt;
&lt;h3 id=&quot;效果&quot;&gt;&lt;a href=&quot;#效果&quot; class=&quot;headerlink&quot; title=&quot;效果&quot;&gt;&lt;/a&gt;效果&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/vue-bus.jpg&quot; alt=&quot;vue&quot;&gt;&lt;/p&gt;
&lt;h3 i
      
    
    </summary>
    
    
      <category term="vue" scheme="https://www.xiemx.com/categories/vue/"/>
    
    
      <category term="vue" scheme="https://www.xiemx.com/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>vue component</title>
    <link href="https://www.xiemx.com//2021/02/13/vue-component/"/>
    <id>https://www.xiemx.com//2021/02/13/vue-component/</id>
    <published>2021-02-13T06:01:04.000Z</published>
    <updated>2021-03-17T11:27:30.781Z</updated>
    
    <content type="html"><![CDATA[<p>vue componet</p><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p><img src="/images/vue-component.jpg" alt="vue"></p><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vue.js 组件<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;style.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue/dist/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navbar</span>&gt;</span><span class="tag">&lt;/<span class="name">navbar</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">v-show</span>=<span class="string">&quot;isShow&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">child</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>动态传值 -- 父传子（属性）<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">:name</span>=<span class="string">&quot;myname&quot;</span> <span class="attr">:isshow</span>=<span class="string">&quot;isShow&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">child</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">:name</span>=<span class="string">&quot;myname&quot;</span> <span class="attr">:isshow</span>=<span class="string">&quot;false&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">child</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">:name</span>=<span class="string">&quot;myname&quot;</span> <span class="attr">:isshow</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">child</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;child :name=&quot;myname&quot; isshow=&quot;false&quot;&gt;&lt;/child&gt; --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;navbarChild&gt;&lt;/navbarChild&gt; --&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>动态传值 -- 子传父（事件）<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        //$event 传参数为固定写法</span><br><span class="line">        <span class="tag">&lt;<span class="name">child</span> @<span class="attr">myevent</span>=<span class="string">&quot;handlerEvent($event)&quot;</span> <span class="attr">name</span>=<span class="string">&quot;付款&quot;</span> <span class="attr">:isshow</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">child</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>example<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sidebar1</span> @<span class="attr">sidebar-event</span>=<span class="string">&quot;handlerSEvent&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sidebar1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sidebar2</span> <span class="attr">v-show</span>=<span class="string">isShow</span>&gt;</span><span class="tag">&lt;/<span class="name">sidebar2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    Vue.component(<span class="string">&quot;navbar&quot;</span>, &#123;</span></span><br><span class="line">        template: `</span><br><span class="line"><span class="handlebars"><span class="xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span> </span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&#x27;handlerClick&#x27;</span>&gt;</span>Newer<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">button</span>&gt;</span>Older<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">child</span>&gt;</span><span class="tag">&lt;/<span class="name">child</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">navbarChild</span>&gt;</span><span class="tag">&lt;/<span class="name">navbarChild</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span>`,</span></span></span><br><span class="line">        components: &#123;</span><br><span class="line"><span class="javascript">            <span class="comment">// 内部组件</span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            navbarChild: &#123; template: `<span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">button</span>&gt;</span>navbar child 内部组件<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>` &#125;</span></span></span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line"><span class="javascript">            <span class="function"><span class="title">handlerClick</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&#x27;narvar&#x27;</span>)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="comment">// 全局组件</span></span></span><br><span class="line"><span class="javascript">    Vue.component(<span class="string">&quot;child&quot;</span>, &#123;</span></span><br><span class="line">        template: `</span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">button</span>&gt;</span>Child 全局组件 -- </span><span class="template-variable">&#123;&#123;<span class="name">name</span>&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">v-show</span>=<span class="string">&quot;isshow&quot;</span>&gt;</span> isShow-- </span><span class="template-variable">&#123;&#123;<span class="name">isshow</span>&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">v-show</span>=<span class="string">&quot;isshow&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;handlerClick&quot;</span>&gt;</span> 付款 <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span></span><br><span class="line">            `,</span><br><span class="line"><span class="javascript">        <span class="comment">// props: [&quot;name&quot;, &quot;isshow&quot;],   </span></span></span><br><span class="line">        props: &#123;</span><br><span class="line"><span class="javascript">            name: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">            isshow: <span class="built_in">Boolean</span>,</span></span><br><span class="line"><span class="javascript">            t: <span class="literal">null</span>    <span class="comment">// null 表示不限制</span></span></span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line"><span class="javascript">            <span class="function"><span class="title">handlerClick</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="built_in">this</span>.count)</span></span><br><span class="line"><span class="javascript">                <span class="built_in">this</span>.$emit(<span class="string">&quot;myevent&quot;</span>, <span class="built_in">this</span>.count)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line"><span class="javascript">        <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line">                count: 100</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="javascript">    Vue.component(<span class="string">&#x27;sidebar1&#x27;</span>, &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        template: `<span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;handlerSClick&quot;</span>&gt;</span> 侧边栏 <span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>`,</span></span></span><br><span class="line">        methods: &#123;</span><br><span class="line"><span class="javascript">            <span class="function"><span class="title">handlerSClick</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">this</span>.$emit(<span class="string">&quot;sidebar-event&quot;</span>)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    Vue.component(<span class="string">&#x27;sidebar2&#x27;</span>, &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        template: `<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;background:red;width:200px&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">li</span>&gt;</span> 11111 <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">li</span>&gt;</span> 11111 <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">li</span>&gt;</span> 11111 <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">li</span>&gt;</span> 11111 <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">li</span>&gt;</span> 11111 <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">li</span>&gt;</span> 11111 <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span>     </span></span></span><br><span class="line"><span class="handlebars"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span>`</span></span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">        el: <span class="string">&quot;#box&quot;</span>,</span></span><br><span class="line">        data: &#123;</span><br><span class="line"><span class="javascript">            myname: <span class="string">&#x27;XXXX&#x27;</span>,</span></span><br><span class="line"><span class="javascript">            isShow: <span class="literal">false</span></span></span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line"><span class="javascript">            <span class="function"><span class="title">handlerEvent</span>(<span class="params">ev</span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&#x27;收到付款:&#x27;</span>, ev)</span></span><br><span class="line">            &#125;,</span><br><span class="line"><span class="javascript">            <span class="function"><span class="title">handlerSEvent</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">this</span>.isShow = !<span class="built_in">this</span>.isShow</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;vue componet&lt;/p&gt;
&lt;h3 id=&quot;效果&quot;&gt;&lt;a href=&quot;#效果&quot; class=&quot;headerlink&quot; title=&quot;效果&quot;&gt;&lt;/a&gt;效果&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/vue-component.jpg&quot; alt=&quot;vue&quot;&gt;&lt;/p
      
    
    </summary>
    
    
      <category term="vue" scheme="https://www.xiemx.com/categories/vue/"/>
    
    
      <category term="vue" scheme="https://www.xiemx.com/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>vue keepalived</title>
    <link href="https://www.xiemx.com//2021/02/13/vue-keepalived/"/>
    <id>https://www.xiemx.com//2021/02/13/vue-keepalived/</id>
    <published>2021-02-13T06:01:04.000Z</published>
    <updated>2021-03-17T11:24:41.482Z</updated>
    
    <content type="html"><![CDATA[<p>vue 使用keepalived 避免组件被销毁，在内存中可保持数据</p><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vue.js 组件<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;style.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue/dist/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;whoami=&#x27;page1&#x27;&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;whoami=&#x27;page2&#x27;&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;whoami=&#x27;page3&#x27;&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--  keep-alive 保持组件，避免重复渲染 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">keep-alive</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--  component is属性 动态渲染组件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;whoami&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">        el: <span class="string">&quot;#box&quot;</span>,</span></span><br><span class="line">        data: &#123;</span><br><span class="line"><span class="javascript">            whoami: <span class="string">&#x27;page1&#x27;</span>,</span></span><br><span class="line">        &#125;,</span><br><span class="line">        components: &#123;</span><br><span class="line"><span class="handlebars"><span class="xml">            &quot;page1&quot;: &#123; template: `<span class="tag">&lt;<span class="name">div</span>&gt;</span> page1 <span class="tag">&lt;/<span class="name">br</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span>&gt;</span>` &#125;,</span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            &quot;page2&quot;: &#123; template: `<span class="tag">&lt;<span class="name">div</span>&gt;</span> page2 <span class="tag">&lt;/<span class="name">br</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span>&gt;</span>` &#125;,</span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            &quot;page3&quot;: &#123; template: `<span class="tag">&lt;<span class="name">div</span>&gt;</span> page3 <span class="tag">&lt;/<span class="name">br</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span>&gt;</span>` &#125;</span></span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;vue 使用keepalived 避免组件被销毁，在内存中可保持数据&lt;/p&gt;
&lt;h3 id=&quot;源码&quot;&gt;&lt;a href=&quot;#源码&quot; class=&quot;headerlink&quot; title=&quot;源码&quot;&gt;&lt;/a&gt;源码&lt;/h3&gt;&lt;figure class=&quot;highlight html&quot;&gt;
      
    
    </summary>
    
    
      <category term="vue" scheme="https://www.xiemx.com/categories/vue/"/>
    
    
      <category term="vue" scheme="https://www.xiemx.com/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>vue 计算属性</title>
    <link href="https://www.xiemx.com//2021/02/12/vue-computed/"/>
    <id>https://www.xiemx.com//2021/02/12/vue-computed/</id>
    <published>2021-02-12T06:01:04.000Z</published>
    <updated>2021-03-17T11:07:28.293Z</updated>
    
    <content type="html"><![CDATA[<p>vue 方法会每次重新计算， computed会复用结果，见图调用次数</p><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p><img src="/images/vue-computed.jpg" alt="vues"></p><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vue.JS<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;style.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue/dist/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>方法：&#123;&#123;getName&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>计算属性：&#123;&#123;getNameMethods()&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>-----------------<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>方法：&#123;&#123;getName&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>计算属性：&#123;&#123;getNameMethods()&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">        el: <span class="string">&quot;#box&quot;</span>,</span></span><br><span class="line">        data: &#123;</span><br><span class="line">            x: 1</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line"><span class="javascript">            <span class="function"><span class="title">getNameMethods</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&quot;Methods&quot;</span>)</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> <span class="string">&#x27;123&#x27;</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        computed: &#123;</span><br><span class="line"><span class="javascript">            <span class="function"><span class="title">getName</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&#x27;computed&#x27;</span>)</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> <span class="string">&#x27;123&#x27;</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;vue 方法会每次重新计算， computed会复用结果，见图调用次数&lt;/p&gt;
&lt;h3 id=&quot;效果&quot;&gt;&lt;a href=&quot;#效果&quot; class=&quot;headerlink&quot; title=&quot;效果&quot;&gt;&lt;/a&gt;效果&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/vue-compu
      
    
    </summary>
    
    
      <category term="vue" scheme="https://www.xiemx.com/categories/vue/"/>
    
    
      <category term="vue" scheme="https://www.xiemx.com/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>vue v-bind等基础用法</title>
    <link href="https://www.xiemx.com//2021/02/10/vue-notebook-1/"/>
    <id>https://www.xiemx.com//2021/02/10/vue-notebook-1/</id>
    <published>2021-02-10T02:01:04.000Z</published>
    <updated>2021-03-17T10:53:10.295Z</updated>
    
    <content type="html"><![CDATA[<p>vue 基础知识和用法</p><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p><img src="/images/vue-note-1.jpg" alt="vue-note-1"></p><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Vue.js<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;style.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue/dist/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">:class</span>=<span class="string">&quot;isActive?&#x27;red&#x27;:&#x27;yellow&#x27;&quot;</span>&gt;</span>三目<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">:class</span>=<span class="string">&quot;classArr&quot;</span>&gt;</span>array<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">:class</span>=<span class="string">&quot;classObj&quot;</span>&gt;</span>object<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">:style</span>=<span class="string">&quot;&#x27;background:&#x27; + (isActive?&#x27;red&#x27;:&#x27;blue&#x27;)&quot;</span>&gt;</span>三目<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">:style</span>=<span class="string">&quot;styleObj&quot;</span>&gt;</span>object<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">:style</span>=<span class="string">&quot;styleArr&quot;</span>&gt;</span>array<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-bind:title</span>=<span class="string">&quot;message&quot;</span>&gt;</span></span><br><span class="line">            鼠标悬停几秒钟查看此处动态绑定的提示信息！</span><br><span class="line">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-html</span>=<span class="string">&quot;html&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-show</span>=<span class="string">&quot;isShow&quot;</span>&gt;</span>v-show<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">&quot;isCreated&quot;</span>&gt;</span>v-if<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else</span>&gt;</span>v-else<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">v-if</span>=<span class="string">&quot;datalist.length&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;data in datalist&quot;</span>&gt;</span> &#123;&#123;data&#125;&#125; <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-else</span>&gt;</span> empty datalist<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;handlerClick&quot;</span>&gt;</span>Click<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;(data, index) in dataArr&quot;</span>&gt;</span></span><br><span class="line">                    &#123;&#123;data&#125;&#125; -- &#123;&#123;index&#125;&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;(vaule, key) in dataObj&quot;</span>&gt;</span></span><br><span class="line">                    &#123;&#123;key&#125;&#125; -- &#123;&#123;vaule&#125;&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>按键触发:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> @<span class="attr">keyup.enter</span>=<span class="string">&quot;handlerInput&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;filtertext&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>事件触发:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> @<span class="attr">input</span>=<span class="string">&quot;handlerInput&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;filtertext&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>焦点触发:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> @<span class="attr">change</span>=<span class="string">&quot;handlerInput&quot;</span> <span class="attr">v-model.lazy</span>=<span class="string">&quot;filtertext&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;item in filterlist&quot;</span>&gt;</span></span><br><span class="line">                    &#123;&#123;item&#125;&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> @<span class="attr">click</span>=<span class="string">&quot;handlerUlClick&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> @<span class="attr">click.stop</span>=<span class="string">&quot;handlerLiClick&quot;</span>&gt;</span>Stop<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click.once</span>=<span class="string">&quot;handlerLiClick&quot;</span>&gt;</span>Once<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;isRemember&quot;</span> <span class="attr">value</span>=<span class="string">&quot;isRemember&quot;</span>&gt;</span>Remember me</span><br><span class="line">            <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">            &#123;&#123;langs&#125;&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">checkbox</span> <span class="attr">v-model</span>=<span class="string">&quot;langs&quot;</span> <span class="attr">value</span>=<span class="string">&quot;python&quot;</span>&gt;</span> python</span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">checkbox</span> <span class="attr">v-model</span>=<span class="string">&quot;langs&quot;</span> <span class="attr">value</span>=<span class="string">&quot;java&quot;</span>&gt;</span> java</span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">checkbox</span> <span class="attr">v-model</span>=<span class="string">&quot;langs&quot;</span> <span class="attr">value</span>=<span class="string">&quot;golang&quot;</span>&gt;</span> golang</span><br><span class="line">            <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">            &#123;&#123;fruit&#125;&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;fruit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;apple&quot;</span>&gt;</span> apple</span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;fruit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;banana&quot;</span>&gt;</span> banana</span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;fruit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;pear&quot;</span>&gt;</span> pear</span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        购物车：</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> @<span class="attr">change</span>=<span class="string">&quot;handlerChange&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;isAll&quot;</span>&gt;</span>全选<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;product in products&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;checkoutPrices&quot;</span> <span class="attr">:value</span>=<span class="string">&quot;product&quot;</span></span></span><br><span class="line"><span class="tag">                        @<span class="attr">change</span>=<span class="string">&quot;handlerliChange&quot;</span>&gt;</span>&#123;&#123;product.name&#125;&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;handlerDelClick(product)&quot;</span>&gt;</span>Del<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    &#123;&#123;product.number&#125;&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;product.number++&quot;</span>&gt;</span>Add<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;&#123;checkoutPrices&#125;&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>总金额：&#123;&#123; getSum() &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">        el: <span class="string">&quot;#box&quot;</span>,</span></span><br><span class="line">        data: &#123;</span><br><span class="line"><span class="javascript">            message: <span class="string">&quot;123123&quot;</span>,</span></span><br><span class="line"><span class="handlebars"><span class="xml">            html: &quot;<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">#</span>&gt;</span>super man<span class="tag">&lt;/<span class="name">a</span>&gt;</span>&quot;,</span></span></span><br><span class="line"><span class="javascript">            isShow: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">            isCreated: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">            isActive: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">            isRemember: <span class="literal">false</span>,</span></span><br><span class="line">            classObj: &#123;</span><br><span class="line"><span class="javascript">                <span class="string">&quot;red&quot;</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">                <span class="string">&quot;yellow&quot;</span>: <span class="literal">true</span>,</span></span><br><span class="line">            &#125;,</span><br><span class="line"><span class="javascript">            classArr: [<span class="string">&quot;red&quot;</span>, <span class="string">&quot;yellow&quot;</span>],</span></span><br><span class="line">            styleObj: &#123;</span><br><span class="line"><span class="javascript">                background: <span class="string">&quot;red&quot;</span></span></span><br><span class="line">            &#125;,</span><br><span class="line"><span class="javascript">            styleArr: [&#123; <span class="attr">background</span>: <span class="string">&quot;blue&quot;</span> &#125;, &#123; <span class="attr">fontSize</span>: <span class="string">&quot;40px&quot;</span> &#125;],</span></span><br><span class="line">            datalist: [],</span><br><span class="line"><span class="javascript">            dataArr: [<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>],</span></span><br><span class="line">            dataObj: &#123;</span><br><span class="line"><span class="javascript">                keyA: <span class="string">&quot;vauleA&quot;</span>,</span></span><br><span class="line"><span class="javascript">                keyB: <span class="string">&quot;vauleB&quot;</span>,</span></span><br><span class="line"><span class="javascript">                keyC: <span class="string">&quot;vauleC&quot;</span></span></span><br><span class="line">            &#125;,</span><br><span class="line"><span class="javascript">            filtertext: <span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="javascript">            filterlist: [<span class="string">&#x27;apple&#x27;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;bear&quot;</span>, <span class="string">&quot;able&quot;</span>, <span class="string">&quot;application&quot;</span>],</span></span><br><span class="line"><span class="javascript">            list: [<span class="string">&#x27;apple&#x27;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;bear&quot;</span>, <span class="string">&quot;able&quot;</span>, <span class="string">&quot;application&quot;</span>],</span></span><br><span class="line">            langs: [],</span><br><span class="line"><span class="javascript">            fruit: <span class="string">&quot;&quot;</span>,</span></span><br><span class="line">            products: [</span><br><span class="line"><span class="javascript">                &#123; <span class="attr">name</span>: <span class="string">&quot;A&quot;</span>, <span class="attr">price</span>: <span class="number">1</span>, <span class="attr">number</span>: <span class="number">2</span>, <span class="attr">id</span>: <span class="number">1</span> &#125;,</span></span><br><span class="line"><span class="javascript">                &#123; <span class="attr">name</span>: <span class="string">&quot;B&quot;</span>, <span class="attr">price</span>: <span class="number">1.1</span>, <span class="attr">number</span>: <span class="number">3</span>, <span class="attr">id</span>: <span class="number">2</span> &#125;,</span></span><br><span class="line"><span class="javascript">                &#123; <span class="attr">name</span>: <span class="string">&quot;C&quot;</span>, <span class="attr">price</span>: <span class="number">1.2</span>, <span class="attr">number</span>: <span class="number">2</span>, <span class="attr">id</span>: <span class="number">3</span> &#125;,</span></span><br><span class="line"><span class="javascript">                &#123; <span class="attr">name</span>: <span class="string">&quot;D&quot;</span>, <span class="attr">price</span>: <span class="number">2</span>, <span class="attr">number</span>: <span class="number">1</span>, <span class="attr">id</span>: <span class="number">4</span> &#125;,</span></span><br><span class="line">            ],</span><br><span class="line">            checkoutPrices: [],</span><br><span class="line"><span class="javascript">            isAll: <span class="literal">false</span></span></span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line"><span class="javascript">            handlerClick: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">this</span>.isCreated = !<span class="built_in">this</span>.isCreated</span></span><br><span class="line"><span class="javascript">                <span class="built_in">this</span>.datalist = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span></span><br><span class="line">            &#125;,</span><br><span class="line"><span class="javascript">            handlerInput: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">this</span>.filterlist = <span class="built_in">this</span>.list.filter(<span class="function"><span class="params">item</span> =&gt;</span> !item.indexOf(<span class="built_in">this</span>.filtertext))</span></span><br><span class="line">            &#125;,</span><br><span class="line"><span class="javascript">            handlerUlClick: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&quot;ul click&quot;</span>)</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(event)</span></span><br><span class="line">            &#125;,</span><br><span class="line"><span class="javascript">            handlerLiClick: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// event.stopPropagation()</span></span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&quot;li click&quot;</span>)</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(event)</span></span><br><span class="line">            &#125;,</span><br><span class="line"><span class="javascript">            getSum: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> sum = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> <span class="built_in">this</span>.checkoutPrices) &#123;</span></span><br><span class="line"><span class="javascript">                    sum += <span class="built_in">this</span>.checkoutPrices[i].number * <span class="built_in">this</span>.checkoutPrices[i].price</span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> sum</span></span><br><span class="line">            &#125;,</span><br><span class="line"><span class="javascript">            handlerChange: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (<span class="built_in">this</span>.isAll) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">this</span>.checkoutPrices = <span class="built_in">this</span>.products</span></span><br><span class="line"><span class="javascript">                &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">this</span>.checkoutPrices = []</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line"><span class="javascript">            handlerliChange: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (<span class="built_in">this</span>.checkoutPrices.length == <span class="built_in">this</span>.products.length) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">this</span>.isAll = <span class="literal">true</span></span></span><br><span class="line"><span class="javascript">                &#125; <span class="keyword">else</span> &#123; <span class="built_in">this</span>.isAll = <span class="literal">false</span> &#125;</span></span><br><span class="line">            &#125;,</span><br><span class="line"><span class="javascript">            handlerDelClick: <span class="function"><span class="keyword">function</span> (<span class="params">product</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(product)</span></span><br><span class="line">                product.number--</span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (product.number &lt;= <span class="number">0</span>) &#123;</span></span><br><span class="line">                    product.number = 0</span><br><span class="line"><span class="javascript">                    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> <span class="built_in">this</span>.checkoutPrices) &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span> (<span class="built_in">this</span>.checkoutPrices[i].id === product.id) &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="built_in">this</span>.checkoutPrices.splice(i, <span class="number">1</span>)</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;vue 基础知识和用法&lt;/p&gt;
&lt;h3 id=&quot;效果&quot;&gt;&lt;a href=&quot;#效果&quot; class=&quot;headerlink&quot; title=&quot;效果&quot;&gt;&lt;/a&gt;效果&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/vue-note-1.jpg&quot; alt=&quot;vue-note-1&quot;&gt;
      
    
    </summary>
    
    
      <category term="vue" scheme="https://www.xiemx.com/categories/vue/"/>
    
    
      <category term="vue" scheme="https://www.xiemx.com/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>alicloud k8s 日志接入 sls</title>
    <link href="https://www.xiemx.com//2020/12/17/aliyun-ack-sls/"/>
    <id>https://www.xiemx.com//2020/12/17/aliyun-ack-sls/</id>
    <published>2020-12-17T02:01:04.000Z</published>
    <updated>2020-12-25T07:39:21.804Z</updated>
    
    <content type="html"><![CDATA[<h2 id="采集原理"><a href="#采集原理" class="headerlink" title="采集原理"></a>采集原理</h2><p>通过 DaemonSet 模式在每个 node 上运行 logtail client，客户端启动后加入指定 machine-group，通过 docker.sock 与 ecs 上的 docker daemon 通讯，通过检索 container 环境变量来查找符合采集规则的 container，以及定位内部文件和容器 stdout 日志，在通过监听内核 inotify 事件来进行日志文件变化监听。 </p><h2 id="Pod-日志接入模式（环境变量注入）"><a href="#Pod-日志接入模式（环境变量注入）" class="headerlink" title="Pod 日志接入模式（环境变量注入）"></a>Pod 日志接入模式（环境变量注入）</h2><p>通过在pod中注入环境变量aliyun_logs_{key} 来接入aliyun SLS日志系统，如未指定project 则使用在DaemonSet 模式默认部署的 logtail 默认配置。</p><h2 id="logtail-ds-configMap"><a href="#logtail-ds-configMap" class="headerlink" title="logtail-ds configMap"></a>logtail-ds configMap</h2><p>采集插件安装不再赘述</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">cpu-core-limit:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">  <span class="attr">log-ali-uid:</span> <span class="string">&quot;163139xxxxxxxx497&quot;</span></span><br><span class="line">  <span class="attr">log-config-path:</span> <span class="string">/etc/ilogtail/conf/cn-hangzhou/ilogtail_config.json</span></span><br><span class="line">  <span class="attr">log-endpoint:</span> <span class="string">cn-hangzhou-intranet.log.aliyuncs.com</span></span><br><span class="line">  <span class="attr">log-machine-group:</span> <span class="string">k8s-group-cbe7f0d404866409exxxxxxcefeda</span></span><br><span class="line">  <span class="attr">log-project:</span> <span class="string">k8s-log-c79a7ce35db39488xxxxxx9432e53e6</span></span><br><span class="line">  <span class="attr">max-bytes-per-sec:</span> <span class="string">&quot;209715200&quot;</span></span><br><span class="line">  <span class="attr">mem-limit:</span> <span class="string">&quot;512&quot;</span></span><br><span class="line">  <span class="attr">send-requests-concurrency:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alibaba-log-configuration</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure><h2 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h2><table><thead><tr><th>支持的环境变量</th><th></th><th></th></tr></thead><tbody><tr><td>aliyun_logs_{key}</td><td>必选项。{key}只能包含小写字母、数字和-。若不存在aliyun_logs_{key}_logstore，则默认创建并采集到名为{key}的logstore。当值为stdout表示采集容器的标准输出；其他值为容器内的日志路径。</td><td>默认采集方式为极简模式, {key}需保持在K8s集群内唯一。</td></tr><tr><td>aliyun_logs_{key}_tags</td><td>可选。值为{tag-key}={tag-value}类型，用于对日志进行标识。</td><td>-</td></tr><tr><td>aliyun_logs_{key}_project</td><td>可选。值为指定的日志服务Project。当不存在该环境变量时为您安装时所选的Project。</td><td>Project需与您的Logtail工作所在Region一致。</td></tr><tr><td>aliyun_logs_{key}_logstore</td><td>可选。值为指定的日志服务Logstore。当不存在该环境变量时Logstore和{key}一致。</td><td>-</td></tr><tr><td>aliyun_logs_{key}_shard</td><td>可选。值为创建Logstore时的shard数，有效值为1~10。当不存在该环境变量时值为2。</td><td>-</td></tr><tr><td>aliyun_logs_{key}_ttl</td><td>可选。值为指定的日志保存时间，有效值为1~3650。当取值为3650时，指定日志的保存时间为永久保存。当不存在该环境变量时，默认指定日志的保存时间为90天。</td><td>-</td></tr><tr><td>aliyun_logs_{key}_machinegroup</td><td>可选。值为应用的机器组。当不存在该环境变量时与安装Logtail的默认机器组一致。</td><td>-</td></tr></tbody></table><hr><h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><h3 id="Step1"><a href="#Step1" class="headerlink" title="Step1"></a>Step1</h3><p>  创建测试容器，并注入环境变量</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">template:</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/instance:</span> <span class="string">xiemx-training</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">xiemx-training</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">aliyun_logs_xiemx-training-stdout-log</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">stdout</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.16.0</span></span><br></pre></td></tr></table></figure><h3 id="Step-2"><a href="#Step-2" class="headerlink" title="Step 2"></a>Step 2</h3><p>此时阿里云SLS日志服务中即会创建logStore，默认 logtail 为极简模式，日志未进行解析。</p><div align=center><img src="/images/ali-sls-logstore.png"></div><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;inputs&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;detail&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;IncludeEnv&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;aliyun_logs_xiemx-training-stdout-log&quot;</span>: <span class="string">&quot;stdout&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;Stderr&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">&quot;Stdout&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;service_docker_stdout&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Step-3"><a href="#Step-3" class="headerlink" title="Step 3"></a>Step 3</h3><p>进行日志拆分极细，aliyun支持多种解析插件，当前使用自定义的正则来演示，logtail 配置如下。<br>插件可参考：<a href="https://help.aliyun.com/document_detail/64957.html?spm=a2c4g.11186623.6.640.60a31de3orfOsD">https://help.aliyun.com/document_detail/64957.html?spm=a2c4g.11186623.6.640.60a31de3orfOsD</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;inputs&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;detail&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;IncludeEnv&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;aliyun_logs_xiemx-training-stdout-log&quot;</span>: <span class="string">&quot;stdout&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;Stderr&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">&quot;Stdout&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;service_docker_stdout&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;processors&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;detail&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;KeepSource&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">&quot;NoMatchError&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">&quot;Keys&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;remote_addr&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;time&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;http_method&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;request_uri&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;status_code&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;body_bytes_sent&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;http_referer&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;user_agent&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;http_x_forwarded_for&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">&quot;SourceKey&quot;</span>: <span class="string">&quot;content&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;Regex&quot;</span>: <span class="string">&quot;(\\S+) \\S+ \\S+ \\[(\\S+) \\S+\\] \&quot;([A-Z]+) (.*)\&quot; (\\d+) (\\S+) \&quot;(\\S+)\&quot; \&quot;(.*)\&quot; \&quot;(.*)\&quot;&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;NoKeyError&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;processor_regex&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要注意：当使用 regex 进行分组时，请务必不要使用 <code>(()())</code> 类似嵌套表达式会导致日志解析结果和 Key 对应关系错乱，日志数据混乱。如下例子：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((<span class="symbol">\d</span>+<span class="symbol">\.</span>)&#123;3&#125;(<span class="symbol">\d</span>+))  --替换-&gt; (<span class="symbol">\S</span>+)</span><br></pre></td></tr></table></figure><h3 id="Step-4"><a href="#Step-4" class="headerlink" title="Step 4"></a>Step 4</h3><p>此时如果正则解析无问题的情况下即可查看刀拆分后的日志，如没有查看刀拆分的日志，可点击诊断按钮查看客户端错误进行debug。</p><div align=center><img src="/images/ali-sls-search.png"></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;采集原理&quot;&gt;&lt;a href=&quot;#采集原理&quot; class=&quot;headerlink&quot; title=&quot;采集原理&quot;&gt;&lt;/a&gt;采集原理&lt;/h2&gt;&lt;p&gt;通过 DaemonSet 模式在每个 node 上运行 logtail client，客户端启动后加入指定 machine-
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="aliyun" scheme="https://www.xiemx.com/tags/aliyun/"/>
    
  </entry>
  
  <entry>
    <title>Ingress Controller V2 TargetGroupBinding使用方法</title>
    <link href="https://www.xiemx.com//2020/12/03/aws-targetgroupbinding/"/>
    <id>https://www.xiemx.com//2020/12/03/aws-targetgroupbinding/</id>
    <published>2020-12-03T02:52:00.000Z</published>
    <updated>2020-12-14T06:37:28.240Z</updated>
    
    <content type="html"><![CDATA[<p>Ingress Controller V2 TargetGroupBinding使用方法 场景<br>实现EC2到EKS的平滑过渡，想在暴露EKS Ingress的时候使用原来给EC2使用的ALB，因此可以使用Ingress Controller V2版本的TargetGroupBinding新功能。<br>Demo步骤</p><ul><li>安装ALBIngressControllerv2版本, 或将v1版本迁移至v2 <ul><li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/guide/controller/installation/">https://kubernetes-sigs.github.io/aws-load-balancer-controller/guide/controller/installation/</a></li><li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/guide/upgrade/migrate_v1_v2/">https://kubernetes-sigs.github.io/aws-load-balancer-controller/guide/upgrade/migrate_v1_v2/</a></li></ul></li><li>创建一个新的targetgroup，并记录下arn，后续要把该arn写到TargetGroupBinding的CR当中</li><li>在alb上配置到目标组的路由策略<ul><li><img src="/images/aws-tgbinding.jpg" alt="tgbinding-rule"></li></ul></li><li>赋予nodegroup上的iam role能够注册到目标组的权限</li><li>创建ns/deployment/services<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wormhole</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">wormhole</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="number">600</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">wormhole</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">wormhole</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">wormhole</span></span><br><span class="line">        <span class="attr">service:</span> <span class="string">wormhole</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">envFrom:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">wormhole</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">wormhole</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http-web</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">https-web</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">node.kubernetes.io/service-type:</span> <span class="string">product</span></span><br><span class="line">        <span class="attr">node.kubernetes.io/workload-type:</span> <span class="string">stateless</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wormhole-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Local</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">http-web</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">https-web</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wormhole</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure></li><li>service暴露完成之后，不再需要创建ingress了，直接和targetgroup进行绑定，（kubectl logs aws-load-balancer-controller-xxx -f -n kube-system可查看是否发生错误)，注册到目标组的方式通过targetType来指定，支持ip与instance两种方式，绑定后，实例或ip会自动注册到目标组中<ul><li><pre><code class="yaml"><span class="attr">apiVersion:</span> <span class="string">elbv2.k8s.aws/v1alpha1</span><span class="attr">kind:</span> <span class="string">TargetGroupBinding</span><span class="attr">metadata:</span> <span class="attr">  name:</span> <span class="string">wormhole-tg-bind</span><span class="attr">spec:</span><span class="attr">  targetType:</span> <span class="string">instance</span><span class="attr">serviceRef:</span><span class="attr">  name:</span> <span class="string">wormhole-svc</span><span class="attr">  port:</span> <span class="number">80</span><span class="attr">targetGroupArn:</span> <span class="attr">arn:aws:elasticloadbalancer:xxxxxx:xxxxxxxx:targetgroup/tg-bind</span></code></pre></li><li><img src="/images/aws-tgbinding-ec2.jpg" alt="aws-tgbinding-ec2"></li></ul></li></ul><hr><p><strong>注意</strong></p><ul><li>和一般的ingress不同，路由策略要在alb侦听器上自行编辑</li><li>实例端口也不会自动在安全组中开放，需要在node使用的安全组上自行打开 </li><li>node需要有足够的权限注册到目标组中</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Ingress Controller V2 TargetGroupBinding使用方法 场景&lt;br&gt;实现EC2到EKS的平滑过渡，想在暴露EKS Ingress的时候使用原来给EC2使用的ALB，因此可以使用Ingress Controller V2版本的TargetGr
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>k8s services iptables规则探究</title>
    <link href="https://www.xiemx.com//2020/12/03/k8s-services-iptables/"/>
    <id>https://www.xiemx.com//2020/12/03/k8s-services-iptables/</id>
    <published>2020-12-03T02:52:00.000Z</published>
    <updated>2020-12-14T06:37:28.245Z</updated>
    
    <content type="html"><![CDATA[<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>本文只讨论iptables的services实现，ipvs实现有所不同，这里先说结论如下：</p><ul><li>service 使用iptables 来进行pod的dnat，services本身只是一条虚拟的iptables规则，不存在实体。</li><li>service 使用iptales 扩展模块来实现pod轮询策略故而无法实现最小链接数等负载算法<ul><li>多pod下的RR实现使用iptables statistic模块的random算法加权实现</li><li>sessionAffinity 使用iptables recent模块实现保持，功能主要依赖于nf_conntrack来实现连接标记</li></ul></li></ul><hr><h4 id="单pod时service-iptables-规则实现"><a href="#单pod时service-iptables-规则实现" class="headerlink" title="单pod时service iptables 规则实现"></a>单pod时service iptables 规则实现</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> nginx pod ip地址：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe pod nginx-fb8d45fxt-dcc1t | grep <span class="string">&quot;IP&quot;</span></span></span><br><span class="line"></span><br><span class="line">IP:             10.200.1.21</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Service服务，通过172.30.13.253:80则实际访问到10.200.1.21:80</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe svc nginx</span></span><br><span class="line">...</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                172.30.13.25</span><br><span class="line">Port:              &lt;unset&gt;  80/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:         10.200.1.21:80</span><br><span class="line">Session Affinity:  None</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables-save (选取部分关键规则)</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-A PREROUTING -m comment --comment &quot;kubernetes service portals&quot; -j KUBE-SERVICES</span><br><span class="line">-A OUTPUT -m comment --comment &quot;kubernetes service portals&quot; -j KUBE-SERVICES</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-A KUBE-SEP-UWNFTKZFYWNNNTK7 -s 10.200.1.21/32 -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-UWNFTKZFYWNNNTK7 -p tcp -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -m tcp -j DNAT --to-destination 10.200.1.21:80</span><br><span class="line">-A KUBE-SERVICES -d 172.30.13.25/32 -p tcp -m comment \</span><br><span class="line">   --comment &quot;demo/nginx: cluster IP&quot; -m tcp --dport 80 -j KUBE-SVC-1T7IBBNZDJ76</span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -j KUBE-SEP-UWNFTKZFYWNNNTK7</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h4><p>当访问 172.30.13.25/32 的80 端口时，iptables 规则会被第三条规则命中KUBE-SERVICES，在转发到 KUBE-SVC-1T7IBBNZDJ76 链 ，KUBE-SVC-1T7IBBNZDJ76链对流量进行comment标记之后 转发到 KUBE-SEP-UWNFTKZFYWNNNTK7<br>该链上实现了第一条访问外网的和一条对内的DNAT，此时是向内访问规则会命中第二条向内部进行DNAT 转发到pod地址上，进行路由寻址。</p><hr><h3 id="负载算法实现"><a href="#负载算法实现" class="headerlink" title="负载算法实现"></a>负载算法实现</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl scale deploy/nginx --replicas=3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables-save (选取部分规则)</span></span><br><span class="line">-A KUBE-SEP-BI123VOIAZZ5S7 -s 10.129.1.12/32 -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-BI123VOIAZZ5S7 -p tcp -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -m tcp -j DNAT --to-destination 10.129.1.12:80</span><br><span class="line"></span><br><span class="line">-A KUBE-SEP-CDQIKASRG66RK -s 10.129.1.13/32 -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-CDQIKASRG66RK -p tcp -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -m tcp -j DNAT --to-destination 10.129.1.13:80</span><br><span class="line"></span><br><span class="line">-A KUBE-SEP-W5HTO42ZVNHJQWBG -s 10.129.1.14/32 -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-W5HTO42ZVNHJQWBG -p tcp -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -m tcp -j DNAT --to-destination 10.129.1.14:80</span><br><span class="line"></span><br><span class="line">-A KUBE-SERVICES -d 172.30.13.25/32 -p tcp -m comment \</span><br><span class="line">   --comment &quot;demo/nginx: cluster IP&quot; -m tcp --dport 80 -j KUBE-SVC-1T7IBBNZDJ76</span><br><span class="line"></span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -m statistic --mode random --probability 0.33332999982 -j KUBE-SEP-BI123VOIAZZ5S7</span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-CDQIKASRG66RK</span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -j KUBE-SEP-W5HTO42ZVNHJQWBG</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="分析：-1"><a href="#分析：-1" class="headerlink" title="分析："></a>分析：</h3><p>iptable 在实现多pod 负载算法的时候使用了 statistic模块的random 加权算法 <code>-m statistic --mode random --probability 0.33332999982</code>来实现。具体模块用法可以参考：<a href="http://ipset.netfilter.org/iptables-extensions.man.html">http://ipset.netfilter.org/iptables-extensions.man.html</a></p><hr><h3 id="会话保持"><a href="#会话保持" class="headerlink" title="会话保持"></a>会话保持</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl edit svc nginx</span></span><br><span class="line">...</span><br><span class="line">  sessionAffinity: ClientIP</span><br><span class="line">  sessionAffinityConfig:</span><br><span class="line">    clientIP:</span><br><span class="line">      timeoutSeconds: 3600</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables-save (选取部分规则)</span> </span><br><span class="line">-A KUBE-SEP-BI123VOIAZZ5S7 -s 10.129.1.12/32 -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-BI123VOIAZZ5S7 -p tcp -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -m recent --set --name KUBE-SEP-BI123VOIAZZ5S7 --mask 255.255.255.255 \</span><br><span class="line">   --rsource -m tcp -j DNAT --to-destination 10.129.1.12:80</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-A KUBE-SERVICES -d 172.30.13.25/32 -p tcp -m comment \</span><br><span class="line">   --comment &quot;demo/nginx: cluster IP&quot; -m tcp --dport 80 -j KUBE-SVC-1T7IBBNZDJ76</span><br><span class="line"></span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -m recent --rcheck --seconds 3600 --reap --name KUBE-SEP-BI123VOIAZZ5S7 \</span><br><span class="line">   --mask 255.255.255.255 --rsource -j KUBE-SEP-BI123VOIAZZ5S7</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -m statistic --mode random --probability 0.33332999982 -j KUBE-SEP-BI123VOIAZZ5S7</span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-CDQIKASRG66RK</span><br><span class="line">-A KUBE-SVC-1T7IBBNZDJ76 -m comment --comment &quot;demo/nginx:&quot; \</span><br><span class="line">   -j KUBE-SEP-W5HTO42ZVNHJQWBG</span><br></pre></td></tr></table></figure><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>iptables 主要使用recent 模块来标记追踪连接状态 <code>-m recent --rcheck --seconds 3600</code>来完成会话保持。具体recent模块用法可以参考：<a href="http://ipset.netfilter.org/iptables-extensions.man.html">http://ipset.netfilter.org/iptables-extensions.man.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;结论&quot;&gt;&lt;a href=&quot;#结论&quot; class=&quot;headerlink&quot; title=&quot;结论&quot;&gt;&lt;/a&gt;结论&lt;/h3&gt;&lt;p&gt;本文只讨论iptables的services实现，ipvs实现有所不同，这里先说结论如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;service 使用i
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
      <category term="iptables" scheme="https://www.xiemx.com/categories/k8s/iptables/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="iptables" scheme="https://www.xiemx.com/tags/iptables/"/>
    
  </entry>
  
  <entry>
    <title>k8s cluster-autoscaler</title>
    <link href="https://www.xiemx.com//2020/12/02/k8s-cluster-autoscaler/"/>
    <id>https://www.xiemx.com//2020/12/02/k8s-cluster-autoscaler/</id>
    <published>2020-12-02T09:05:04.000Z</published>
    <updated>2020-12-14T06:37:28.244Z</updated>
    
    <content type="html"><![CDATA[<p>为了在集群中能够动态的根据pod的资源使用量来进行node的动态扩容，K8S cluster-autoscaler 提供了这样的功能，目前接入了大部分主流的厂商，由于我们使用的是aws eks，这里只进行aws 编排。</p><ul><li>项目地址：<a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler">https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler</a></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-addon:</span> <span class="string">cluster-autoscaler.addons.k8s.io</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-addon:</span> <span class="string">cluster-autoscaler.addons.k8s.io</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>, <span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods/eviction&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods/status&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;cluster-autoscaler&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;pods&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;services&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;replicationcontrollers&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;persistentvolumeclaims&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;persistentvolumes&quot;</span></span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;get&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;extensions&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;replicasets&quot;</span>, <span class="string">&quot;daemonsets&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;get&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;policy&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;poddisruptionbudgets&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;statefulsets&quot;</span>, <span class="string">&quot;replicasets&quot;</span>, <span class="string">&quot;daemonsets&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;get&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>, <span class="string">&quot;csinodes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;get&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;batch&quot;</span>, <span class="string">&quot;extensions&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;jobs&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;coordination.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;leases&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;coordination.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;cluster-autoscaler&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;leases&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-addon:</span> <span class="string">cluster-autoscaler.addons.k8s.io</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;cluster-autoscaler-status&quot;</span>, <span class="string">&quot;cluster-autoscaler-priority-expander&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;delete&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-addon:</span> <span class="string">cluster-autoscaler.addons.k8s.io</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-addon:</span> <span class="string">cluster-autoscaler.addons.k8s.io</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">cluster-autoscaler.kubernetes.io/safe-to-evict:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">&#x27;8085&#x27;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">node.kubernetes.io/service-type:</span> <span class="string">auxiliary</span></span><br><span class="line">        <span class="attr">node.kubernetes.io/workload-type:</span> <span class="string">stateless</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">k8s.gcr.io/autoscaling/cluster-autoscaler:v1.17.3</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">300Mi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">300Mi</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./cluster-autoscaler</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--v=4</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--stderrthreshold=info</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--cloud-provider=aws</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--skip-nodes-with-local-storage=true</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--expander=least-waste</span></span><br><span class="line">            <span class="comment"># 我们这里使用自动发现模式，将底层的机器配置，spot/on-daemon机器比例等等逻辑放到aws autoscaling group中去，通过配置的tag寻找对应的asg组，建议使用此方法也可参考官网使用其它模式。</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--node-group-auto-discovery=asg:tag=k8s.io/cluster-autoscaler/enabled,kubernetes.io/cluster/aux-eks</span> </span><br><span class="line">            <span class="comment"># - --balance-similar-node-groups</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--skip-nodes-with-system-pods=false</span></span><br><span class="line">            <span class="comment"># - --aws-use-static-instance-list=true</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ssl-certs</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/ssl/certs/ca-certificates.crt</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">&quot;Always&quot;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ssl-certs</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&quot;/etc/ssl/certs/ca-bundle.crt&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  cluster-autoscaler git:(master) k get pod -A | grep auto</span><br><span class="line">kube-system              cluster-autoscaler-6f5dcc568c-xsbgc                          1/1     Running     1          66d</span><br><span class="line"></span><br><span class="line">➜  k logs -f -n kube-system cluster-autoscaler-6f5dcc568c-xsbgc</span><br><span class="line"></span><br><span class="line">I1203 07:59:42.152656       1 static_autoscaler.go:194] Starting main loop</span><br><span class="line">I1203 07:59:42.153624       1 clusterstate.go:252] Scale up in group aux-eks-product-stateless-20200814145032009600000010 finished successfully in 2m10.67671515s</span><br><span class="line">...</span><br><span class="line">I1203 08:00:02.185930       1 static_autoscaler.go:194] Starting main loop</span><br><span class="line">I1203 08:00:02.337720       1 auto_scaling_groups.go:351] Regenerating instance to ASG map for ASGs: [aux-eks-auxiliary-stateful-2020081414503199620000000e aux-eks-auxiliary-stateless-2020081414503200200000000f aux-eks-product-stateful-2020081414503199420000000d aux-eks-product-stateless-20200814145032009600000010]</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ul><li>cluster-autoscaler 通过计算node 上pod的request/limit来分析资源是否存在不足，因此建议对pod进行明确的资源限制</li><li>node 扩容时尽量选择同配置的机型，或CPU/Memory相同的机型。如果需要使用不同机型可以针对资源进行编组，扩容时按需选择不同的组进行扩容。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;为了在集群中能够动态的根据pod的资源使用量来进行node的动态扩容，K8S cluster-autoscaler 提供了这样的功能，目前接入了大部分主流的厂商，由于我们使用的是aws eks，这里只进行aws 编排。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;项目地址：&lt;a href=&quot;
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="cluster-autoscaler" scheme="https://www.xiemx.com/tags/cluster-autoscaler/"/>
    
  </entry>
  
  <entry>
    <title>k8s descheduler</title>
    <link href="https://www.xiemx.com//2020/12/01/k8s-descheduler/"/>
    <id>https://www.xiemx.com//2020/12/01/k8s-descheduler/</id>
    <published>2020-12-01T09:05:04.000Z</published>
    <updated>2020-12-14T06:37:28.244Z</updated>
    
    <content type="html"><![CDATA[<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p> kube-scheduler通过各种算法计算出最佳节点去运行Pod,当出现新的 Pod 进行调度时，调度程序会根据其当时对 Kubernetes 集群的资源做出调度决定。但Kubernetes集群发生变化，比如一个节点为了维护，执行了驱逐操作，这个节点的 Pod 会被驱逐到其他节点，但是当我们维护完成Pod 不会自动回到该节点上来，由此 Kubernetes 集群出现了不均衡的状态，可以使用descheduler进行在均衡。</p><ul><li>项目地址：<a href="https://github.com/kubernetes-sigs/descheduler">https://github.com/kubernetes-sigs/descheduler</a></li></ul><h3 id="install-descheduler"><a href="#install-descheduler" class="headerlink" title="install descheduler"></a>install descheduler</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">descheduler-policy-configmap</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">policy.yaml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">&quot;descheduler/v1alpha1&quot;</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">&quot;DeschedulerPolicy&quot;</span></span><br><span class="line">    <span class="attr">strategies:</span></span><br><span class="line">      <span class="attr">&quot;RemoveDuplicates&quot;:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">params:</span></span><br><span class="line">          <span class="attr">removeDuplicates:</span></span><br><span class="line">            <span class="attr">excludeOwnerKinds:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;DaemonSet&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;StatefulSet&quot;</span></span><br><span class="line">            <span class="attr">namespaces:</span></span><br><span class="line">              <span class="attr">include:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">uat</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">uat2</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">uat3</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">aux</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">preprod</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">production</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">staging</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">qa</span></span><br><span class="line">      <span class="attr">&quot;RemovePodsViolatingInterPodAntiAffinity&quot;:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">&quot;RemovePodsHavingTooManyRestarts&quot;:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">params:</span></span><br><span class="line">          <span class="attr">podsHavingTooManyRestarts:</span></span><br><span class="line">            <span class="attr">podRestartThreshold:</span> <span class="number">100</span></span><br><span class="line">            <span class="attr">includingInitContainers:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">&quot;LowNodeUtilization&quot;:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">params:</span></span><br><span class="line">          <span class="attr">nodeResourceUtilizationThresholds:</span></span><br><span class="line">            <span class="attr">thresholds:</span></span><br><span class="line">              <span class="string">&quot;cpu&quot;</span> <span class="string">:</span> <span class="number">20</span></span><br><span class="line">              <span class="attr">&quot;memory&quot;:</span> <span class="number">20</span></span><br><span class="line">              <span class="attr">&quot;pods&quot;:</span> <span class="number">20</span></span><br><span class="line">            <span class="attr">targetThresholds:</span></span><br><span class="line">              <span class="string">&quot;cpu&quot;</span> <span class="string">:</span> <span class="number">70</span></span><br><span class="line">              <span class="attr">&quot;memory&quot;:</span> <span class="number">70</span></span><br><span class="line">              <span class="attr">&quot;pods&quot;:</span> <span class="number">40</span></span><br><span class="line">      <span class="attr">&quot;PodLifeTime&quot;:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">params:</span></span><br><span class="line">          <span class="attr">podLifeTime:</span></span><br><span class="line">            <span class="attr">maxPodLifeTimeSeconds:</span> <span class="number">86400</span></span><br><span class="line">            <span class="attr">podStatusPhases:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;Pending&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">descheduler-cronjob</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/2 * * * *&quot;</span></span><br><span class="line">  <span class="attr">concurrencyPolicy:</span> <span class="string">&quot;Forbid&quot;</span></span><br><span class="line">  <span class="attr">successfulJobsHistoryLimit:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">descheduler-pod</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">descheduler</span></span><br><span class="line">              <span class="attr">image:</span> <span class="string">k8s.gcr.io/descheduler/descheduler:v0.19.0</span></span><br><span class="line">              <span class="attr">volumeMounts:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/policy-dir</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">policy-volume</span></span><br><span class="line">              <span class="attr">command:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;/bin/descheduler&quot;</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;--policy-config-file&quot;</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;/policy-dir/policy.yaml&quot;</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;--v&quot;</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">&quot;Never&quot;</span></span><br><span class="line">          <span class="attr">serviceAccountName:</span> <span class="string">descheduler-sa</span></span><br><span class="line">          <span class="attr">volumes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">policy-volume</span></span><br><span class="line">              <span class="attr">configMap:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">descheduler-policy-configmap</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">descheduler-cluster-role</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;namespaces&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods/eviction&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;scheduling.k8s.io&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;priorityclasses&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">descheduler-sa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">descheduler-cluster-role-binding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">descheduler-cluster-role</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">descheduler-sa</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure><h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">➜  descheduler git:(master) k get cronjob  -A</span><br><span class="line">NAMESPACE     NAME                  SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><br><span class="line">kube-system   descheduler-cronjob   */2 * * * *   True      0        3d2h            8d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">➜  descheduler git:(master) k get pod -A | grep desc</span><br><span class="line">kube-system   descheduler-cronjob-1606710120-np5xc               0/1     Completed   0          3d2h</span><br><span class="line"></span><br><span class="line">➜  descheduler git:(master) k logs -f descheduler-cronjob-1606710120-np5xc -n kube-system</span><br><span class="line">I1130 04:22:07.533753       1 node.go:45] node lister returned empty list, now fetch directly</span><br><span class="line">I1130 04:22:07.541476       1 toomanyrestarts.go:73] Processing node: cn-hongkong.10.0.3.20</span><br><span class="line">I1130 04:22:07.565399       1 toomanyrestarts.go:73] Processing node: cn-hongkong.10.0.3.21</span><br><span class="line">I1130 04:22:07.577738       1 duplicates.go:73] Processing node: &quot;cn-hongkong.10.0.3.20&quot;</span><br><span class="line">I1130 04:22:07.593279       1 duplicates.go:73] Processing node: &quot;cn-hongkong.10.0.3.21&quot;</span><br><span class="line">I1130 04:22:07.632923       1 lownodeutilization.go:203] Node &quot;cn-hongkong.10.0.3.20&quot; is appropriately utilized with usage: api.ResourceThresholds&#123;&quot;cpu&quot;:32.5, &quot;memory&quot;:29.3980074559352, &quot;pods&quot;:17.1875&#125;</span><br><span class="line">I1130 04:22:07.632997       1 lownodeutilization.go:203] Node &quot;cn-hongkong.10.0.3.21&quot; is appropriately utilized with usage: api.ResourceThresholds&#123;&quot;cpu&quot;:30, &quot;memory&quot;:23.303233323623655, &quot;pods&quot;:15.625&#125;</span><br><span class="line">I1130 04:22:07.633016       1 lownodeutilization.go:101] Criteria for a node under utilization: CPU: 20, Mem: 20, Pods: 20</span><br><span class="line">I1130 04:22:07.633028       1 lownodeutilization.go:105] No node is underutilized, nothing to do here, you might tune your thresholds further</span><br><span class="line">I1130 04:22:07.633042       1 pod_antiaffinity.go:72] Processing node: &quot;cn-hongkong.10.0.3.20&quot;</span><br><span class="line">I1130 04:22:07.647199       1 pod_antiaffinity.go:72] Processing node: &quot;cn-hongkong.10.0.3.21&quot;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;原理&quot;&gt;&lt;a href=&quot;#原理&quot; class=&quot;headerlink&quot; title=&quot;原理&quot;&gt;&lt;/a&gt;原理&lt;/h3&gt;&lt;p&gt; kube-scheduler通过各种算法计算出最佳节点去运行Pod,当出现新的 Pod 进行调度时，调度程序会根据其当时对 Kuberne
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="descheduler" scheme="https://www.xiemx.com/tags/descheduler/"/>
    
  </entry>
  
  <entry>
    <title>nginx-ingress下使用ldap 实现ingress auth认证</title>
    <link href="https://www.xiemx.com//2020/11/21/nginx-ingress-ldap/"/>
    <id>https://www.xiemx.com//2020/11/21/nginx-ingress-ldap/</id>
    <published>2020-11-21T09:05:04.000Z</published>
    <updated>2020-12-14T06:37:28.252Z</updated>
    
    <content type="html"><![CDATA[<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>使用nginx subrequest在请求直线通过 ingress annotation注入一条规则去调用auth接口完成ldap认证。参考文档：</p><ul><li><a href="http://nginx.org/en/docs/http/ngx_http_auth_request_module.html">http://nginx.org/en/docs/http/ngx_http_auth_request_module.html</a></li><li><a href="https://www.nginx.com/blog/nginx-plus-authenticate-users">https://www.nginx.com/blog/nginx-plus-authenticate-users</a></li><li><a href="https://docs.foxpass.com/docs/ldap-overview-debugging">https://docs.foxpass.com/docs/ldap-overview-debugging</a></li><li><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#external-authentication">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#external-authentication</a></li></ul><h3 id="创建ldap认证服务"><a href="#创建ldap认证服务" class="headerlink" title="创建ldap认证服务"></a>创建ldap认证服务</h3><h2 id="yaml"><a href="#yaml" class="headerlink" title="```yaml"></a>```yaml</h2><p>apiVersion: v1<br>kind: ConfigMap<br>metadata:<br>  name: nginx-ldap-auth-config<br>data:<br>  foxpass.conf: |<br>    # define ldap server<br>    ldap_server foxpass {<br>        url “ldaps://ldap.foxpass.com:636/dc=xiemx,dc=com?uid?sub?(objectClass=*)”;<br>        binddn “{dn信息}”; # cn=test,dc=xiemx,dc=com<br>        binddn_passwd “xxxxxx”;<br>        group_attribute groups;<br>        group_attribute_is_dn on;<br>        require valid_user;<br>    }<br><br>    server {<br>      listen 5555;<br><br>      location / {<br>        auth_ldap “foxpass”;<br>        auth_ldap_servers foxpass;<br><br>        try_files index.html,index.htm @auth;<br>      }<br><br>      location @auth {<br>        return 200 “ldap auth”;<br>      }<br>    }</p><hr><p>apiVersion: v1<br>kind: ServiceAccount<br>metadata:</p><h2 id="name-nginx-ldap-auth"><a href="#name-nginx-ldap-auth" class="headerlink" title="  name: nginx-ldap-auth"></a>  name: nginx-ldap-auth</h2><p>apiVersion: rbac.authorization.k8s.io/v1beta1<br>kind: Role<br>metadata:<br>  name: nginx-ldap-auth<br>rules:</p><ul><li>apiGroups:<ul><li>“”<br>resources:</li><li>configmaps<br>resourceNames:</li><li>“nginx-ladp-auth-config”<br>verbs:</li><li>get</li></ul></li></ul><hr><p>apiVersion: rbac.authorization.k8s.io/v1beta1<br>kind: RoleBinding<br>metadata:<br>  name: nginx-ldap-auth<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: Role<br>  name: nginx-ldap-auth<br>subjects:</p><ul><li>kind: ServiceAccount<br>name: nginx-ldap-auth</li></ul><hr><p>kind: Service<br>apiVersion: v1<br>metadata:<br>  name: nginx-ldap-auth<br>spec:<br>  type: ClusterIP<br>  ports:</p><ul><li>name: nginx-ldap-auth<br>port: 5555<br>protocol: TCP<br>targetPort: 5555<br>selector:<br>app: nginx-ldap-auth</li></ul><hr><p>kind: Deployment<br>apiVersion: apps/v1<br>metadata:<br>  name: nginx-ldap-auth<br>  labels:<br>    app: nginx-ldap-auth<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      app: “nginx-ldap-auth”<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx-ldap-auth<br>    spec:<br>      serviceAccountName: nginx-ldap-auth<br>      containers:<br>      - image: weseek/nginx-auth-ldap:1.15.11-alpine<br>        name: nginx-ldap-auth<br>        ports:<br>        - name: http<br>          containerPort: 5555<br>        resources:<br>          limits:<br>            memory: 200Mi<br>          requests:<br>            cpu: 100m<br>            memory: 200Mi<br>        volumeMounts:<br>        - name: config<br>          mountPath: /etc/nginx/conf.d<br>      volumes:<br>      - name: config<br>        configMap:<br>          name: nginx-ldap-auth-config</p><hr><p>apiVersion: extensions/v1beta1<br>kind: Ingress<br>metadata:<br>  annotations:<br>    kubernetes.io/ingress.class: nginx<br>  labels:<br>    app: nginx-ldap-auth<br>  name: nginx-ldap-auth<br>spec:<br>  rules:</p><ul><li>host: foxpass.i.xiemx.com<br>http:<br>  paths:<ul><li>backend:<br>  serviceName: nginx-ldap-auth<br>  servicePort: 5555<br>path: /</li></ul></li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### ingress 开启auth认证</span><br><span class="line"></span><br><span class="line">```yaml</span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadat<span class="variable">a:</span></span><br><span class="line">  annotation<span class="variable">s:</span></span><br><span class="line">      nginx.ingress.kubernetes.io/auth-ur<span class="variable">l:</span> http<span class="variable">s:</span>//foxpass.i.xiemx.<span class="keyword">com</span></span><br><span class="line">  name: kibana</span><br><span class="line">spec:</span><br><span class="line">  rule<span class="variable">s:</span></span><br><span class="line">  - hos<span class="variable">t:</span> kibana.i.xiemx.<span class="keyword">com</span></span><br><span class="line">    http:</span><br><span class="line">      path<span class="variable">s:</span></span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: kibana</span><br><span class="line">          servicePor<span class="variable">t:</span> <span class="number">5601</span></span><br><span class="line"></span><br><span class="line">### 测试</span><br><span class="line">➜  kibana gi<span class="variable">t:</span>(master) curl kibana.i.xiemx.<span class="keyword">com</span></span><br><span class="line"><span class="symbol">&lt;html&gt;</span></span><br><span class="line"><span class="symbol">&lt;head&gt;</span><span class="symbol">&lt;title&gt;</span><span class="number">401</span> Authorization Required&lt;/title&gt;&lt;/head&gt;</span><br><span class="line"><span class="symbol">&lt;body&gt;</span></span><br><span class="line"><span class="symbol">&lt;center&gt;</span><span class="symbol">&lt;h1&gt;</span><span class="number">401</span> Authorization Required&lt;/h1&gt;&lt;/<span class="keyword">center</span>&gt;</span><br><span class="line"><span class="symbol">&lt;hr&gt;</span><span class="symbol">&lt;center&gt;</span>nginx/<span class="number">1.15</span>.<span class="number">9</span>&lt;/<span class="keyword">center</span>&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">➜  kibana gi<span class="variable">t:</span>(master) curl kibana.i.xiemx.<span class="keyword">com</span> --user mingxu.xie</span><br><span class="line">Enter host password <span class="keyword">for</span> user <span class="string">&#x27;mingxu.xie&#x27;</span>:</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;原理&quot;&gt;&lt;a href=&quot;#原理&quot; class=&quot;headerlink&quot; title=&quot;原理&quot;&gt;&lt;/a&gt;原理&lt;/h3&gt;&lt;p&gt;使用nginx subrequest在请求直线通过 ingress annotation注入一条规则去调用auth接口完成ldap认证。参考
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="ingress" scheme="https://www.xiemx.com/tags/ingress/"/>
    
      <category term="nginx" scheme="https://www.xiemx.com/tags/nginx/"/>
    
      <category term="ldap" scheme="https://www.xiemx.com/tags/ldap/"/>
    
  </entry>
  
  <entry>
    <title>kong 测试代码</title>
    <link href="https://www.xiemx.com//2020/11/03/kong-test-code/"/>
    <id>https://www.xiemx.com//2020/11/03/kong-test-code/</id>
    <published>2020-11-03T02:52:00.000Z</published>
    <updated>2020-12-14T06:37:28.247Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### docker-compose.yaml</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">kong</span> <span class="string">git:(master)</span> <span class="string">✗</span> <span class="string">cat</span> <span class="string">docker-compose.yaml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">kong:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kong:latest</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KONG_ADMIN_LISTEN=0.0.0.0:8001,</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8444</span> <span class="string">ssl</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KONG_DATABASE=off</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KONG_DECLARATIVE_CONFIG=/usr/local/kong/declarative/kong.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KONG_PROXY_ACCESS_LOG=/dev/stdout</span> <span class="string">json</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KONG_ADMIN_ACCESS_LOG=/dev/stdout</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KONG_PROXY_ERROR_LOG=/dev/stderr</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KONG_ADMIN_ERROR_LOG=/dev/stderr</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./kong.yaml:/usr/local/kong/declarative/kong.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-template:/etc/kong/nginx-template.conf</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8000</span><span class="string">:8000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8001</span><span class="string">:8001</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8443</span><span class="string">:8443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8444</span><span class="string">:8444</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8881</span><span class="string">:8881</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;kong&quot;</span>, <span class="string">&quot;docker-start&quot;</span>, <span class="string">&quot;--nginx-conf&quot;</span>, <span class="string">&quot;/etc/kong/nginx-template.conf&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">###nginx template</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">kong</span> <span class="string">git:(master)</span> <span class="string">✗</span> <span class="string">cat</span> <span class="string">nginx-template</span></span><br><span class="line"><span class="string">worker_processes</span> <span class="string">$&#123;&#123;NGINX_WORKER_PROCESSES&#125;&#125;;</span></span><br><span class="line"><span class="string">daemon</span> <span class="string">$&#123;&#123;NGINX_DAEMON&#125;&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="string">pid</span> <span class="string">pids/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">error_log</span> <span class="string">logs/error.log</span> <span class="string">$&#123;&#123;LOG_LEVEL&#125;&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="string">events</span> &#123;</span><br><span class="line">    <span class="string">use</span> <span class="string">epoll;</span></span><br><span class="line">    <span class="string">multi_accept</span> <span class="string">on;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">http</span> &#123;</span><br><span class="line">    <span class="string">log_format</span> <span class="string">json</span> <span class="string">&#x27;&#123; &quot;timestamp&quot;: &quot;$time_local&quot;, &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;server_name&quot;: &quot;$host&quot;,&#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;remote_addr&quot;: &quot;$remote_addr&quot;, &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;ip&quot;: &quot;$http_ip&quot;, &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;remote_user&quot;: &quot;$remote_user&quot;, &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;body_bytes_sent&quot;: &quot;$body_bytes_sent&quot;, &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;request_time&quot;: &quot;$request_time&quot;, &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;status&quot;: &quot;$status&quot;, &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;request&quot;: &quot;$request&quot;, &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;request_method&quot;: &quot;$request_method&quot;, &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;http_referrer&quot;: &quot;$http_referer&quot;, &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;body_bytes_sent&quot;:&quot;$body_bytes_sent&quot;, &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;http_x_forwarded_for&quot;: &quot;$http_x_forwarded_for&quot;, &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;http_user_agent&quot;: &quot;$http_user_agent&quot; &#125;&#x27;</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">include</span> <span class="string">&quot;nginx-kong.conf&quot;</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">server</span> &#123;</span><br><span class="line">        <span class="string">listen</span> <span class="number">8881</span><span class="string">;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">            <span class="string">return</span> <span class="number">200</span> <span class="string">&quot;1&quot;</span><span class="string">;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### kong.yaml</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">kong</span> <span class="string">git:(master)</span> <span class="string">✗</span> <span class="string">cat</span> <span class="string">kong.yaml</span></span><br><span class="line"><span class="attr">_format_version:</span> <span class="string">&quot;1.1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xiemx.com-service</span></span><br><span class="line">  <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">connect_timeout:</span> <span class="number">60000</span></span><br><span class="line">  <span class="attr">read_timeout:</span> <span class="number">60000</span></span><br><span class="line">  <span class="attr">write_timeout:</span> <span class="number">60000</span></span><br><span class="line">  <span class="comment"># url: http://xiemx.com</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">xiemx.com-upstream</span></span><br><span class="line">  <span class="comment"># port: 80</span></span><br><span class="line">  <span class="attr">protocol:</span> <span class="string">https</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TCPService</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">http://ifconfig.io</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mockbin.org-service</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">http://mockbin.org</span></span><br><span class="line"></span><br><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HTTPRoute</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">xiemx.com-service</span></span><br><span class="line">  <span class="comment"># preserve_host: true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;xiemx.com&quot;</span>]</span><br><span class="line">  <span class="attr">methods:</span> [<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, <span class="string">&quot;HEAD&quot;</span>]</span><br><span class="line">  <span class="comment"># strip_path: true</span></span><br><span class="line">  <span class="attr">headers:</span> &#123; <span class="attr">&quot;version&quot;:</span> [<span class="string">&quot;v1&quot;</span>,<span class="string">&quot;v2&quot;</span>]&#125;</span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/v1/\d+</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/v2/\d+/status/\d+</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/v3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/v4/any/</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/</span></span><br><span class="line">  <span class="attr">regex_priority:</span> <span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mockbin.org-route</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">mockbin.org-service</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;mockbin.org&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TCPRoute</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">TCPService</span></span><br><span class="line">  <span class="attr">protocols:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tls</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tcp</span></span><br><span class="line">  <span class="attr">sources:</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">ip:</span> <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span><span class="string">/32</span>, <span class="attr">port:</span> <span class="number">1234</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br><span class="line">  <span class="attr">destinations:</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">ip:</span> <span class="number">2.2</span><span class="number">.2</span><span class="number">.2</span><span class="string">/32</span>, <span class="attr">port:</span> <span class="number">1234</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">key-auth</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">mockbin.org-service</span></span><br><span class="line">  <span class="attr">consumer:</span> <span class="string">xiemx1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">consumers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">username:</span> <span class="string">xiemx1</span></span><br><span class="line">  <span class="attr">keyauth-credentials:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">username:</span> <span class="string">xiemx2</span></span><br><span class="line">  <span class="attr">keyauth-credentials:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">upstreams:</span></span><br><span class="line"><span class="comment"># - name: mockbin.org-upstream</span></span><br><span class="line"><span class="comment">#   targets:</span></span><br><span class="line"><span class="comment">#     - target: mockbin.org</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xiemx.com-upstream</span></span><br><span class="line">  <span class="attr">targets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="string">www.xiemx.com:443</span></span><br><span class="line">  <span class="attr">algorithm:</span> <span class="string">&quot;round-robin&quot;</span></span><br><span class="line">  <span class="comment"># host_header: &quot;baidu.com&quot;  ### proxy_set_header host &quot;xiemx.com&quot;</span></span><br><span class="line">  <span class="attr">hash_on:</span> <span class="string">&quot;none&quot;</span></span><br><span class="line">  <span class="attr">hash_fallback:</span> <span class="string">&quot;none&quot;</span></span><br><span class="line">  <span class="attr">hash_on_cookie_path:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">  <span class="attr">slots:</span> <span class="number">10001</span></span><br><span class="line">  <span class="attr">healthchecks:</span></span><br><span class="line">    <span class="attr">active:</span></span><br><span class="line">        <span class="attr">https_verify_certificate:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">unhealthy:</span></span><br><span class="line">            <span class="attr">http_statuses:</span> [<span class="number">429</span>, <span class="number">404</span>, <span class="number">500</span>, <span class="number">501</span>, <span class="number">502</span>, <span class="number">503</span>, <span class="number">504</span>, <span class="number">505</span>]</span><br><span class="line">            <span class="attr">tcp_failures:</span> <span class="number">0</span></span><br><span class="line">            <span class="attr">timeouts:</span> <span class="number">0</span></span><br><span class="line">            <span class="attr">http_failures:</span> <span class="number">0</span></span><br><span class="line">            <span class="attr">interval:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">http_path:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">        <span class="attr">timeout:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">healthy:</span></span><br><span class="line">            <span class="attr">http_statuses:</span> [<span class="number">200</span>, <span class="number">302</span>]</span><br><span class="line">            <span class="attr">interval:</span> <span class="number">0</span></span><br><span class="line">            <span class="attr">successes:</span> <span class="number">0</span></span><br><span class="line">        <span class="comment"># https_sni: &quot;example.com&quot;</span></span><br><span class="line">        <span class="attr">concurrency:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;http&quot;</span></span><br><span class="line">    <span class="attr">passive:</span></span><br><span class="line">        <span class="attr">unhealthy:</span></span><br><span class="line">            <span class="attr">http_failures:</span> <span class="number">0</span></span><br><span class="line">            <span class="attr">http_statuses:</span> [<span class="number">429</span>, <span class="number">500</span>, <span class="number">503</span>]</span><br><span class="line">            <span class="attr">tcp_failures:</span> <span class="number">0</span></span><br><span class="line">            <span class="attr">timeouts:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">healthy:</span></span><br><span class="line">            <span class="attr">successes:</span> <span class="number">0</span></span><br><span class="line">            <span class="attr">http_statuses:</span> [<span class="number">200</span>, <span class="number">201</span>, <span class="number">202</span>, <span class="number">203</span>, <span class="number">204</span>, <span class="number">205</span>, <span class="number">206</span>, <span class="number">207</span>, <span class="number">208</span>, <span class="number">226</span>, <span class="number">300</span>, <span class="number">301</span>, <span class="number">302</span>, <span class="number">303</span>, <span class="number">304</span>, <span class="number">305</span>, <span class="number">306</span>, <span class="number">307</span>, <span class="number">308</span>]</span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">http</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">xiemx</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=
      
    
    </summary>
    
    
      <category term="kong" scheme="https://www.xiemx.com/categories/kong/"/>
    
    
      <category term="docker" scheme="https://www.xiemx.com/tags/docker/"/>
    
      <category term="kong" scheme="https://www.xiemx.com/tags/kong/"/>
    
      <category term="nginx" scheme="https://www.xiemx.com/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>kong ingress</title>
    <link href="https://www.xiemx.com//2020/11/03/aws-alb-ingress/"/>
    <id>https://www.xiemx.com//2020/11/03/aws-alb-ingress/</id>
    <published>2020-11-03T02:52:00.000Z</published>
    <updated>2020-12-14T06:37:28.239Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Kong-Ingress"><a href="#Kong-Ingress" class="headerlink" title="Kong Ingress"></a>Kong Ingress</h2><p>项目地址：<a href="https://github.com/Kong/kubernetes-ingress-controller">https://github.com/Kong/kubernetes-ingress-controller</a></p><p><img src="/images/kong-architecture.jpg" alt="kong-architecture"></p><p>结论：</p><ul><li>kongIngress和kongPlugin 可以看成是对原始ingress进行增强的补丁（个人理解）</li><li>kong ingress 可以原则上无缝接管nginx ingress</li><li>kong ingress 可以实现规则灵活挂接，可允许在<code>SVC</code>、<code>INGRESS</code> 上接入规则，可以基于ingress实现host 级别 global规则，也可基于path分别对于不同的svc进行管理</li></ul><hr><h4 id="install-controller"><a href="#install-controller" class="headerlink" title="install controller"></a>install controller</h4><details><summary>ingress-controller.yaml</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kong</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kongclusterplugins.configuration.konghq.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">additionalPrinterColumns:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.plugin</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">plugin</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Plugin-Type</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.metadata.creationTimestamp</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Age</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Age</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">date</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.disabled</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Indicates</span> <span class="string">if</span> <span class="string">the</span> <span class="string">plugin</span> <span class="string">is</span> <span class="string">disabled</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Disabled</span></span><br><span class="line">    <span class="attr">priority:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">boolean</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.config</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Configuration</span> <span class="string">of</span> <span class="string">the</span> <span class="string">plugin</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Config</span></span><br><span class="line">    <span class="attr">priority:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">configuration.konghq.com</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">KongClusterPlugin</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">kongclusterplugins</span></span><br><span class="line">    <span class="attr">shortNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kcp</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">validation:</span></span><br><span class="line">    <span class="attr">openAPIV3Schema:</span></span><br><span class="line">      <span class="attr">properties:</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">        <span class="attr">configFrom:</span></span><br><span class="line">          <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">properties:</span></span><br><span class="line">                <span class="attr">key:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">name:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">namespace:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">              <span class="attr">required:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">name</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">namespace</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">key</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">        <span class="attr">disabled:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">boolean</span></span><br><span class="line">        <span class="attr">plugin:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">protocols:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">            <span class="attr">enum:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">http</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">https</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">grpc</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">grpcs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">tcp</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">tls</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">        <span class="attr">run_on:</span></span><br><span class="line">          <span class="attr">enum:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">first</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">second</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">required:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">plugin</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kongconsumers.configuration.konghq.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">additionalPrinterColumns:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.username</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Username</span> <span class="string">of</span> <span class="string">a</span> <span class="string">Kong</span> <span class="string">Consumer</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Username</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.metadata.creationTimestamp</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Age</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Age</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">date</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">configuration.konghq.com</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">KongConsumer</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">kongconsumers</span></span><br><span class="line">    <span class="attr">shortNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kc</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">validation:</span></span><br><span class="line">    <span class="attr">openAPIV3Schema:</span></span><br><span class="line">      <span class="attr">properties:</span></span><br><span class="line">        <span class="attr">credentials:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">        <span class="attr">custom_id:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">username:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kongcredentials.configuration.konghq.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">additionalPrinterColumns:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.type</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Type</span> <span class="string">of</span> <span class="string">credential</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Credential-type</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.metadata.creationTimestamp</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Age</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Age</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">date</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.consumerRef</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Owner</span> <span class="string">of</span> <span class="string">the</span> <span class="string">credential</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Consumer-Ref</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">configuration.konghq.com</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">KongCredential</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">kongcredentials</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">validation:</span></span><br><span class="line">    <span class="attr">openAPIV3Schema:</span></span><br><span class="line">      <span class="attr">properties:</span></span><br><span class="line">        <span class="attr">consumerRef:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">type:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">required:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consumerRef</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">type</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kongingresses.configuration.konghq.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">configuration.konghq.com</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">KongIngress</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">kongingresses</span></span><br><span class="line">    <span class="attr">shortNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ki</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">validation:</span></span><br><span class="line">    <span class="attr">openAPIV3Schema:</span></span><br><span class="line">      <span class="attr">properties:</span></span><br><span class="line">        <span class="attr">proxy:</span></span><br><span class="line">          <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">connect_timeout:</span></span><br><span class="line">              <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">            <span class="attr">path:</span></span><br><span class="line">              <span class="attr">pattern:</span> <span class="string">^/.*$</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">            <span class="attr">protocol:</span></span><br><span class="line">              <span class="attr">enum:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">http</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">https</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">grpc</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">grpcs</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">tcp</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">tls</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">            <span class="attr">read_timeout:</span></span><br><span class="line">              <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">            <span class="attr">retries:</span></span><br><span class="line">              <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">            <span class="attr">write_timeout:</span></span><br><span class="line">              <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">        <span class="attr">route:</span></span><br><span class="line">          <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">headers:</span></span><br><span class="line">              <span class="attr">additionalProperties:</span></span><br><span class="line">                <span class="attr">items:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">            <span class="attr">https_redirect_status_code:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">            <span class="attr">methods:</span></span><br><span class="line">              <span class="attr">items:</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">            <span class="attr">path_handling:</span></span><br><span class="line">              <span class="attr">enum:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">v0</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">            <span class="attr">preserve_host:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">boolean</span></span><br><span class="line">            <span class="attr">protocols:</span></span><br><span class="line">              <span class="attr">items:</span></span><br><span class="line">                <span class="attr">enum:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">http</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">https</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">grpc</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">grpcs</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">tcp</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">tls</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">            <span class="attr">regex_priority:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">            <span class="attr">strip_path:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">boolean</span></span><br><span class="line">        <span class="attr">upstream:</span></span><br><span class="line">          <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">algorithm:</span></span><br><span class="line">              <span class="attr">enum:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">round-robin</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">consistent-hashing</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">least-connections</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">            <span class="attr">hash_fallback:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">            <span class="attr">hash_fallback_header:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">            <span class="attr">hash_on:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">            <span class="attr">hash_on_cookie:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">            <span class="attr">hash_on_cookie_path:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">            <span class="attr">hash_on_header:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">            <span class="attr">healthchecks:</span></span><br><span class="line">              <span class="attr">properties:</span></span><br><span class="line">                <span class="attr">active:</span></span><br><span class="line">                  <span class="attr">properties:</span></span><br><span class="line">                    <span class="attr">concurrency:</span></span><br><span class="line">                      <span class="attr">minimum:</span> <span class="number">1</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                    <span class="attr">healthy:</span></span><br><span class="line">                      <span class="attr">properties:</span></span><br><span class="line">                        <span class="attr">http_statuses:</span></span><br><span class="line">                          <span class="attr">items:</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                        <span class="attr">interval:</span></span><br><span class="line">                          <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                        <span class="attr">successes:</span></span><br><span class="line">                          <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">http_path:</span></span><br><span class="line">                      <span class="attr">pattern:</span> <span class="string">^/.*$</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                    <span class="attr">timeout:</span></span><br><span class="line">                      <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                    <span class="attr">unhealthy:</span></span><br><span class="line">                      <span class="attr">properties:</span></span><br><span class="line">                        <span class="attr">http_failures:</span></span><br><span class="line">                          <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                        <span class="attr">http_statuses:</span></span><br><span class="line">                          <span class="attr">items:</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                        <span class="attr">interval:</span></span><br><span class="line">                          <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                        <span class="attr">tcp_failures:</span></span><br><span class="line">                          <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                        <span class="attr">timeout:</span></span><br><span class="line">                          <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                <span class="attr">passive:</span></span><br><span class="line">                  <span class="attr">properties:</span></span><br><span class="line">                    <span class="attr">healthy:</span></span><br><span class="line">                      <span class="attr">properties:</span></span><br><span class="line">                        <span class="attr">http_statuses:</span></span><br><span class="line">                          <span class="attr">items:</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                        <span class="attr">interval:</span></span><br><span class="line">                          <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                        <span class="attr">successes:</span></span><br><span class="line">                          <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                    <span class="attr">unhealthy:</span></span><br><span class="line">                      <span class="attr">properties:</span></span><br><span class="line">                        <span class="attr">http_failures:</span></span><br><span class="line">                          <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                        <span class="attr">http_statuses:</span></span><br><span class="line">                          <span class="attr">items:</span></span><br><span class="line">                            <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                        <span class="attr">interval:</span></span><br><span class="line">                          <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                        <span class="attr">tcp_failures:</span></span><br><span class="line">                          <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                        <span class="attr">timeout:</span></span><br><span class="line">                          <span class="attr">minimum:</span> <span class="number">0</span></span><br><span class="line">                          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                <span class="attr">threshold:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">            <span class="attr">host_header:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">            <span class="attr">slots:</span></span><br><span class="line">              <span class="attr">minimum:</span> <span class="number">10</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kongplugins.configuration.konghq.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">additionalPrinterColumns:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.plugin</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">plugin</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Plugin-Type</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.metadata.creationTimestamp</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Age</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Age</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">date</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.disabled</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Indicates</span> <span class="string">if</span> <span class="string">the</span> <span class="string">plugin</span> <span class="string">is</span> <span class="string">disabled</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Disabled</span></span><br><span class="line">    <span class="attr">priority:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">boolean</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.config</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Configuration</span> <span class="string">of</span> <span class="string">the</span> <span class="string">plugin</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Config</span></span><br><span class="line">    <span class="attr">priority:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">configuration.konghq.com</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">kongplugins</span></span><br><span class="line">    <span class="attr">shortNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kp</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">validation:</span></span><br><span class="line">    <span class="attr">openAPIV3Schema:</span></span><br><span class="line">      <span class="attr">properties:</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">        <span class="attr">configFrom:</span></span><br><span class="line">          <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">properties:</span></span><br><span class="line">                <span class="attr">key:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">name:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">              <span class="attr">required:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">name</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">key</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">        <span class="attr">disabled:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">boolean</span></span><br><span class="line">        <span class="attr">plugin:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">protocols:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">            <span class="attr">enum:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">http</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">https</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">grpc</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">grpcs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">tcp</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">tls</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">        <span class="attr">run_on:</span></span><br><span class="line">          <span class="attr">enum:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">first</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">second</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">required:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">plugin</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tcpingresses.configuration.konghq.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">additionalPrinterColumns:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.status.loadBalancer.ingress[*].ip</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Address</span> <span class="string">of</span> <span class="string">the</span> <span class="string">load</span> <span class="string">balancer</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Address</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">JSONPath:</span> <span class="string">.metadata.creationTimestamp</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Age</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Age</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">date</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">configuration.konghq.com</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">TCPIngress</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">tcpingresses</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">subresources:</span></span><br><span class="line">    <span class="attr">status:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">validation:</span></span><br><span class="line">    <span class="attr">openAPIV3Schema:</span></span><br><span class="line">      <span class="attr">properties:</span></span><br><span class="line">        <span class="attr">apiVersion:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">kind:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">rules:</span></span><br><span class="line">              <span class="attr">items:</span></span><br><span class="line">                <span class="attr">properties:</span></span><br><span class="line">                  <span class="attr">backend:</span></span><br><span class="line">                    <span class="attr">properties:</span></span><br><span class="line">                      <span class="attr">serviceName:</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                      <span class="attr">servicePort:</span></span><br><span class="line">                        <span class="attr">format:</span> <span class="string">int32</span></span><br><span class="line">                        <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                    <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                  <span class="attr">host:</span></span><br><span class="line">                    <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                  <span class="attr">port:</span></span><br><span class="line">                    <span class="attr">format:</span> <span class="string">int32</span></span><br><span class="line">                    <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">            <span class="attr">tls:</span></span><br><span class="line">              <span class="attr">items:</span></span><br><span class="line">                <span class="attr">properties:</span></span><br><span class="line">                  <span class="attr">hosts:</span></span><br><span class="line">                    <span class="attr">items:</span></span><br><span class="line">                      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                    <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">                  <span class="attr">secretName:</span></span><br><span class="line">                    <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">        <span class="attr">status:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1beta1</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">acceptedNames:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">conditions:</span> []</span><br><span class="line">  <span class="attr">storedVersions:</span> []</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kong-serviceaccount</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kong-ingress-clusterrole</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.internal.knative.dev</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.internal.knative.dev</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configuration.konghq.com</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tcpingresses/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configuration.konghq.com</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kongplugins</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kongclusterplugins</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kongcredentials</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kongconsumers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kongingresses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tcpingresses</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kong-ingress-clusterrole-nisa-binding</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kong-ingress-clusterrole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kong-serviceaccount</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment">#    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: tcp</span></span><br><span class="line">    <span class="comment">#    service.beta.kubernetes.io/aws-load-balancer-type: nlb</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kong-proxy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">proxy</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">proxy-ssl</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">ingress-kong</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kong-validation-webhook</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webhook</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">ingress-kong</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-kong</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">ingress-kong</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">kuma.io/gateway:</span> <span class="string">enabled</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">&quot;8100&quot;</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">traffic.sidecar.istio.io/includeInboundPorts:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">ingress-kong</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KONG_PROXY_LISTEN</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8000,</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8443</span> <span class="string">ssl</span> <span class="string">http2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KONG_ADMIN_LISTEN</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8444</span> <span class="string">ssl</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KONG_STATUS_LISTEN</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8100</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KONG_DATABASE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;off&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KONG_NGINX_WORKER_PROCESSES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KONG_ADMIN_ACCESS_LOG</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/dev/stdout</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KONG_ADMIN_ERROR_LOG</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/dev/stderr</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KONG_PROXY_ERROR_LOG</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/dev/stderr</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">kong:2.0</span></span><br><span class="line">        <span class="attr">lifecycle:</span></span><br><span class="line">          <span class="attr">preStop:</span></span><br><span class="line">            <span class="attr">exec:</span></span><br><span class="line">              <span class="attr">command:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">kong</span> <span class="string">quit</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/status</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8100</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">proxy</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">proxy</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8443</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">proxy-ssl</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8100</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/status</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8100</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONTROLLER_KONG_ADMIN_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">https://127.0.0.1:8444</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONTROLLER_KONG_ADMIN_TLS_SKIP_VERIFY</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONTROLLER_PUBLISH_SERVICE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">kong/kong-proxy</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">kong-docker-kubernetes-ingress-controller.bintray.io/kong-ingress-controller:0.9.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">10254</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">ingress-controller</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">webhook</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">10254</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kong-serviceaccount</span></span><br></pre></td></tr></table></figure></details><h4 id="部署测试服务"><a href="#部署测试服务" class="headerlink" title="部署测试服务"></a>部署测试服务</h4><details><summary>echo.yaml</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">echo</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">echo-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">high</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">low</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">echo</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">echo</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">echo-v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">high</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">low</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">echo</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">echo</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">echo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">echo</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">echo</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">gcr.io/kubernetes-e2e-test-images/echoserver:2.2</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">echo</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_IP</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/v1</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">echo-v1</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/v2</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">echo-v2</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure></details><details><summary>KongPlugins.yaml</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">auth</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">key-auth</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">global:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">global-rate-limit</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">limit_by:</span> <span class="string">consumer</span></span><br><span class="line">  <span class="attr">minute:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">policy:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">rate-limiting</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rate-limit</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">limit_by:</span> <span class="string">consumer</span></span><br><span class="line">  <span class="attr">minute:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">policy:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">rate-limiting</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">correlation-id</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">header_name:</span> <span class="string">X-Request-ID</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">request-id</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">response-header</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">add:</span></span><br><span class="line">    <span class="attr">headers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;x-cust-resp-header: xiemx&#x27;</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">response-transformer</span></span><br></pre></td></tr></table></figure></details><details><summary>KongIngress.yaml</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongIngress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">custom-ingress</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">methods:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">GET</span></span><br><span class="line">    <span class="comment">#strip_path: true</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongIngress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">custom-svc</span></span><br><span class="line"><span class="attr">upstream:</span></span><br><span class="line">  <span class="attr">hash_on:</span> <span class="string">ip</span></span><br><span class="line"><span class="attr">proxy:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/foo/</span></span><br></pre></td></tr></table></figure></details><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>本测试只使用少数几个plugin测试kong的ingress、svc规则生效，具体plugin可以另行测试，已附上对应具体yaml</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">➜  kong git:(master) ✗ kga</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/echo-85fb7989cc-pmjq7          1/1     Running   0          2d14h</span><br><span class="line">pod/ingress-kong-d7b5d68f4-8v9tk   2/2     Running   0          2d14h</span><br><span class="line"></span><br><span class="line">NAME                              TYPE           CLUSTER-IP       EXTERNAL-IP                                                                    PORT(S)                      AGE</span><br><span class="line">service/echo-v1                   ClusterIP      172.20.76.165    &lt;none&gt;                                                                         8080/TCP,80/TCP              2d21h</span><br><span class="line">service/echo-v2                   ClusterIP      172.20.198.164   &lt;none&gt;                                                                         8080/TCP,80/TCP              2d21h</span><br><span class="line">service/kong-proxy                LoadBalancer   172.20.113.185   a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com   80:31957/TCP,443:30218/TCP   2d21h</span><br><span class="line">service/kong-validation-webhook   ClusterIP      172.20.51.128    &lt;none&gt;                                                                         443/TCP                      2d21h</span><br><span class="line"></span><br><span class="line">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/echo           1/1     1            1           2d21h</span><br><span class="line">deployment.apps/ingress-kong   1/1     1            1           2d21h</span><br><span class="line"></span><br><span class="line">NAME                                     DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/echo-85fb7989cc          1         1         1       2d21h</span><br><span class="line">replicaset.apps/ingress-kong-d7b5d68f4   1         1         1       2d21h</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ k get kongingress</span><br><span class="line">NAME             AGE</span><br><span class="line">custom-ingress   2d21h</span><br><span class="line">custom-svc       2d21h</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ k get kongPlugin</span><br><span class="line">NAME              PLUGIN-TYPE            AGE</span><br><span class="line">rate-limit        rate-limiting          2d21h</span><br><span class="line">request-id        correlation-id         2d21h</span><br><span class="line">response-header   response-transformer   2d21h</span><br></pre></td></tr></table></figure><ul><li>测试ingress 规则注入<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 无注入访问/v1 和 /v2</span></span></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v2 -X POST -I</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/plain; charset=UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Date: Mon, 07 Dec 2020 03:53:09 GMT</span><br><span class="line">Server: echoserver</span><br><span class="line">X-Kong-Upstream-Latency: 0</span><br><span class="line">X-Kong-Proxy-Latency: 0</span><br><span class="line">Via: kong/2.0.5</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v1 -X POST -I</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/plain; charset=UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Date: Mon, 07 Dec 2020 03:53:16 GMT</span><br><span class="line">Server: echoserver</span><br><span class="line">X-Kong-Upstream-Latency: 0</span><br><span class="line">X-Kong-Proxy-Latency: 0</span><br><span class="line">Via: kong/2.0.5</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 注入ingress，限制请求方法为GET</span></span></span><br><span class="line">➜  kong git:(master) ✗ cat kongIngress/ingress.yaml</span><br><span class="line">apiVersion: configuration.konghq.com/v1</span><br><span class="line">kind: KongIngress</span><br><span class="line">metadata:</span><br><span class="line">  name: custom-ingress</span><br><span class="line">route:</span><br><span class="line">  methods:</span><br><span class="line">  - GET</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ k describe ingress demo</span><br><span class="line">Name:             demo</span><br><span class="line">Namespace:        kong</span><br><span class="line">Address:          a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com</span><br><span class="line">Default backend:  default-http-backend:80 (&lt;none&gt;)</span><br><span class="line">Rules:</span><br><span class="line">  Host  Path  Backends</span><br><span class="line">  ----  ----  --------</span><br><span class="line">  *</span><br><span class="line">        /v1   echo-v1:80 (10.200.1.88:8080)</span><br><span class="line">        /v2   echo-v2:80 (10.200.1.88:8080)</span><br><span class="line">Annotations:</span><br><span class="line">  konghq.com/override:                               custom-ingress</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v1 -X POST -I</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">Date: Mon, 07 Dec 2020 03:56:31 GMT</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 48</span><br><span class="line">X-Kong-Response-Latency: 1</span><br><span class="line">Server: kong/2.0.5</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v2 -X POST -I</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">Date: Mon, 07 Dec 2020 03:56:37 GMT</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 48</span><br><span class="line">X-Kong-Response-Latency: 0</span><br><span class="line">Server: kong/2.0.5</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v2 -X GET -I</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/plain; charset=UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Date: Mon, 07 Dec 2020 03:56:43 GMT</span><br><span class="line">Server: echoserver</span><br><span class="line">X-Kong-Upstream-Latency: 1</span><br><span class="line">X-Kong-Proxy-Latency: 0</span><br><span class="line">Via: kong/2.0.5</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v1 -X GET -I</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/plain; charset=UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Date: Mon, 07 Dec 2020 03:56:48 GMT</span><br><span class="line">Server: echoserver</span><br><span class="line">X-Kong-Upstream-Latency: 0</span><br><span class="line">X-Kong-Proxy-Latency: 0</span><br><span class="line">Via: kong/2.0.5</span><br></pre></td></tr></table></figure></li><li>测试svc 规则注入<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">➜  kong git:(master) ✗ cat kongIngress/ingress.yaml</span><br><span class="line">apiVersion: configuration.konghq.com/v1</span><br><span class="line">kind: KongIngress</span><br><span class="line">metadata:</span><br><span class="line">  name: custom-svc</span><br><span class="line">proxy:</span><br><span class="line">  path: /foo/</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ k describe svc echo-v1 echo-v2</span><br><span class="line">Name:              echo-v1</span><br><span class="line">Namespace:         kong</span><br><span class="line">Labels:            app=echo</span><br><span class="line">Annotations:       konghq.com/override: custom-svc</span><br><span class="line">                   kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                     &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Service&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&quot;configuration.konghq.com&quot;:&quot;custom-svc&quot;&#125;,&quot;labels&quot;:&#123;&quot;app&quot;:&quot;echo&quot;&#125;,&quot;name&quot;:&quot;ec...</span><br><span class="line">Selector:          app=echo</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                172.20.76.165</span><br><span class="line">Port:              high  8080/TCP</span><br><span class="line">TargetPort:        8080/TCP</span><br><span class="line">Endpoints:         10.200.1.88:8080</span><br><span class="line">Port:              low  80/TCP</span><br><span class="line">TargetPort:        8080/TCP</span><br><span class="line">Endpoints:         10.200.1.88:8080</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Name:              echo-v2</span><br><span class="line">Namespace:         kong</span><br><span class="line">Labels:            app=echo</span><br><span class="line">Annotations:       kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                     &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Service&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;app&quot;:&quot;echo&quot;&#125;,&quot;name&quot;:&quot;echo-v2&quot;,&quot;namespace&quot;:&quot;kong&quot;&#125;,&quot;spec&quot;:&#123;&quot;por...</span><br><span class="line">Selector:          app=echo</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                172.20.198.164</span><br><span class="line">Port:              high  8080/TCP</span><br><span class="line">TargetPort:        8080/TCP</span><br><span class="line">Endpoints:         10.200.1.88:8080</span><br><span class="line">Port:              low  80/TCP</span><br><span class="line">TargetPort:        8080/TCP</span><br><span class="line">Endpoints:         10.200.1.88:8080</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 测试</span></span></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v1 -X GET</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hostname: echo-85fb7989cc-pmjq7</span><br><span class="line"></span><br><span class="line">Pod Information:</span><br><span class="line">node name:ip-10-200-1-155.ap-northeast-1.compute.internal</span><br><span class="line">pod name:echo-85fb7989cc-pmjq7</span><br><span class="line">pod namespace:kong</span><br><span class="line">pod IP:10.200.1.88</span><br><span class="line"></span><br><span class="line">Server values:</span><br><span class="line">server_version=nginx: 1.12.2 - lua: 10010</span><br><span class="line"></span><br><span class="line">Request Information:</span><br><span class="line">client_address=10.200.1.189</span><br><span class="line">method=GET</span><br><span class="line">real path=/foo/v1</span><br><span class="line">query=</span><br><span class="line">request_version=1.1</span><br><span class="line">request_scheme=http</span><br><span class="line">request_uri=http://a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com:8080/foo/v1</span><br><span class="line"></span><br><span class="line">Request Headers:</span><br><span class="line">accept=*/*</span><br><span class="line">connection=keep-alive</span><br><span class="line">host=a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com</span><br><span class="line">user-agent=curl/7.54.0</span><br><span class="line">x-forwarded-for=10.200.2.91</span><br><span class="line">x-forwarded-host=a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com</span><br><span class="line">x-forwarded-port=8000</span><br><span class="line">x-forwarded-proto=http</span><br><span class="line">x-real-ip=10.200.2.91</span><br><span class="line"></span><br><span class="line">Request Body:</span><br><span class="line">-no body in request-</span><br><span class="line"></span><br><span class="line">➜  kong git:(master) ✗ curl a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com/v2 -X GET</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hostname: echo-85fb7989cc-pmjq7</span><br><span class="line"></span><br><span class="line">Pod Information:</span><br><span class="line">node name:ip-10-200-1-155.ap-northeast-1.compute.internal</span><br><span class="line">pod name:echo-85fb7989cc-pmjq7</span><br><span class="line">pod namespace:kong</span><br><span class="line">pod IP:10.200.1.88</span><br><span class="line"></span><br><span class="line">Server values:</span><br><span class="line">server_version=nginx: 1.12.2 - lua: 10010</span><br><span class="line"></span><br><span class="line">Request Information:</span><br><span class="line">client_address=10.200.1.189</span><br><span class="line">method=GET</span><br><span class="line">real path=/v2</span><br><span class="line">query=</span><br><span class="line">request_version=1.1</span><br><span class="line">request_scheme=http</span><br><span class="line">request_uri=http://a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com:8080/v2</span><br><span class="line"></span><br><span class="line">Request Headers:</span><br><span class="line">accept=*/*</span><br><span class="line">connection=keep-alive</span><br><span class="line">host=a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com</span><br><span class="line">user-agent=curl/7.54.0</span><br><span class="line">x-forwarded-for=10.200.1.234</span><br><span class="line">x-forwarded-host=a7a642206e35c414d8c7be4330144b8f-1688272697.ap-northeast-1.elb.amazonaws.com</span><br><span class="line">x-forwarded-port=8000</span><br><span class="line">x-forwarded-proto=http</span><br><span class="line">x-real-ip=10.200.1.234</span><br><span class="line"></span><br><span class="line">Request Body:</span><br><span class="line">-no body in request-</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Kong-Ingress&quot;&gt;&lt;a href=&quot;#Kong-Ingress&quot; class=&quot;headerlink&quot; title=&quot;Kong Ingress&quot;&gt;&lt;/a&gt;Kong Ingress&lt;/h2&gt;&lt;p&gt;项目地址：&lt;a href=&quot;https://github.c
      
    
    </summary>
    
    
      <category term="kong" scheme="https://www.xiemx.com/categories/kong/"/>
    
      <category term="ingress" scheme="https://www.xiemx.com/categories/kong/ingress/"/>
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/kong/ingress/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="ingress" scheme="https://www.xiemx.com/tags/ingress/"/>
    
      <category term="kong" scheme="https://www.xiemx.com/tags/kong/"/>
    
  </entry>
  
  <entry>
    <title>kong 学习随记</title>
    <link href="https://www.xiemx.com//2020/11/02/kong-notebook/"/>
    <id>https://www.xiemx.com//2020/11/02/kong-notebook/</id>
    <published>2020-11-02T02:52:00.000Z</published>
    <updated>2020-12-14T06:37:28.246Z</updated>
    
    <content type="html"><![CDATA[<h4 id="模式"><a href="#模式" class="headerlink" title="模式"></a>模式</h4><ul><li>db</li><li>dbless</li></ul><hr><h4 id="install"><a href="#install" class="headerlink" title="install"></a>install</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name kong \</span><br><span class="line">     -v &quot;kong.yaml:/usr/local/kong/declarative&quot; \</span><br><span class="line">     -e &quot;KONG_DATABASE=off&quot; \</span><br><span class="line">     -e &quot;KONG_DECLARATIVE_CONFIG=/usr/local/kong/declarative/kong.yml&quot; \</span><br><span class="line">     -e &quot;KONG_PROXY_ACCESS_LOG=/dev/stdout&quot; \</span><br><span class="line">     -e &quot;KONG_ADMIN_ACCESS_LOG=/dev/stdout&quot; \</span><br><span class="line">     -e &quot;KONG_PROXY_ERROR_LOG=/dev/stderr&quot; \</span><br><span class="line">     -e &quot;KONG_ADMIN_ERROR_LOG=/dev/stderr&quot; \</span><br><span class="line">     -e &quot;KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl&quot; \</span><br><span class="line">     -p 8000:8000 \</span><br><span class="line">     -p 8443:8443 \</span><br><span class="line">     -p 8001:8001 \</span><br><span class="line">     -p 8444:8444 \</span><br><span class="line">     kong:latest</span><br></pre></td></tr></table></figure><ul><li>plugins –&gt; module</li><li>comsumer –&gt; 消费者目前只看到用作auth认证用</li><li>services –&gt; upstream</li><li>routes –&gt; server</li></ul><hr><h4 id="debug-模式"><a href="#debug-模式" class="headerlink" title="debug 模式"></a>debug 模式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;X-Kong-Debug: 1&quot; http://localhost:8000</span><br></pre></td></tr></table></figure><h4 id="注入环境变量"><a href="#注入环境变量" class="headerlink" title="注入环境变量"></a>注入环境变量</h4><p>从配置文件中加载属性时，Kong还将寻找同名的环境变量。声明前缀<code>KONG_</code>并大写可以覆盖默认配置。<br>example:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="builtin-name">export</span> <span class="attribute">KONG_DATABASE</span>=off</span><br><span class="line">使用dbless 模式启动kong</span><br></pre></td></tr></table></figure><h4 id="注入nginx变量"><a href="#注入nginx变量" class="headerlink" title="注入nginx变量"></a>注入nginx变量</h4><p>前缀为的条目<code>nginx_http_</code>将注入到整体http 块指令中。</p><p>前缀为的条目<code>nginx_proxy_</code>将注入到server处理Kong代理端口的block指令中。</p><p>前缀为的条目<code>nginx_admin_</code>将注入到server处理Kong的Admin API端口的block指令中。</p><p>example：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="builtin-name">export</span> <span class="attribute">KONG_NGINX_HTTP_OUTPUT_BUFFERS</span>=<span class="string">&quot;4 64k&quot;</span></span><br><span class="line"></span><br><span class="line">将会在nginx的http 代码段中加入一条 </span><br><span class="line"><span class="attribute">output_buffers</span>=<span class="string">&quot;4 64k&quot;</span></span><br></pre></td></tr></table></figure><hr><h4 id="HOST传递"><a href="#HOST传递" class="headerlink" title="HOST传递"></a>HOST传递</h4><p><code>preserve_host: true</code> 将会传递request原始的host，相当于<code>proxy_set_header host $host</code></p><p>expamle:</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">services</span>:</span><br><span class="line">- <span class="attribute">name</span>: test</span><br><span class="line">  <span class="attribute">preserve_host</span>: true</span><br><span class="line">  <span class="attribute">url</span>: <span class="attribute">http</span>:<span class="comment">//mockbin.org</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h4 id="request-header区分路由"><a href="#request-header区分路由" class="headerlink" title="request header区分路由"></a>request header区分路由</h4><p>注意：headers键是逻辑键AND，其值是逻辑键OR。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;x.t.xiemx.com&quot;</span>]</span><br><span class="line">  <span class="attr">headers:</span> &#123; <span class="attr">&quot;version&quot;:</span> [<span class="string">&quot;v1&quot;</span>,<span class="string">&quot;v2&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">➜</span>  <span class="string">Documents</span> <span class="string">curl</span> <span class="string">localhost:8000</span> <span class="string">-H</span> <span class="string">version:v1</span> <span class="string">-H</span> <span class="string">host:x.t.xiemx.com</span> <span class="string">-I</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/html;</span> <span class="string">charset=utf-8</span></span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">10695</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">Cowboy</span></span><br><span class="line"><span class="attr">Etag:</span> <span class="string">W/&quot;29c7-XG+PICJmz/J+UYWt5gkKqqAUXjc&quot;</span></span><br><span class="line"><span class="attr">Vary:</span> <span class="string">Accept-Encoding</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Fri,</span> <span class="number">03</span> <span class="string">Jan</span> <span class="number">2020 03:19:08 </span><span class="string">GMT</span></span><br><span class="line"><span class="attr">Via:</span> <span class="string">kong/1.4.2</span></span><br><span class="line"><span class="attr">X-Kong-Upstream-Status:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">X-Kong-Upstream-Latency:</span> <span class="number">517</span></span><br><span class="line"><span class="attr">X-Kong-Proxy-Latency:</span> <span class="number">34</span></span><br><span class="line"><span class="attr">Kong-Cloud-Request-ID:</span> <span class="string">eeb277b4d0df3eb242e92dc0c669f8bc</span></span><br><span class="line"></span><br><span class="line"><span class="string">➜</span>  <span class="string">Documents</span> <span class="string">curl</span> <span class="string">localhost:8000</span> <span class="string">-H</span> <span class="string">version:v2</span> <span class="string">-H</span> <span class="string">host:x.t.xiemx.com</span> <span class="string">-I</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/html;</span> <span class="string">charset=utf-8</span></span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">10695</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">Cowboy</span></span><br><span class="line"><span class="attr">Etag:</span> <span class="string">W/&quot;29c7-XG+PICJmz/J+UYWt5gkKqqAUXjc&quot;</span></span><br><span class="line"><span class="attr">Vary:</span> <span class="string">Accept-Encoding</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Fri,</span> <span class="number">03</span> <span class="string">Jan</span> <span class="number">2020 03:19:17 </span><span class="string">GMT</span></span><br><span class="line"><span class="attr">Via:</span> <span class="string">kong/1.4.2</span></span><br><span class="line"><span class="attr">X-Kong-Upstream-Status:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">X-Kong-Upstream-Latency:</span> <span class="number">566</span></span><br><span class="line"><span class="attr">X-Kong-Proxy-Latency:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">Kong-Cloud-Request-ID:</span> <span class="string">f3eaf8e27f3d3f9510f1c0c4619df035</span></span><br><span class="line"></span><br><span class="line"><span class="string">➜</span>  <span class="string">Documents</span> <span class="string">curl</span> <span class="string">localhost:8000</span> <span class="string">-H</span> <span class="string">version:v3</span> <span class="string">-H</span> <span class="string">host:x.t.xiemx.com</span> <span class="string">-I</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">404</span> <span class="string">Not</span> <span class="string">Found</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Fri,</span> <span class="number">03</span> <span class="string">Jan</span> <span class="number">2020 03:19:23 </span><span class="string">GMT</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">application/json;</span> <span class="string">charset=utf-8</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">48</span></span><br><span class="line"><span class="attr">X-Kong-Response-Latency:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">kong/1.4.2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h4 id="path优先级"><a href="#path优先级" class="headerlink" title="path优先级"></a>path优先级</h4><ul><li>用路径前缀代理时，最长的路径将首先被评估</li><li>regex_priority 优先级</li></ul><h4 id="src-dest-ip白名单"><a href="#src-dest-ip白名单" class="headerlink" title="src/dest ip白名单"></a>src/dest ip白名单</h4><p>sources/destinations路由属性仅适用于TCP和TLS路线。它允许通过传入连接IP、网段或端口源的列表来匹配路由</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">service:</span> <span class="string">TCPService</span></span><br><span class="line"><span class="attr">protocols:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">tls</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tcp</span></span><br><span class="line"><span class="attr">sources:</span> </span><br><span class="line">  <span class="bullet">-</span> &#123; <span class="attr">ip:</span> <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span><span class="string">/32</span>, <span class="attr">port:</span> <span class="number">1234</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br><span class="line"><span class="attr">destinations:</span></span><br><span class="line">  <span class="bullet">-</span> &#123; <span class="attr">ip:</span> <span class="number">2.2</span><span class="number">.2</span><span class="number">.2</span><span class="string">/32</span>, <span class="attr">port:</span> <span class="number">1234</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br></pre></td></tr></table></figure><h4 id="strip-path-转发时删除路径"><a href="#strip-path-转发时删除路径" class="headerlink" title="strip_path 转发时删除路径"></a>strip_path 转发时删除路径</h4><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;paths&quot;</span>: [<span class="string">&quot;/service&quot;</span>],</span><br><span class="line">    <span class="string">&quot;strip_path&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">request_url -&gt; <span class="regexp">/service/</span><span class="number">1</span>/</span><br><span class="line">proxy_url -&gt; <span class="regexp">/1/</span></span><br></pre></td></tr></table></figure><hr><h3 id="Kong-proxy时默认处理的HEADER"><a href="#Kong-proxy时默认处理的HEADER" class="headerlink" title="Kong proxy时默认处理的HEADER"></a>Kong proxy时默认处理的HEADER</h3><ul><li>Host: <your_upstream_host></li><li>Connection: keep-alive，以允许重用上游连接。</li><li>X-Real-IP: <remote_addr>，其中<code>$remote_addr</code>变量的名称与ngx_http_core_module提供的名称相同。<code>$remote_addr</code>可能被ngx_http_realip_module覆盖。</li><li>X-Forwarded-For: <ip>, 访问路径。</li><li>X-Forwarded-Proto: <protocol>，客户端使用的协议。使用ngx_http_core_module <code>$scheme</code>提供的变量的值。</li><li>X-Forwarded-Host: <host>，客户端发送的主机名。</li><li>X-Forwarded-Port: <port>，服务器的端口。使用ngx_http_core_module <code>$server_port</code>变量的值。</li></ul><hr><h3 id="Kong-Response-headers"><a href="#Kong-Response-headers" class="headerlink" title="Kong Response headers"></a>Kong Response headers</h3><p>nginx 接收到upstream 的响应只会执行header-filter阶段将下面的header封装进header，后续会在执行body—filter阶段</p><ul><li>Via: kong/x.x.x，x.x.x使用的Kong版本在哪里</li><li>X-Kong-Proxy-Latency: <latency>，Kong从客户端接收请求到将请求发送到上游服务之间的时间（以毫秒为单位）。</li><li>X-Kong-Upstream-Latency: <latency>，Kong等待上游服务响应的第一个字节的时间（以毫秒为单位）。</li></ul><hr><h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><ul><li><h4 id="DNS负载均衡-ttl-0"><a href="#DNS负载均衡-ttl-0" class="headerlink" title="DNS负载均衡(ttl=0)"></a>DNS负载均衡(ttl=0)</h4><ul><li>SRV record</li><li>A record</li><li>CNAME record</li></ul><p><strong>优先级：</strong></p><ul><li>LAST(最后一次成功的类型) -&gt; SRV -&gt; A -&gt; CNAME</li><li>可以在Kong的配置文件中修改,默认<code>dns_order:LAST,SRV,A,CNAME</code></li></ul><p><strong>问题：</strong></p><ul><li>DNS可能不会返回所有的记录，导致下游服务器负载不均衡</li></ul></li><li><h4 id="Ring-balancer"><a href="#Ring-balancer" class="headerlink" title="Ring-balancer"></a>Ring-balancer</h4><ul><li><p>upstream</p><ul><li>service中host=”upstream_name”使用的名字，使用方法同nginx类似</li><li>upstream 需要预先分配一个slots，target会根据weight分配到slots上，默认upstream的slots=10000，范围（1 - 65536）。</li><li>插槽数越多，随机分布越好，但是更改的开销就越大（添加/删除目标）</li><li>当插槽数量更改时，将需要重建</li><li>which can be overwritten before proxying, using upstream’s property <code>host_header</code></li></ul></li><li><p>target</p><ul><li>实际upstream中使用的主机地址，等同于nginx upstream中的server指令，支持定义<code>weight</code></li><li>当target使用域名时，会将域名进行解析，然后将每条记录都设置到slots上，切遵循DNS TTL过期时间，去重复查询</li><li>如果存在SRV记录，会优先使用SRV 记录的weight/port</li></ul></li></ul></li><li><h4 id="负载均衡算法"><a href="#负载均衡算法" class="headerlink" title="负载均衡算法"></a>负载均衡算法</h4><ul><li><p>HASH（如下hash key）</p><ul><li>none 不使用哈希，而采用weighted-round-robin（默认值）。</li><li>cookie</li><li>ip</li><li>header</li><li>consumer</li></ul></li><li><p>WRR(weighted-round-robin)</p></li></ul><p><strong>PS</strong>: upstream 中的target 如未指定port则使用requst 请求中的port 不会使用，service中定义的port</p></li></ul><hr><h3 id="健康检测"><a href="#健康检测" class="headerlink" title="健康检测"></a>健康检测</h3><ul><li><p>active<br>主动发出http/https request轮询target</p></li><li><p>passive<br>分析backend response的状态码，不需要指定URL等参数</p><p>PS: interval=0时禁止，healthcheck可以同时开启被动检测，已实现断路功能，并开启主动检测中的unhealthcheck实现target故障自愈后自动加入</p></li></ul><hr><h3 id="kong-cluster"><a href="#kong-cluster" class="headerlink" title="kong cluster"></a>kong cluster</h3><ul><li><p>集群之间的节点流量不会自动负载均衡，需要在node前面有一个负载均衡器</p></li><li><p>由于性能的原因，node不会在proxy流量时去链接PG，而是将数据cache在内存中，多node集群中需要保证节点的数据同步更新</p><ul><li>db_update_frequency: 5 #node节点去db中同步数据的间隔，数据刷新间隔</li><li>db_update_propagation: 0 #如果后端是分布式数据库的话，则需要配置这个值。此值应该等于分布式数据库内部传播数据最终达到数据一致的时间。如果设置这个值，数据库更新时间将会为<code>db_update_frequency + db_update_propagation</code>，并且设置的节点也会等待一个propagation时间再去update cache</li><li>db_cache_ttl: 0 #防止invalid event事件node没有接收到而错过更新，可以设置一个主动过期时间</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;模式&quot;&gt;&lt;a href=&quot;#模式&quot; class=&quot;headerlink&quot; title=&quot;模式&quot;&gt;&lt;/a&gt;模式&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;db&lt;/li&gt;
&lt;li&gt;dbless&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h4 id=&quot;install&quot;&gt;&lt;a href=&quot;#in
      
    
    </summary>
    
    
      <category term="kong" scheme="https://www.xiemx.com/categories/kong/"/>
    
    
      <category term="kong" scheme="https://www.xiemx.com/tags/kong/"/>
    
  </entry>
  
  <entry>
    <title>aws alb ingress controller</title>
    <link href="https://www.xiemx.com//2020/10/03/kong-ingress/"/>
    <id>https://www.xiemx.com//2020/10/03/kong-ingress/</id>
    <published>2020-10-03T02:52:00.000Z</published>
    <updated>2020-12-14T06:37:28.246Z</updated>
    
    <content type="html"><![CDATA[<h2 id="AWS-alb-ingress-controller"><a href="#AWS-alb-ingress-controller" class="headerlink" title="AWS-alb-ingress-controller"></a>AWS-alb-ingress-controller</h2><p>项目：<a href="https://github.com/kubernetes-sigs/aws-load-balancer-controller">https://github.com/kubernetes-sigs/aws-load-balancer-controller</a></p><p><img src="/images/aws-alb-ingress-controller.jpg" alt="aws-alb-ingress-controller"></p><ul><li><strong>步骤1</strong>: controller 监听api-services的event事件,当发现 Ingress 资源满足要求，则将开始创建 AWS 资源。</li><li><strong>步骤2</strong>: 为 Ingress 资源创建 ALB</li><li><strong>步骤3</strong>: 为 Ingress 资源中指定的每个后端创建目标组</li><li><strong>步骤4</strong>: 为 Ingress 资源注释中指定的每个端口创建侦听器</li><li><strong>步骤5</strong>: 为 Ingress 资源中指定的每个路径创建规则<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a><strong>注意</strong></h4><ul><li>ingress-controller 需要有权限访问aws创建资源，具体权限可参考：<code>iam-policy.json</code>。本例子中直接对eks worknode role进行授权。理论上也可以进行OIDC接入aws iam针对于pod级别进行权限管理（未测试）。</li><li>确保ingress annotation的资源存在，否则创建会失败，具体可看pod日志。</li><li><code>service</code> 的type为 <code>nodeport</code>。</li></ul></li></ul><hr><h3 id="Install-controller"><a href="#Install-controller" class="headerlink" title="Install controller"></a>Install controller</h3><details><summary>rbac+sa+ns.yaml</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">alb-ingress</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alb-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">alb-ingress-controller</span></span><br></pre></td></tr></table></figure></details><details><summary>controller.yaml</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line">  <span class="comment"># Namespace the ALB Ingress Controller should run in. Does not impact which</span></span><br><span class="line">  <span class="comment"># namespaces it&#x27;s able to resolve ingress resource for. For limiting ingress</span></span><br><span class="line">  <span class="comment"># namespace scope, see --watch-namespace.</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">alb-ingress-controller</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">            <span class="comment"># Limit the namespace where this ALB Ingress Controller deployment will</span></span><br><span class="line">            <span class="comment"># resolve ingress resources. If left commented, all namespaces are used.</span></span><br><span class="line">            <span class="comment"># - --watch-namespace=uat</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Setting the ingress-class flag below ensures that only ingress resources with the</span></span><br><span class="line">            <span class="comment"># annotation kubernetes.io/ingress.class: &quot;alb&quot; are respected by the controller. You may</span></span><br><span class="line">            <span class="comment"># choose any class you&#x27;d like for this controller to respect.</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--ingress-class=alb</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Name of your cluster. Used when naming resources created</span></span><br><span class="line">            <span class="comment"># by the ALB Ingress Controller, providing distinction between</span></span><br><span class="line">            <span class="comment"># clusters.</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--cluster-name=aux-eks</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># AWS VPC ID this ingress controller will use to create AWS resources.</span></span><br><span class="line">            <span class="comment"># If unspecified, it will be discovered from ec2metadata.</span></span><br><span class="line">            <span class="comment"># - --aws-vpc-id=vpc-xxxxxx</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># AWS region this ingress controller will operate in.</span></span><br><span class="line">            <span class="comment"># If unspecified, it will be discovered from ec2metadata.</span></span><br><span class="line">            <span class="comment"># List of regions: http://docs.aws.amazon.com/general/latest/gr/rande.html#vpc_region</span></span><br><span class="line">            <span class="comment"># - --aws-region=us-west-1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Enables logging on all outbound requests sent to the AWS API.</span></span><br><span class="line">            <span class="comment"># If logging is desired, set to true.</span></span><br><span class="line">            <span class="comment"># - ---aws-api-debug</span></span><br><span class="line">            <span class="comment"># Maximum number of times to retry the aws calls.</span></span><br><span class="line">            <span class="comment"># defaults to 10.</span></span><br><span class="line">            <span class="comment"># - --aws-max-retries=10</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="comment"># AWS key id for authenticating with the AWS API.</span></span><br><span class="line">            <span class="comment"># This is only here for examples. It&#x27;s recommended you instead use</span></span><br><span class="line">            <span class="comment"># a project like kube2iam for granting access.</span></span><br><span class="line">            <span class="comment">#- name: AWS_ACCESS_KEY_ID</span></span><br><span class="line">            <span class="comment">#  value: KEYVALUE</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># AWS key secret for authenticating with the AWS API.</span></span><br><span class="line">            <span class="comment"># This is only here for examples. It&#x27;s recommended you instead use</span></span><br><span class="line">            <span class="comment"># a project like kube2iam for granting access.</span></span><br><span class="line">            <span class="comment">#- name: AWS_SECRET_ACCESS_KEY</span></span><br><span class="line">            <span class="comment">#  value: SECRETVALUE</span></span><br><span class="line">          <span class="comment"># Repository location of the ALB Ingress Controller.</span></span><br><span class="line">          <span class="attr">image:</span> <span class="number">894847497797.</span><span class="string">dkr.ecr.us-west-2.amazonaws.com/aws-alb-ingress-controller:v1.0.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">          <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">alb-ingress</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">alb-ingress</span></span><br></pre></td></tr></table></figure></details><details><summary>iam-policy.json</summary><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Action&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;acm:DescribeCertificate&quot;</span>,</span><br><span class="line">        <span class="string">&quot;acm:ListCertificates&quot;</span>,</span><br><span class="line">        <span class="string">&quot;acm:GetCertificate&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span>: <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Action&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;ec2:AuthorizeSecurityGroupIngress&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ec2:CreateSecurityGroup&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ec2:CreateTags&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ec2:DeleteTags&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ec2:DeleteSecurityGroup&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ec2:DescribeInstances&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ec2:DescribeInstanceStatus&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ec2:DescribeSecurityGroups&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ec2:DescribeSubnets&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ec2:DescribeTags&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ec2:DescribeVpcs&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ec2:ModifyInstanceAttribute&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ec2:ModifyNetworkInterfaceAttribute&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ec2:RevokeSecurityGroupIngress&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span>: <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Action&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:AddTags&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:CreateListener&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:CreateLoadBalancer&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:CreateRule&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:CreateTargetGroup&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:DeleteListener&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:DeleteLoadBalancer&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:DeleteRule&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:DeleteTargetGroup&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:DeregisterTargets&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:DescribeListeners&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:DescribeLoadBalancers&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:DescribeLoadBalancerAttributes&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:DescribeRules&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:DescribeSSLPolicies&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:DescribeTags&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:DescribeTargetGroups&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:DescribeTargetGroupAttributes&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:DescribeTargetHealth&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:ModifyListener&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:ModifyLoadBalancerAttributes&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:ModifyRule&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:ModifyTargetGroup&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:ModifyTargetGroupAttributes&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:RegisterTargets&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:RemoveTags&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:SetIpAddressType&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:SetSecurityGroups&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:SetSubnets&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticloadbalancing:SetWebACL&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span>: <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Action&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;iam:GetServerCertificate&quot;</span>,</span><br><span class="line">        <span class="string">&quot;iam:ListServerCertificates&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span>: <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Action&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;waf-regional:GetWebACLForResource&quot;</span>,</span><br><span class="line">        <span class="string">&quot;waf-regional:GetWebACL&quot;</span>,</span><br><span class="line">        <span class="string">&quot;waf-regional:AssociateWebACL&quot;</span>,</span><br><span class="line">        <span class="string">&quot;waf-regional:DisassociateWebACL&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span>: <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Action&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;tag:GetResources&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tag:TagResources&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span>: <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Action&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;waf:GetWebACL&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span>: <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><details><summary>ingress.yaml</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/actions.ssl-redirect:</span> <span class="string">&#x27;&#123;&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;:</span></span><br><span class="line"><span class="string">      &#123; &quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;&#125;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/certificate-arn:</span> <span class="string">arn:aws:acm:ap-northeast-1:xxxxxxxxx:certificate/281bee29-717c-4b50-bf8e-41a39748c548</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/listen-ports:</span> <span class="string">&#x27;[&#123;&quot;HTTP&quot;: 80, &quot;HTTPS&quot;: 443&#125;]&#x27;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/scheme:</span> <span class="string">internet-facing</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/subnets:</span> <span class="string">subnet-32ce5544,</span> <span class="string">subnet-41cf6c19</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/security-groups:</span> <span class="string">sg-018347dc7a3ade5a2</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">alb</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">xiemx-web-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.xiemx.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">echo-v1</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&#x27;*.xiemx.com&#x27;</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">ssl-redirect</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="string">use-annotation</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/*</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">echo-v1</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/*</span></span><br></pre></td></tr></table></figure></details><hr><h4 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h4><ul><li>创建<code>alb-ingress-controller</code><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">➜  aws-alb-ingress-controller git:(master) ✗ k get all</span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/alb-ingress-controller-9596b67b9-d7p69   1/1     Running   0          80d</span><br><span class="line"></span><br><span class="line">NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/alb-ingress-controller   1/1     1            1           361d</span><br><span class="line"></span><br><span class="line">NAME                                               DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/alb-ingress-controller-9596b67b9   1         1         1       361d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">➜  aws-alb-ingress-controller git:(master) ✗ k logs -f pod/alb-ingress-controller-9596b67b9-d7p69</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">AWS ALB Ingress controller</span><br><span class="line">  Release:    v1.0.0</span><br><span class="line">  Build:      git-c25bc6c5</span><br><span class="line">  Repository: https://github.com/kubernetes-sigs/aws-alb-ingress-controller</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">W0917 09:50:21.934737       1 client_config.go:552] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.</span><br><span class="line">I0917 09:50:21.990251       1 :0] kubebuilder/controller &quot;level&quot;=0 &quot;msg&quot;=&quot;Starting EventSource&quot;  &quot;Controller&quot;=&quot;alb-ingress-controller&quot; &quot;Source&quot;=&#123;&quot;Type&quot;:&#123;&quot;metadata&quot;:&#123;&quot;creationTimestamp&quot;:null&#125;,&quot;spec&quot;:&#123;&#125;,&quot;status&quot;:&#123;&quot;loadBalancer&quot;:&#123;&#125;&#125;&#125;&#125;</span><br><span class="line">I0917 09:50:21.990434       1 :0] kubebuilder/controller &quot;level&quot;=0 &quot;msg&quot;=&quot;Starting EventSource&quot;  &quot;Controller&quot;=&quot;alb-ingress-controller&quot; &quot;Source&quot;=&#123;&quot;Type&quot;:&#123;&quot;metadata&quot;:&#123;&quot;creationTimestamp&quot;:null&#125;,&quot;spec&quot;:&#123;&#125;,&quot;status&quot;:&#123;&quot;loadBalancer&quot;:&#123;&#125;&#125;&#125;&#125;</span><br><span class="line">I0917 09:50:21.990555       1 :0] kubebuilder/controller &quot;level&quot;=0 &quot;msg&quot;=&quot;Starting EventSource&quot;  &quot;Controller&quot;=&quot;alb-ingress-controller&quot; &quot;Source&quot;=&#123;&quot;Type&quot;:&#123;&quot;metadata&quot;:&#123;&quot;creationTimestamp&quot;:null&#125;&#125;&#125;</span><br><span class="line">I0917 09:50:21.990841       1 :0] kubebuilder/controller &quot;level&quot;=0 &quot;msg&quot;=&quot;Starting EventSource&quot;  &quot;Controller&quot;=&quot;alb-ingress-controller&quot; &quot;Source&quot;=&#123;&quot;Type&quot;:&#123;&quot;metadata&quot;:&#123;&quot;creationTimestamp&quot;:null&#125;,&quot;spec&quot;:&#123;&#125;,&quot;status&quot;:&#123;&quot;daemonEndpoints&quot;:&#123;&quot;kubeletEndpoint&quot;:&#123;&quot;Port&quot;:0&#125;&#125;,&quot;nodeInfo&quot;:&#123;&quot;machineID&quot;:&quot;&quot;,&quot;systemUUID&quot;:&quot;&quot;,&quot;bootID&quot;:&quot;&quot;,&quot;kernelVersion&quot;:&quot;&quot;,&quot;osImage&quot;:&quot;&quot;,&quot;containerRuntimeVersion&quot;:&quot;&quot;,&quot;kubeletVersion&quot;:&quot;&quot;,&quot;kubeProxyVersion&quot;:&quot;&quot;,&quot;operatingSystem&quot;:&quot;&quot;,&quot;architecture&quot;:&quot;&quot;&#125;&#125;&#125;&#125;</span><br><span class="line">I0917 09:50:21.993054       1 leaderelection.go:185] attempting to acquire leader lease  alb-ingress-controller/ingress-controller-leader-alb...</span><br><span class="line">I0917 09:50:38.515944       1 leaderelection.go:194] successfully acquired lease alb-ingress-controller/ingress-controller-leader-alb</span><br><span class="line">I0917 09:50:38.716164       1 :0] kubebuilder/controller &quot;level&quot;=0 &quot;msg&quot;=&quot;Starting Controller&quot;  &quot;Controller&quot;=&quot;alb-ingress-controller&quot;</span><br><span class="line">I0917 09:50:38.816322       1 :0] kubebuilder/controller &quot;level&quot;=0 &quot;msg&quot;=&quot;Starting workers&quot;  &quot;Controller&quot;=&quot;alb-ingress-controller&quot; &quot;WorkerCount&quot;=1</span><br></pre></td></tr></table></figure></li><li>创建<code>ingress</code>测试<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">➜  aws-alb-ingress-controller git:(master) ✗ k get ingress</span><br><span class="line">NAME                HOSTS                       ADDRESS                                                                      PORTS   AGE</span><br><span class="line">xiemx-web-ingress   www.xiemx.com,*.xiemx.com   71a14391-albingresscontrol-2ac6-648325502.ap-northeast-1.elb.amazonaws.com   80      14m</span><br><span class="line">➜  aws-alb-ingress-controller git:(master) ✗ curl 71a14391-albingresscontrol-2ac6-648325502.ap-northeast-1.elb.amazonaws.com -H host:www.xiemx.com -I</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Mon, 07 Dec 2020 06:39:29 GMT</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Server: echoserver</span><br><span class="line"></span><br><span class="line">➜  aws-alb-ingress-controller git:(master) ✗ curl 71a14391-albingresscontrol-2ac6-648325502.ap-northeast-1.elb.amazonaws.com -H host:www.xiemx.com -i</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Mon, 07 Dec 2020 06:39:37 GMT</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Server: echoserver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hostname: echo-85fb7989cc-d556c</span><br><span class="line"></span><br><span class="line">Pod Information:</span><br><span class="line">node name:ip-10-200-2-113.ap-northeast-1.compute.internal</span><br><span class="line">pod name:echo-85fb7989cc-d556c</span><br><span class="line">pod namespace:alb-ingress-controller</span><br><span class="line">pod IP:10.200.2.197</span><br><span class="line"></span><br><span class="line">Server values:</span><br><span class="line">server_version=nginx: 1.12.2 - lua: 10010</span><br><span class="line"></span><br><span class="line">Request Information:</span><br><span class="line">client_address=10.200.2.21</span><br><span class="line">method=GET</span><br><span class="line">real path=/</span><br><span class="line">query=</span><br><span class="line">request_version=1.1</span><br><span class="line">request_scheme=http</span><br><span class="line">request_uri=http://www.xiemx.com:8080/</span><br><span class="line"></span><br><span class="line">Request Headers:</span><br><span class="line">accept=*/*</span><br><span class="line">host=www.xiemx.com</span><br><span class="line">user-agent=curl/7.54.0</span><br><span class="line">x-amzn-trace-id=Root=1-5fcdce29-473e8ac375ce203f4961bec3</span><br><span class="line">x-forwarded-for=101.231.43.114</span><br><span class="line">x-forwarded-port=80</span><br><span class="line">x-forwarded-proto=http</span><br><span class="line"></span><br><span class="line">Request Body:</span><br><span class="line">-no body in request-</span><br><span class="line"></span><br><span class="line">➜  aws-alb-ingress-controller git:(master) ✗ curl 71a14391-albingresscontrol-2ac6-648325502.ap-northeast-1.elb.amazonaws.com -H host:blog.xiemx.com -I</span><br><span class="line">HTTP/1.1 301 Moved Permanently</span><br><span class="line">Server: awselb/2.0</span><br><span class="line">Date: Mon, 07 Dec 2020 06:39:44 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 134</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: https://blog.xiemx.com:443/</span><br></pre></td></tr></table></figure></li><li><h3 id="aws-alb-规则"><a href="#aws-alb-规则" class="headerlink" title="aws alb 规则"></a>aws alb 规则</h3><img src="/images/aws-alb-ingress-ex1.jpg" alt="aws-alb-ingress-ex1"><br><img src="/images/aws-alb-ingress-ex2.jpg" alt="aws-alb-ingress-ex2"><br><img src="/images/aws-alb-ingress-ex3.jpg" alt="aws-alb-ingress-ex3"><br><img src="/images/aws-alb-ingress-ex4.jpg" alt="aws-alb-ingress-ex4"></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;AWS-alb-ingress-controller&quot;&gt;&lt;a href=&quot;#AWS-alb-ingress-controller&quot; class=&quot;headerlink&quot; title=&quot;AWS-alb-ingress-controller&quot;&gt;&lt;/a&gt;AWS-alb-
      
    
    </summary>
    
    
      <category term="ingress" scheme="https://www.xiemx.com/categories/ingress/"/>
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/ingress/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="aws" scheme="https://www.xiemx.com/tags/aws/"/>
    
      <category term="ingress" scheme="https://www.xiemx.com/tags/ingress/"/>
    
  </entry>
  
  <entry>
    <title>nginx/openresty 执行阶段</title>
    <link href="https://www.xiemx.com//2020/02/28/nginx-and-openresty-phases/"/>
    <id>https://www.xiemx.com//2020/02/28/nginx-and-openresty-phases/</id>
    <published>2020-02-27T17:12:43.000Z</published>
    <updated>2020-12-14T06:37:28.251Z</updated>
    
    <content type="html"><![CDATA[<h4 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h4><hr><p>nginx 官方文档：<a href="http://nginx.org/en/docs/dev/development_guide.html#http_phases">http://nginx.org/en/docs/dev/development_guide.html#http_phases</a></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">NGX_HTTP_POST_READ_PHASE</span>:</span><br><span class="line">接收完请求头之后的第一个阶段，ngx_http_realip_module 注册在这个阶段</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_SERVER_REWRITE_PHASE</span>:</span><br><span class="line">server级别的uri重写阶段， ngx_http_rewrite_module 注册在这个阶段</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_FIND_CONFIG_PHASE</span>:</span><br><span class="line">寻找location配置阶段，该阶段使用重写之后的uri来查找对应的location</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_REWRITE_PHASE</span>:</span><br><span class="line">location级别的uri重写阶段</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_POST_REWRITE_PHASE</span>:</span><br><span class="line">location级别重写的后一阶段，用来检查上阶段是否有uri重写，并根据结果跳转到合适的阶段</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_PREACCESS_PHASE</span>:</span><br><span class="line">一般也用于访问控制，比如限制访问频率，并发等</span><br><span class="line">ngx_http_limit_conn_module/ngx_http_limit_req_module这两个模块注册在此阶段</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_ACCESS_PHASE</span>:</span><br><span class="line">访问权限控制阶段，比如基于ip黑白名单的权限控制，基于用户名密码的权限控制等， ngx_http_access_module/ngx_http_auth_basic_module 注册在此阶段</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_POST_ACCESS_PHASE</span>:</span><br><span class="line">问权限控制的后一阶段，该阶段根据权限控制阶段的执行结果进行相应处理 <span class="built_in">`satisfy`</span> 指令在此阶段生效。</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_TRY_FILES_PHASE</span>:</span><br><span class="line">try_files指令的处理阶段，如果没有配置try_files指令，则该阶段被跳过</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_CONTENT_PHASE</span>:</span><br><span class="line">内容生成阶段，该阶段产生响应，并发送到客户端</span><br><span class="line"></span><br><span class="line"><span class="attribute">NGX_HTTP_LOG_PHASE</span>:</span><br><span class="line">日志记录阶段，该阶段记录访问日志</span><br></pre></td></tr></table></figure><h4 id="openresty"><a href="#openresty" class="headerlink" title="openresty"></a>openresty</h4><hr><p>参考文档：<a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/ngx_lua/phase.html">https://moonbingbing.gitbooks.io/openresty-best-practices/content/ngx_lua/phase.html</a><br><img src="/images/openresty_phases.png" alt="phase"></p><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set<span class="number">_</span><span class="meta">by</span><span class="number">_</span>lua*: 流程分支处理判断变量初始化</span><br><span class="line">rewrite<span class="number">_</span><span class="meta">by</span><span class="number">_</span>lua*: 转发、重定向、缓存等功能(例如特定请求代理到外网)</span><br><span class="line">access<span class="number">_</span><span class="meta">by</span><span class="number">_</span>lua*: IP 准入、接口权限等情况集中处理(例如配合 iptable 完成简单防火墙)</span><br><span class="line">content<span class="number">_</span><span class="meta">by</span><span class="number">_</span>lua*: 内容生成</span><br><span class="line">header<span class="number">_f</span>ilter<span class="number">_</span><span class="meta">by</span><span class="number">_</span>lua*: 响应头部过滤处理(例如添加头部信息)</span><br><span class="line">body<span class="number">_f</span>ilter<span class="number">_</span><span class="meta">by</span><span class="number">_</span>lua*: 响应体过滤处理(例如完成应答内容统一成大写)</span><br><span class="line">log<span class="number">_</span><span class="meta">by</span><span class="number">_</span>lua*: 会话完成后本地异步完成日志记录(日志可以记录在本地，还可以同步到其他机器)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;nginx&quot;&gt;&lt;a href=&quot;#nginx&quot; class=&quot;headerlink&quot; title=&quot;nginx&quot;&gt;&lt;/a&gt;nginx&lt;/h4&gt;&lt;hr&gt;
&lt;p&gt;nginx 官方文档：&lt;a href=&quot;http://nginx.org/en/docs/dev/deve
      
    
    </summary>
    
    
      <category term="nginx" scheme="https://www.xiemx.com/categories/nginx/"/>
    
    
      <category term="nginx" scheme="https://www.xiemx.com/tags/nginx/"/>
    
      <category term="openresty" scheme="https://www.xiemx.com/tags/openresty/"/>
    
  </entry>
  
</feed>
