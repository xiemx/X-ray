<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>求索</title>
  
  <subtitle>尔不必求记，却宜求个明白！</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.xiemx.com/"/>
  <updated>2019-10-21T06:57:42.989Z</updated>
  <id>https://www.xiemx.com/</id>
  
  <author>
    <name>Mingxu.xie</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>k8s ingress-nginx动态balance实现解析</title>
    <link href="https://www.xiemx.com//2019/09/16/k8s-ingress-nginx/"/>
    <id>https://www.xiemx.com//2019/09/16/k8s-ingress-nginx/</id>
    <published>2019-09-15T23:09:52.000Z</published>
    <updated>2019-10-21T06:57:42.989Z</updated>
    
    <content type="html"><![CDATA[<p>只节选了比较关键的代码，删除了比较多的干扰项。纯属个人理解！！！</p><h4 id="1-初始化balancer-init-worker-，使用balancer-balance-动态获取"><a href="#1-初始化balancer-init-worker-，使用balancer-balance-动态获取" class="headerlink" title="1. 初始化balancer.init_worker()，使用balancer.balance()动态获取"></a>1. 初始化balancer.init_worker()，使用balancer.balance()动态获取</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">        lua_package_path <span class="string">"/etc/nginx/lua/?.lua;/etc/nginx/lua/vendor/?.lua;/usr/local/lib/lua/?.lua;;"</span>;</span><br><span class="line">        init_by_lua_block &#123;</span><br><span class="line">                ok, res = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">"configuration"</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        init_worker_by_lua_block &#123;</span><br><span class="line">                balancer.init_worker()  #####创建定时任务 ngx.timer.every(BACKENDS_SYNC_INTERVAL, sync_backends)</span><br><span class="line">        &#125;</span><br><span class="line">     </span><br><span class="line">###upstream configure</span><br><span class="line">upstream upstream_balancer &#123;</span><br><span class="line">server <span class="number">0.0</span><span class="number">.0</span><span class="number">.1</span>; # placeholder</span><br><span class="line"></span><br><span class="line">balancer_by_lua_block &#123;</span><br><span class="line">balancer.balance()</span><br><span class="line">&#125;</span><br><span class="line">keepalive <span class="number">32</span>;</span><br><span class="line">keepalive_timeout  <span class="number">60</span>s;</span><br><span class="line">keepalive_requests <span class="number">100</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-获取backend信息，balancer-init-worker"><a href="#2-获取backend信息，balancer-init-worker" class="headerlink" title="2. 获取backend信息，balancer.init_worker()"></a>2. 获取backend信息，balancer.init_worker()</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">####https://sourcegraph.com/github.com/kubernetes/ingress-nginx@dd0fe4b458cc5520f25eb8bba25bbe6f0c72ee98/-/blob/rootfs/etc/nginx/lua/balancer.lua?utm_source=share#L223</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> configuration = <span class="built_in">require</span>(<span class="string">"configuration"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_M.init_worker</span><span class="params">()</span></span></span><br><span class="line">  sync_backends() <span class="comment">-- when worker starts, sync backends without delay</span></span><br><span class="line">  <span class="keyword">local</span> _, err = ngx.timer.every(BACKENDS_SYNC_INTERVAL, sync_backends)</span><br><span class="line">  <span class="keyword">if</span> err <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ERR, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"error when setting up timer.every for sync_backends: %s"</span>, <span class="built_in">tostring</span>(err)))</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">sync_backends</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">local</span> backends_data = configuration.get_backends_data()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> new_backends, err = cjson.decode(backends_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> balancers_to_keep = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> _, new_backend <span class="keyword">in</span> <span class="built_in">ipairs</span>(new_backends) <span class="keyword">do</span></span><br><span class="line">    sync_backend(new_backend)</span><br><span class="line">    balancers_to_keep[new_backend.name] = balancers[new_backend.name]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">####https://sourcegraph.com/github.com/kubernetes/ingress-nginx@dd0fe4b458cc5520f25eb8bba25bbe6f0c72ee98/-/blob/rootfs/etc/nginx/lua/configuration.lua?utm_source=share#L10:<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> configuration_data = ngx.shared.configuration_data</span><br><span class="line"><span class="keyword">local</span> certificate_data = ngx.shared.certificate_data</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> _M = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_M.get_backends_data</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">return</span> configuration_data:get(<span class="string">"backends"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_M.call</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">if</span> ngx.var.request_method ~= <span class="string">"POST"</span> <span class="keyword">and</span> ngx.var.request_method ~= <span class="string">"GET"</span> <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">status</span> = ngx.HTTP_BAD_REQUEST</span><br><span class="line">    ngx.<span class="built_in">print</span>(<span class="string">"Only POST and GET requests are allowed!"</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ngx.var.request_uri == <span class="string">"/configuration/servers"</span> <span class="keyword">then</span></span><br><span class="line">    handle_servers()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ngx.var.request_uri == <span class="string">"/configuration/general"</span> <span class="keyword">then</span></span><br><span class="line">    handle_general()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ngx.var.uri == <span class="string">"/configuration/certs"</span> <span class="keyword">then</span></span><br><span class="line">    handle_certs()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ngx.var.request_uri ~= <span class="string">"/configuration/backends"</span> <span class="keyword">then</span> ####只接受以上<span class="number">4</span>类型URL</span><br><span class="line">    ngx.<span class="built_in">status</span> = ngx.HTTP_NOT_FOUND</span><br><span class="line">    ngx.<span class="built_in">print</span>(<span class="string">"Not found!"</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> backends = fetch_request_body()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> success, err = configuration_data:set(<span class="string">"backends"</span>, backends)</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">### fetch_request_body()，从此函数可以看出此函数是一个外部调用，可以得出原始的数据来源为外部触发的POST，可以查询Call()函数的引用位置</span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch_request_body</span><span class="params">()</span></span></span><br><span class="line">  ngx.req.read_body() ###防止ngx.req.get_body_data()返回<span class="literal">nil</span>,显示执行一下</span><br><span class="line">  <span class="keyword">local</span> body = ngx.req.get_body_data()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> body <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> file_name = ngx.req.get_body_file() ###读取cache file</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> file = <span class="built_in">io</span>.<span class="built_in">open</span>(file_name, <span class="string">"rb"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> file <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    body = file:<span class="built_in">read</span>(<span class="string">"*all"</span>)</span><br><span class="line">    file:<span class="built_in">close</span>()</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> body</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####nginx.conf 查看nginx配置文件中显示调用call()函数的位置为当前server切url /configuration 符合函数要求，在查找外部调用的代码（基本可以定位为控制器的逻辑控制）</span></span><br><span class="line">       <span class="built_in"> server </span>&#123;</span><br><span class="line">                listen unix:/tmp/nginx-status-server.sock;</span><br><span class="line">                <span class="builtin-name">set</span> <span class="variable">$proxy_upstream_name</span> <span class="string">"internal"</span>;</span><br><span class="line"></span><br><span class="line">                keepalive_timeout 0;</span><br><span class="line">                gzip off;</span><br><span class="line"></span><br><span class="line">                access_log off;</span><br><span class="line"></span><br><span class="line">                location /configuration &#123;</span><br><span class="line">                        # this should be equals <span class="keyword">to</span> configuration_data dict</span><br><span class="line">                        client_max_body_size                    10m;</span><br><span class="line">                        client_body_buffer_size                 10m;</span><br><span class="line">                        proxy_buffering                         off;</span><br><span class="line"></span><br><span class="line">                        content_by_lua_block &#123;</span><br><span class="line">                                configuration.call()</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure><h4 id="3-通过上面的信息检索，在Ingress中监听pod变化信息，动态调用-configuration-backends-函数为configureBackends"><a href="#3-通过上面的信息检索，在Ingress中监听pod变化信息，动态调用-configuration-backends-函数为configureBackends" class="headerlink" title="3. 通过上面的信息检索，在Ingress中监听pod变化信息，动态调用/configuration/backends, 函数为configureBackends()"></a>3. 通过上面的信息检索，在Ingress中监听pod变化信息，动态调用/configuration/backends, 函数为configureBackends()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">####https:<span class="comment">//github.com/kubernetes/ingress-nginx/blob/ce3e3d51c397ff6a0cd6731cc64360ecdb69ea54/internal/ingress/controller/nginx.go#L982</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">configureBackends</span><span class="params">(rawBackends []*ingress.Backend)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">backends := <span class="built_in">make</span>([]*ingress.Backend, <span class="built_in">len</span>(rawBackends))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, backend := <span class="keyword">range</span> rawBackends &#123;</span><br><span class="line"><span class="keyword">var</span> service *apiv1.Service</span><br><span class="line"><span class="keyword">if</span> backend.Service != <span class="literal">nil</span> &#123;</span><br><span class="line">service = &amp;apiv1.Service&#123;Spec: backend.Service.Spec&#125;</span><br><span class="line">&#125;</span><br><span class="line">luaBackend := &amp;ingress.Backend&#123;</span><br><span class="line">Name:                 backend.Name,</span><br><span class="line">Port:                 backend.Port,</span><br><span class="line">SSLPassthrough:       backend.SSLPassthrough,</span><br><span class="line">SessionAffinity:      backend.SessionAffinity,</span><br><span class="line">UpstreamHashBy:       backend.UpstreamHashBy,</span><br><span class="line">LoadBalancing:        backend.LoadBalancing,</span><br><span class="line">Service:              service,</span><br><span class="line">NoServer:             backend.NoServer,</span><br><span class="line">TrafficShapingPolicy: backend.TrafficShapingPolicy,</span><br><span class="line">AlternativeBackends:  backend.AlternativeBackends,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> endpoints []ingress.Endpoint</span><br><span class="line"><span class="keyword">for</span> _, endpoint := <span class="keyword">range</span> backend.Endpoints &#123;</span><br><span class="line">endpoints = <span class="built_in">append</span>(endpoints, ingress.Endpoint&#123;</span><br><span class="line">Address: endpoint.Address,</span><br><span class="line">Port:    endpoint.Port,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">luaBackend.Endpoints = endpoints</span><br><span class="line">backends[i] = luaBackend</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">statusCode, _, err := nginx.NewPostStatusRequest(<span class="string">"/configuration/backends"</span>, <span class="string">"application/json"</span>, backends) ####backends 为request.body,却内容为IP/PORT，以下给出了backend的<span class="keyword">struct</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> statusCode != http.StatusCreated &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"unexpected error code: %d"</span>, statusCode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">####Backend <span class="keyword">struct</span></span><br><span class="line"><span class="keyword">type</span> Backend <span class="keyword">struct</span> &#123;</span><br><span class="line">Name    <span class="keyword">string</span>             <span class="string">`json:"name"`</span></span><br><span class="line">Service *apiv1.Service     <span class="string">`json:"service,omitempty"`</span></span><br><span class="line">Port    intstr.IntOrString <span class="string">`json:"port"`</span></span><br><span class="line">SecureCACert resolver.AuthSSLCert <span class="string">`json:"secureCACert"`</span></span><br><span class="line">SSLPassthrough <span class="keyword">bool</span> <span class="string">`json:"sslPassthrough"`</span></span><br><span class="line">Endpoints []Endpoint <span class="string">`json:"endpoints,omitempty"`</span></span><br><span class="line">SessionAffinity SessionAffinityConfig <span class="string">`json:"sessionAffinityConfig"`</span></span><br><span class="line">UpstreamHashBy UpstreamHashByConfig <span class="string">`json:"upstreamHashByConfig,omitempty"`</span></span><br><span class="line">LoadBalancing <span class="keyword">string</span> <span class="string">`json:"load-balance,omitempty"`</span></span><br><span class="line">NoServer <span class="keyword">bool</span> <span class="string">`json:"noServer"`</span></span><br><span class="line">TrafficShapingPolicy TrafficShapingPolicy <span class="string">`json:"trafficShapingPolicy,omitempty"`</span></span><br><span class="line">AlternativeBackends []<span class="keyword">string</span> <span class="string">`json:"alternativeBackends,omitempty"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-ngx-balancer-set-current-peer-设置backend信息"><a href="#4-ngx-balancer-set-current-peer-设置backend信息" class="headerlink" title="4. ngx_balancer.set_current_peer()设置backend信息"></a>4. ngx_balancer.set_current_peer()设置backend信息</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">####https://sourcegraph.com/github.com/kubernetes/ingress-nginx@dd0fe4b458cc5520f25eb8bba25bbe6f0c72ee98/-/blob/rootfs/etc/nginx/lua/balancer.lua?utm_source=share#L232:<span class="number">13</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_M.balance</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">local</span> balancer = get_balancer()</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> balancer <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> peer = balancer:balance()</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> peer <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.WARN, <span class="string">"no peer was returned, balancer: "</span> .. balancer.name)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  ngx_balancer.set_more_tries(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> ok, err = ngx_balancer.set_current_peer(peer) ####设置server信息</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ERR, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"error while setting current upstream peer %s: %s"</span>, peer, err))</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">get_balancer</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">if</span> ngx.ctx.balancer <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> ngx.ctx.balancer</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> backend_name = ngx.var.proxy_upstream_name ###获取当前request上下文中共享的变量proxy_upstream_name</span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> balancer = balancers[backend_name] ###获取balancers信息由sync_backend()函数定时轮询</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> balancer <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> route_to_alternative_balancer(balancer) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> alternative_backend_name = balancer.alternative_backends[<span class="number">1</span>]</span><br><span class="line">    ngx.var.proxy_alternative_upstream_name = alternative_backend_name</span><br><span class="line"></span><br><span class="line">    balancer = balancers[alternative_backend_name]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  ngx.ctx.balancer = balancer</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> balancer</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###nginx.conf</span></span><br><span class="line"><span class="attribute">set</span> <span class="variable">$proxy_upstream_name</span>    <span class="string">"dev-dev-auto-deploy-5000"</span>;</span><br><span class="line"><span class="attribute">set</span> <span class="variable">$proxy_host</span>             <span class="variable">$proxy_upstream_name</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://upstream_balancer;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;只节选了比较关键的代码，删除了比较多的干扰项。纯属个人理解！！！&lt;/p&gt;
&lt;h4 id=&quot;1-初始化balancer-init-worker-，使用balancer-balance-动态获取&quot;&gt;&lt;a href=&quot;#1-初始化balancer-init-worker-，使用b
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="ingress" scheme="https://www.xiemx.com/tags/ingress/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL查看复制状态</title>
    <link href="https://www.xiemx.com//2019/07/08/postgresql-replica-status/"/>
    <id>https://www.xiemx.com//2019/07/08/postgresql-replica-status/</id>
    <published>2019-07-08T03:07:36.000Z</published>
    <updated>2019-10-19T09:40:34.388Z</updated>
    
    <content type="html"><![CDATA[<h4 id="postgresql查看复制状态，master上执行"><a href="#postgresql查看复制状态，master上执行" class="headerlink" title="postgresql查看复制状态，master上执行"></a>postgresql查看复制状态，master上执行</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#select * from pg_stat_replication; </span></span><br><span class="line">postgres=<span class="comment"># select * from pg_stat_replication;</span></span><br><span class="line">-[ RECORD 1 ]<span class="comment">----+------------------------------</span></span><br><span class="line">pid              | 13321</span><br><span class="line">usesysid         | 17019</span><br><span class="line">usename          | replication</span><br><span class="line">application_name | walreceiver</span><br><span class="line">client_addr      | 10.0.0.81</span><br><span class="line">client_hostname  | </span><br><span class="line">client_port      | 42809</span><br><span class="line">backend_start    | 2016-08-11 10:57:35.856289+08</span><br><span class="line">backend_xmin     | </span><br><span class="line">state            | streaming <span class="comment">--同步状态</span></span><br><span class="line">sent_location    | 1/E0CE9750</span><br><span class="line">write_location   | 1/E0CE9750</span><br><span class="line">flush_location   | 1/E0CE9750</span><br><span class="line">replay_location  | 1/E0CE9750</span><br><span class="line">sync_priority    | 0</span><br><span class="line">sync_state       | async  <span class="comment">--同步模式</span></span><br><span class="line"></span><br><span class="line">state: 同步状态</span><br><span class="line">    streaming : 同步</span><br><span class="line">    startup : 连接中</span><br><span class="line">    catchup: 同步中</span><br><span class="line"></span><br><span class="line">sync_state: 同步模式.</span><br><span class="line">    async : 异步</span><br><span class="line">    sync : 同步</span><br><span class="line">    potential: 虽然现在是异步,但有可能提升到同步</span><br></pre></td></tr></table></figure><h4 id="查看复制的延迟有多少，字节单位，master上执行"><a href="#查看复制的延迟有多少，字节单位，master上执行" class="headerlink" title="查看复制的延迟有多少，字节单位，master上执行"></a>查看复制的延迟有多少，字节单位，master上执行</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#select pg_xlog_location_diff(sent_location, replay_location) from pg_stat_replication; </span></span><br><span class="line"></span><br><span class="line">posrgresql=<span class="comment"># select pg_xlog_location_diff(sent_location, replay_location) from pg_stat_replication; </span></span><br><span class="line"> pg_xlog_location_diff </span><br><span class="line"><span class="comment">-----------------------</span></span><br><span class="line">                      0</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><h4 id="slave上查看sql滞后时间"><a href="#slave上查看sql滞后时间" class="headerlink" title="slave上查看sql滞后时间"></a>slave上查看sql滞后时间</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> pg_last_xlog_receive_location() = pg_last_xlog_replay_location()</span><br><span class="line">    <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">ELSE</span> <span class="keyword">EXTRACT</span> (EPOCH <span class="keyword">FROM</span> <span class="keyword">now</span>() - pg_last_xact_replay_timestamp())</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> log_delay;</span><br><span class="line"></span><br><span class="line">postgres=<span class="comment"># SELECT CASE WHEN pg_last_xlog_receive_location() = pg_last_xlog_replay_location()</span></span><br><span class="line">postgres-<span class="comment">#     THEN 0</span></span><br><span class="line">postgres-<span class="comment">#     ELSE EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp())</span></span><br><span class="line">postgres-<span class="comment">#     END AS log_delay;</span></span><br><span class="line"> log_delay</span><br><span class="line"><span class="comment">-----------</span></span><br><span class="line">         0</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><h4 id="slave上查看是否处于recovery模式"><a href="#slave上查看是否处于recovery模式" class="headerlink" title="slave上查看是否处于recovery模式"></a>slave上查看是否处于recovery模式</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pg_is_in_recovery();</span><br><span class="line">postgres=<span class="comment"># select pg_is_in_recovery();</span></span><br><span class="line"> pg_is_in_recovery</span><br><span class="line"><span class="comment">-------------------</span></span><br><span class="line"> t</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><h4 id="slave上查看最新的reploy时间戳"><a href="#slave上查看最新的reploy时间戳" class="headerlink" title="slave上查看最新的reploy时间戳"></a>slave上查看最新的reploy时间戳</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#select pg_last_xact_replay_timestamp();</span></span><br><span class="line">postgres=<span class="comment"># select pg_last_xact_replay_timestamp();</span></span><br><span class="line"> pg_last_xact_replay_timestamp</span><br><span class="line"><span class="comment">-------------------------------</span></span><br><span class="line"> 2019-07-08 03:01:33.854131+00</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><h4 id="slave上查看最新的reploy位置"><a href="#slave上查看最新的reploy位置" class="headerlink" title="slave上查看最新的reploy位置"></a>slave上查看最新的reploy位置</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#select pg_last_xlog_replay_location();</span></span><br><span class="line">postgres=<span class="comment"># select pg_last_xlog_replay_location();</span></span><br><span class="line"> pg_last_xlog_replay_location</span><br><span class="line"><span class="comment">------------------------------</span></span><br><span class="line"> 220C/56EB4C10</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;postgresql查看复制状态，master上执行&quot;&gt;&lt;a href=&quot;#postgresql查看复制状态，master上执行&quot; class=&quot;headerlink&quot; title=&quot;postgresql查看复制状态，master上执行&quot;&gt;&lt;/a&gt;postgres
      
    
    </summary>
    
    
      <category term="postgresql" scheme="https://www.xiemx.com/categories/postgresql/"/>
    
    
      <category term="database" scheme="https://www.xiemx.com/tags/database/"/>
    
      <category term="postgresql" scheme="https://www.xiemx.com/tags/postgresql/"/>
    
  </entry>
  
  <entry>
    <title>http cache</title>
    <link href="https://www.xiemx.com//2019/05/13/http-cache/"/>
    <id>https://www.xiemx.com//2019/05/13/http-cache/</id>
    <published>2019-05-13T03:05:02.000Z</published>
    <updated>2019-10-21T06:57:42.935Z</updated>
    
    <content type="html"><![CDATA[<h4 id="cache流程图"><a href="#cache流程图" class="headerlink" title="cache流程图"></a><strong>cache流程图</strong></h4><p><img src="/images/image.png" alt="img"></p><h3 id="“no-cache”和“no-store”"><a href="#“no-cache”和“no-store”" class="headerlink" title="“no-cache”和“no-store”"></a>“no-cache”和“no-store”</h3><p>“no-cache”表示必须先与服务器确认返回的响应是否发生了变化，然后才能使用该响应来满足后续对同一网址的请求。 因此，如果存在合适的验证令牌 (ETag)，no-cache 会发起往返通信来验证缓存的响应，但如果资源未发生变化，则可避免下载。</p><p>“no-store”禁止浏览器以及所有中间缓存存储任何版本的返回响应，例如，包含个人隐私数据或银行业务数据的响应。 每次用户请求该资产时，都会向服务器发送请求，并下载完整的响应。</p><h3 id="“public”与-“private”"><a href="#“public”与-“private”" class="headerlink" title="“public”与 “private”"></a>“public”与 “private”</h3><p>“public”则即使它有关联的 HTTP 身份验证，甚至响应状态代码通常无法缓存，也可以缓存响应。 大多数情况下，“public”不是必需的，因为明确的缓存信息（例如“max-age”）已表示响应是可以缓存的。</p><p>“private”浏览器可以缓存响应，不允许任何中间缓存对其进行缓存。 例如，用户的浏览器可以缓存包含用户私人信息的 HTML 网页，但 CDN 却不能缓存。</p><h3 id="“max-age”"><a href="#“max-age”" class="headerlink" title="“max-age”"></a>“max-age”</h3><p>指令指定从请求的时间开始，允许提取的响应被重用的最长时间（单位：秒）。 例如，“max-age=60”表示可在接下来的 60 秒缓存和重用响应。</p><h2 id="通过-ETag-验证缓存的响应"><a href="#通过-ETag-验证缓存的响应" class="headerlink" title="通过 ETag 验证缓存的响应"></a>通过 ETag 验证缓存的响应</h2><p>在首次请求资源时服务器生成并返回”ETag” http请求头(通常是文件内容的哈希值或某个其他指纹)。 当120 秒后，浏览器又对该资源发起了新的请求。 首先，浏览器会检查本地缓存并找到之前的响应。如果发现缓存超过max-age, 浏览器将发起一个带有”If-None-Match”的http请求。 如果Etag相同，则返回304，使用本地缓存。</p><p><img src="/images/http-cache-control.png" alt="HTTP Cache-Control 示例"></p><p>参考： <a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching" target="_blank" rel="noopener">https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;cache流程图&quot;&gt;&lt;a href=&quot;#cache流程图&quot; class=&quot;headerlink&quot; title=&quot;cache流程图&quot;&gt;&lt;/a&gt;&lt;strong&gt;cache流程图&lt;/strong&gt;&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;/images/image.png&quot; 
      
    
    </summary>
    
    
      <category term="http" scheme="https://www.xiemx.com/categories/http/"/>
    
    
      <category term="http" scheme="https://www.xiemx.com/tags/http/"/>
    
      <category term="cache" scheme="https://www.xiemx.com/tags/cache/"/>
    
  </entry>
  
  <entry>
    <title>Mysqldump error</title>
    <link href="https://www.xiemx.com//2019/05/06/mysqldump-error/"/>
    <id>https://www.xiemx.com//2019/05/06/mysqldump-error/</id>
    <published>2019-05-06T03:05:56.000Z</published>
    <updated>2019-10-19T10:22:28.240Z</updated>
    
    <content type="html"><![CDATA[<h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@FCHK-instance ~]# mysqldump <span class="comment">--host rm-xxxxxxxxxxx.mysql.rds.aliyuncs.com -u xxxx -p --databases visa &gt; hk.sql</span></span><br><span class="line">Enter password:</span><br><span class="line"><span class="literal">Warning</span>: A partial dump from a server that has GTIDs will by <span class="keyword">default</span> include the GTIDs <span class="keyword">of</span> <span class="keyword">all</span> transactions, even those that changed suppressed parts <span class="keyword">of</span> the database. <span class="keyword">If</span> you don<span class="symbol">'t</span> want <span class="keyword">to</span> restore GTIDs, pass <span class="comment">--set-gtid-purged=OFF. To make a complete dump, pass --all-databases --triggers --routines --events.</span></span><br><span class="line">mysqldump: Couldn<span class="symbol">'t</span> execute <span class="symbol">'SELECT</span> COLUMN_NAME,                       JSON_EXTRACT(HISTOGRAM, '$.<span class="string">"number-of-buckets-specified"</span>')                FROM information_schema.COLUMN_STATISTICS                WHERE SCHEMA_NAME = <span class="symbol">'visa</span>' <span class="keyword">AND</span> TABLE_NAME = <span class="symbol">'admin</span>';': Unknown table <span class="symbol">'column_statistics</span>' <span class="keyword">in</span> information_schema (<span class="number">1109</span></span><br></pre></td></tr></table></figure><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@FCHK-instance ~]# mysql <span class="comment">--version</span></span><br><span class="line">mysql  Ver <span class="number">8.0</span><span class="number">.11</span> <span class="keyword">for</span> Linux <span class="keyword">on</span> x86_64 (MySQL Community <span class="keyword">Server</span> - GPL)</span><br><span class="line"></span><br><span class="line">可能是由于mysqldump <span class="number">8</span>中默认启用（COLUMN_STATISTICS）</span><br><span class="line"></span><br><span class="line">官方文档解释</span><br><span class="line">Mysql <span class="number">8.0</span> The INFORMATION_SCHEMA COLUMN_STATISTICS <span class="keyword">Table</span></span><br><span class="line">https://dev.mysql.com/doc/refman/<span class="number">8.0</span>/en/<span class="keyword">column</span>-<span class="keyword">statistics</span>-<span class="keyword">table</span>.html</span><br></pre></td></tr></table></figure><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@FCHK-instance ~]# mysqldump <span class="comment">--host rm-xxxxxxxxxx2.mysql.rds.aliyuncs.com -u xxxx -p --databases visa --column-statistics=0 &gt; hk.sql</span></span><br><span class="line">Enter password:</span><br><span class="line"><span class="literal">Warning</span>: A partial dump from a server that has GTIDs will by <span class="keyword">default</span> include the GTIDs <span class="keyword">of</span> <span class="keyword">all</span> transactions, even those that changed suppressed parts <span class="keyword">of</span> the database. <span class="keyword">If</span> you don<span class="symbol">'t</span> want <span class="keyword">to</span> restore GTIDs, pass <span class="comment">--set-gtid-purged=OFF. To make a complete dump, pass --all-databases --triggers --routines --events.</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;现象&quot;&gt;&lt;a href=&quot;#现象&quot; class=&quot;headerlink&quot; title=&quot;现象&quot;&gt;&lt;/a&gt;现象&lt;/h3&gt;&lt;figure class=&quot;highlight vhdl&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span c
      
    
    </summary>
    
    
      <category term="mysql" scheme="https://www.xiemx.com/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://www.xiemx.com/tags/mysql/"/>
    
      <category term="debug" scheme="https://www.xiemx.com/tags/debug/"/>
    
      <category term="database" scheme="https://www.xiemx.com/tags/database/"/>
    
  </entry>
  
  <entry>
    <title>redis-dump使用</title>
    <link href="https://www.xiemx.com//2019/05/06/redis-dump/"/>
    <id>https://www.xiemx.com//2019/05/06/redis-dump/</id>
    <published>2019-05-06T03:05:33.000Z</published>
    <updated>2019-10-19T09:09:04.060Z</updated>
    
    <content type="html"><![CDATA[<ul><li>安装redis-dump/redis-load</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">需要ruby 2.2.2以上版本（可以直接使用ruby:2.2.3的docker images）</span></span><br><span class="line">gem install redis-dum</span><br></pre></td></tr></table></figure><ul><li><p>dump redis</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@5dba1bd8fa77:/# redis-dump -h</span><br><span class="line">  Try: /usr/local/bundle/bin/redis-dump show-commands</span><br><span class="line">Usage: /usr/local/bundle/bin/redis-dump [global options] COMMAND [command options]</span><br><span class="line">    -u, --uri=S                      Redis URI (e.g. redis://hostname[:port])</span><br><span class="line">    -d, --database=S                 Redis database (e.g. -d 15)</span><br><span class="line">    -a, --password=S                 Redis password (e.g. -a 'my@pass/word')</span><br><span class="line">    -s, --sleep=S                    Sleep for S seconds after dumping (for debugging)</span><br><span class="line">    -c, --count=S                    Chunk size (default: 10000)</span><br><span class="line">    -f, --filter=S                   Filter selected keys (passed directly to redis' KEYS command)</span><br><span class="line">    -b, --base64                     Encode key values as base64 (useful for binary values)</span><br><span class="line">    -O, --without_optimizations      Disable run time optimizations</span><br><span class="line">    -V, --version                    Display version</span><br><span class="line">    -D, --debug</span><br><span class="line">        --nosafe</span><br><span class="line"></span><br><span class="line">root@5dba1bd8fa77:/# redis-dump -u aux-redis.1uvkyf.0001.cnn1.cache.amazonaws.com.cn &gt; redis-uat.json</span><br></pre></td></tr></table></figure></li><li><p>load redis</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@5dba1bd8fa77:/# redis-load -h</span><br><span class="line">  Try: /usr/local/bundle/bin/redis-load show-commands</span><br><span class="line">Usage: /usr/local/bundle/bin/redis-load [global options] COMMAND [command options]</span><br><span class="line">    -u, --uri=S                      Redis URI (e.g. redis://hostname[:port])</span><br><span class="line">    -d, --database=S                 Redis database (e.g. -d 15)</span><br><span class="line">    -a, --password=S                 Redis password (e.g. -a 'my@pass/word')</span><br><span class="line">    -s, --sleep=S                    Sleep for S seconds after dumping (for debugging)</span><br><span class="line">    -b, --base64                     Decode key values from base64 (used with redis-dump -b)</span><br><span class="line">    -n, --no_check_utf8</span><br><span class="line">    -V, --version                    Display version</span><br><span class="line">    -D, --debug</span><br><span class="line">        --nosafe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@5dba1bd8fa77:/# redis-load -u aux-redis.1uvkyf.0001.cnn1.cache.amazonaws.com.cn:6379/0 &lt; redis-uat.json</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;安装redis-dump/redis-load&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;b
      
    
    </summary>
    
    
      <category term="redis" scheme="https://www.xiemx.com/categories/redis/"/>
    
    
      <category term="redis" scheme="https://www.xiemx.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>SSH的AuthorizedKeysCommand、AuthorizedKeysCommandUser</title>
    <link href="https://www.xiemx.com//2019/05/06/ssh-authorizedkeyscommand/"/>
    <id>https://www.xiemx.com//2019/05/06/ssh-authorizedkeyscommand/</id>
    <published>2019-05-06T03:05:17.000Z</published>
    <updated>2019-10-21T06:57:43.061Z</updated>
    
    <content type="html"><![CDATA[<ul><li>AuthorizedKeysCommand 可以指定运行一个脚本，而这个脚本主要是寻找登录用户的publickey，默认传参为登录用户名，若未认证成功，将继续使用AuthorizedKeysFile文件来做认证。</li><li>AuthorizedKeysCommandUser就是指定以什么用户来运行这个脚本。 这两个配置选项的一个用处就是在用户管理上可以不再依靠本地管理，而可以通过脚本读取远程数据库系统中的用户的publickey进行认证，例如MySQL或者LDAP，这样的话，更便于用户的集中管理。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;AuthorizedKeysCommand 可以指定运行一个脚本，而这个脚本主要是寻找登录用户的publickey，默认传参为登录用户名，若未认证成功，将继续使用AuthorizedKeysFile文件来做认证。&lt;/li&gt;
&lt;li&gt;AuthorizedKeysC
      
    
    </summary>
    
    
      <category term="linux" scheme="https://www.xiemx.com/categories/linux/"/>
    
    
      <category term="linux" scheme="https://www.xiemx.com/tags/linux/"/>
    
      <category term="ssh" scheme="https://www.xiemx.com/tags/ssh/"/>
    
  </entry>
  
  <entry>
    <title>通过lambda修改AWS CloudFront回源host</title>
    <link href="https://www.xiemx.com//2018/10/11/aws-edge-lambda-modify-origin-host/"/>
    <id>https://www.xiemx.com//2018/10/11/aws-edge-lambda-modify-origin-host/</id>
    <published>2018-10-10T19:10:17.000Z</published>
    <updated>2019-10-21T06:57:43.061Z</updated>
    
    <content type="html"><![CDATA[<p>在使用aws cloudfront时发现cloudfront默认不允许自定义回源请求头的Host字段，对于一些情况我们需要使用这个host+ip来回源的时候就有点坑了，这个时候我们可以通过使用aws的lambda@edge，去修改request的header来实现自定义host来回源。</p><p>aws lambda@edge文档：<a href="https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/lambda-edge.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/lambda-edge.html</a></p><ol><li>在创建lambda函数，并发布一个版本注意只能在us-east-1这个区创建，否则在附加到cloudfront的时候会报错不支持的区域，代码如下</li></ol><p><img src="/images/img_5bbef98529a61.png" alt="img"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// force a specific Host header to be sent to the origin</span></span><br><span class="line"></span><br><span class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> request = event.Records[<span class="number">0</span>].cf.request;</span><br><span class="line">    request.headers.host[<span class="number">0</span>].value = <span class="string">'www.xiemx.com'</span>;</span><br><span class="line">    <span class="keyword">return</span> callback(<span class="literal">null</span>, request);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol start="2"><li>在cloudfront的Behavior菜单中</li></ol><p><img src="/images/img_5bbefa0f833d9.png" alt="img"></p><ol start="3"><li>重新deploy cdn和刷新一次cdn缓存</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在使用aws cloudfront时发现cloudfront默认不允许自定义回源请求头的Host字段，对于一些情况我们需要使用这个host+ip来回源的时候就有点坑了，这个时候我们可以通过使用aws的lambda@edge，去修改request的header来实现自定义ho
      
    
    </summary>
    
    
      <category term="aws" scheme="https://www.xiemx.com/categories/aws/"/>
    
    
      <category term="aws" scheme="https://www.xiemx.com/tags/aws/"/>
    
      <category term="lambda" scheme="https://www.xiemx.com/tags/lambda/"/>
    
      <category term="cloudfront" scheme="https://www.xiemx.com/tags/cloudfront/"/>
    
  </entry>
  
  <entry>
    <title>SLB 502报错Debug</title>
    <link href="https://www.xiemx.com//2018/07/20/slb-502-debug/"/>
    <id>https://www.xiemx.com//2018/07/20/slb-502-debug/</id>
    <published>2018-07-19T18:07:06.000Z</published>
    <updated>2019-10-19T08:11:47.770Z</updated>
    
    <content type="html"><![CDATA[<p>用户自定义站点502问题分析</p><ol><li>现象：自定义域名用户反馈，打开网站返回502，如图</li></ol><p><img src="/images/img_5b5183b84d4dd.png" alt="img"></p><p> 根据response header判断，请求到达captain，怀疑captain返回的502页面。查看nginx proxy_pass得知后端的地址为bobcat.sxldns.com.</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">set</span> <span class="variable">$bobcat_backend</span> <span class="string">"bobcat.sxldns.com"</span>;</span><br><span class="line"><span class="attribute">proxy_pass</span> http://<span class="variable">$bobcat_backend</span>;</span><br></pre></td></tr></table></figure><p>使用curl模拟请求，直接请求bobcat.sxldns.com,正常获得返回内容，具体针对每个服务器的IP的curl,不再单独列出。</p><p><img src="/images/img_5b5184bfd49e3.png" alt="img"></p><p>通过上述返回基本判断，问题出在我们的代理层。具体查看代理层的nginx配置和系统资源利用率。</p><p>查看当时系统的资源状态,查看到当时的系统磁盘空间使用完。查看nginx上有关于proxy的cache相关配置,nginx会cache的response的content的内容。怀疑nginx转发请求之后但是backend返回内容后，nginx cache到本地的时候无法写入disk导致会话结束，SLB的请求无返回包认为后端宕机抛出502。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache_path /etc/nginx/china_cache <span class="attribute">levels</span>=1:2 <span class="attribute">keys_zone</span>=user_page_cache:100m <span class="attribute">max_size</span>=20g <span class="attribute">inactive</span>=60m <span class="attribute">use_temp_path</span>=off;</span><br></pre></td></tr></table></figure><p>具体DEBUG如下：</p><ol><li>获取container中的nginx worker进程的PID</li></ol><p><img src="/images/img_5b5184fb1c8d4.png" alt="img"></p><ol start="2"><li>strace查看下系统调用具体信息</li></ol><p><img src="/images/img_5b518515e4fe7.png" alt="img"></p><p>通过上图strace追踪流程可以看到左侧是一个正常的请求的全部流程，右侧是故障状态的strace的系统调用全流程。</p><p>通过对比左右两侧的系统调用流程可以看到，当nginx cache的时候写入<code>/etc/nginx/china_cache</code>目录时提示<code>no space</code>后续的writev()和sendfile()方法就没有调用，因此导致SLB无法获得返回包，抛出<code>badgateway</code>的错误.</p><p>PS：</p><ol><li>为什么单独请求返回头的时候正常返回？nginx返回请求头的时候并不会走proxy的cache流程。因此没有调用open()方法读写disk，正常返回，但是实际请求数据的时候cache写磁盘直接失败，后续直接退出。</li><li>上图的系统调用过程为了debug的方便使用了非折叠模式。因此一些no space的一些报错未显示出来可以。全部流程见附录。</li></ol><p>附录：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">1.异常调用堆栈</span><br><span class="line">[root@iZ2ze2mzhjk3ou1vsnkthzZ rpm]# strace -p 3904 -v</span><br><span class="line">strace: Process 3904 attached</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN, &#123;u32=69025808, u64=140003117973520&#125;&#125;], 512, -1) = 1</span><br><span class="line">accept4(6, &#123;sa_family=AF_INET, sin_port=htons(59464), sin_addr=inet_addr("10.130.0.4")&#125;, [16], SOCK_NONBLOCK) = 11</span><br><span class="line">epoll_ctl(8, EPOLL_CTL_ADD, 11, &#123;EPOLLIN|EPOLLRDHUP|EPOLLET, &#123;u32=69027249, u64=140003117974961&#125;&#125;) = 0</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN, &#123;u32=69027249, u64=140003117974961&#125;&#125;], 512, 60000) = 1</span><br><span class="line">recvfrom(11, "GET /?key=testxxxx HTTP/1.1<span class="symbol">\r</span><span class="symbol">\n</span>Use"..., 1024, 0, NULL, NULL) = 88</span><br><span class="line">epoll_ctl(8, EPOLL_CTL_MOD, 11, &#123;EPOLLIN|EPOLLOUT|EPOLLRDHUP|EPOLLET, &#123;u32=69027249, u64=140003117974961&#125;&#125;) = 0</span><br><span class="line">open("/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2", O_RDONLY|O_NONBLOCK) = 14</span><br><span class="line">fstat(14, &#123;st_dev=makedev(253, 1), st_ino=655502, st_mode=S_IFREG|0600, st_nlink=1, st_uid=101, st_gid=101, st_blksize=4096, st_blocks=96, st_size=46750, st_atime=2018/07/17-16:34:43.967698739, st_mtime=2018/07/17-16:34:43.966698736, st_ctime=2018/07/17-16:34:43.967698739&#125;) = 0</span><br><span class="line">pread64(14, "<span class="symbol">\5</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span>(<span class="symbol">\2</span>52M[<span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span>"..., 636, 0) = 636</span><br><span class="line">getsockname(11, &#123;sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr("172.17.0.2")&#125;, [16]) = 0</span><br><span class="line">sendto(13, "nN<span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 35, 0, NULL, 0) = 35</span><br><span class="line">sendto(13, "<span class="symbol">\3</span>75<span class="symbol">\2</span>15<span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 35, 0, NULL, 0) = 35</span><br><span class="line">epoll_wait(8, [&#123;EPOLLOUT, &#123;u32=69027249, u64=140003117974961&#125;&#125;, &#123;EPOLLIN, &#123;u32=69026288, u64=140003117974000&#125;&#125;], 512, 5000) = 2</span><br><span class="line">recvfrom(13, "nN<span class="symbol">\2</span>01<span class="symbol">\2</span>00<span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\3</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 4096, 0, NULL, NULL) = 147</span><br><span class="line">recvfrom(13, "<span class="symbol">\3</span>75<span class="symbol">\2</span>15<span class="symbol">\2</span>01<span class="symbol">\2</span>00<span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 4096, 0, NULL, NULL) = 168</span><br><span class="line">socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 15</span><br><span class="line">ioctl(15, FIONBIO, [1]) = 0</span><br><span class="line">epoll_ctl(8, EPOLL_CTL_ADD, 15, &#123;EPOLLIN|EPOLLOUT|EPOLLRDHUP|EPOLLET, &#123;u32=69027488, u64=140003117975200&#125;&#125;) = 0</span><br><span class="line">connect(15, &#123;sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr("54.222.148.216")&#125;, 16) = -1 EINPROGRESS (Operation now in progress)</span><br><span class="line">recvfrom(13, 0x7ffd1f603790, 4096, 0, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">epoll_wait(8, [&#123;EPOLLOUT, &#123;u32=69027488, u64=140003117975200&#125;&#125;], 512, 20000) = 1</span><br><span class="line">getsockopt(15, SOL_SOCKET, SO_ERROR, [0], [4]) = 0</span><br><span class="line">writev(15, [&#123;"GET /?key=testxxxx HTTP/1.0<span class="symbol">\r</span><span class="symbol">\n</span>Hos"..., 219&#125;], 1) = 219</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=69027488, u64=140003117975200&#125;&#125;], 512, 60000) = 1</span><br><span class="line">recvfrom(15, "HTTP/1.1 200 OK<span class="symbol">\r</span><span class="symbol">\n</span>Content-Type: t"..., 3723, 0, NULL, NULL) = 3723</span><br><span class="line">close(14) = 0</span><br><span class="line">readv(15, [&#123;"a.qnssl.com/images/265818/Fntncr"..., 4096&#125;], 1) = 4096</span><br><span class="line">readv(15, [&#123;"w-card-price&#123;color: #004aa0;&#125;.s-"..., 4096&#125;], 1) = 4096</span><br><span class="line">readv(15, [&#123;" &#123;<span class="symbol">\n</span> font-family: <span class="symbol">\"</span>Open Sans"..., 4096&#125;], 1) = 373</span><br><span class="line">open("/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2.0000014052", O_RDWR|O_CREAT|O_EXCL, 0600) = 14</span><br><span class="line">pwritev(14, [&#123;"<span class="symbol">\5</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\3</span>56<span class="symbol">\2</span>54M[<span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span>"..., 4096&#125;, &#123;"a.qnssl.com/images/265818/Fntncr"..., 4096&#125;, &#123;"w-card-price&#123;color: #004aa0;&#125;.s-"..., 4096&#125;], 3, 0) = -1 ENOSPC (No space left on device)</span><br><span class="line">gettid() = 7</span><br><span class="line">write(4, "2018/07/17 08:46:33 [crit] 7#7: "..., 328) = 328</span><br><span class="line">close(15) = 0</span><br><span class="line">unlink("/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2.0000014052") = 0</span><br><span class="line">write(5, "&#123; <span class="symbol">\"</span>time<span class="symbol">\"</span>: <span class="symbol">\"</span>2018-07-17T08:46:33+0"..., 382) = 382</span><br><span class="line">close(14) = 0</span><br><span class="line">close(11) = 0</span><br><span class="line"></span><br><span class="line">2.正常调用堆栈过程</span><br><span class="line">[root@iZ2ze2mzhjk3ou1vsnkthzZ rpm]# strace -p 3904 -v</span><br><span class="line">strace: Process 3904 attached</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN, &#123;u32=69025808, u64=140003117973520&#125;&#125;], 512, -1) = 1</span><br><span class="line">accept4(6, &#123;sa_family=AF_INET, sin_port=htons(59360), sin_addr=inet_addr("10.130.0.4")&#125;, [16], SOCK_NONBLOCK) = 11</span><br><span class="line">epoll_ctl(8, EPOLL_CTL_ADD, 11, &#123;EPOLLIN|EPOLLRDHUP|EPOLLET, &#123;u32=69027248, u64=140003117974960&#125;&#125;) = 0</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN, &#123;u32=69027248, u64=140003117974960&#125;&#125;], 512, 60000) = 1</span><br><span class="line">recvfrom(11, "GET /?key=testxxxx HTTP/1.1<span class="symbol">\r</span><span class="symbol">\n</span>Use"..., 1024, 0, NULL, NULL) = 88</span><br><span class="line">epoll_ctl(8, EPOLL_CTL_MOD, 11, &#123;EPOLLIN|EPOLLOUT|EPOLLRDHUP|EPOLLET, &#123;u32=69027248, u64=140003117974960&#125;&#125;) = 0</span><br><span class="line">open("/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2", O_RDONLY|O_NONBLOCK) = 14</span><br><span class="line">fstat(14, &#123;st_dev=makedev(253, 1), st_ino=655504, st_mode=S_IFREG|0600, st_nlink=1, st_uid=101, st_gid=101, st_blksize=4096, st_blocks=96, st_size=46750, st_atime=2018/07/17-16:14:38.127407158, st_mtime=2018/07/17-16:14:38.127407158, st_ctime=2018/07/17-16:14:38.128407161&#125;) = 0</span><br><span class="line">pread64(14, "<span class="symbol">\5</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span>s<span class="symbol">\2</span>45M[<span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span>"..., 636, 0) = 636</span><br><span class="line">getsockname(11, &#123;sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr("172.17.0.2")&#125;, [16]) = 0</span><br><span class="line">sendto(12, "<span class="symbol">\2</span>10V<span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 35, 0, NULL, 0) = 35</span><br><span class="line">sendto(12, "<span class="symbol">\2</span>7<span class="symbol">\1</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 35, 0, NULL, 0) = 35</span><br><span class="line">epoll_wait(8, [&#123;EPOLLOUT, &#123;u32=69027248, u64=140003117974960&#125;&#125;, &#123;EPOLLIN, &#123;u32=69027728, u64=140003117975440&#125;&#125;], 512, 5000) = 2</span><br><span class="line">recvfrom(12, "<span class="symbol">\2</span>10V<span class="symbol">\2</span>01<span class="symbol">\2</span>00<span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\3</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 4096, 0, NULL, NULL) = 147</span><br><span class="line">recvfrom(12, "<span class="symbol">\2</span>7<span class="symbol">\1</span><span class="symbol">\2</span>01<span class="symbol">\2</span>00<span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 4096, 0, NULL, NULL) = 168</span><br><span class="line">socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 15</span><br><span class="line">ioctl(15, FIONBIO, [1]) = 0</span><br><span class="line">epoll_ctl(8, EPOLL_CTL_ADD, 15, &#123;EPOLLIN|EPOLLOUT|EPOLLRDHUP|EPOLLET, &#123;u32=69027489, u64=140003117975201&#125;&#125;) = 0</span><br><span class="line">connect(15, &#123;sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr("52.80.58.42")&#125;, 16) = -1 EINPROGRESS (Operation now in progress)</span><br><span class="line">recvfrom(12, 0x7ffd1f603790, 4096, 0, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">epoll_wait(8, [&#123;EPOLLOUT, &#123;u32=69027489, u64=140003117975201&#125;&#125;], 512, 20000) = 1</span><br><span class="line">getsockopt(15, SOL_SOCKET, SO_ERROR, [0], [4]) = 0</span><br><span class="line">writev(15, [&#123;"GET /?key=testxxxx HTTP/1.0<span class="symbol">\r</span><span class="symbol">\n</span>Hos"..., 219&#125;], 1) = 219</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=69027489, u64=140003117975201&#125;&#125;], 512, 60000) = 1</span><br><span class="line">recvfrom(15, "HTTP/1.1 200 OK<span class="symbol">\r</span><span class="symbol">\n</span>Content-Type: t"..., 3723, 0, NULL, NULL) = 3723</span><br><span class="line">close(14) = 0</span><br><span class="line">readv(15, [&#123;"a.qnssl.com/images/265818/Fntncr"..., 4096&#125;], 1) = 4096</span><br><span class="line">readv(15, [&#123;"w-card-price&#123;color: #004aa0;&#125;.s-"..., 4096&#125;], 1) = 4096</span><br><span class="line">readv(15, [&#123;" &#123;<span class="symbol">\n</span> font-family: <span class="symbol">\"</span>Open Sans"..., 4096&#125;], 1) = 2565</span><br><span class="line">open("/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2.0000014051", O_RDWR|O_CREAT|O_EXCL, 0600) = 14</span><br><span class="line">pwritev(14, [&#123;"<span class="symbol">\5</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span>(<span class="symbol">\2</span>52M[<span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span>"..., 4096&#125;, &#123;"a.qnssl.com/images/265818/Fntncr"..., 4096&#125;, &#123;"w-card-price&#123;color: #004aa0;&#125;.s-"..., 4096&#125;], 3, 0) = 12288</span><br><span class="line">writev(11, [&#123;"HTTP/1.1 200 OK<span class="symbol">\r</span><span class="symbol">\n</span>Server: nginx/1"..., 321&#125;], 1) = 321</span><br><span class="line">sendfile(11, 14, [636] =&gt; [12288], 11652) = 11652</span><br><span class="line">epoll_wait(8, [&#123;EPOLLOUT, &#123;u32=69027489, u64=140003117975201&#125;&#125;], 512, 59955) = 1</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=69027489, u64=140003117975201&#125;&#125;], 512, 59953) = 1</span><br><span class="line">readv(15, [&#123;"rc=<span class="symbol">\"</span>//nzr2ybsda.qnssl.com/images"..., 1531&#125;, &#123;"lass=<span class="symbol">\"</span>s-nav-item<span class="symbol">\"</span> target=<span class="symbol">\"</span>_self<span class="symbol">\"</span>"..., 4096&#125;, &#123;"lign: left; font-size: 160<span class="variable">%;\"&gt;\302\240"..., 4096&#125;, &#123;"OQswmpPvoA0.jpg?imageMogr2/strip"..., 4096&#125;], 4) = 10136</span></span><br><span class="line"><span class="variable">pwritev(14, [&#123;" &#123;\n font-family: \"Open Sans"..., 4096&#125;, &#123;"lass=\"s-nav-item\" target=\"_self\""..., 4096&#125;, &#123;"lign: left; font-size: 160%</span>;<span class="symbol">\"</span>&gt;<span class="symbol">\3</span>02<span class="symbol">\2</span>40"..., 4096&#125;], 3, 12288) = 12288</span><br><span class="line">sendfile(11, 14, [12288] =&gt; [24576], 12288) = 12288</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=69027489, u64=140003117975201&#125;&#125;], 512, 59948) = 1</span><br><span class="line">readv(15, [&#123;"olor-custom1<span class="symbol">\"</span>&gt;<span class="symbol">\3</span>47<span class="symbol">\2</span>54<span class="symbol">\2</span>54<span class="symbol">\3</span>44<span class="symbol">\2</span>70<span class="symbol">\2</span>11<span class="symbol">\3</span>46<span class="symbol">\2</span>26<span class="symbol">\2</span>71<span class="symbol">\3</span>45"..., 3683&#125;, &#123;"container title-group-container<span class="symbol">\"</span>"..., 4096&#125;, &#123;";cs=srgb&amp;s=f71a6adc1e5953a52"..., 4096&#125;, &#123;")<span class="symbol">\"</span> data-bg=<span class="symbol">\"</span>//nzr2ybsda.qnssl.co"..., 4096&#125;], 4) = 15971</span><br><span class="line">readv(15, [&#123;"<span class="symbol">\2</span>30<span class="symbol">\2</span>63<span class="symbol">\3</span>45<span class="symbol">\2</span>24<span class="symbol">\2</span>57<span class="symbol">\3</span>46<span class="symbol">\2</span>31<span class="symbol">\2</span>37<span class="symbol">\"</span> title=<span class="symbol">\"</span><span class="symbol">\3</span>46<span class="symbol">\2</span>62<span class="symbol">\2</span>10<span class="symbol">\3</span>51<span class="symbol">\2</span>30<span class="symbol">\2</span>63<span class="symbol">\3</span>45<span class="symbol">\2</span>24<span class="symbol">\2</span>57<span class="symbol">\3</span>46<span class="symbol">\2</span>31<span class="symbol">\2</span>37<span class="symbol">\3</span>45<span class="symbol">\2</span>25<span class="symbol">\2</span>06"..., 4096&#125;], 1) = 2853</span><br><span class="line">pwritev(14, [&#123;"OQswmpPvoA0.jpg?imageMogr2/strip"..., 4096&#125;, &#123;"container title-group-container<span class="symbol">\"</span>"..., 4096&#125;, &#123;";cs=srgb&amp;s=f71a6adc1e5953a52"..., 4096&#125;, &#123;")<span class="symbol">\"</span> data-bg=<span class="symbol">\"</span>//nzr2ybsda.qnssl.co"..., 4096&#125;], 4, 24576) = 16384</span><br><span class="line">sendfile(11, 14, [24576] =&gt; [40960], 16384) = 16384</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=69027489, u64=140003117975201&#125;&#125;], 512, 59947) = 1</span><br><span class="line">readv(15, [&#123;"</span><br><span class="line"></span><br><span class="line">&lt;d"..., 1243&#125;, &#123;"<span class="symbol">\2</span>32<span class="symbol">\2</span>04<span class="symbol">\3</span>44<span class="symbol">\2</span>70<span class="symbol">\2</span>32<span class="symbol">\3</span>47<span class="symbol">\2</span>73<span class="symbol">\2</span>51<span class="symbol">\3</span>44<span class="symbol">\2</span>71<span class="symbol">\2</span>37<span class="symbol">\3</span>45<span class="symbol">\2</span>34<span class="symbol">\2</span>50<span class="symbol">\3</span>44<span class="symbol">\2</span>70<span class="symbol">\2</span>15<span class="symbol">\3</span>46<span class="symbol">\2</span>26<span class="symbol">\2</span>55<span class="symbol">\3</span>46<span class="symbol">\2</span>24<span class="symbol">\2</span>00<span class="symbol">\3</span>45<span class="symbol">\2</span>15<span class="symbol">\2</span>07<span class="symbol">\3</span>43<span class="symbol">\2</span>00<span class="symbol">\2</span>02&lt;/d"..., 4096&#125;, &#123;"", 4096&#125;, &#123;"", 4096&#125;, &#123;"", 4096&#125;], 5) = 2937</span><br><span class="line">pwritev(14, [&#123;"<span class="symbol">\2</span>30<span class="symbol">\2</span>63<span class="symbol">\3</span>45<span class="symbol">\2</span>24<span class="symbol">\2</span>57<span class="symbol">\3</span>46<span class="symbol">\2</span>31<span class="symbol">\2</span>37<span class="symbol">\"</span> title=<span class="symbol">\"</span><span class="symbol">\3</span>46<span class="symbol">\2</span>62<span class="symbol">\2</span>10<span class="symbol">\3</span>51<span class="symbol">\2</span>30<span class="symbol">\2</span>63<span class="symbol">\3</span>45<span class="symbol">\2</span>24<span class="symbol">\2</span>57<span class="symbol">\3</span>46<span class="symbol">\2</span>31<span class="symbol">\2</span>37<span class="symbol">\3</span>45<span class="symbol">\2</span>25<span class="symbol">\2</span>06"..., 4096&#125;, &#123;"<span class="symbol">\2</span>32<span class="symbol">\2</span>04<span class="symbol">\3</span>44<span class="symbol">\2</span>70<span class="symbol">\2</span>32<span class="symbol">\3</span>47<span class="symbol">\2</span>73<span class="symbol">\2</span>51<span class="symbol">\3</span>44<span class="symbol">\2</span>71<span class="symbol">\2</span>37<span class="symbol">\3</span>45<span class="symbol">\2</span>34<span class="symbol">\2</span>50<span class="symbol">\3</span>44<span class="symbol">\2</span>70<span class="symbol">\2</span>15<span class="symbol">\3</span>46<span class="symbol">\2</span>26<span class="symbol">\2</span>55<span class="symbol">\3</span>46<span class="symbol">\2</span>24<span class="symbol">\2</span>00<span class="symbol">\3</span>45<span class="symbol">\2</span>15<span class="symbol">\2</span>07<span class="symbol">\3</span>43<span class="symbol">\2</span>00<span class="symbol">\2</span>02&lt;/d"..., 1694&#125;], 2, 40960) = 5790 sendfile(11, 14, [40960] =&gt; [46750], 5790) = 5790</span><br><span class="line">chmod("/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2.0000014051", 0600) = 0</span><br><span class="line">rename("/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2.0000014051", "/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2") = 0</span><br><span class="line">fstat(14, &#123;st_dev=makedev(253, 1), st_ino=655502, st_mode=S_IFREG|0600, st_nlink=1, st_uid=101, st_gid=101, st_blksize=4096, st_blocks=96, st_size=46750, st_atime=2018/07/17-16:34:43.967698739, st_mtime=2018/07/17-16:34:43.966698736, st_ctime=2018/07/17-16:34:43.967698739&#125;) = 0</span><br><span class="line">close(15) = 0</span><br><span class="line">write(5, "&#123; <span class="symbol">\"</span>time<span class="symbol">\"</span>: <span class="symbol">\"</span>2018-07-17T08:34:43+0"..., 386) = 386</span><br><span class="line">close(14) = 0</span><br><span class="line">setsockopt(11, SOL_TCP, TCP_NODELAY, [1], 4) = 0</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN|EPOLLOUT|EPOLLRDHUP, &#123;u32=69027248, u64=140003117974960&#125;&#125;], 512, 65000) = 1</span><br><span class="line">recvfrom(11, "", 1024, 0, NULL, NULL) = 0</span><br><span class="line">close(11) = 0</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;用户自定义站点502问题分析&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;现象：自定义域名用户反馈，打开网站返回502，如图&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;/images/img_5b5183b84d4dd.png&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt; 根据respons
      
    
    </summary>
    
    
      <category term="linux" scheme="https://www.xiemx.com/categories/linux/"/>
    
      <category term="nginx" scheme="https://www.xiemx.com/categories/linux/nginx/"/>
    
      <category term="debug" scheme="https://www.xiemx.com/categories/linux/nginx/debug/"/>
    
    
      <category term="debug" scheme="https://www.xiemx.com/tags/debug/"/>
    
      <category term="linux" scheme="https://www.xiemx.com/tags/linux/"/>
    
      <category term="nginx" scheme="https://www.xiemx.com/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>TCP状态机</title>
    <link href="https://www.xiemx.com//2018/01/23/tcp-state/"/>
    <id>https://www.xiemx.com//2018/01/23/tcp-state/</id>
    <published>2018-01-23T03:01:20.000Z</published>
    <updated>2019-10-21T06:57:42.714Z</updated>
    
    <content type="html"><![CDATA[<h3 id="TCP状态分析"><a href="#TCP状态分析" class="headerlink" title="TCP状态分析"></a>TCP状态分析</h3><ul><li>listen／close</li><li>syn-sent/syn-revd</li><li>established</li><li>fin_wait_1/close_wait</li><li>fin_wait_2/last_ack</li><li>time_wait/close</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">LISTEN</span>        <span class="string">等待来自远程TCP应用程序的请求</span></span><br><span class="line"><span class="attr">SYN_SENT</span><span class="string">发送连接请求后等待来自远程端点的确认。TCP第一次握手后客户端所处的状态</span></span><br><span class="line"><span class="meta">SYN-RECEIVED</span><span class="string">该端点已经接收到连接请求并发送确认。该端点正在等待最终确认。TCP第二次握手后服务端所处的状态</span></span><br><span class="line"><span class="attr">ESTABLISHED</span><span class="string">代表连接已经建立起来了。这是连接数据传输阶段的正常状态</span></span><br><span class="line"><span class="attr">FIN_WAIT_1</span><span class="string">等待来自远程TCP的终止连接请求或终止请求的确认</span></span><br><span class="line"><span class="attr">FIN_WAIT_2</span><span class="string">在此端点发送终止连接请求后，等待来自远程TCP的连接终止请求</span></span><br><span class="line"><span class="attr">CLOSE_WAIT</span><span class="string">该端点已经收到来自远程端点的关闭请求，此TCP正在等待本地应用程序的连接终止请求</span></span><br><span class="line"><span class="attr">CLOSING</span>        <span class="string">等待来自远程TCP的连接终止请求确认</span></span><br><span class="line"><span class="attr">LAST_ACK</span><span class="string">等待先前发送到远程TCP的连接终止请求的确认</span></span><br><span class="line"><span class="attr">TIME_WAIT</span><span class="string">等待足够的时间来确保远程TCP接收到其连接终止请求的确认</span></span><br></pre></td></tr></table></figure><p>以上大致为一个Tcp从三次握手建立连接到四次挥手断开连接的整个过程C/S对应的TCP状态。</p><h3 id="详细流程"><a href="#详细流程" class="headerlink" title="详细流程"></a>详细流程</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 客户端(close)发送syn连接请求给服务端(<span class="section">listen</span>),客户端等待服务端ack(syn_sent)</span><br><span class="line"><span class="number">2.</span> 服务端收到syn请求,发送ack/syn(syn_rec)</span><br><span class="line"><span class="number">3.</span> 客户端收到ack(establelished)</span><br><span class="line"><span class="number">4.</span> 传输数据</span><br><span class="line"><span class="number">5.</span> 客户端数据交互完成请求关闭连接，发送fin请求(fin_wait_1)</span><br><span class="line"><span class="number">6.</span> 服务端收到fin请求,发送ack(close_wait)</span><br><span class="line"><span class="number">7.</span> 服务端数据交互完成,发送fin请求关闭连接(last_ack)</span><br><span class="line"><span class="number">8.</span> 客户端收到服务端的ack请求(fin_wait_2)</span><br><span class="line"><span class="number">9.</span> 客户端收到服务端的fin请求,发送ack确认断开(time_wait)</span><br><span class="line"><span class="number">10.</span> 服务端收到客户端的ack,关闭连接(close)</span><br><span class="line"><span class="number">11.</span> 客户端维护<span class="number">2</span>个msl时间后回收socket</span><br></pre></td></tr></table></figure><p>引用网上的一张图：</p><p><img src="/images/img_5a66a577176c8.png" alt="img"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;TCP状态分析&quot;&gt;&lt;a href=&quot;#TCP状态分析&quot; class=&quot;headerlink&quot; title=&quot;TCP状态分析&quot;&gt;&lt;/a&gt;TCP状态分析&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;listen／close&lt;/li&gt;
&lt;li&gt;syn-sent/syn-revd&lt;/li&gt;
      
    
    </summary>
    
    
      <category term="linux" scheme="https://www.xiemx.com/categories/linux/"/>
    
    
      <category term="linux" scheme="https://www.xiemx.com/tags/linux/"/>
    
      <category term="tcp" scheme="https://www.xiemx.com/tags/tcp/"/>
    
  </entry>
  
  <entry>
    <title>TCP TIME_WAIT</title>
    <link href="https://www.xiemx.com//2018/01/23/tcp-time_wait/"/>
    <id>https://www.xiemx.com//2018/01/23/tcp-time_wait/</id>
    <published>2018-01-23T02:01:21.000Z</published>
    <updated>2019-10-19T07:40:03.304Z</updated>
    
    <content type="html"><![CDATA[<h4 id="维持TIME-WAIT有两个原因："><a href="#维持TIME-WAIT有两个原因：" class="headerlink" title="维持TIME_WAIT有两个原因："></a>维持TIME_WAIT有两个原因：</h4><ol><li><p>可靠地实现TCP的全双工连接终止</p><p> 在四次挥手中，假设最后的ACK丢失了，被动关闭方会重发FIN。主动关闭端必须维护状态，来允许被动关闭方重发最后的ACK；如果它没有维护这个状态，将会对重发FIN返回RST，被动关闭方会认为这是个错误。如果TCP正在执行彻底终止数据流的两个方向所需的所有工作（即全双工关闭），则必须正确处理这四个段中任何一个的丢失。所以执行主动关闭的一方必须在结束时保持TIME_WAIT状态：因为它可能必须重传最后的ACK。</p></li><li><p>允许旧的重复数据段在网络中过期</p><p> 假设在主机1.1.1.1的1111端口和2.2.2.2的2222端口之间有一个TCP连接。此连接关闭后，相同的地址和端口建立了一个新连接。由于IP地址和端口相同，TCP必须防止旧连接的数据包再次出现，被新的连接误收。为此，TCP将不会启动当前处于TIME_WAIT状态的连接。由于TIME_WAIT状态的持续时间是两倍的MSL，因此TCP允许一个方向的数据在MSL秒内丢失，也允许回复在一个MSL秒内丢失。通过此规则来保证当一个TCP连接成功建立时，来自先前连接的所有旧的副本在网络中已过期。</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;维持TIME-WAIT有两个原因：&quot;&gt;&lt;a href=&quot;#维持TIME-WAIT有两个原因：&quot; class=&quot;headerlink&quot; title=&quot;维持TIME_WAIT有两个原因：&quot;&gt;&lt;/a&gt;维持TIME_WAIT有两个原因：&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;可
      
    
    </summary>
    
    
      <category term="linux" scheme="https://www.xiemx.com/categories/linux/"/>
    
    
      <category term="linux" scheme="https://www.xiemx.com/tags/linux/"/>
    
      <category term="tcp" scheme="https://www.xiemx.com/tags/tcp/"/>
    
  </entry>
  
  <entry>
    <title>zabbix distrubuted monitor</title>
    <link href="https://www.xiemx.com//2017/09/21/zabbix-distrubuted-monitor/"/>
    <id>https://www.xiemx.com//2017/09/21/zabbix-distrubuted-monitor/</id>
    <published>2017-09-20T18:09:37.000Z</published>
    <updated>2019-10-21T06:57:42.570Z</updated>
    
    <content type="html"><![CDATA[<p>zabbix 分布式监控2种模式</p><ul><li>node模式</li><li>proxy模式</li></ul><p>PS: node模式官方在2.4版本之后已经弃用，重点讨论proxy模式</p><h3 id="proxy-模式"><a href="#proxy-模式" class="headerlink" title="proxy 模式"></a>proxy 模式</h3><p>Zabbix proxy可以代替Zabbix服务器收集性能和可用性数据，一个代理可以承担一些收集数据的负载。使用代理是实现集中式和分布式监控的最简单方法。proxy需要使用单独的数据库来缓存agent数据，在发给server防止出现因网络问题造成的数据丢失。zabbix proxy只是一个数据收集组件，不会触发任何trigger／alert.</p><p><img src="/images/img_59c35cd9ab71b.png" alt="img"></p><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul><li>Monitor remote locations</li><li>Monitor locations having unreliable communications</li><li>Offload the Zabbix server when monitoring thousands of devices</li><li>Simplify the maintenance of distributed monitoring</li></ul><h3 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">同安装zabbix server 类似，不赘述,需要其他功能也可以在编译时自行开启。</span></span><br><span class="line"></span><br><span class="line">./configure --prefix=/opt/zabbix_proxy/ --enable-proxy --with-mysql --with-libcurl</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">create databases zabbix</span><br><span class="line">grant all to zabbix.* to zabbix@'%' identified by "zabbix";</span><br><span class="line"><span class="meta">#</span><span class="bash">导入schema.sql</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置文件中hostname需要和zabbix上添加的保持一致</span></span><br><span class="line"><span class="meta">#</span><span class="bash">其它参考server设置参数</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">ps：设置适当的配置同步时间，默认一小时。建议设置短一点，这样如果有新机器加入配置修改都可以快速同步并监控。</span></span><br><span class="line">ConfigFrequency=600</span><br></pre></td></tr></table></figure><p>zabbix server 配置</p><p><img src="/images/img_59c35d1d930c1.png" alt="img"></p><p>添加主机时选择指定的proxy</p><p><img src="/images/img_59c35d389b1c5.png" alt="img"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;zabbix 分布式监控2种模式&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;node模式&lt;/li&gt;
&lt;li&gt;proxy模式&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;PS: node模式官方在2.4版本之后已经弃用，重点讨论proxy模式&lt;/p&gt;
&lt;h3 id=&quot;proxy-模式&quot;&gt;&lt;a href=&quot;#
      
    
    </summary>
    
    
      <category term="zabbix" scheme="https://www.xiemx.com/categories/zabbix/"/>
    
    
      <category term="zabbix" scheme="https://www.xiemx.com/tags/zabbix/"/>
    
  </entry>
  
  <entry>
    <title>graphite_relay sharding</title>
    <link href="https://www.xiemx.com//2017/09/08/graphite_relay-sharding/"/>
    <id>https://www.xiemx.com//2017/09/08/graphite_relay-sharding/</id>
    <published>2017-09-07T22:09:47.000Z</published>
    <updated>2019-10-21T06:57:43.060Z</updated>
    
    <content type="html"><![CDATA[<p>当statsd发送超量的metrics到graphite中，graphite单节点无法负载的情况，可以使用consistent-hashing的模式来将数据分片到backend中。同样的consistent-hashing模式下可以自动剔除／加入节点。</p><p>官方文档：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">carbon-relay.py serves two distinct purposes: replication and sharding.</span><br><span class="line"></span><br><span class="line">When running <span class="keyword">with</span> RELAY_METHOD = <span class="keyword">rules</span>, a carbon-relay.py <span class="keyword">instance</span> can run <span class="keyword">in</span> place <span class="keyword">of</span> a carbon-cache.py <span class="keyword">server</span> <span class="keyword">and</span> relay <span class="keyword">all</span> incoming metrics <span class="keyword">to</span> multiple backend carbon-cache.py‘s running <span class="keyword">on</span> different ports <span class="keyword">or</span> hosts.</span><br><span class="line"></span><br><span class="line"><span class="keyword">In</span> RELAY_METHOD = <span class="keyword">consistent</span>-hashing <span class="keyword">mode</span>, a DESTINATIONS setting defines a sharding strategy across multiple carbon-cache.py backends. The same <span class="keyword">consistent</span> hashing <span class="keyword">list</span> can be provided <span class="keyword">to</span> the graphite webapp via CARBONLINK_HOSTS <span class="keyword">to</span> spread <span class="keyword">reads</span> across the multiple backends.</span><br><span class="line">本例模拟一个双后端的carbon-<span class="keyword">cache</span> instance.单机器运行,使用carbon-cache.py 的<span class="keyword">instance</span>功能</span><br><span class="line"></span><br><span class="line">config文件：</span><br><span class="line"><span class="comment">#####carbon.conf</span></span><br><span class="line">[<span class="keyword">cache</span>:a]</span><br><span class="line">LINE_RECEIVER_PORT = <span class="number">2203</span></span><br><span class="line">PICKLE_RECEIVER_PORT = <span class="number">2204</span></span><br><span class="line">CACHE_QUERY_PORT = <span class="number">7102</span></span><br><span class="line">LOCAL_DATA_DIR = /opt/graphite/<span class="keyword">storage</span>/whisper_a/</span><br><span class="line">[<span class="keyword">cache</span>:b]</span><br><span class="line">LINE_RECEIVER_PORT = <span class="number">2205</span></span><br><span class="line">PICKLE_RECEIVER_PORT = <span class="number">2206</span></span><br><span class="line">CACHE_QUERY_PORT = <span class="number">7202</span></span><br><span class="line">LOCAL_DATA_DIR = /opt/graphite/<span class="keyword">storage</span>/whisper_b/</span><br><span class="line">[relay]</span><br><span class="line">LINE_RECEIVER_INTERFACE = <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">LINE_RECEIVER_PORT = <span class="number">2003</span></span><br><span class="line">PICKLE_RECEIVER_INTERFACE = <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">PICKLE_RECEIVER_PORT = <span class="number">2004</span></span><br><span class="line">DESTINATIONS = <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a, <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b </span><br><span class="line">启动服务：</span><br><span class="line"></span><br><span class="line">启动<span class="keyword">instance</span>:a</span><br><span class="line">xmx@xiemx-<span class="keyword">test</span>:/opt/graphisudo ./carbon-cache.py <span class="comment">--instance=a --config=/opt/graphite/conf/carbon.conf start</span></span><br><span class="line"><span class="keyword">Starting</span> carbon-<span class="keyword">cache</span> (<span class="keyword">instance</span> a)</span><br><span class="line"></span><br><span class="line">启动<span class="keyword">instance</span>:b</span><br><span class="line">xmx@xiemx-<span class="keyword">test</span>:/opt/graphite/<span class="keyword">bin</span>$ sudo ./carbon-cache.py <span class="comment">--instance=b --config=/opt/graphite/conf/carbon.conf start</span></span><br><span class="line"><span class="keyword">Starting</span> carbon-<span class="keyword">cache</span> (<span class="keyword">instance</span> b)</span><br><span class="line"></span><br><span class="line">启动relay:</span><br><span class="line">xmx@xiemx-<span class="keyword">test</span>:/opt/graphite/conf$ sudo /opt/graphite/<span class="keyword">bin</span>/carbon-relay.py <span class="comment">--debug --config=/opt/graphite/conf/carbon.conf start</span></span><br><span class="line"><span class="keyword">Starting</span> carbon-relay (<span class="keyword">instance</span> a)</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] <span class="keyword">Using</span> sorted write strategy <span class="keyword">for</span> <span class="keyword">cache</span></span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] connecting <span class="keyword">to</span> carbon daemon <span class="keyword">at</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] connecting <span class="keyword">to</span> carbon daemon <span class="keyword">at</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] twistd <span class="number">16.4</span><span class="number">.1</span> (/usr/<span class="keyword">bin</span>/python <span class="number">2.7</span><span class="number">.6</span>) <span class="keyword">starting</span> up.</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] reactor <span class="keyword">class</span>: twisted.internet.epollreactor.EPollReactor.</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] <span class="keyword">Starting</span> factory CarbonClientFactory(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b)</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] CarbonClientFactory(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b)::startedConnecting (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>)</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] <span class="keyword">Starting</span> factory CarbonClientFactory(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a)</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] CarbonClientFactory(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a)::startedConnecting (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>)</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] CarbonReceiverFactory <span class="keyword">starting</span> <span class="keyword">on</span> <span class="number">2003</span></span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] <span class="keyword">Starting</span> factory </span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] CarbonReceiverFactory <span class="keyword">starting</span> <span class="keyword">on</span> <span class="number">2004</span></span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] <span class="keyword">Starting</span> factory </span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] CarbonClientProtocol(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b)::connectionMade</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] CarbonClientFactory(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b)::connectionMade (CarbonClientProtocol(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b))</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] Destination <span class="keyword">is</span> up: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] CarbonClientProtocol(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a)::connectionMade</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] CarbonClientFactory(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a)::connectionMade (CarbonClientProtocol(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a))</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] Destination <span class="keyword">is</span> up: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a</span><br></pre></td></tr></table></figure><p>测试：</p><p>模拟5个客户端同时发送100个key</p><p><img src="/images/img_59b26b3126991.png" alt="img"></p><p><img src="/images/img_59b26b4437729.png" alt="img"></p><p>模拟node掉线重连</p><p><img src="/images/img_59b26b60dc7e7.png" alt="img"></p><p>graphite-web数据聚合展示</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">修改local_settings.py</span><br><span class="line">CARBONLINK_HOSTS = [<span class="string">"127.0.0.1:7102:a"</span>, <span class="string">"127.0.0.1:7202:b"</span>]</span><br><span class="line"></span><br><span class="line">启动django</span><br><span class="line">sudo PYTHONPATH=/opt/graphite/webapp django-admin<span class="selector-class">.py</span> runserver <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">5000</span> --settings</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;当statsd发送超量的metrics到graphite中，graphite单节点无法负载的情况，可以使用consistent-hashing的模式来将数据分片到backend中。同样的consistent-hashing模式下可以自动剔除／加入节点。&lt;/p&gt;
&lt;p&gt;官方文
      
    
    </summary>
    
    
      <category term="statsd" scheme="https://www.xiemx.com/categories/statsd/"/>
    
      <category term="graphite" scheme="https://www.xiemx.com/categories/statsd/graphite/"/>
    
    
  </entry>
  
  <entry>
    <title>statsd cluster proxy</title>
    <link href="https://www.xiemx.com//2017/09/08/statsd-cluster-proxy/"/>
    <id>https://www.xiemx.com//2017/09/08/statsd-cluster-proxy/</id>
    <published>2017-09-07T21:09:37.000Z</published>
    <updated>2019-10-21T06:57:42.329Z</updated>
    
    <content type="html"><![CDATA[<p>通过UDP proxy程序将前端的数据通过一定的hash算法将相同的metric发送的固定的后aggregation数据。proxy代理支持健康检测自动剔除／加入后端statsd。</p><p>1.配置<br>本例展示一个3节点的statsd后端且将聚合数据发送到standout方便观测。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">node1</span><br><span class="line"><span class="comment">######config文件：</span></span><br><span class="line">&#123;</span><br><span class="line"> port: 8127</span><br><span class="line">, mgmt_port: 8227</span><br><span class="line">, backends: [ <span class="string">"./backends/console"</span> ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">启动:</span><br><span class="line">xiemx➜  statsd : master ✘ :✹✭ ᐅ  node stats.js config8127.js</span><br><span class="line">8 Sep 11:06:36 - [81604] reading<span class="built_in"> config </span>file: config8127.js</span><br><span class="line">8 Sep 11:06:36 -<span class="built_in"> server </span>is up INFO</span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">node2</span><br><span class="line"><span class="comment">######config文件：</span></span><br><span class="line">&#123;</span><br><span class="line"> port: 8128</span><br><span class="line">, mgmt_port: 8228</span><br><span class="line">, backends: [ <span class="string">"./backends/console"</span> ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">启动：</span><br><span class="line">xiemx➜  statsd : master ✘ :✹✭ ᐅ  node stats.js config8128.js</span><br><span class="line">8 Sep 11:07:09 - [81665] reading<span class="built_in"> config </span>file: config8128.js</span><br><span class="line">8 Sep 11:07:09 -<span class="built_in"> server </span>is up INFO</span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">node3</span><br><span class="line"><span class="comment">######config文件：</span></span><br><span class="line">&#123;</span><br><span class="line"> port: 8129</span><br><span class="line">, mgmt_port: 8229</span><br><span class="line">, backends: [ <span class="string">"./backends/console"</span> ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">启动：</span><br><span class="line">xiemx➜  statsd : master ✘ :✹✭ ᐅ  node stats.js config8129.js</span><br><span class="line">8 Sep 11:07:45 - [81723] reading<span class="built_in"> config </span>file: config8129.js</span><br><span class="line">8 Sep 11:07:45 -<span class="built_in"> server </span>is up INFO</span><br></pre></td></tr></table></figure><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">proxy</span></span><br><span class="line">#####<span class="selector-id">#config</span>文件：</span><br><span class="line">&#123;</span><br><span class="line"><span class="attribute">nodes</span>: [</span><br><span class="line">&#123;<span class="attribute">host</span>: <span class="string">'127.0.0.1'</span>, <span class="attribute">port</span>: <span class="number">8127</span>, <span class="attribute">adminport</span>: <span class="number">8227</span>&#125;,</span><br><span class="line">&#123;<span class="attribute">host</span>: <span class="string">'127.0.0.1'</span>, <span class="attribute">port</span>: <span class="number">8128</span>, <span class="attribute">adminport</span>: <span class="number">8228</span>&#125;,</span><br><span class="line">&#123;<span class="attribute">host</span>: <span class="string">'127.0.0.1'</span>, <span class="attribute">port</span>: <span class="number">8129</span>, <span class="attribute">adminport</span>: <span class="number">8229</span>&#125;</span><br><span class="line">],</span><br><span class="line"><span class="attribute">server</span>: <span class="string">'./servers/udp'</span>,</span><br><span class="line"><span class="attribute">host</span>:  <span class="string">'0.0.0.0'</span>,</span><br><span class="line"><span class="attribute">port</span>: <span class="number">8125</span>,</span><br><span class="line"><span class="attribute">mgmt_port</span>: <span class="number">8126</span>,</span><br><span class="line"><span class="attribute">forkCount</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attribute">checkInterval</span>: <span class="number">1000</span>,</span><br><span class="line"><span class="attribute">cacheSize</span>: <span class="number">10000</span>,</span><br><span class="line"><span class="attribute">deleteIdleStats</span>: true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">启动：</span><br><span class="line"><span class="selector-tag">xiemx</span>➜  <span class="selector-tag">statsd</span> : <span class="selector-tag">master</span> ✘ :✹✭ ᐅ  <span class="selector-tag">node</span> <span class="selector-tag">proxy</span><span class="selector-class">.js</span> <span class="selector-tag">proxyconfig</span><span class="selector-class">.js</span></span><br><span class="line"><span class="selector-tag">8</span> <span class="selector-tag">Sep</span> <span class="selector-tag">11</span><span class="selector-pseudo">:09</span><span class="selector-pseudo">:02</span> <span class="selector-tag">-</span> <span class="selector-attr">[81938]</span> <span class="selector-tag">reading</span> <span class="selector-tag">config</span> <span class="selector-tag">file</span>: <span class="selector-tag">proxyconfig</span><span class="selector-class">.js</span></span><br><span class="line"><span class="selector-tag">8</span> <span class="selector-tag">Sep</span> <span class="selector-tag">11</span><span class="selector-pseudo">:09</span><span class="selector-pseudo">:02</span> <span class="selector-tag">-</span> <span class="selector-tag">INFO</span>: <span class="selector-attr">[81938]</span> <span class="selector-tag">server</span> <span class="selector-tag">is</span> <span class="selector-tag">up</span></span><br></pre></td></tr></table></figure><p>测试：<br>5个线程同时推送500个metric到代理查看分片情况</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">测试命令：</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq <span class="number">1</span> <span class="number">500</span>);<span class="keyword">do</span> echo <span class="string">"Ezbuy-$i:1|c"</span> | nc -u -w0 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">8125</span>;done</span><br></pre></td></tr></table></figure><p><img src="/images/img_59b269634a216.png" alt="img"></p><p><img src="/images/img_59b2697b89208.png" alt="img"></p><p>节点自动剔除和加入：</p><p><img src="/images/img_59b2698d5658f.png" alt="img"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;通过UDP proxy程序将前端的数据通过一定的hash算法将相同的metric发送的固定的后aggregation数据。proxy代理支持健康检测自动剔除／加入后端statsd。&lt;/p&gt;
&lt;p&gt;1.配置&lt;br&gt;本例展示一个3节点的statsd后端且将聚合数据发送到stan
      
    
    </summary>
    
    
      <category term="statsd" scheme="https://www.xiemx.com/categories/statsd/"/>
    
      <category term="graphite" scheme="https://www.xiemx.com/categories/statsd/graphite/"/>
    
    
      <category term="database" scheme="https://www.xiemx.com/tags/database/"/>
    
      <category term="statsd" scheme="https://www.xiemx.com/tags/statsd/"/>
    
      <category term="graphite" scheme="https://www.xiemx.com/tags/graphite/"/>
    
      <category term="monitor" scheme="https://www.xiemx.com/tags/monitor/"/>
    
  </entry>
  
  <entry>
    <title>redis 淘汰策略</title>
    <link href="https://www.xiemx.com//2017/07/14/redis-maxmemory-policy/"/>
    <id>https://www.xiemx.com//2017/07/14/redis-maxmemory-policy/</id>
    <published>2017-07-14T02:07:44.000Z</published>
    <updated>2019-10-19T09:11:22.213Z</updated>
    
    <content type="html"><![CDATA[<p>redis 内存数据使用到maxmemory的时候，就会根据maxmemory_policy设定的淘汰策略进行内存整理数据回收。选择不同的策略，要根据redis的用途来区分。</p><p>redis 提供 6种数据淘汰策略：</p><ul><li>volatile-lru：从已设置过期时间的数据集中挑选最近最少使用的数据淘汰</li><li>volatile-ttl：从已设置过期时间的数据集中挑选将要过期的数据淘汰</li><li>volatile-random：从已设置过期时间的数据集中任意选择数据淘汰</li><li>allkeys-lru：从数据集中挑选最近最少使用的数据淘汰</li><li>allkeys-random：从数据集中任意选择数据淘汰</li><li>noenviction：禁止删除数据</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;redis 内存数据使用到maxmemory的时候，就会根据maxmemory_policy设定的淘汰策略进行内存整理数据回收。选择不同的策略，要根据redis的用途来区分。&lt;/p&gt;
&lt;p&gt;redis 提供 6种数据淘汰策略：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;volatile-l
      
    
    </summary>
    
    
      <category term="redis" scheme="https://www.xiemx.com/categories/redis/"/>
    
    
      <category term="redis" scheme="https://www.xiemx.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>iptables count计数</title>
    <link href="https://www.xiemx.com//2017/04/11/iptables-count/"/>
    <id>https://www.xiemx.com//2017/04/11/iptables-count/</id>
    <published>2017-04-10T21:04:23.000Z</published>
    <updated>2019-10-21T06:57:42.886Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">两个参数：</span><br><span class="line">  --verbose-vverbose mode</span><br><span class="line">  --zero    -Z [chain [rulenum]]  Zero counters <span class="keyword">in</span> chain <span class="keyword">or</span> all chains</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p-hsg-cache<span class="number">-6</span>% sudo iptables -nL -v -t nat</span><br><span class="line">Chain PREROUTING (policy ACCEPT <span class="number">50741</span> packets, <span class="number">2370</span>K bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line">  <span class="number">436</span> <span class="number">22672</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6379</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.82</span>:<span class="number">6379</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6380</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6380</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6381</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6381</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6382</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6382</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6383</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6383</span></span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT <span class="number">18988</span> packets, <span class="number">1082</span>K bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT <span class="number">10532</span> packets, <span class="number">549</span>K bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT <span class="number">0</span> packets, <span class="number">0</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line"><span class="number">10968</span>  <span class="number">572</span>K MASQUERADE  all  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line"></span><br><span class="line">p-hsg-cache<span class="number">-6</span>% sudo iptables -Z -t nat</span><br><span class="line"></span><br><span class="line">p-hsg-cache<span class="number">-6</span>% sudo iptables -nL -v -t nat</span><br><span class="line">Chain PREROUTING (policy ACCEPT <span class="number">12</span> packets, <span class="number">624</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line">    <span class="number">1</span>    <span class="number">52</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6379</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.82</span>:<span class="number">6379</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6380</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6380</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6381</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6381</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6382</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6382</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6383</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6383</span></span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT <span class="number">12</span> packets, <span class="number">624</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT <span class="number">6</span> packets, <span class="number">312</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT <span class="number">0</span> packets, <span class="number">0</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line">    <span class="number">7</span>   <span class="number">364</span> MASQUERADE  all  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">p-hsg-cache<span class="number">-6</span>%</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight angelscript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span
      
    
    </summary>
    
    
      <category term="linux" scheme="https://www.xiemx.com/categories/linux/"/>
    
    
      <category term="linux" scheme="https://www.xiemx.com/tags/linux/"/>
    
      <category term="iptables" scheme="https://www.xiemx.com/tags/iptables/"/>
    
  </entry>
  
  <entry>
    <title>iis备份还原</title>
    <link href="https://www.xiemx.com//2017/03/31/iis-backup-restore/"/>
    <id>https://www.xiemx.com//2017/03/31/iis-backup-restore/</id>
    <published>2017-03-31T02:03:43.000Z</published>
    <updated>2019-10-21T06:57:43.060Z</updated>
    
    <content type="html"><![CDATA[<ol><li>打开我们的IIS管理器，在功能视图里找到共享的配置这个功能然后双击进入。</li></ol><p><img src="/images/img_58ddc18a1993a.png" alt="img"></p><ol start="2"><li>进入后单机右上方的“导出配置”选项，选择导出配置文件的物理路径，然后设置一个密码，密码必须是包含数字、符号、大小写字母组合并且至少为8个字符长的强密码，确定导出后会在你导出配置文件目录下生成administration.config、applicationHost.config和configEncKey.key共3个文件，这3个文件就是我们备份的IIS站点配置信息文件。</li></ol><p><img src="/images/img_58ddc1b2d8078.png" alt="img"></p><ol start="3"><li>现在是还原IIS的配置信息，首先将你导出后的administration.config、applicationHost.config和configEncKey.key这个3个文件复制到你需要恢复IIS配置信息的电脑或服务器上，然后打开IIS，同样在功能视图里找到“共享的配置”并打开。</li></ol><p><img src="/images/img_58ddc20c6f8c3.png" alt="img"></p><ol start="4"><li>把“启用共享的配置”勾选上，物理路径就选择你备份的文件所在目录，用户名、密码输入框都不需要填写，直接点击右上方的应用，然后它要你输入密码，确定后重启下我们的IIS 就可以看到以前的站点信息都还原了。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ol&gt;
&lt;li&gt;打开我们的IIS管理器，在功能视图里找到共享的配置这个功能然后双击进入。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;/images/img_58ddc18a1993a.png&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;进入后单机
      
    
    </summary>
    
    
      <category term="windows" scheme="https://www.xiemx.com/categories/windows/"/>
    
      <category term="iis" scheme="https://www.xiemx.com/categories/windows/iis/"/>
    
    
      <category term="webserver" scheme="https://www.xiemx.com/tags/webserver/"/>
    
      <category term="iis" scheme="https://www.xiemx.com/tags/iis/"/>
    
      <category term="windows" scheme="https://www.xiemx.com/tags/windows/"/>
    
  </entry>
  
  <entry>
    <title>进程状态</title>
    <link href="https://www.xiemx.com//2017/03/29/linux-process-status/"/>
    <id>https://www.xiemx.com//2017/03/29/linux-process-status/</id>
    <published>2017-03-29T02:03:05.000Z</published>
    <updated>2019-10-21T06:57:42.805Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">D</span>  <span class="string">不能中断的进程（通常为IO）</span></span><br><span class="line"><span class="attr">R</span>  <span class="string">正在运行中的进程</span></span><br><span class="line"><span class="attr">S</span>  <span class="string">已经中断的进程，通常情况下，系统中大部分进程都是这个状态</span></span><br><span class="line"><span class="attr">T</span>  <span class="string">已经停止或者暂停的进程，如果我们正在运行一个命令，比如说sleep 10，如果我们按一下ctrl -z 让他暂停，那么我们用ps查看就会显示T这个状态</span></span><br><span class="line"><span class="attr">W</span> <span class="string">这个好像是说，从内核2.6xx 以后，表示为没有足够的内存页分配</span></span><br><span class="line"><span class="attr">X</span>  <span class="string">已经死掉的进程（这个好像从来不会出现）</span></span><br><span class="line"><span class="attr">Z</span>  <span class="string">僵尸进程</span></span><br><span class="line"></span><br><span class="line"><span class="attr">下面一些是BSD风格的参数</span></span><br><span class="line"><span class="meta">&lt;</span>  <span class="string">高优先级进程</span></span><br><span class="line"><span class="attr">N</span>  <span class="string">低优先级进程</span></span><br><span class="line"><span class="attr">L</span>   <span class="string">在内存中被锁了内存分页</span></span><br><span class="line"><span class="attr">s</span>   <span class="string">主进程</span></span><br><span class="line"><span class="attr">l</span>   <span class="string">多线程进程</span></span><br><span class="line"><span class="meta">+</span>  <span class="string">代表在前台运行的进程</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight properties&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span 
      
    
    </summary>
    
    
      <category term="linux" scheme="https://www.xiemx.com/categories/linux/"/>
    
    
      <category term="linux" scheme="https://www.xiemx.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>redis repl_diskless_replication</title>
    <link href="https://www.xiemx.com//2017/03/06/redis-repl_diskless_replication/"/>
    <id>https://www.xiemx.com//2017/03/06/redis-repl_diskless_replication/</id>
    <published>2017-03-05T20:03:55.000Z</published>
    <updated>2019-10-21T06:57:42.620Z</updated>
    
    <content type="html"><![CDATA[<p>redis diskless replication</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># Replication</span><br><span class="line">role:slave</span><br><span class="line">master_host:192.168.10.226</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:down</span><br><span class="line">master_last_io_seconds_ago:-1</span><br><span class="line">master_sync_in_progress:1</span><br><span class="line">slave_repl_offset:1</span><br><span class="line">master_sync_left_bytes:-4022404224</span><br><span class="line">master_sync_last_io_seconds_ago:37</span><br><span class="line">master_link_down_since_seconds:1488785860</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_repl_offset:0</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=192.168.10.192,port=6379,state=online,offset=1134556373255,lag=1</span><br><span class="line">slave1:ip=192.168.10.82,port=6379,state=wait_bgsave,offset=0,lag=0</span><br><span class="line">master_repl_offset:1134556812751</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1134555764176</span><br><span class="line">repl_backlog_histlen:1048576</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">6581:C 06 Mar 15:28:27.766 * DB saved on disk</span><br><span class="line">26581:C 06 Mar 15:28:27.990 * RDB: 212 MB of memory used by copy-on-write</span><br><span class="line">2251:M 06 Mar 15:28:28.379 * Background saving terminated with success</span><br><span class="line">2251:M 06 Mar 15:29:08.687 * Synchronization with slave 192.168.10.82:6379 succeeded</span><br><span class="line">2251:M 06 Mar 15:29:47.093 # Client id=314558845 addr=192.168.10.82:58002 fd=16 name= age=194 idle=1 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=3617 omem=95797745 events=rw cmd=psync scheduled to be closed ASAP for overcoming of output buffer limits.</span><br><span class="line">2251:M 06 Mar 15:29:47.093 # Connection with slave 192.168.10.82:6379 lost.</span><br><span class="line">2251:M 06 Mar 15:30:15.999 * Slave 192.168.10.82:6379 asks for synchronization</span><br><span class="line">2251:M 06 Mar 15:30:15.999 * Unable to partial resync with slave 192.168.10.82:6379 for lack of backlog (Slave request was: 1134354232038).</span><br><span class="line">2251:M 06 Mar 15:30:15.999 * Starting BGSAVE for SYNC with target: disk</span><br><span class="line">2251:M 06 Mar 15:30:16.232 * Background saving started by pid 30494</span><br><span class="line">30494:C 06 Mar 15:31:52.413 * DB saved on disk</span><br><span class="line">30494:C 06 Mar 15:31:52.597 * RDB: 223 MB of memory used by copy-on-write</span><br><span class="line">2251:M 06 Mar 15:31:52.950 * Background saving terminated with success</span><br><span class="line">2251:M 06 Mar 15:32:33.375 * Synchronization with slave 192.168.10.82:6379 succeeded</span><br><span class="line">2251:M 06 Mar 15:33:08.106 # Client id=314561307 addr=192.168.10.82:38644 fd=16 name= age=173 idle=1 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=4325 omem=102199438 events=rw cmd=psync scheduled to be closed ASAP for overcoming of output buffer limits.</span><br><span class="line">2251:M 06 Mar 15:33:08.106 # Connection with slave 192.168.10.82:6379 lost.</span><br><span class="line">2251:M 06 Mar 15:33:40.471 * Slave 192.168.10.82:6379 asks for synchronization</span><br><span class="line">2251:M 06 Mar 15:33:40.471 * Unable to partial resync with slave 192.168.10.82:6379 for lack of backlog (Slave request was: 1134453799057).</span><br><span class="line">2251:M 06 Mar 15:33:40.471 * Starting BGSAVE for SYNC with target: disk</span><br><span class="line">2251:M 06 Mar 15:33:40.715 * Background saving started by pid 1440</span><br><span class="line">2251:M 06 Mar 15:35:14.354 # Connection with slave 192.168.10.82:6379 lost.</span><br><span class="line">1440:C 06 Mar 15:35:20.564 * DB saved on disk</span><br><span class="line">1440:C 06 Mar 15:35:20.743 * RDB: 296 MB of memory used by copy-on-write</span><br><span class="line">2251:M 06 Mar 15:35:21.013 * Background saving terminated with success</span><br></pre></td></tr></table></figure><h3 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h3><p>如果设置了一个slave，不管是在第一次链接还是重新链接master的时候，slave会发送一个同步命令<br>然后master开始后台保存，收集所有对修改数据的命令。当后台保存完成，master会将这个数据文件传送到slave，<br>然后保存在磁盘，加载到内存中，master接着发送收集到的所有的修改数据的命令。</p><p>Redis为避免输出缓冲区过度耗用内存，使用client-output-buffer-limit参数限制客户端输出缓冲区内存使用量。<br>Redis数据复制过程中，Slave有个flags=S的客户端连接到Master; 它和其他客户端一样有输出缓冲区和缓冲区大小限制。<br><code>client-output-buffer-limit slave 256mb 64mb 60</code><br>当缓冲区使用超过256mb,Master会尽快杀掉它；<br>当缓冲区使用大于64mb,且小于256mb的soft limit值时，并持续时间达60秒，也会被Master尽快杀掉。</p><p>通过以上的原理分析我们可以得到一个解决方法：扩大buffer和timeout，但对于一个数据量比较大的db且服务器本身内存不足的情况下。<br>我们可以采用diskless replication，直接通过网络将数据更新过去，不再让服务器去同步到disk再从disk输出到内存导致output报错</p><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>开启redis diskless replication</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; CONFIG set repl-diskless-sync yes</span><br><span class="line">OK</span><br><span class="line">(1.97s)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2251:M 06 Mar 15:35:34.896 * Slave 192.168.10.82:6379 asks for synchronization</span><br><span class="line">2251:M 06 Mar 15:35:34.896 * Full resync requested by slave 192.168.10.82:6379</span><br><span class="line">2251:M 06 Mar 15:35:34.896 * Delay next BGSAVE for SYNC</span><br><span class="line">2251:M 06 Mar 15:35:40.203 * Starting BGSAVE for SYNC with target: slaves sockets</span><br><span class="line">2251:M 06 Mar 15:35:40.469 * Background RDB transfer started by pid 3351</span><br><span class="line">3351:C 06 Mar 15:37:03.206 * RDB: 233 MB of memory used by copy-on-write</span><br><span class="line">2251:M 06 Mar 15:37:03.473 * Background RDB transfer terminated with success</span><br><span class="line">2251:M 06 Mar 15:37:03.473 # Slave 192.168.10.82:6379 correctly received the streamed RDB file.</span><br><span class="line">2251:M 06 Mar 15:37:03.473 * Streamed RDB transfer with slave 192.168.10.82:6379 succeeded (socket). Waiting for REPLCONF ACK from slave to enable streaming</span><br><span class="line">2251:M 06 Mar 15:37:24.848 * 50000 changes in 60 seconds. Saving...</span><br><span class="line">2251:M 06 Mar 15:37:25.097 * Background saving started by pid 5916</span><br><span class="line">2251:M 06 Mar 15:38:10.510 * Synchronization with slave 192.168.10.82:6379 succeeded</span><br><span class="line">5916:C 06 Mar 15:39:06.535 * DB saved on disk</span><br><span class="line">5916:C 06 Mar 15:39:06.742 * RDB: 250 MB of memory used by copy-on-write</span><br><span class="line">2251:M 06 Mar 15:39:07.093 * Background saving terminated with success</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># Replication</span><br><span class="line">role:slave</span><br><span class="line">master_host:192.168.10.226</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:1</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:1134697190334</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_repl_offset:0</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line"></span><br><span class="line"># Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=192.168.10.192,port=6379,state=online,offset=1135553694283,lag=1</span><br><span class="line">slave1:ip=192.168.10.82,port=6379,state=online,offset=1135553653727,lag=1</span><br><span class="line">master_repl_offset:1135554186742</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1135553138167</span><br><span class="line">repl_backlog_histlen:1048576</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;redis diskless replication&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span cl
      
    
    </summary>
    
    
      <category term="redis" scheme="https://www.xiemx.com/categories/redis/"/>
    
    
      <category term="redis" scheme="https://www.xiemx.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redis-trib.rb工具使用</title>
    <link href="https://www.xiemx.com//2017/02/27/redis-trib-rb/"/>
    <id>https://www.xiemx.com//2017/02/27/redis-trib-rb/</id>
    <published>2017-02-26T21:02:35.000Z</published>
    <updated>2019-10-21T06:57:42.989Z</updated>
    
    <content type="html"><![CDATA[<p>redis-trib.rb是redis官方推出的管理redis集群的工具，集成在redis的源码src目录下，是基于redis提供的集群命令封装成简单、便捷、实用的操作工具。redis-trib.rb是redis作者用ruby完成的。</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">root@</span><span class="string">p-hsg-</span><span class="string">redis-1:</span>~<span class="comment"># redis-trib.rb</span></span><br><span class="line"><span class="string">Usage:</span> <span class="string">redis-trib </span> </span><br><span class="line"></span><br><span class="line">  <span class="string">create </span>         <span class="string">host1:port1 </span>... <span class="string">hostN:portN</span></span><br><span class="line"><span class="string"> </span>                 <span class="built_in">--replicas</span> </span><br><span class="line">  <span class="string">check </span>          <span class="string">host:port</span></span><br><span class="line"><span class="string"> </span> <span class="string">info </span>           <span class="string">host:port</span></span><br><span class="line"><span class="string"> </span> <span class="string">fix </span>            <span class="string">host:port</span></span><br><span class="line"><span class="string"> </span>                 <span class="built_in">--timeout</span> </span><br><span class="line">  <span class="string">reshard </span>        <span class="string">host:port</span></span><br><span class="line"><span class="string"> </span>                 <span class="built_in">--from</span> </span><br><span class="line">                  <span class="built_in">--to</span> </span><br><span class="line">                  <span class="built_in">--slots</span> </span><br><span class="line">                  <span class="built_in">--yes</span></span><br><span class="line"><span class="built_in"></span>                  <span class="built_in">--timeout</span> </span><br><span class="line">                  <span class="built_in">--pipeline</span> </span><br><span class="line">  <span class="string">rebalance </span>      <span class="string">host:port</span></span><br><span class="line"><span class="string"> </span>                 <span class="built_in">--weight</span> </span><br><span class="line">                  <span class="built_in">--auto-weights</span></span><br><span class="line"><span class="built_in"></span>                  <span class="built_in">--use-empty-masters</span></span><br><span class="line"><span class="built_in"></span>                  <span class="built_in">--timeout</span> </span><br><span class="line">                  <span class="built_in">--simulate</span></span><br><span class="line"><span class="built_in"></span>                  <span class="built_in">--pipeline</span> </span><br><span class="line">                  <span class="built_in">--threshold</span> </span><br><span class="line">  <span class="string">add-node </span>       <span class="string">new_host:new_port </span><span class="string">existing_host:existing_port</span></span><br><span class="line"><span class="string"> </span>                 <span class="built_in">--slave</span></span><br><span class="line"><span class="built_in"></span>                  <span class="built_in">--master-id</span> </span><br><span class="line">  <span class="string">del-node </span>       <span class="string">host:port </span><span class="string">node_id</span></span><br><span class="line"><span class="string"> </span> <span class="built_in">set-timeout</span>     <span class="string">host:port </span><span class="string">milliseconds</span></span><br><span class="line"><span class="string"> </span> <span class="string">call </span>           <span class="string">host:port </span><span class="string">command </span><span class="string">arg </span><span class="string">arg </span>.. <span class="string">arg</span></span><br><span class="line"><span class="string"> </span> <span class="string">import </span>         <span class="string">host:port</span></span><br><span class="line"><span class="string"> </span>                 <span class="built_in">--from</span> </span><br><span class="line">                  <span class="built_in">--copy</span></span><br><span class="line"><span class="built_in"></span>                  <span class="built_in">--replace</span></span><br><span class="line"><span class="built_in"></span>  <span class="string">help </span>           (<span class="string">show </span><span class="string">this </span><span class="string">help)</span></span><br><span class="line"></span><br><span class="line"><span class="string">For </span><span class="string">check,</span> <span class="string">fix,</span> <span class="string">reshard,</span> <span class="string">del-node,</span> <span class="built_in">set-timeout</span> <span class="string">you </span><span class="string">can </span><span class="string">specify </span><span class="string">the </span><span class="string">host </span><span class="string">and </span><span class="string">port </span><span class="string">of </span><span class="string">any </span><span class="string">working </span><span class="string">node </span><span class="string">in </span><span class="string">the </span><span class="string">cluster.</span></span><br></pre></td></tr></table></figure><p>可以看到redis-trib.rb具有以下功能：</p><ul><li>create：创建集群</li><li>check：检查集群</li><li>info：查看集群信息</li><li>fix：修复集群</li><li>reshard：在线迁移slot</li><li>rebalance：平衡集群节点slot数量</li><li>add-node：将新节点加入集群</li><li>del-node：从集群中删除节点</li><li>set-timeout：设置集群节点间心跳连接的超时时间</li><li>call：在集群全部节点上执行命令</li><li>import：将外部redis数据导入集群</li></ul><h3 id="create创建集群"><a href="#create创建集群" class="headerlink" title="create创建集群"></a>create创建集群</h3><p>create命令可选replicas参数，replicas表示需要有几个slave。最简单命令使用如下：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ruby redis-trib.rb create <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br></pre></td></tr></table></figure><p>有一个slave的创建命令如下：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ruby redis-trib.rb create --replicas <span class="number">1</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span>  <span class="number">10.180</span><span class="number">.157</span><span class="number">.205</span>:<span class="number">6379</span>  <span class="number">10.180</span><span class="number">.157</span><span class="number">.208</span>:<span class="number">6379</span></span><br></pre></td></tr></table></figure><p>创建流程如下：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、首先为每个节点创建ClusterNode对象，包括连接每个节点。检查每个节点是否为独立且db为空的节点。执行load_<span class="literal">inf</span>o方法导入节点信息。</span><br><span class="line"><span class="number">2</span>、检查传入的<span class="literal">master</span>节点数量是否大于等于<span class="number">3</span>个。只有大于<span class="number">3</span>个节点才能组成集群。</span><br><span class="line"><span class="number">3</span>、计算每个<span class="literal">master</span>需要分配的slot数量，以及给<span class="literal">master</span>分配<span class="literal">slave</span>。分配的算法大致如下：</span><br><span class="line">先把节点按照host分类，这样保证<span class="literal">master</span>节点能分配到更多的主机中。</span><br><span class="line">不停遍历遍历host列表，从每个host列表中弹出一个节点，放入interleaved数组。直到所有的节点都弹出为止。</span><br><span class="line"><span class="literal">master</span>节点列表就是interleaved前面的<span class="literal">master</span>数量的节点列表。保存在masters数组。</span><br><span class="line">计算每个<span class="literal">master</span>节点负责的slot数量，保存在slots_per_node对象，用slot总数除以<span class="literal">master</span>数量取整即可。</span><br><span class="line">遍历masters数组，每个<span class="literal">master</span>分配slots_per_node个slot，最后一个<span class="literal">master</span>，分配到<span class="number">16384</span>个slot为止。</span><br><span class="line">接下来为<span class="literal">master</span>分配<span class="literal">slave</span>，分配算法会尽量保证<span class="literal">master</span>和<span class="literal">slave</span>节点不在同一台主机上。对于分配完指定<span class="literal">slave</span>数量的节点，还有多余的节点，也会为这些节点寻找<span class="literal">master</span>。分配算法会遍历两次masters数组。</span><br><span class="line">第一次遍历masters数组，在余下的节点列表找到replicas数量个<span class="literal">slave</span>。每个<span class="literal">slave</span>为第一个和<span class="literal">master</span>节点host不一样的节点，如果没有不一样的节点，则直接取出余下列表的第一个节点。</span><br><span class="line">第二次遍历是在对于节点数除以replicas不为整数，则会多余一部分节点。遍历的方式跟第一次一样，只是第一次会一次性给<span class="literal">master</span>分配replicas数量个<span class="literal">slave</span>，而第二次遍历只分配一个，直到余下的节点被全部分配出去。</span><br><span class="line"><span class="number">4</span>、打印出分配信息，并提示用户输入“yes”确认是否按照打印出来的分配方式创建集群。</span><br><span class="line"><span class="number">5</span>、输入“yes”后，会执行flush_nodes_config操作，该操作执行前面的分配结果，给<span class="literal">master</span>分配slot，让<span class="literal">slave</span>复制<span class="literal">master</span>，对于还没有握手（cluster meet）的节点，<span class="literal">slave</span>复制操作无法完成，不过没关系，flush_nodes_config操作出现异常会很快返回，后续握手后会再次执行flush_nodes_config。</span><br><span class="line"><span class="number">6</span>、给每个节点分配epoch，遍历节点，每个节点分配的epoch比之前节点大<span class="number">1</span>。</span><br><span class="line"><span class="number">7</span>、节点间开始相互握手，握手的方式为节点列表的其他节点跟第一个节点握手。</span><br><span class="line"><span class="number">8</span>、然后每隔<span class="number">1</span>秒检查一次各个节点是否已经消息同步完成，使用ClusterNode的get_config_signature方法，检查的算法为获取每个节点cluster nodes信息，排序每个节点，组装成node_id1:slots|node_id2:slot2|...的字符串。如果每个节点获得字符串都相同，即认为握手成功。</span><br><span class="line"><span class="number">9</span>、此后会再执行一次flush_nodes_config，这次主要是为了完成<span class="literal">slave</span>复制操作。</span><br><span class="line"><span class="number">10</span>、最后再执行check_cluster，全面检查一次集群状态。包括和前面握手时检查一样的方式再检查一遍。确认没有迁移的节点。确认所有的slot都被分配出去了。</span><br><span class="line"><span class="number">11</span>、至此完成了整个创建流程，返回[OK] All <span class="number">16384</span> slots covered.。</span><br></pre></td></tr></table></figure><h3 id="check检查集群"><a href="#check检查集群" class="headerlink" title="check检查集群"></a>check检查集群</h3><p>检查集群状态的命令，没有其他参数，只需要选择一个集群中的一个节点即可。执行命令以及结果如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">ruby redis-trib.rb check 10.180.157.199:6379</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing Cluster Check (using node 10.180.157.199:6379)</span></span><br><span class="line">M: b2506515b38e6bbd3034d540599f4cd2a5279ad1 10.180.157.199:6379</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: d376aaf80de0e01dde1f8cd4647d5ac3317a8641 10.180.157.205:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates e36c46dbe90960f30861af00786d4c2064e63df2</span><br><span class="line">M: 15126fb33796c2c26ea89e553418946f7443d5a5 10.180.157.201:6379</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 59fa6ee455f58a5076f6d6f83ddd74161fd7fb55 10.180.157.208:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 15126fb33796c2c26ea89e553418946f7443d5a5</span><br><span class="line">S: 460b3a11e296aafb2615043291b7dd98274bb351 10.180.157.202:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates b2506515b38e6bbd3034d540599f4cd2a5279ad1</span><br><span class="line">M: e36c46dbe90960f30861af00786d4c2064e63df2 10.180.157.200:6379</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure><p>检查前会先执行load_cluster_info_from_node方法，把所有节点数据load进来。load的方式为通过自己的cluster nodes发现其他节点，然后连接每个节点，并加入nodes数组。接着生成节点间的复制关系。</p><p>load完数据后，开始检查数据，检查的方式也是调用创建时候使用的check_cluster。</p><h3 id="info查看集群信息"><a href="#info查看集群信息" class="headerlink" title="info查看集群信息"></a>info查看集群信息</h3><p>info命令用来查看集群的信息。info命令也是先执行load_cluster_info_from_node获取完整的集群信息。然后显示ClusterNode的info_string结果，示例如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">ruby redis-trib.rb info 10.180.157.199:6379</span></span><br><span class="line">10.180.157.199:6379 (b2506515...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line">10.180.157.201:6379 (15126fb3...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line">10.180.157.200:6379 (e36c46db...) -&gt; 0 keys | 5462 slots | 1 slaves.</span><br><span class="line">[OK] 0 keys in 3 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br></pre></td></tr></table></figure><h3 id="fix修复集群"><a href="#fix修复集群" class="headerlink" title="fix修复集群"></a>fix修复集群</h3><p>fix命令的流程跟check的流程很像，显示加载集群信息，然后在check_cluster方法内传入fix为<br>true的变量，会在集群检查出现异常的时候执行修复流程。目前fix命令能修复两种异常，一种是集群有处于迁移中的slot的节点，一种是slot未完全分配的异常。</p><p>fix_open_slot方法是修复集群有处于迁移中的slot的节点异常。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、先检查该slot是谁负责的，迁移的源节点如果没完成迁移，owner还是该节点。没有owner的slot无法完成修复功能。</span><br><span class="line"><span class="number">2</span>、遍历每个节点，获取哪些节点标记该slot为migrating状态，哪些节点标记该slot为importing状态。对于owner不是该节点，但是通过cluster countkeysinslot获取到该节点有数据的情况，也认为该节点为importing状态。</span><br><span class="line"><span class="number">3</span>、如果migrating和importing状态的节点均只有<span class="number">1</span>个，这可能是迁移过程中redis-trib.rb被中断所致，直接执行move_slot继续完成迁移任务即可。传递dots和fix为<span class="literal">true</span>。</span><br><span class="line"><span class="number">4</span>、如果migrating为空，importing状态的节点大于<span class="number">0</span>，那么这种情况执行回滚流程，将importing状态的节点数据通过move_slot方法导给slot的owner节点，传递dots、fix和cold为<span class="literal">true</span>。接着对importing的节点执行cluster stable命令恢复稳定。</span><br><span class="line"><span class="number">5</span>、如果importing状态的节点为空，有一个migrating状态的节点，而且该节点在当前slot没有数据，那么可以直接把这个slot设为stable。</span><br><span class="line"><span class="number">6</span>、如果migrating和importing状态不是上述情况，目前redis-trib.rb工具无法修复，上述的三种情况也已经覆盖了通过redis-trib.rb工具迁移出现异常的各个方面，人为的异常情形太多，很难考虑完全。</span><br><span class="line">fix_slots_coverage方法能修复slot未完全分配的异常。未分配的slot有三种状态。</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、所有节点的该slot都没有数据。该状态redis-trib.rb工具直接采用随机分配的方式，并没有考虑节点的均衡。本人尝试对没有分配slot的集群通过fix修复集群，结果slot还是能比较平均的分配，但是没有了连续性，打印的slot信息非常离散。</span><br><span class="line"><span class="number">2</span>、有一个节点的该slot有数据。该状态下，直接把slot分配给该slot有数据的节点。</span><br><span class="line"><span class="number">3</span>、有多个节点的该slot有数据。此种情况目前还处于TODO状态，不过redis作者列出了修复的步骤，对这些节点，除第一个节点，执行cluster migrating命令，然后把这些节点的数据迁移到第一个节点上。清除migrating状态，然后把slot分配给第一个节点。</span><br></pre></td></tr></table></figure><h3 id="reshard在线迁移slot"><a href="#reshard在线迁移slot" class="headerlink" title="reshard在线迁移slot"></a>reshard在线迁移slot</h3><p>reshard命令可以在线把集群的一些slot从集群原来slot负责节点迁移到新的节点，利用reshard可以完成集群的在线横向扩容和缩容。</p><p>reshard的参数很多，下面来一一解释一番：</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">reshard</span>         host:<span class="keyword">port</span></span><br><span class="line">                <span class="comment">--from </span></span><br><span class="line">                <span class="comment">--to </span></span><br><span class="line">                <span class="comment">--slots </span></span><br><span class="line">                <span class="comment">--yes</span></span><br><span class="line">                <span class="comment">--timeout </span></span><br><span class="line">                <span class="comment">--pipeline </span></span><br><span class="line">host:<span class="keyword">port</span>：这个是必传参数，用来从一个节点获取整个集群信息，相当于获取集群信息的入口。</span><br><span class="line"><span class="comment">--from ：需要从哪些源节点上迁移slot，可从多个源节点完成迁移，以逗号隔开，传递的是节点的node id，还可以直接传递--from all，这样源节点就是集群的所有节点，不传递该参数的话，则会在迁移过程中提示用户输入。</span></span><br><span class="line"><span class="comment">--to ：slot需要迁移的目的节点的node id，目的节点只能填写一个，不传递该参数的话，则会在迁移过程中提示用户输入。</span></span><br><span class="line"><span class="comment">--slots ：需要迁移的slot数量，不传递该参数的话，则会在迁移过程中提示用户输入。</span></span><br><span class="line"><span class="comment">--yes：设置该参数，可以在打印执行reshard计划的时候，提示用户输入yes确认后再执行reshard。</span></span><br><span class="line"><span class="comment">--timeout ：设置migrate命令的超时时间。</span></span><br><span class="line"><span class="comment">--pipeline ：定义cluster getkeysinslot命令一次取出的key数量，不传的话使用默认值为10。</span></span><br></pre></td></tr></table></figure><p>迁移的流程如下：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、通过load_cluster_info_from_node方法装载集群信息。</span><br><span class="line"><span class="number">2</span>、执行check_cluster方法检查集群是否健康。只有健康的集群才能进行迁移。</span><br><span class="line"><span class="number">3</span>、获取需要迁移的slot数量，用户没传递--slots参数，则提示用户手动输入。</span><br><span class="line"><span class="number">4</span>、获取迁移的目的节点，用户没传递--to参数，则提示用户手动输入。此处会检查目的节点必须为master节点。</span><br><span class="line"><span class="number">5</span>、获取迁移的源节点，用户没传递--<span class="keyword">from</span>参数，则提示用户手动输入。此处会检查源节点必须为master节点。--<span class="keyword">from</span> all的话，源节点就是除了目的节点外的全部master节点。这里为了保证集群slot分配的平均，建议传递--<span class="keyword">from</span> all。</span><br><span class="line"><span class="number">6</span>、执行compute_reshard_table方法，计算需要迁移的slot数量如何分配到源节点列表，采用的算法是按照节点负责slot数量由多到少排序，计算每个节点需要迁移的slot的方法为：迁移slot数量 * (该源节点负责的slot数量 / 源节点列表负责的slot总数)。这样算出的数量可能不为整数，这里代码用了下面的方式处理：</span><br><span class="line"></span><br><span class="line">n = (numslots/source_tot_slots*s.slots.length)</span><br><span class="line"><span class="keyword">if</span> i == <span class="number">0</span></span><br><span class="line">    n = n.ceil</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    n = n.floor</span><br><span class="line">这样的处理方式会带来最终分配的slot与请求迁移的slot数量不一致，这个BUG已经在github上提给作者，https:<span class="comment">//github.com/antirez/redis/issues/2990。</span></span><br><span class="line"></span><br><span class="line"><span class="number">7</span>、打印出reshard计划，如果用户没传--yes，就提示用户确认计划。</span><br><span class="line"><span class="number">8</span>、根据reshard计划，一个个slot的迁移到新节点上，迁移使用move_slot方法，该方法被很多命令使用，具体可以参见下面的迁移流程。move_slot方法传递dots为<span class="literal">true</span>和pipeline数量。</span><br><span class="line"><span class="number">9</span>、至此，就完成了全部的迁移任务。</span><br></pre></td></tr></table></figure><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">ruby redis-trib.rb reshard --<span class="keyword">from</span> all --to <span class="number">80</span>b661ecca260c89e3d8ea9b98f77edaeef43dcd --slots <span class="number">11</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span></span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span>)</span><br><span class="line">S: b2506515b38e6bbd3034d540599f4cd2a5279ad1 <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates <span class="number">460</span>b3a11e296aafb2615043291b7dd98274bb351</span><br><span class="line">S: d376aaf80de0e01dde1f8cd4647d5ac3317a8641 <span class="number">10.180</span><span class="number">.157</span><span class="number">.205</span>:<span class="number">6379</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates e36c46dbe90960f30861af00786d4c2064e63df2</span><br><span class="line">M: <span class="number">15126f</span>b33796c2c26ea89e553418946f7443d5a5 <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">10923</span><span class="number">-16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">S: <span class="number">59f</span>a6ee455f58a5076f6d6f83ddd74161fd7fb55 <span class="number">10.180</span><span class="number">.157</span><span class="number">.208</span>:<span class="number">6379</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates <span class="number">15126f</span>b33796c2c26ea89e553418946f7443d5a5</span><br><span class="line">M: <span class="number">460</span>b3a11e296aafb2615043291b7dd98274bb351 <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">0</span><span class="number">-5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">M: <span class="number">80</span>b661ecca260c89e3d8ea9b98f77edaeef43dcd <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">M: e36c46dbe90960f30861af00786d4c2064e63df2 <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">5461</span><span class="number">-10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All <span class="number">16384</span> slots covered.</span><br><span class="line"></span><br><span class="line">Ready to move <span class="number">11</span> slots.</span><br><span class="line">  Source nodes:</span><br><span class="line">    M: <span class="number">15126f</span>b33796c2c26ea89e553418946f7443d5a5 <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">10923</span><span class="number">-16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">    M: <span class="number">460</span>b3a11e296aafb2615043291b7dd98274bb351 <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">0</span><span class="number">-5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">    M: e36c46dbe90960f30861af00786d4c2064e63df2 <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">5461</span><span class="number">-10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">  Destination node:</span><br><span class="line">    M: <span class="number">80</span>b661ecca260c89e3d8ea9b98f77edaeef43dcd <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">  Resharding plan:</span><br><span class="line">    Moving slot <span class="number">5461</span> <span class="keyword">from</span> e36c46dbe90960f30861af00786d4c2064e63df2</span><br><span class="line">    Moving slot <span class="number">5462</span> <span class="keyword">from</span> e36c46dbe90960f30861af00786d4c2064e63df2</span><br><span class="line">    Moving slot <span class="number">5463</span> <span class="keyword">from</span> e36c46dbe90960f30861af00786d4c2064e63df2</span><br><span class="line">    Moving slot <span class="number">5464</span> <span class="keyword">from</span> e36c46dbe90960f30861af00786d4c2064e63df2</span><br><span class="line">    Moving slot <span class="number">0</span> <span class="keyword">from</span> <span class="number">460</span>b3a11e296aafb2615043291b7dd98274bb351</span><br><span class="line">    Moving slot <span class="number">1</span> <span class="keyword">from</span> <span class="number">460</span>b3a11e296aafb2615043291b7dd98274bb351</span><br><span class="line">    Moving slot <span class="number">2</span> <span class="keyword">from</span> <span class="number">460</span>b3a11e296aafb2615043291b7dd98274bb351</span><br><span class="line">    Moving slot <span class="number">10923</span> <span class="keyword">from</span> <span class="number">15126f</span>b33796c2c26ea89e553418946f7443d5a5</span><br><span class="line">    Moving slot <span class="number">10924</span> <span class="keyword">from</span> <span class="number">15126f</span>b33796c2c26ea89e553418946f7443d5a5</span><br><span class="line">    Moving slot <span class="number">10925</span> <span class="keyword">from</span> <span class="number">15126f</span>b33796c2c26ea89e553418946f7443d5a5</span><br><span class="line">Do you want to proceed with the proposed reshard plan (yes/no)? yes</span><br><span class="line">Moving slot <span class="number">5461</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">5462</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">5463</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">5464</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">0</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">1</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">2</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">10923</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">10924</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br><span class="line">Moving slot <span class="number">10925</span> <span class="keyword">from</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span> to <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6380</span>:</span><br></pre></td></tr></table></figure><p>move_slot方法可以在线将一个slot的全部数据从源节点迁移到目的节点，fix、reshard、rebalance都需要调用该方法迁移slot。</p><p>move_slot接受下面几个参数，</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、pipeline：设置一次从slot上获取多少个<span class="type">key</span>。</span><br><span class="line"><span class="number">2</span>、quiet：迁移会打印相关信息，设置quiet参数，可以不用打印这些信息。</span><br><span class="line"><span class="number">3</span>、cold：设置cold，会忽略执行importing和migrating。</span><br><span class="line"><span class="number">4</span>、dots：设置dots，则会在迁移过程打印迁移<span class="type">key</span>数量的进度。</span><br><span class="line"><span class="number">5</span>、update：设置update，则会更新内存信息，方便以后的操作。</span><br></pre></td></tr></table></figure><p>move_slot流程如下：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、如果没有设置cold，则对源节点执行cluster importing命令，对目的节点执行migrating命令。fix的时候有可能importing和migrating已经执行过来，所以此种场景会设置cold。</span><br><span class="line"><span class="number">2</span>、通过cluster getkeysinslot命令，一次性获取远节点迁移slot的pipeline个<span class="type">key</span>的数量.</span><br><span class="line"><span class="number">3</span>、对这些<span class="type">key</span>执行migrate命令，将数据从源节点迁移到目的节点。</span><br><span class="line"><span class="number">4</span>、如果migrate出现异常，在fix模式下，BUSYKEY的异常，会使用migrate的replace模式再执行一次，BUSYKEY表示目的节点已经有该<span class="type">key</span>了，replace模式可以强制替换目的节点的<span class="type">key</span>。不是fix模式就直接返回错误了。</span><br><span class="line"><span class="number">5</span>、循环执行cluster getkeysinslot命令，直到返回的<span class="type">key</span>数量为<span class="number">0</span>，就退出循环。</span><br><span class="line"><span class="number">6</span>、如果没有设置cold，对每个节点执行cluster setslot命令，把slot赋给目的节点。</span><br><span class="line"><span class="number">7</span>、如果设置update，则修改源节点和目的节点的slot信息。</span><br><span class="line"><span class="number">8</span>、至此完成了迁移slot的流程。</span><br></pre></td></tr></table></figure><h3 id="rebalance平衡集群节点slot数量"><a href="#rebalance平衡集群节点slot数量" class="headerlink" title="rebalance平衡集群节点slot数量"></a>rebalance平衡集群节点slot数量</h3><p>rebalance命令可以根据用户传入的参数平衡集群节点的slot数量，rebalance功能非常强大，可以传入的参数很多，以下是rebalance的参数列表和命令示例。</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">rebalance</span>       <span class="comment">host:port</span></span><br><span class="line"><span class="comment"></span>                <span class="literal">-</span><span class="literal">-</span><span class="comment">weight</span> </span><br><span class="line">                <span class="literal">-</span><span class="literal">-</span><span class="comment">auto</span><span class="literal">-</span><span class="comment">weights</span></span><br><span class="line"><span class="comment"></span>                <span class="literal">-</span><span class="literal">-</span><span class="comment">threshold</span> </span><br><span class="line">                <span class="literal">-</span><span class="literal">-</span><span class="comment">use</span><span class="literal">-</span><span class="comment">empty</span><span class="literal">-</span><span class="comment">masters</span></span><br><span class="line"><span class="comment"></span>                <span class="literal">-</span><span class="literal">-</span><span class="comment">timeout</span> </span><br><span class="line">                <span class="literal">-</span><span class="literal">-</span><span class="comment">simulate</span></span><br><span class="line"><span class="comment"></span>                <span class="literal">-</span><span class="literal">-</span><span class="comment">pipeline</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">$ruby</span> <span class="comment">redis</span><span class="literal">-</span><span class="comment">trib</span><span class="string">.</span><span class="comment">rb</span> <span class="comment">rebalance</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">threshold</span> <span class="comment">1</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">weight</span> <span class="comment">b31e3a2e=5</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">weight</span> <span class="comment">60b8e3a1=5</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">use</span><span class="literal">-</span><span class="comment">empty</span><span class="literal">-</span><span class="comment">masters</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">simulate</span> <span class="comment">10</span><span class="string">.</span><span class="comment">180</span><span class="string">.</span><span class="comment">157</span><span class="string">.</span><span class="comment">199:6379</span></span><br><span class="line"><span class="comment">下面也先一一解释下每个参数的用法：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">host:port：这个是必传参数，用来从一个节点获取整个集群信息，相当于获取集群信息的入口。</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="comment">weight</span> <span class="comment">：节点的权重，格式为node_id=weight，如果需要为多个节点分配权重的话，需要添加多个</span><span class="literal">-</span><span class="literal">-</span><span class="comment">weight</span> <span class="comment">参数，即</span><span class="literal">-</span><span class="literal">-</span><span class="comment">weight</span> <span class="comment">b31e3a2e=5</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">weight</span> <span class="comment">60b8e3a1=5，node_id可为节点名称的前缀，只要保证前缀位数能唯一区分该节点即可。没有传递–weight的节点的权重默认为1。</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="comment">auto</span><span class="literal">-</span><span class="comment">weights：这个参数在rebalance流程中并未用到。</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="comment">threshold</span> <span class="comment">：只有节点需要迁移的slot阈值超过threshold，才会执行rebalance操作。具体计算方法可以参考下面的rebalance命令流程的第四步。</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="comment">use</span><span class="literal">-</span><span class="comment">empty</span><span class="literal">-</span><span class="comment">masters：rebalance是否考虑没有节点的master，默认没有分配slot节点的master是不参与rebalance的，设置</span><span class="literal">-</span><span class="literal">-</span><span class="comment">use</span><span class="literal">-</span><span class="comment">empty</span><span class="literal">-</span><span class="comment">masters可以让没有分配slot的节点参与rebalance。</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="comment">timeout</span> <span class="comment">：设置migrate命令的超时时间。</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="comment">simulate：设置该参数，可以模拟rebalance操作，提示用户会迁移哪些slots，而不会真正执行迁移操作。</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="comment">pipeline</span> <span class="comment">：与reshar的pipeline参数一样，定义cluster</span> <span class="comment">getkeysinslot命令一次取出的key数量，不传的话使用默认值为10。</span></span><br></pre></td></tr></table></figure><p>rebalance命令流程如下：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、load_cluster_info_from_node方法先加载集群信息。</span><br><span class="line"><span class="number">2</span>、计算每个master的权重，根据参数--weight ，为每个设置的节点分配权重，没有设置的节点，则权重默认为<span class="number">1</span>。</span><br><span class="line"><span class="number">3</span>、根据每个master的权重，以及总的权重，计算自己期望被分配多少个slot。计算的方式为：总slot数量 * （自己的权重 / 总权重）。</span><br><span class="line"><span class="number">4</span>、计算每个master期望分配的slot是否超过设置的阈值，即--threshold 设置的阈值或者默认的阈值。计算的方式为：先计算期望移动节点的阈值，算法为：(<span class="number">100</span>-(<span class="number">100.0</span>*expected/n.slots.length)).abs，如果计算出的阈值没有超出设置阈值，则不需要为该节点移动slot。只要有一个master的移动节点超过阈值，就会触发rebalance操作。</span><br><span class="line"><span class="number">5</span>、如果触发了rebalance操作。那么就开始执行rebalance操作，先将每个节点当前分配的slots数量减去期望分配的slot数量获得balance值。将每个节点的balance从小到大进行排序获得sn数组。</span><br><span class="line"><span class="number">6</span>、用dst_idx和src_idx游标分别从sn数组的头部和尾部开始遍历。目的是为了把尾部节点的slot分配给头部节点。</span><br><span class="line"></span><br><span class="line">sn数组保存的balance列表排序后，负数在前面，正数在后面。负数表示需要有slot迁入，所以使用dst_idx游标，正数表示需要有slot迁出，所以使用src_idx游标。理论上sn数组各节点的balance值加起来应该为<span class="number">0</span>，不过由于在计算期望分配的slot的时候只是使用直接取整的方式，所以可能出现balance值之和不为<span class="number">0</span>的情况，balance值之和不为<span class="number">0</span>即为节点不平衡的slot数量，由于slot总数有<span class="number">16384</span>个，不平衡数量相对于总数，基数很小，所以对rebalance流程影响不大。</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>、获取sn[dst_idx]和sn[src_idx]的balance值较小的那个值，该值即为需要从sn[src_idx]节点迁移到sn[dst_idx]节点的slot数量。</span><br><span class="line"><span class="number">8</span>、接着通过compute_reshard_table方法计算源节点的slot如何分配到源节点列表。这个方法在reshard流程中也有调用，具体步骤可以参考reshard流程的第六步。</span><br><span class="line"><span class="number">9</span>、如果是simulate模式，则只是打印出迁移列表。</span><br><span class="line"><span class="number">10</span>、如果没有设置simulate，则执行move_slot操作，迁移slot，传入的参数为:quiet=&gt;<span class="literal">true</span>,:dots=&gt;<span class="literal">false</span>,:update=&gt;<span class="literal">true</span>。</span><br><span class="line"><span class="number">11</span>、迁移完成后更新sn[dst_idx]和sn[src_idx]的balance值。如果balance值为<span class="number">0</span>后，游标向前进<span class="number">1</span>。</span><br><span class="line"><span class="number">12</span>、直到dst_idx到达src_idx游标，完成整个rebalance操作。</span><br></pre></td></tr></table></figure><h3 id="add-node将新节点加入集群"><a href="#add-node将新节点加入集群" class="headerlink" title="add-node将新节点加入集群"></a>add-node将新节点加入集群</h3><p>add-node命令可以将新节点加入集群，节点可以为master，也可以为某个master节点的slave。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add-node    new_host:new_port existing_host:existing_port</span><br><span class="line">          --slave</span><br><span class="line">          --master-id </span><br><span class="line">add-node有两个可选参数：</span><br><span class="line"></span><br><span class="line">--slave：设置该参数，则新节点以slave的角色加入集群</span><br><span class="line">--master-id：这个参数需要设置了--slave才能生效，--master-id用来指定新节点的master节点。如果不设置该参数，则会随机为节点选择master节点。</span><br></pre></td></tr></table></figure><p>可以看下add-node命令的执行示例：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ruby redis-trib.rb add-node --slave --master-id dcb792b3e85726f012e83061bf237072dfc45f99 <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span></span><br><span class="line">&gt;&gt;&gt; Adding node <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span> to cluster <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span></span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span>)</span><br><span class="line">M: dcb792b3e85726f012e83061bf237072dfc45f99 <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">0</span><span class="number">-5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">M: <span class="number">464</span>d740bf48953ebcf826f4113c86f9db3a9baf3 <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">10923</span><span class="number">-16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">M: befa7e17b4e5f239e519bc74bfef3264a40f96ae <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span></span><br><span class="line">   slots:<span class="number">5461</span><span class="number">-10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All <span class="number">16384</span> slots covered.</span><br><span class="line">&gt;&gt;&gt; Send CLUSTER MEET to node <span class="number">10.180</span><span class="number">.157</span><span class="number">.202</span>:<span class="number">6379</span> to make it join the cluster.</span><br><span class="line">Waiting <span class="keyword">for</span> the cluster to join.</span><br><span class="line">&gt;&gt;&gt; Configure node as replica of <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379.</span></span><br><span class="line">[OK] New node added correctly.</span><br></pre></td></tr></table></figure><p>add-node流程如下：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、通过load_cluster_<span class="literal">inf</span>o_from_node方法转载集群信息，check_cluster方法检查集群是否健康。</span><br><span class="line"><span class="number">2</span>、如果设置了--<span class="literal">slave</span>，则需要为该节点寻找<span class="literal">master</span>节点。设置了--<span class="literal">master</span>-id，则以该节点作为新节点的<span class="literal">master</span>，如果没有设置--<span class="literal">master</span>-id，则调用get_master_with_least_replicas方法，寻找<span class="literal">slave</span>数量最少的<span class="literal">master</span>节点。如果<span class="literal">slave</span>数量一致，则选取load_cluster_<span class="literal">inf</span>o_from_node顺序发现的第一个节点。load_cluster_<span class="literal">inf</span>o_from_node顺序的第一个节点是add-<span class="keyword">node</span><span class="title">设置的existing_host</span>:existing_port节点，后面的顺序根据在该节点执行cluster nodes返回的结果返回的节点顺序。</span><br><span class="line"><span class="number">3</span>、连接新的节点并与集群第一个节点握手。</span><br><span class="line"><span class="number">4</span>、如果没设置–<span class="literal">slave</span>就直接返回ok，设置了–<span class="literal">slave</span>，则需要等待确认新节点加入集群，然后执行cluster replicate命令复制<span class="literal">master</span>节点。</span><br><span class="line"><span class="number">5</span>、至此，完成了全部的增加节点的流程。</span><br></pre></td></tr></table></figure><h3 id="del-node从集群中删除节点"><a href="#del-node从集群中删除节点" class="headerlink" title="del-node从集群中删除节点"></a>del-node从集群中删除节点</h3><p>del-node可以把某个节点从集群中删除。del-node只能删除没有分配slot的节点。删除命令传递两个参数：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">host:port：从该节点获取集群信息。</span><br><span class="line">node_id：需要删除的节点<span class="built_in">id</span>。</span><br></pre></td></tr></table></figure><p>del-node执行结果示例如下：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ruby redis-trib.rb del-<span class="keyword">node</span> <span class="title">10</span>.<span class="number">180.157</span>.<span class="number">199</span>:<span class="number">6379</span> d5f6d1d17426bd564a6e309f32d0f5b96962fe53</span><br><span class="line">&gt;&gt;&gt; Removing <span class="keyword">node</span> <span class="title">d5f6d1d17426bd564a6e309f32d0f5b96962fe53</span> from cluster <span class="number">10.180</span>.<span class="number">157.199</span>:<span class="number">6379</span></span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="line">&gt;&gt;&gt; SHUTDOWN the <span class="keyword">node</span>.<span class="title"></span></span><br></pre></td></tr></table></figure><p>del-node流程如下：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、通过load_cluster_<span class="literal">inf</span>o_from_node方法转载集群信息。</span><br><span class="line"><span class="number">2</span>、根据传入的<span class="keyword">node</span> <span class="title">id</span>获取节点，如果节点没找到，则直接提示错误并退出。</span><br><span class="line"><span class="number">3</span>、如果节点分配的slot不为空，则直接提示错误并退出。</span><br><span class="line"><span class="number">4</span>、遍历集群内的其他节点，执行cluster forget命令，从每个节点中去除该节点。如果删除的节点是<span class="literal">master</span>，而且它有<span class="literal">slave</span>的话，这些<span class="literal">slave</span>会去复制其他<span class="literal">master</span>，调用的方法是get_master_with_least_replicas，与add-<span class="keyword">node</span><span class="title">没设置--master-id</span>寻找<span class="literal">master</span>的方法一样。</span><br><span class="line"><span class="number">5</span>、然后关闭该节点。</span><br></pre></td></tr></table></figure><h3 id="set-timeout设置集群节点间心跳连接的超时时间"><a href="#set-timeout设置集群节点间心跳连接的超时时间" class="headerlink" title="set-timeout设置集群节点间心跳连接的超时时间"></a>set-timeout设置集群节点间心跳连接的超时时间</h3><p>set-timeout用来设置集群节点间心跳连接的超时时间，单位是毫秒，不得小于100毫秒，因为100毫秒对于心跳时间来说太短了。该命令修改是节点配置参数cluster-node-timeout，默认是15000毫秒。通过该命令，可以给每个节点设置超时时间，设置的方式使用config set命令动态设置，然后执行config rewrite命令将配置持久化保存到硬盘。以下是示例：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ruby redis-trib.rb <span class="keyword">set</span>-timeout <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span> <span class="number">30000</span></span><br><span class="line">&gt;&gt;&gt; Reconfiguring node timeout <span class="keyword">in</span> every cluster node...</span><br><span class="line">*** New timeout <span class="keyword">set</span> <span class="keyword">for</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span></span><br><span class="line">*** New timeout <span class="keyword">set</span> <span class="keyword">for</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.205</span>:<span class="number">6379</span></span><br><span class="line">*** New timeout <span class="keyword">set</span> <span class="keyword">for</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br><span class="line">*** New timeout <span class="keyword">set</span> <span class="keyword">for</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span></span><br><span class="line">*** New timeout <span class="keyword">set</span> <span class="keyword">for</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.208</span>:<span class="number">6379</span></span><br><span class="line">&gt;&gt;&gt; New node timeout <span class="keyword">set</span>. <span class="number">5</span> OK, <span class="number">0</span> ERR.</span><br></pre></td></tr></table></figure><h3 id="call在集群全部节点上执行命令"><a href="#call在集群全部节点上执行命令" class="headerlink" title="call在集群全部节点上执行命令"></a>call在集群全部节点上执行命令</h3><p>call命令可以用来在集群的全部节点执行相同的命令。call命令也是需要通过集群的一个节点地址，连上整个集群，然后在集群的每个节点执行该命令。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ruby redis-trib.rb call <span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span> <span class="keyword">get</span> key</span><br><span class="line">&gt;&gt;&gt; Calling GET key</span><br><span class="line"><span class="number">10.180</span><span class="number">.157</span><span class="number">.199</span>:<span class="number">6379</span>: MOVED <span class="number">12539</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br><span class="line"><span class="number">10.180</span><span class="number">.157</span><span class="number">.205</span>:<span class="number">6379</span>: MOVED <span class="number">12539</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br><span class="line"><span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span>:</span><br><span class="line"><span class="number">10.180</span><span class="number">.157</span><span class="number">.200</span>:<span class="number">6379</span>: MOVED <span class="number">12539</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br><span class="line"><span class="number">10.180</span><span class="number">.157</span><span class="number">.208</span>:<span class="number">6379</span>: MOVED <span class="number">12539</span> <span class="number">10.180</span><span class="number">.157</span><span class="number">.201</span>:<span class="number">6379</span></span><br></pre></td></tr></table></figure><h3 id="import将外部redis数据导入集群"><a href="#import将外部redis数据导入集群" class="headerlink" title="import将外部redis数据导入集群"></a>import将外部redis数据导入集群</h3><p>import命令可以把外部的redis节点数据导入集群。导入的流程如下：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、通过load_cluster_info_from_node方法转载集群信息，check_cluster方法检查集群是否健康。</span><br><span class="line"><span class="number">2</span>、连接外部redis节点，如果外部节点开启了cluster_enabled，则提示错误。</span><br><span class="line"><span class="number">3</span>、通过scan命令遍历外部节点，一次获取<span class="number">1000</span>条数据。</span><br><span class="line"><span class="number">4</span>、遍历这些<span class="type">key</span>，计算出<span class="type">key</span>对应的slot。</span><br><span class="line"><span class="number">5</span>、执行migrate命令,源节点是外部节点,目的节点是集群slot对应的节点，如果设置了--copy参数，则传递copy参数，如果设置了--replace，则传递replace参数。</span><br><span class="line"><span class="number">6</span>、不停执行scan命令，直到遍历完全部的<span class="type">key</span>。</span><br><span class="line"><span class="number">7</span>、至此完成整个迁移流程</span><br><span class="line">这中间如果出现异常，程序就会停止。没使用--copy模式，则可以重新执行import命令，使用--copy的话，最好清空新的集群再导入一次。</span><br></pre></td></tr></table></figure><p>import命令更适合离线的把外部redis数据导入，在线导入的话最好使用更专业的导入工具，以slave的方式连接redis节点去同步节点数据应该是更好的方式。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;redis-trib.rb是redis官方推出的管理redis集群的工具，集成在redis的源码src目录下，是基于redis提供的集群命令封装成简单、便捷、实用的操作工具。redis-trib.rb是redis作者用ruby完成的。&lt;/p&gt;
&lt;figure class=&quot;
      
    
    </summary>
    
    
      <category term="redis" scheme="https://www.xiemx.com/categories/redis/"/>
    
    
      <category term="redis" scheme="https://www.xiemx.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redis-trib.rb构建redis集群</title>
    <link href="https://www.xiemx.com//2017/02/27/redis-trib-rb-create-cluster/"/>
    <id>https://www.xiemx.com//2017/02/27/redis-trib-rb-create-cluster/</id>
    <published>2017-02-26T20:02:11.000Z</published>
    <updated>2019-10-21T06:57:42.922Z</updated>
    
    <content type="html"><![CDATA[<p>redis-cluster</p><p>使用官方的redis-trib.rb构建redis集群,要让redis cluster集群正常工作需要有三个主节点，因此我们在三台机器上部署6个节点，每台机器一个master一个slave。</p><p>环境：<br>p-hsg-redis-1  192.168.10.81   7000/7001<br>p-hsg-redis-2     192.168.10.82   7000/7001<br>p-hsg-redis-3     192.168.10.83   7000/7001</p><p>部署流程：</p><p>1.安装redis－server</p><p>我这里已经有saltstack的自动化构建脚本，因此使用salt安装软件。具体redis安装方法不再赘述。<br>salt-call state.sls redis.cluster</p><p>2.修改配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@p-hsg-redis-1:/etc/redis# cat /etc/redis/7000.conf</span><br><span class="line">protected-mode no</span><br><span class="line">daemonize yes</span><br><span class="line">port 7000</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-7000.conf</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line">appendonly yes</span><br><span class="line">dir /var/lib/redis/7000</span><br></pre></td></tr></table></figure><p>3.启动redis节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@p-hsg-redis-3:/etc/redis# ps -ef | grep redis</span><br><span class="line">root     30431     1  0 15:12 ?        00:00:00 /usr/local/bin/redis-server *:7001 [cluster]</span><br><span class="line">root     30446     1  0 15:12 ?        00:00:00 /usr/local/bin/redis-server *:7000 [cluster]</span><br><span class="line">root     30450 11073  0 15:12 pts/1    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure><p>4.创建集群</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb create --replicas 1 192.168.10.81:7001 192.168.10.81:7000 192.168.10.82:7000 192.168.10.82:7001 192.168.10.83:7000 192.168.10.83:7001</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Creating cluster</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span></span><br><span class="line">Using 3 masters:</span><br><span class="line">192.168.10.81:7001</span><br><span class="line">192.168.10.82:7000</span><br><span class="line">192.168.10.83:7000</span><br><span class="line">Adding replica 192.168.10.82:7001 to 192.168.10.81:7001</span><br><span class="line">Adding replica 192.168.10.81:7000 to 192.168.10.82:7000</span><br><span class="line">Adding replica 192.168.10.83:7001 to 192.168.10.83:7000</span><br><span class="line">M: 5fd250591aa474d6370e1df547959c5895716192 192.168.10.81:7001</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">S: ef8bf8a326894fee37a398d3f88de3120fc71ea5 192.168.10.81:7000</span><br><span class="line">   replicates dc62f19b8894db1816f7b92e3fe05b8244832d3e</span><br><span class="line">M: dc62f19b8894db1816f7b92e3fe05b8244832d3e 192.168.10.82:7000</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">S: eb2c7cc3cb56bb5ee124d80e353a91331d092042 192.168.10.82:7001</span><br><span class="line">   replicates 5fd250591aa474d6370e1df547959c5895716192</span><br><span class="line">M: 1773d96052f573361a13b5e9015f947b340d45cd 192.168.10.83:7000</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">S: 670f158355b93b4a7ac30d69dc3e1e8c4c484a9f 192.168.10.83:7001</span><br><span class="line">   replicates 1773d96052f573361a13b5e9015f947b340d45cd</span><br><span class="line">Can I set the above configuration? (type 'yes' to accept): yes</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Nodes configuration updated</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Assign a different config epoch to each node</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span></span><br><span class="line">Waiting for the cluster to join...</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing Cluster Check (using node 192.168.10.81:7001)</span></span><br><span class="line">M: 5fd250591aa474d6370e1df547959c5895716192 192.168.10.81:7001</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 1773d96052f573361a13b5e9015f947b340d45cd 192.168.10.83:7000</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: ef8bf8a326894fee37a398d3f88de3120fc71ea5 192.168.10.81:7000</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates dc62f19b8894db1816f7b92e3fe05b8244832d3e</span><br><span class="line">S: 670f158355b93b4a7ac30d69dc3e1e8c4c484a9f 192.168.10.83:7001</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 1773d96052f573361a13b5e9015f947b340d45cd</span><br><span class="line">M: dc62f19b8894db1816f7b92e3fe05b8244832d3e 192.168.10.82:7000</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: eb2c7cc3cb56bb5ee124d80e353a91331d092042 192.168.10.82:7001</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 5fd250591aa474d6370e1df547959c5895716192</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;redis-cluster&lt;/p&gt;
&lt;p&gt;使用官方的redis-trib.rb构建redis集群,要让redis cluster集群正常工作需要有三个主节点，因此我们在三台机器上部署6个节点，每台机器一个master一个slave。&lt;/p&gt;
&lt;p&gt;环境：&lt;br&gt;p-hsg-
      
    
    </summary>
    
    
      <category term="redis" scheme="https://www.xiemx.com/categories/redis/"/>
    
    
      <category term="cluster" scheme="https://www.xiemx.com/tags/cluster/"/>
    
      <category term="redis" scheme="https://www.xiemx.com/tags/redis/"/>
    
  </entry>
  
</feed>
