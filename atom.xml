<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>求索</title>
  
  <subtitle>尔不必求记，却宜求个明白！</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.xiemx.com/"/>
  <updated>2019-12-12T07:06:52.916Z</updated>
  <id>https://www.xiemx.com/</id>
  
  <author>
    <name>Mingxu.xie</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>nginx remote_port为空</title>
    <link href="https://www.xiemx.com//2019/12/12/nginx-remote-port-is-null/"/>
    <id>https://www.xiemx.com//2019/12/12/nginx-remote-port-is-null/</id>
    <published>2019-12-12T02:01:04.000Z</published>
    <updated>2019-12-12T07:06:52.916Z</updated>
    
    <content type="html"><![CDATA[<h3 id="nginx-remote-port为空"><a href="#nginx-remote-port为空" class="headerlink" title="nginx remote_port为空"></a>nginx remote_port为空</h3><h4 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h4><p>由于网安要求记录用户请求来源端口到日志中，因此为了实现这个需求在log_format中增加了”ngx_remote_port: $remote_port”字段(如下)， 但实际日志系统中收录到的日志<code>ngx_remote_port:&quot;&quot;</code>为空</p><figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">log_format json '&#123; <span class="string">"time"</span>: <span class="string">"<span class="variable">$time_iso8601</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_true_client_ip"</span>: <span class="string">"<span class="variable">$http_true_client_ip</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_x_real_ip"</span>: <span class="string">"<span class="variable">$http_x_real_ip</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_cdn_src_ip"</span>: <span class="string">"<span class="variable">$http_cdn_src_ip</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_geo_location_ip"</span>: <span class="string">"<span class="variable">$client_ip</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_remote_addr"</span>: <span class="string">"<span class="variable">$remote_addr</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_remote_port"</span>: <span class="string">"<span class="variable">$remote_port</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_x_user_site_proxy"</span>: <span class="string">"<span class="variable">$http_x_user_site_proxy</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_x_forwarded_for"</span>: <span class="string">"<span class="variable">$http_x_forwarded_for</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_host"</span>: <span class="string">"<span class="variable">$host</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_http_user_agent"</span>: <span class="string">"<span class="variable">$http_user_agent</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_body_bytes_sent"</span>: <span class="string">"<span class="variable">$body_bytes_sent</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_request_time"</span>: <span class="string">"<span class="variable">$request_time</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_upstream_response_time"</span>: <span class="string">"<span class="variable">$upstream_response_time</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_upstream_connect_time"</span>: <span class="string">"<span class="variable">$upstream_connect_time</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_upstream_header_time:"</span>: <span class="string">"<span class="variable">$upstream_header_time</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_upstream_addr"</span>: <span class="string">"<span class="variable">$upstream_addr</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_upstream_content_length"</span>: <span class="string">"<span class="variable">$sent_http_content_length</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_status_code"</span>: <span class="string">"<span class="variable">$status</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_scheme"</span>: <span class="string">"<span class="variable">$scheme</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_request_method"</span>: <span class="string">"<span class="variable">$request_method</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_request_uri"</span>: <span class="string">"<span class="variable">$request_uri</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_request"</span>: <span class="string">"<span class="variable">$request</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_http_referrer"</span>: <span class="string">"<span class="variable">$http_referer</span>"</span>  &#125;';</span><br></pre></td></tr></table></figure><h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>由于$remote_port这个变量是nginx核心模块提供的，因此猜测是由第三方模块再次操作导致为空，经过测试发现通过proxy进来的请求remote_port为空，<br>而直接访问本地nginx的请求都能够正确获取port信息，对于以上2中情况的对比<br>怀疑是由于经过proxy之类的组建request header中有x-forworder-for的头，从而触发了realip 模块（这个怀疑没有具体验证），解决方案就是使用realip模块提供的变量’realip_remote_port’来记录来源port, 修改log_format</p><figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log_format json '&#123; <span class="string">"time"</span>: <span class="string">"<span class="variable">$time_iso8601</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_true_client_ip"</span>: <span class="string">"<span class="variable">$http_true_client_ip</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_x_real_ip"</span>: <span class="string">"<span class="variable">$http_x_real_ip</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_cdn_src_ip"</span>: <span class="string">"<span class="variable">$http_cdn_src_ip</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_geo_location_ip"</span>: <span class="string">"<span class="variable">$client_ip</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_remote_addr"</span>: <span class="string">"<span class="variable">$remote_addr</span>"</span>, '</span><br><span class="line">                    '<span class="string">"ngx_remote_port"</span>: <span class="string">"<span class="variable">$remote_port</span>"</span>, '</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;nginx-remote-port为空&quot;&gt;&lt;a href=&quot;#nginx-remote-port为空&quot; class=&quot;headerlink&quot; title=&quot;nginx remote_port为空&quot;&gt;&lt;/a&gt;nginx remote_port为空&lt;/h3&gt;&lt;h4 i
      
    
    </summary>
    
    
      <category term="nginx" scheme="https://www.xiemx.com/categories/nginx/"/>
    
    
      <category term="webserver" scheme="https://www.xiemx.com/tags/webserver/"/>
    
      <category term="nginx" scheme="https://www.xiemx.com/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>如何在K8S环境中抓POD的包</title>
    <link href="https://www.xiemx.com//2019/12/12/k8s-tcpdump/"/>
    <id>https://www.xiemx.com//2019/12/12/k8s-tcpdump/</id>
    <published>2019-12-12T02:01:04.000Z</published>
    <updated>2019-12-12T07:05:08.737Z</updated>
    
    <content type="html"><![CDATA[<h3 id="如何在K8S环境中抓POD的包"><a href="#如何在K8S环境中抓POD的包" class="headerlink" title="如何在K8S环境中抓POD的包"></a>如何在K8S环境中抓POD的包</h3><ol><li><p>kubectl get pod -o wide 获取pod所在的node信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  Documents kubectl get pod -o wide </span><br><span class="line">NAME                                                 READY   STATUS             RESTARTS   AGE   IP             NODE                                              NOMINATED NODE</span><br><span class="line">internal-nginx-ingress-controller-7fdf7f457d-bd59z   1/1     Running            0          42m   10.200.1.83    ip-10-200-1-202.ap-northeast-1.compute.internal   &lt;none&gt;</span><br><span class="line"></span><br><span class="line">2. kubectl describe pod/podname 获取pod的containid</span><br><span class="line">```shell</span><br><span class="line">➜  Documents k get pod -o jsonpath='&#123;.status.containerStatuses[*].containerID&#125;' internal-nginx-ingress-controller-7fdf7f457d-bd59z</span><br><span class="line">docker://ae9a6df60584e797e56cc64d0df02e64d7731a0d852026fab0a76c920c608cbe</span><br></pre></td></tr></table></figure></li><li><p>登陆node节点，找到container查看eth0网卡的ID</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-10-200-1-202 net]$ docker exec -it ae9a6df60584e797e56cc64d0df02e64d7731a0d852026fab0a76c920c608cbe cat /sys/class/net/eth0/iflink</span><br><span class="line">88</span><br></pre></td></tr></table></figure></li><li><p>宿主机上查询对应ID的网卡设备号</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[ec<span class="number">2</span>-user<span class="title">@ip-10-200-1-202</span> net]$ cd /sys/class/net<span class="comment">; for i in $(ls);do echo $i ;grep 88 $i/ifindex;done</span></span><br><span class="line"><span class="comment">eni0143b083c86</span></span><br><span class="line"><span class="comment">eni154a5470c40</span></span><br><span class="line"><span class="comment">eni1c162323f07</span></span><br><span class="line"><span class="comment">eni1d3e2ba2ce1</span></span><br><span class="line"><span class="comment">eni3fbceb3330b</span></span><br><span class="line"><span class="comment">eni457702aeb41</span></span><br><span class="line"><span class="comment">eni45f360a240e</span></span><br><span class="line"><span class="comment">eni50431e3a94f</span></span><br><span class="line"><span class="comment">eni619e29d4bac</span></span><br><span class="line"><span class="comment">eni66339821adf</span></span><br><span class="line"><span class="comment">eni6fe679d6356</span></span><br><span class="line"><span class="comment">eni79708a78f8b</span></span><br><span class="line"><span class="comment">eni7cc26b0b7d2</span></span><br><span class="line"><span class="comment">eni855ca0ba49b</span></span><br><span class="line"><span class="comment">eni8799376f27c</span></span><br><span class="line"><span class="comment">eni90208382a7b</span></span><br><span class="line"><span class="comment">eni909411bbf11</span></span><br><span class="line"><span class="comment">eni94c3d2bb833</span></span><br><span class="line"><span class="comment">enia14f5f7c3e9</span></span><br><span class="line"><span class="comment">enib70b44b2399</span></span><br><span class="line"><span class="comment">enic2ad9523b38 ###容器所属网卡</span></span><br><span class="line"><span class="comment">88</span></span><br><span class="line"><span class="comment">enid60e48c6616</span></span><br><span class="line"><span class="comment">enid8f13b5dd06</span></span><br><span class="line"><span class="comment">enida858799e91</span></span><br><span class="line"><span class="comment">enieee4f7696a1</span></span><br><span class="line"><span class="comment">enif0d5e81d420</span></span><br><span class="line"><span class="comment">eth0</span></span><br><span class="line"><span class="comment">eth1</span></span><br><span class="line"><span class="comment">lo</span></span><br></pre></td></tr></table></figure></li><li><p>tcpdump 抓包即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  ssh-keys git:(master) ✗ ssh -F ~/.matrix/jp/ssh.aux.config 10.200.1.202 -l ec2-user "sudo tcpdump -vvv -i enic2ad9523b38 tcp port 80 -w -" | wireshark -k -i -</span><br><span class="line">Warning: Permanently added '10.200.1.4' (ECDSA) to the list of known hosts.</span><br><span class="line">Warning: Permanently added '10.200.1.202' (ECDSA) to the list of known hosts.</span><br><span class="line">tcpdump: listening on eni86f5b593a42, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">tcpdump: pcap_loop: The interface went down</span><br><span class="line">7408 packets captured</span><br><span class="line">7408 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;如何在K8S环境中抓POD的包&quot;&gt;&lt;a href=&quot;#如何在K8S环境中抓POD的包&quot; class=&quot;headerlink&quot; title=&quot;如何在K8S环境中抓POD的包&quot;&gt;&lt;/a&gt;如何在K8S环境中抓POD的包&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;kubectl g
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="linux" scheme="https://www.xiemx.com/tags/linux/"/>
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="tcpdump" scheme="https://www.xiemx.com/tags/tcpdump/"/>
    
      <category term="network" scheme="https://www.xiemx.com/tags/network/"/>
    
  </entry>
  
  <entry>
    <title>k8s ingress-nginx动态balance实现解析</title>
    <link href="https://www.xiemx.com//2019/09/16/k8s-ingress-nginx/"/>
    <id>https://www.xiemx.com//2019/09/16/k8s-ingress-nginx/</id>
    <published>2019-09-15T23:09:52.000Z</published>
    <updated>2019-10-21T06:57:42.989Z</updated>
    
    <content type="html"><![CDATA[<p>只节选了比较关键的代码，删除了比较多的干扰项。纯属个人理解！！！</p><h4 id="1-初始化balancer-init-worker-，使用balancer-balance-动态获取"><a href="#1-初始化balancer-init-worker-，使用balancer-balance-动态获取" class="headerlink" title="1. 初始化balancer.init_worker()，使用balancer.balance()动态获取"></a>1. 初始化balancer.init_worker()，使用balancer.balance()动态获取</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">        lua_package_path <span class="string">"/etc/nginx/lua/?.lua;/etc/nginx/lua/vendor/?.lua;/usr/local/lib/lua/?.lua;;"</span>;</span><br><span class="line">        init_by_lua_block &#123;</span><br><span class="line">                ok, res = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">"configuration"</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        init_worker_by_lua_block &#123;</span><br><span class="line">                balancer.init_worker()  #####创建定时任务 ngx.timer.every(BACKENDS_SYNC_INTERVAL, sync_backends)</span><br><span class="line">        &#125;</span><br><span class="line">     </span><br><span class="line">###upstream configure</span><br><span class="line">upstream upstream_balancer &#123;</span><br><span class="line">server <span class="number">0.0</span><span class="number">.0</span><span class="number">.1</span>; # placeholder</span><br><span class="line"></span><br><span class="line">balancer_by_lua_block &#123;</span><br><span class="line">balancer.balance()</span><br><span class="line">&#125;</span><br><span class="line">keepalive <span class="number">32</span>;</span><br><span class="line">keepalive_timeout  <span class="number">60</span>s;</span><br><span class="line">keepalive_requests <span class="number">100</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-获取backend信息，balancer-init-worker"><a href="#2-获取backend信息，balancer-init-worker" class="headerlink" title="2. 获取backend信息，balancer.init_worker()"></a>2. 获取backend信息，balancer.init_worker()</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">####https://sourcegraph.com/github.com/kubernetes/ingress-nginx@dd0fe4b458cc5520f25eb8bba25bbe6f0c72ee98/-/blob/rootfs/etc/nginx/lua/balancer.lua?utm_source=share#L223</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> configuration = <span class="built_in">require</span>(<span class="string">"configuration"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_M.init_worker</span><span class="params">()</span></span></span><br><span class="line">  sync_backends() <span class="comment">-- when worker starts, sync backends without delay</span></span><br><span class="line">  <span class="keyword">local</span> _, err = ngx.timer.every(BACKENDS_SYNC_INTERVAL, sync_backends)</span><br><span class="line">  <span class="keyword">if</span> err <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ERR, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"error when setting up timer.every for sync_backends: %s"</span>, <span class="built_in">tostring</span>(err)))</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">sync_backends</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">local</span> backends_data = configuration.get_backends_data()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> new_backends, err = cjson.decode(backends_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> balancers_to_keep = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> _, new_backend <span class="keyword">in</span> <span class="built_in">ipairs</span>(new_backends) <span class="keyword">do</span></span><br><span class="line">    sync_backend(new_backend)</span><br><span class="line">    balancers_to_keep[new_backend.name] = balancers[new_backend.name]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">####https://sourcegraph.com/github.com/kubernetes/ingress-nginx@dd0fe4b458cc5520f25eb8bba25bbe6f0c72ee98/-/blob/rootfs/etc/nginx/lua/configuration.lua?utm_source=share#L10:<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> configuration_data = ngx.shared.configuration_data</span><br><span class="line"><span class="keyword">local</span> certificate_data = ngx.shared.certificate_data</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> _M = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_M.get_backends_data</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">return</span> configuration_data:get(<span class="string">"backends"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_M.call</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">if</span> ngx.var.request_method ~= <span class="string">"POST"</span> <span class="keyword">and</span> ngx.var.request_method ~= <span class="string">"GET"</span> <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">status</span> = ngx.HTTP_BAD_REQUEST</span><br><span class="line">    ngx.<span class="built_in">print</span>(<span class="string">"Only POST and GET requests are allowed!"</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ngx.var.request_uri == <span class="string">"/configuration/servers"</span> <span class="keyword">then</span></span><br><span class="line">    handle_servers()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ngx.var.request_uri == <span class="string">"/configuration/general"</span> <span class="keyword">then</span></span><br><span class="line">    handle_general()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ngx.var.uri == <span class="string">"/configuration/certs"</span> <span class="keyword">then</span></span><br><span class="line">    handle_certs()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ngx.var.request_uri ~= <span class="string">"/configuration/backends"</span> <span class="keyword">then</span> ####只接受以上<span class="number">4</span>类型URL</span><br><span class="line">    ngx.<span class="built_in">status</span> = ngx.HTTP_NOT_FOUND</span><br><span class="line">    ngx.<span class="built_in">print</span>(<span class="string">"Not found!"</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> backends = fetch_request_body()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> success, err = configuration_data:set(<span class="string">"backends"</span>, backends)</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">### fetch_request_body()，从此函数可以看出此函数是一个外部调用，可以得出原始的数据来源为外部触发的POST，可以查询Call()函数的引用位置</span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch_request_body</span><span class="params">()</span></span></span><br><span class="line">  ngx.req.read_body() ###防止ngx.req.get_body_data()返回<span class="literal">nil</span>,显示执行一下</span><br><span class="line">  <span class="keyword">local</span> body = ngx.req.get_body_data()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> body <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> file_name = ngx.req.get_body_file() ###读取cache file</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> file = <span class="built_in">io</span>.<span class="built_in">open</span>(file_name, <span class="string">"rb"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> file <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    body = file:<span class="built_in">read</span>(<span class="string">"*all"</span>)</span><br><span class="line">    file:<span class="built_in">close</span>()</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> body</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####nginx.conf 查看nginx配置文件中显示调用call()函数的位置为当前server切url /configuration 符合函数要求，在查找外部调用的代码（基本可以定位为控制器的逻辑控制）</span></span><br><span class="line">       <span class="built_in"> server </span>&#123;</span><br><span class="line">                listen unix:/tmp/nginx-status-server.sock;</span><br><span class="line">                <span class="builtin-name">set</span> <span class="variable">$proxy_upstream_name</span> <span class="string">"internal"</span>;</span><br><span class="line"></span><br><span class="line">                keepalive_timeout 0;</span><br><span class="line">                gzip off;</span><br><span class="line"></span><br><span class="line">                access_log off;</span><br><span class="line"></span><br><span class="line">                location /configuration &#123;</span><br><span class="line">                        # this should be equals <span class="keyword">to</span> configuration_data dict</span><br><span class="line">                        client_max_body_size                    10m;</span><br><span class="line">                        client_body_buffer_size                 10m;</span><br><span class="line">                        proxy_buffering                         off;</span><br><span class="line"></span><br><span class="line">                        content_by_lua_block &#123;</span><br><span class="line">                                configuration.call()</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure><h4 id="3-通过上面的信息检索，在Ingress中监听pod变化信息，动态调用-configuration-backends-函数为configureBackends"><a href="#3-通过上面的信息检索，在Ingress中监听pod变化信息，动态调用-configuration-backends-函数为configureBackends" class="headerlink" title="3. 通过上面的信息检索，在Ingress中监听pod变化信息，动态调用/configuration/backends, 函数为configureBackends()"></a>3. 通过上面的信息检索，在Ingress中监听pod变化信息，动态调用/configuration/backends, 函数为configureBackends()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">####https:<span class="comment">//github.com/kubernetes/ingress-nginx/blob/ce3e3d51c397ff6a0cd6731cc64360ecdb69ea54/internal/ingress/controller/nginx.go#L982</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">configureBackends</span><span class="params">(rawBackends []*ingress.Backend)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">backends := <span class="built_in">make</span>([]*ingress.Backend, <span class="built_in">len</span>(rawBackends))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, backend := <span class="keyword">range</span> rawBackends &#123;</span><br><span class="line"><span class="keyword">var</span> service *apiv1.Service</span><br><span class="line"><span class="keyword">if</span> backend.Service != <span class="literal">nil</span> &#123;</span><br><span class="line">service = &amp;apiv1.Service&#123;Spec: backend.Service.Spec&#125;</span><br><span class="line">&#125;</span><br><span class="line">luaBackend := &amp;ingress.Backend&#123;</span><br><span class="line">Name:                 backend.Name,</span><br><span class="line">Port:                 backend.Port,</span><br><span class="line">SSLPassthrough:       backend.SSLPassthrough,</span><br><span class="line">SessionAffinity:      backend.SessionAffinity,</span><br><span class="line">UpstreamHashBy:       backend.UpstreamHashBy,</span><br><span class="line">LoadBalancing:        backend.LoadBalancing,</span><br><span class="line">Service:              service,</span><br><span class="line">NoServer:             backend.NoServer,</span><br><span class="line">TrafficShapingPolicy: backend.TrafficShapingPolicy,</span><br><span class="line">AlternativeBackends:  backend.AlternativeBackends,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> endpoints []ingress.Endpoint</span><br><span class="line"><span class="keyword">for</span> _, endpoint := <span class="keyword">range</span> backend.Endpoints &#123;</span><br><span class="line">endpoints = <span class="built_in">append</span>(endpoints, ingress.Endpoint&#123;</span><br><span class="line">Address: endpoint.Address,</span><br><span class="line">Port:    endpoint.Port,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">luaBackend.Endpoints = endpoints</span><br><span class="line">backends[i] = luaBackend</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">statusCode, _, err := nginx.NewPostStatusRequest(<span class="string">"/configuration/backends"</span>, <span class="string">"application/json"</span>, backends) ####backends 为request.body,却内容为IP/PORT，以下给出了backend的<span class="keyword">struct</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> statusCode != http.StatusCreated &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"unexpected error code: %d"</span>, statusCode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">####Backend <span class="keyword">struct</span></span><br><span class="line"><span class="keyword">type</span> Backend <span class="keyword">struct</span> &#123;</span><br><span class="line">Name    <span class="keyword">string</span>             <span class="string">`json:"name"`</span></span><br><span class="line">Service *apiv1.Service     <span class="string">`json:"service,omitempty"`</span></span><br><span class="line">Port    intstr.IntOrString <span class="string">`json:"port"`</span></span><br><span class="line">SecureCACert resolver.AuthSSLCert <span class="string">`json:"secureCACert"`</span></span><br><span class="line">SSLPassthrough <span class="keyword">bool</span> <span class="string">`json:"sslPassthrough"`</span></span><br><span class="line">Endpoints []Endpoint <span class="string">`json:"endpoints,omitempty"`</span></span><br><span class="line">SessionAffinity SessionAffinityConfig <span class="string">`json:"sessionAffinityConfig"`</span></span><br><span class="line">UpstreamHashBy UpstreamHashByConfig <span class="string">`json:"upstreamHashByConfig,omitempty"`</span></span><br><span class="line">LoadBalancing <span class="keyword">string</span> <span class="string">`json:"load-balance,omitempty"`</span></span><br><span class="line">NoServer <span class="keyword">bool</span> <span class="string">`json:"noServer"`</span></span><br><span class="line">TrafficShapingPolicy TrafficShapingPolicy <span class="string">`json:"trafficShapingPolicy,omitempty"`</span></span><br><span class="line">AlternativeBackends []<span class="keyword">string</span> <span class="string">`json:"alternativeBackends,omitempty"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-ngx-balancer-set-current-peer-设置backend信息"><a href="#4-ngx-balancer-set-current-peer-设置backend信息" class="headerlink" title="4. ngx_balancer.set_current_peer()设置backend信息"></a>4. ngx_balancer.set_current_peer()设置backend信息</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">####https://sourcegraph.com/github.com/kubernetes/ingress-nginx@dd0fe4b458cc5520f25eb8bba25bbe6f0c72ee98/-/blob/rootfs/etc/nginx/lua/balancer.lua?utm_source=share#L232:<span class="number">13</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_M.balance</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">local</span> balancer = get_balancer()</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> balancer <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> peer = balancer:balance()</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> peer <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.WARN, <span class="string">"no peer was returned, balancer: "</span> .. balancer.name)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  ngx_balancer.set_more_tries(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> ok, err = ngx_balancer.set_current_peer(peer) ####设置server信息</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ERR, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"error while setting current upstream peer %s: %s"</span>, peer, err))</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">get_balancer</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">if</span> ngx.ctx.balancer <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> ngx.ctx.balancer</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> backend_name = ngx.var.proxy_upstream_name ###获取当前request上下文中共享的变量proxy_upstream_name</span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> balancer = balancers[backend_name] ###获取balancers信息由sync_backend()函数定时轮询</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> balancer <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> route_to_alternative_balancer(balancer) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> alternative_backend_name = balancer.alternative_backends[<span class="number">1</span>]</span><br><span class="line">    ngx.var.proxy_alternative_upstream_name = alternative_backend_name</span><br><span class="line"></span><br><span class="line">    balancer = balancers[alternative_backend_name]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  ngx.ctx.balancer = balancer</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> balancer</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###nginx.conf</span></span><br><span class="line"><span class="attribute">set</span> <span class="variable">$proxy_upstream_name</span>    <span class="string">"dev-dev-auto-deploy-5000"</span>;</span><br><span class="line"><span class="attribute">set</span> <span class="variable">$proxy_host</span>             <span class="variable">$proxy_upstream_name</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://upstream_balancer;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;只节选了比较关键的代码，删除了比较多的干扰项。纯属个人理解！！！&lt;/p&gt;
&lt;h4 id=&quot;1-初始化balancer-init-worker-，使用balancer-balance-动态获取&quot;&gt;&lt;a href=&quot;#1-初始化balancer-init-worker-，使用b
      
    
    </summary>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://www.xiemx.com/tags/k8s/"/>
    
      <category term="ingress" scheme="https://www.xiemx.com/tags/ingress/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL查看复制状态</title>
    <link href="https://www.xiemx.com//2019/07/08/postgresql-replica-status/"/>
    <id>https://www.xiemx.com//2019/07/08/postgresql-replica-status/</id>
    <published>2019-07-08T03:07:36.000Z</published>
    <updated>2019-10-19T09:40:34.388Z</updated>
    
    <content type="html"><![CDATA[<h4 id="postgresql查看复制状态，master上执行"><a href="#postgresql查看复制状态，master上执行" class="headerlink" title="postgresql查看复制状态，master上执行"></a>postgresql查看复制状态，master上执行</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#select * from pg_stat_replication; </span></span><br><span class="line">postgres=<span class="comment"># select * from pg_stat_replication;</span></span><br><span class="line">-[ RECORD 1 ]<span class="comment">----+------------------------------</span></span><br><span class="line">pid              | 13321</span><br><span class="line">usesysid         | 17019</span><br><span class="line">usename          | replication</span><br><span class="line">application_name | walreceiver</span><br><span class="line">client_addr      | 10.0.0.81</span><br><span class="line">client_hostname  | </span><br><span class="line">client_port      | 42809</span><br><span class="line">backend_start    | 2016-08-11 10:57:35.856289+08</span><br><span class="line">backend_xmin     | </span><br><span class="line">state            | streaming <span class="comment">--同步状态</span></span><br><span class="line">sent_location    | 1/E0CE9750</span><br><span class="line">write_location   | 1/E0CE9750</span><br><span class="line">flush_location   | 1/E0CE9750</span><br><span class="line">replay_location  | 1/E0CE9750</span><br><span class="line">sync_priority    | 0</span><br><span class="line">sync_state       | async  <span class="comment">--同步模式</span></span><br><span class="line"></span><br><span class="line">state: 同步状态</span><br><span class="line">    streaming : 同步</span><br><span class="line">    startup : 连接中</span><br><span class="line">    catchup: 同步中</span><br><span class="line"></span><br><span class="line">sync_state: 同步模式.</span><br><span class="line">    async : 异步</span><br><span class="line">    sync : 同步</span><br><span class="line">    potential: 虽然现在是异步,但有可能提升到同步</span><br></pre></td></tr></table></figure><h4 id="查看复制的延迟有多少，字节单位，master上执行"><a href="#查看复制的延迟有多少，字节单位，master上执行" class="headerlink" title="查看复制的延迟有多少，字节单位，master上执行"></a>查看复制的延迟有多少，字节单位，master上执行</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#select pg_xlog_location_diff(sent_location, replay_location) from pg_stat_replication; </span></span><br><span class="line"></span><br><span class="line">posrgresql=<span class="comment"># select pg_xlog_location_diff(sent_location, replay_location) from pg_stat_replication; </span></span><br><span class="line"> pg_xlog_location_diff </span><br><span class="line"><span class="comment">-----------------------</span></span><br><span class="line">                      0</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><h4 id="slave上查看sql滞后时间"><a href="#slave上查看sql滞后时间" class="headerlink" title="slave上查看sql滞后时间"></a>slave上查看sql滞后时间</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> pg_last_xlog_receive_location() = pg_last_xlog_replay_location()</span><br><span class="line">    <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">ELSE</span> <span class="keyword">EXTRACT</span> (EPOCH <span class="keyword">FROM</span> <span class="keyword">now</span>() - pg_last_xact_replay_timestamp())</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> log_delay;</span><br><span class="line"></span><br><span class="line">postgres=<span class="comment"># SELECT CASE WHEN pg_last_xlog_receive_location() = pg_last_xlog_replay_location()</span></span><br><span class="line">postgres-<span class="comment">#     THEN 0</span></span><br><span class="line">postgres-<span class="comment">#     ELSE EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp())</span></span><br><span class="line">postgres-<span class="comment">#     END AS log_delay;</span></span><br><span class="line"> log_delay</span><br><span class="line"><span class="comment">-----------</span></span><br><span class="line">         0</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><h4 id="slave上查看是否处于recovery模式"><a href="#slave上查看是否处于recovery模式" class="headerlink" title="slave上查看是否处于recovery模式"></a>slave上查看是否处于recovery模式</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pg_is_in_recovery();</span><br><span class="line">postgres=<span class="comment"># select pg_is_in_recovery();</span></span><br><span class="line"> pg_is_in_recovery</span><br><span class="line"><span class="comment">-------------------</span></span><br><span class="line"> t</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><h4 id="slave上查看最新的reploy时间戳"><a href="#slave上查看最新的reploy时间戳" class="headerlink" title="slave上查看最新的reploy时间戳"></a>slave上查看最新的reploy时间戳</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#select pg_last_xact_replay_timestamp();</span></span><br><span class="line">postgres=<span class="comment"># select pg_last_xact_replay_timestamp();</span></span><br><span class="line"> pg_last_xact_replay_timestamp</span><br><span class="line"><span class="comment">-------------------------------</span></span><br><span class="line"> 2019-07-08 03:01:33.854131+00</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><h4 id="slave上查看最新的reploy位置"><a href="#slave上查看最新的reploy位置" class="headerlink" title="slave上查看最新的reploy位置"></a>slave上查看最新的reploy位置</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#select pg_last_xlog_replay_location();</span></span><br><span class="line">postgres=<span class="comment"># select pg_last_xlog_replay_location();</span></span><br><span class="line"> pg_last_xlog_replay_location</span><br><span class="line"><span class="comment">------------------------------</span></span><br><span class="line"> 220C/56EB4C10</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;postgresql查看复制状态，master上执行&quot;&gt;&lt;a href=&quot;#postgresql查看复制状态，master上执行&quot; class=&quot;headerlink&quot; title=&quot;postgresql查看复制状态，master上执行&quot;&gt;&lt;/a&gt;postgres
      
    
    </summary>
    
    
      <category term="postgresql" scheme="https://www.xiemx.com/categories/postgresql/"/>
    
    
      <category term="database" scheme="https://www.xiemx.com/tags/database/"/>
    
      <category term="postgresql" scheme="https://www.xiemx.com/tags/postgresql/"/>
    
  </entry>
  
  <entry>
    <title>http cache</title>
    <link href="https://www.xiemx.com//2019/05/13/http-cache/"/>
    <id>https://www.xiemx.com//2019/05/13/http-cache/</id>
    <published>2019-05-13T03:05:02.000Z</published>
    <updated>2019-10-21T06:57:42.935Z</updated>
    
    <content type="html"><![CDATA[<h4 id="cache流程图"><a href="#cache流程图" class="headerlink" title="cache流程图"></a><strong>cache流程图</strong></h4><p><img src="/images/image.png" alt="img"></p><h3 id="“no-cache”和“no-store”"><a href="#“no-cache”和“no-store”" class="headerlink" title="“no-cache”和“no-store”"></a>“no-cache”和“no-store”</h3><p>“no-cache”表示必须先与服务器确认返回的响应是否发生了变化，然后才能使用该响应来满足后续对同一网址的请求。 因此，如果存在合适的验证令牌 (ETag)，no-cache 会发起往返通信来验证缓存的响应，但如果资源未发生变化，则可避免下载。</p><p>“no-store”禁止浏览器以及所有中间缓存存储任何版本的返回响应，例如，包含个人隐私数据或银行业务数据的响应。 每次用户请求该资产时，都会向服务器发送请求，并下载完整的响应。</p><h3 id="“public”与-“private”"><a href="#“public”与-“private”" class="headerlink" title="“public”与 “private”"></a>“public”与 “private”</h3><p>“public”则即使它有关联的 HTTP 身份验证，甚至响应状态代码通常无法缓存，也可以缓存响应。 大多数情况下，“public”不是必需的，因为明确的缓存信息（例如“max-age”）已表示响应是可以缓存的。</p><p>“private”浏览器可以缓存响应，不允许任何中间缓存对其进行缓存。 例如，用户的浏览器可以缓存包含用户私人信息的 HTML 网页，但 CDN 却不能缓存。</p><h3 id="“max-age”"><a href="#“max-age”" class="headerlink" title="“max-age”"></a>“max-age”</h3><p>指令指定从请求的时间开始，允许提取的响应被重用的最长时间（单位：秒）。 例如，“max-age=60”表示可在接下来的 60 秒缓存和重用响应。</p><h2 id="通过-ETag-验证缓存的响应"><a href="#通过-ETag-验证缓存的响应" class="headerlink" title="通过 ETag 验证缓存的响应"></a>通过 ETag 验证缓存的响应</h2><p>在首次请求资源时服务器生成并返回”ETag” http请求头(通常是文件内容的哈希值或某个其他指纹)。 当120 秒后，浏览器又对该资源发起了新的请求。 首先，浏览器会检查本地缓存并找到之前的响应。如果发现缓存超过max-age, 浏览器将发起一个带有”If-None-Match”的http请求。 如果Etag相同，则返回304，使用本地缓存。</p><p><img src="/images/http-cache-control.png" alt="HTTP Cache-Control 示例"></p><p>参考： <a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching" target="_blank" rel="noopener">https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;cache流程图&quot;&gt;&lt;a href=&quot;#cache流程图&quot; class=&quot;headerlink&quot; title=&quot;cache流程图&quot;&gt;&lt;/a&gt;&lt;strong&gt;cache流程图&lt;/strong&gt;&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;/images/image.png&quot; 
      
    
    </summary>
    
    
      <category term="http" scheme="https://www.xiemx.com/categories/http/"/>
    
    
      <category term="http" scheme="https://www.xiemx.com/tags/http/"/>
    
      <category term="cache" scheme="https://www.xiemx.com/tags/cache/"/>
    
  </entry>
  
  <entry>
    <title>Mysqldump error</title>
    <link href="https://www.xiemx.com//2019/05/06/mysqldump-error/"/>
    <id>https://www.xiemx.com//2019/05/06/mysqldump-error/</id>
    <published>2019-05-06T03:05:56.000Z</published>
    <updated>2019-10-19T10:22:28.240Z</updated>
    
    <content type="html"><![CDATA[<h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@FCHK-instance ~]# mysqldump <span class="comment">--host rm-xxxxxxxxxxx.mysql.rds.aliyuncs.com -u xxxx -p --databases visa &gt; hk.sql</span></span><br><span class="line">Enter password:</span><br><span class="line"><span class="literal">Warning</span>: A partial dump from a server that has GTIDs will by <span class="keyword">default</span> include the GTIDs <span class="keyword">of</span> <span class="keyword">all</span> transactions, even those that changed suppressed parts <span class="keyword">of</span> the database. <span class="keyword">If</span> you don<span class="symbol">'t</span> want <span class="keyword">to</span> restore GTIDs, pass <span class="comment">--set-gtid-purged=OFF. To make a complete dump, pass --all-databases --triggers --routines --events.</span></span><br><span class="line">mysqldump: Couldn<span class="symbol">'t</span> execute <span class="symbol">'SELECT</span> COLUMN_NAME,                       JSON_EXTRACT(HISTOGRAM, '$.<span class="string">"number-of-buckets-specified"</span>')                FROM information_schema.COLUMN_STATISTICS                WHERE SCHEMA_NAME = <span class="symbol">'visa</span>' <span class="keyword">AND</span> TABLE_NAME = <span class="symbol">'admin</span>';': Unknown table <span class="symbol">'column_statistics</span>' <span class="keyword">in</span> information_schema (<span class="number">1109</span></span><br></pre></td></tr></table></figure><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@FCHK-instance ~]# mysql <span class="comment">--version</span></span><br><span class="line">mysql  Ver <span class="number">8.0</span><span class="number">.11</span> <span class="keyword">for</span> Linux <span class="keyword">on</span> x86_64 (MySQL Community <span class="keyword">Server</span> - GPL)</span><br><span class="line"></span><br><span class="line">可能是由于mysqldump <span class="number">8</span>中默认启用（COLUMN_STATISTICS）</span><br><span class="line"></span><br><span class="line">官方文档解释</span><br><span class="line">Mysql <span class="number">8.0</span> The INFORMATION_SCHEMA COLUMN_STATISTICS <span class="keyword">Table</span></span><br><span class="line">https://dev.mysql.com/doc/refman/<span class="number">8.0</span>/en/<span class="keyword">column</span>-<span class="keyword">statistics</span>-<span class="keyword">table</span>.html</span><br></pre></td></tr></table></figure><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@FCHK-instance ~]# mysqldump <span class="comment">--host rm-xxxxxxxxxx2.mysql.rds.aliyuncs.com -u xxxx -p --databases visa --column-statistics=0 &gt; hk.sql</span></span><br><span class="line">Enter password:</span><br><span class="line"><span class="literal">Warning</span>: A partial dump from a server that has GTIDs will by <span class="keyword">default</span> include the GTIDs <span class="keyword">of</span> <span class="keyword">all</span> transactions, even those that changed suppressed parts <span class="keyword">of</span> the database. <span class="keyword">If</span> you don<span class="symbol">'t</span> want <span class="keyword">to</span> restore GTIDs, pass <span class="comment">--set-gtid-purged=OFF. To make a complete dump, pass --all-databases --triggers --routines --events.</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;现象&quot;&gt;&lt;a href=&quot;#现象&quot; class=&quot;headerlink&quot; title=&quot;现象&quot;&gt;&lt;/a&gt;现象&lt;/h3&gt;&lt;figure class=&quot;highlight vhdl&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span c
      
    
    </summary>
    
    
      <category term="mysql" scheme="https://www.xiemx.com/categories/mysql/"/>
    
    
      <category term="debug" scheme="https://www.xiemx.com/tags/debug/"/>
    
      <category term="mysql" scheme="https://www.xiemx.com/tags/mysql/"/>
    
      <category term="database" scheme="https://www.xiemx.com/tags/database/"/>
    
  </entry>
  
  <entry>
    <title>redis-dump使用</title>
    <link href="https://www.xiemx.com//2019/05/06/redis-dump/"/>
    <id>https://www.xiemx.com//2019/05/06/redis-dump/</id>
    <published>2019-05-06T03:05:33.000Z</published>
    <updated>2019-10-19T09:09:04.060Z</updated>
    
    <content type="html"><![CDATA[<ul><li>安装redis-dump/redis-load</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">需要ruby 2.2.2以上版本（可以直接使用ruby:2.2.3的docker images）</span></span><br><span class="line">gem install redis-dum</span><br></pre></td></tr></table></figure><ul><li><p>dump redis</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@5dba1bd8fa77:/# redis-dump -h</span><br><span class="line">  Try: /usr/local/bundle/bin/redis-dump show-commands</span><br><span class="line">Usage: /usr/local/bundle/bin/redis-dump [global options] COMMAND [command options]</span><br><span class="line">    -u, --uri=S                      Redis URI (e.g. redis://hostname[:port])</span><br><span class="line">    -d, --database=S                 Redis database (e.g. -d 15)</span><br><span class="line">    -a, --password=S                 Redis password (e.g. -a 'my@pass/word')</span><br><span class="line">    -s, --sleep=S                    Sleep for S seconds after dumping (for debugging)</span><br><span class="line">    -c, --count=S                    Chunk size (default: 10000)</span><br><span class="line">    -f, --filter=S                   Filter selected keys (passed directly to redis' KEYS command)</span><br><span class="line">    -b, --base64                     Encode key values as base64 (useful for binary values)</span><br><span class="line">    -O, --without_optimizations      Disable run time optimizations</span><br><span class="line">    -V, --version                    Display version</span><br><span class="line">    -D, --debug</span><br><span class="line">        --nosafe</span><br><span class="line"></span><br><span class="line">root@5dba1bd8fa77:/# redis-dump -u aux-redis.1uvkyf.0001.cnn1.cache.amazonaws.com.cn &gt; redis-uat.json</span><br></pre></td></tr></table></figure></li><li><p>load redis</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@5dba1bd8fa77:/# redis-load -h</span><br><span class="line">  Try: /usr/local/bundle/bin/redis-load show-commands</span><br><span class="line">Usage: /usr/local/bundle/bin/redis-load [global options] COMMAND [command options]</span><br><span class="line">    -u, --uri=S                      Redis URI (e.g. redis://hostname[:port])</span><br><span class="line">    -d, --database=S                 Redis database (e.g. -d 15)</span><br><span class="line">    -a, --password=S                 Redis password (e.g. -a 'my@pass/word')</span><br><span class="line">    -s, --sleep=S                    Sleep for S seconds after dumping (for debugging)</span><br><span class="line">    -b, --base64                     Decode key values from base64 (used with redis-dump -b)</span><br><span class="line">    -n, --no_check_utf8</span><br><span class="line">    -V, --version                    Display version</span><br><span class="line">    -D, --debug</span><br><span class="line">        --nosafe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@5dba1bd8fa77:/# redis-load -u aux-redis.1uvkyf.0001.cnn1.cache.amazonaws.com.cn:6379/0 &lt; redis-uat.json</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;安装redis-dump/redis-load&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;b
      
    
    </summary>
    
    
      <category term="redis" scheme="https://www.xiemx.com/categories/redis/"/>
    
    
      <category term="redis" scheme="https://www.xiemx.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>SSH的AuthorizedKeysCommand、AuthorizedKeysCommandUser</title>
    <link href="https://www.xiemx.com//2019/05/06/ssh-authorizedkeyscommand/"/>
    <id>https://www.xiemx.com//2019/05/06/ssh-authorizedkeyscommand/</id>
    <published>2019-05-06T03:05:17.000Z</published>
    <updated>2019-10-21T06:57:43.061Z</updated>
    
    <content type="html"><![CDATA[<ul><li>AuthorizedKeysCommand 可以指定运行一个脚本，而这个脚本主要是寻找登录用户的publickey，默认传参为登录用户名，若未认证成功，将继续使用AuthorizedKeysFile文件来做认证。</li><li>AuthorizedKeysCommandUser就是指定以什么用户来运行这个脚本。 这两个配置选项的一个用处就是在用户管理上可以不再依靠本地管理，而可以通过脚本读取远程数据库系统中的用户的publickey进行认证，例如MySQL或者LDAP，这样的话，更便于用户的集中管理。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;AuthorizedKeysCommand 可以指定运行一个脚本，而这个脚本主要是寻找登录用户的publickey，默认传参为登录用户名，若未认证成功，将继续使用AuthorizedKeysFile文件来做认证。&lt;/li&gt;
&lt;li&gt;AuthorizedKeysC
      
    
    </summary>
    
    
      <category term="linux" scheme="https://www.xiemx.com/categories/linux/"/>
    
    
      <category term="linux" scheme="https://www.xiemx.com/tags/linux/"/>
    
      <category term="ssh" scheme="https://www.xiemx.com/tags/ssh/"/>
    
  </entry>
  
  <entry>
    <title>通过lambda修改AWS CloudFront回源host</title>
    <link href="https://www.xiemx.com//2018/10/11/aws-edge-lambda-modify-origin-host/"/>
    <id>https://www.xiemx.com//2018/10/11/aws-edge-lambda-modify-origin-host/</id>
    <published>2018-10-10T19:10:17.000Z</published>
    <updated>2019-10-21T06:57:43.061Z</updated>
    
    <content type="html"><![CDATA[<p>在使用aws cloudfront时发现cloudfront默认不允许自定义回源请求头的Host字段，对于一些情况我们需要使用这个host+ip来回源的时候就有点坑了，这个时候我们可以通过使用aws的lambda@edge，去修改request的header来实现自定义host来回源。</p><p>aws lambda@edge文档：<a href="https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/lambda-edge.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/lambda-edge.html</a></p><ol><li>在创建lambda函数，并发布一个版本注意只能在us-east-1这个区创建，否则在附加到cloudfront的时候会报错不支持的区域，代码如下</li></ol><p><img src="/images/img_5bbef98529a61.png" alt="img"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// force a specific Host header to be sent to the origin</span></span><br><span class="line"></span><br><span class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> request = event.Records[<span class="number">0</span>].cf.request;</span><br><span class="line">    request.headers.host[<span class="number">0</span>].value = <span class="string">'www.xiemx.com'</span>;</span><br><span class="line">    <span class="keyword">return</span> callback(<span class="literal">null</span>, request);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol start="2"><li>在cloudfront的Behavior菜单中</li></ol><p><img src="/images/img_5bbefa0f833d9.png" alt="img"></p><ol start="3"><li>重新deploy cdn和刷新一次cdn缓存</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在使用aws cloudfront时发现cloudfront默认不允许自定义回源请求头的Host字段，对于一些情况我们需要使用这个host+ip来回源的时候就有点坑了，这个时候我们可以通过使用aws的lambda@edge，去修改request的header来实现自定义ho
      
    
    </summary>
    
    
      <category term="aws" scheme="https://www.xiemx.com/categories/aws/"/>
    
    
      <category term="aws" scheme="https://www.xiemx.com/tags/aws/"/>
    
      <category term="lambda" scheme="https://www.xiemx.com/tags/lambda/"/>
    
      <category term="cloudfront" scheme="https://www.xiemx.com/tags/cloudfront/"/>
    
  </entry>
  
  <entry>
    <title>SLB 502报错Debug</title>
    <link href="https://www.xiemx.com//2018/07/20/slb-502-debug/"/>
    <id>https://www.xiemx.com//2018/07/20/slb-502-debug/</id>
    <published>2018-07-19T18:07:06.000Z</published>
    <updated>2019-10-19T08:11:47.770Z</updated>
    
    <content type="html"><![CDATA[<p>用户自定义站点502问题分析</p><ol><li>现象：自定义域名用户反馈，打开网站返回502，如图</li></ol><p><img src="/images/img_5b5183b84d4dd.png" alt="img"></p><p> 根据response header判断，请求到达captain，怀疑captain返回的502页面。查看nginx proxy_pass得知后端的地址为bobcat.sxldns.com.</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">set</span> <span class="variable">$bobcat_backend</span> <span class="string">"bobcat.sxldns.com"</span>;</span><br><span class="line"><span class="attribute">proxy_pass</span> http://<span class="variable">$bobcat_backend</span>;</span><br></pre></td></tr></table></figure><p>使用curl模拟请求，直接请求bobcat.sxldns.com,正常获得返回内容，具体针对每个服务器的IP的curl,不再单独列出。</p><p><img src="/images/img_5b5184bfd49e3.png" alt="img"></p><p>通过上述返回基本判断，问题出在我们的代理层。具体查看代理层的nginx配置和系统资源利用率。</p><p>查看当时系统的资源状态,查看到当时的系统磁盘空间使用完。查看nginx上有关于proxy的cache相关配置,nginx会cache的response的content的内容。怀疑nginx转发请求之后但是backend返回内容后，nginx cache到本地的时候无法写入disk导致会话结束，SLB的请求无返回包认为后端宕机抛出502。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache_path /etc/nginx/china_cache <span class="attribute">levels</span>=1:2 <span class="attribute">keys_zone</span>=user_page_cache:100m <span class="attribute">max_size</span>=20g <span class="attribute">inactive</span>=60m <span class="attribute">use_temp_path</span>=off;</span><br></pre></td></tr></table></figure><p>具体DEBUG如下：</p><ol><li>获取container中的nginx worker进程的PID</li></ol><p><img src="/images/img_5b5184fb1c8d4.png" alt="img"></p><ol start="2"><li>strace查看下系统调用具体信息</li></ol><p><img src="/images/img_5b518515e4fe7.png" alt="img"></p><p>通过上图strace追踪流程可以看到左侧是一个正常的请求的全部流程，右侧是故障状态的strace的系统调用全流程。</p><p>通过对比左右两侧的系统调用流程可以看到，当nginx cache的时候写入<code>/etc/nginx/china_cache</code>目录时提示<code>no space</code>后续的writev()和sendfile()方法就没有调用，因此导致SLB无法获得返回包，抛出<code>badgateway</code>的错误.</p><p>PS：</p><ol><li>为什么单独请求返回头的时候正常返回？nginx返回请求头的时候并不会走proxy的cache流程。因此没有调用open()方法读写disk，正常返回，但是实际请求数据的时候cache写磁盘直接失败，后续直接退出。</li><li>上图的系统调用过程为了debug的方便使用了非折叠模式。因此一些no space的一些报错未显示出来可以。全部流程见附录。</li></ol><p>附录：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">1.异常调用堆栈</span><br><span class="line">[root@iZ2ze2mzhjk3ou1vsnkthzZ rpm]# strace -p 3904 -v</span><br><span class="line">strace: Process 3904 attached</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN, &#123;u32=69025808, u64=140003117973520&#125;&#125;], 512, -1) = 1</span><br><span class="line">accept4(6, &#123;sa_family=AF_INET, sin_port=htons(59464), sin_addr=inet_addr("10.130.0.4")&#125;, [16], SOCK_NONBLOCK) = 11</span><br><span class="line">epoll_ctl(8, EPOLL_CTL_ADD, 11, &#123;EPOLLIN|EPOLLRDHUP|EPOLLET, &#123;u32=69027249, u64=140003117974961&#125;&#125;) = 0</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN, &#123;u32=69027249, u64=140003117974961&#125;&#125;], 512, 60000) = 1</span><br><span class="line">recvfrom(11, "GET /?key=testxxxx HTTP/1.1<span class="symbol">\r</span><span class="symbol">\n</span>Use"..., 1024, 0, NULL, NULL) = 88</span><br><span class="line">epoll_ctl(8, EPOLL_CTL_MOD, 11, &#123;EPOLLIN|EPOLLOUT|EPOLLRDHUP|EPOLLET, &#123;u32=69027249, u64=140003117974961&#125;&#125;) = 0</span><br><span class="line">open("/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2", O_RDONLY|O_NONBLOCK) = 14</span><br><span class="line">fstat(14, &#123;st_dev=makedev(253, 1), st_ino=655502, st_mode=S_IFREG|0600, st_nlink=1, st_uid=101, st_gid=101, st_blksize=4096, st_blocks=96, st_size=46750, st_atime=2018/07/17-16:34:43.967698739, st_mtime=2018/07/17-16:34:43.966698736, st_ctime=2018/07/17-16:34:43.967698739&#125;) = 0</span><br><span class="line">pread64(14, "<span class="symbol">\5</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span>(<span class="symbol">\2</span>52M[<span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span>"..., 636, 0) = 636</span><br><span class="line">getsockname(11, &#123;sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr("172.17.0.2")&#125;, [16]) = 0</span><br><span class="line">sendto(13, "nN<span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 35, 0, NULL, 0) = 35</span><br><span class="line">sendto(13, "<span class="symbol">\3</span>75<span class="symbol">\2</span>15<span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 35, 0, NULL, 0) = 35</span><br><span class="line">epoll_wait(8, [&#123;EPOLLOUT, &#123;u32=69027249, u64=140003117974961&#125;&#125;, &#123;EPOLLIN, &#123;u32=69026288, u64=140003117974000&#125;&#125;], 512, 5000) = 2</span><br><span class="line">recvfrom(13, "nN<span class="symbol">\2</span>01<span class="symbol">\2</span>00<span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\3</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 4096, 0, NULL, NULL) = 147</span><br><span class="line">recvfrom(13, "<span class="symbol">\3</span>75<span class="symbol">\2</span>15<span class="symbol">\2</span>01<span class="symbol">\2</span>00<span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 4096, 0, NULL, NULL) = 168</span><br><span class="line">socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 15</span><br><span class="line">ioctl(15, FIONBIO, [1]) = 0</span><br><span class="line">epoll_ctl(8, EPOLL_CTL_ADD, 15, &#123;EPOLLIN|EPOLLOUT|EPOLLRDHUP|EPOLLET, &#123;u32=69027488, u64=140003117975200&#125;&#125;) = 0</span><br><span class="line">connect(15, &#123;sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr("54.222.148.216")&#125;, 16) = -1 EINPROGRESS (Operation now in progress)</span><br><span class="line">recvfrom(13, 0x7ffd1f603790, 4096, 0, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">epoll_wait(8, [&#123;EPOLLOUT, &#123;u32=69027488, u64=140003117975200&#125;&#125;], 512, 20000) = 1</span><br><span class="line">getsockopt(15, SOL_SOCKET, SO_ERROR, [0], [4]) = 0</span><br><span class="line">writev(15, [&#123;"GET /?key=testxxxx HTTP/1.0<span class="symbol">\r</span><span class="symbol">\n</span>Hos"..., 219&#125;], 1) = 219</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=69027488, u64=140003117975200&#125;&#125;], 512, 60000) = 1</span><br><span class="line">recvfrom(15, "HTTP/1.1 200 OK<span class="symbol">\r</span><span class="symbol">\n</span>Content-Type: t"..., 3723, 0, NULL, NULL) = 3723</span><br><span class="line">close(14) = 0</span><br><span class="line">readv(15, [&#123;"a.qnssl.com/images/265818/Fntncr"..., 4096&#125;], 1) = 4096</span><br><span class="line">readv(15, [&#123;"w-card-price&#123;color: #004aa0;&#125;.s-"..., 4096&#125;], 1) = 4096</span><br><span class="line">readv(15, [&#123;" &#123;<span class="symbol">\n</span> font-family: <span class="symbol">\"</span>Open Sans"..., 4096&#125;], 1) = 373</span><br><span class="line">open("/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2.0000014052", O_RDWR|O_CREAT|O_EXCL, 0600) = 14</span><br><span class="line">pwritev(14, [&#123;"<span class="symbol">\5</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\3</span>56<span class="symbol">\2</span>54M[<span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span>"..., 4096&#125;, &#123;"a.qnssl.com/images/265818/Fntncr"..., 4096&#125;, &#123;"w-card-price&#123;color: #004aa0;&#125;.s-"..., 4096&#125;], 3, 0) = -1 ENOSPC (No space left on device)</span><br><span class="line">gettid() = 7</span><br><span class="line">write(4, "2018/07/17 08:46:33 [crit] 7#7: "..., 328) = 328</span><br><span class="line">close(15) = 0</span><br><span class="line">unlink("/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2.0000014052") = 0</span><br><span class="line">write(5, "&#123; <span class="symbol">\"</span>time<span class="symbol">\"</span>: <span class="symbol">\"</span>2018-07-17T08:46:33+0"..., 382) = 382</span><br><span class="line">close(14) = 0</span><br><span class="line">close(11) = 0</span><br><span class="line"></span><br><span class="line">2.正常调用堆栈过程</span><br><span class="line">[root@iZ2ze2mzhjk3ou1vsnkthzZ rpm]# strace -p 3904 -v</span><br><span class="line">strace: Process 3904 attached</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN, &#123;u32=69025808, u64=140003117973520&#125;&#125;], 512, -1) = 1</span><br><span class="line">accept4(6, &#123;sa_family=AF_INET, sin_port=htons(59360), sin_addr=inet_addr("10.130.0.4")&#125;, [16], SOCK_NONBLOCK) = 11</span><br><span class="line">epoll_ctl(8, EPOLL_CTL_ADD, 11, &#123;EPOLLIN|EPOLLRDHUP|EPOLLET, &#123;u32=69027248, u64=140003117974960&#125;&#125;) = 0</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN, &#123;u32=69027248, u64=140003117974960&#125;&#125;], 512, 60000) = 1</span><br><span class="line">recvfrom(11, "GET /?key=testxxxx HTTP/1.1<span class="symbol">\r</span><span class="symbol">\n</span>Use"..., 1024, 0, NULL, NULL) = 88</span><br><span class="line">epoll_ctl(8, EPOLL_CTL_MOD, 11, &#123;EPOLLIN|EPOLLOUT|EPOLLRDHUP|EPOLLET, &#123;u32=69027248, u64=140003117974960&#125;&#125;) = 0</span><br><span class="line">open("/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2", O_RDONLY|O_NONBLOCK) = 14</span><br><span class="line">fstat(14, &#123;st_dev=makedev(253, 1), st_ino=655504, st_mode=S_IFREG|0600, st_nlink=1, st_uid=101, st_gid=101, st_blksize=4096, st_blocks=96, st_size=46750, st_atime=2018/07/17-16:14:38.127407158, st_mtime=2018/07/17-16:14:38.127407158, st_ctime=2018/07/17-16:14:38.128407161&#125;) = 0</span><br><span class="line">pread64(14, "<span class="symbol">\5</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span>s<span class="symbol">\2</span>45M[<span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span>"..., 636, 0) = 636</span><br><span class="line">getsockname(11, &#123;sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr("172.17.0.2")&#125;, [16]) = 0</span><br><span class="line">sendto(12, "<span class="symbol">\2</span>10V<span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 35, 0, NULL, 0) = 35</span><br><span class="line">sendto(12, "<span class="symbol">\2</span>7<span class="symbol">\1</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 35, 0, NULL, 0) = 35</span><br><span class="line">epoll_wait(8, [&#123;EPOLLOUT, &#123;u32=69027248, u64=140003117974960&#125;&#125;, &#123;EPOLLIN, &#123;u32=69027728, u64=140003117975440&#125;&#125;], 512, 5000) = 2</span><br><span class="line">recvfrom(12, "<span class="symbol">\2</span>10V<span class="symbol">\2</span>01<span class="symbol">\2</span>00<span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\3</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 4096, 0, NULL, NULL) = 147</span><br><span class="line">recvfrom(12, "<span class="symbol">\2</span>7<span class="symbol">\1</span><span class="symbol">\2</span>01<span class="symbol">\2</span>00<span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\1</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\6</span>bobcat<span class="symbol">\6</span>sxldns<span class="symbol">\3</span>com<span class="symbol">\0</span><span class="symbol">\0</span>"..., 4096, 0, NULL, NULL) = 168</span><br><span class="line">socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 15</span><br><span class="line">ioctl(15, FIONBIO, [1]) = 0</span><br><span class="line">epoll_ctl(8, EPOLL_CTL_ADD, 15, &#123;EPOLLIN|EPOLLOUT|EPOLLRDHUP|EPOLLET, &#123;u32=69027489, u64=140003117975201&#125;&#125;) = 0</span><br><span class="line">connect(15, &#123;sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr("52.80.58.42")&#125;, 16) = -1 EINPROGRESS (Operation now in progress)</span><br><span class="line">recvfrom(12, 0x7ffd1f603790, 4096, 0, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">epoll_wait(8, [&#123;EPOLLOUT, &#123;u32=69027489, u64=140003117975201&#125;&#125;], 512, 20000) = 1</span><br><span class="line">getsockopt(15, SOL_SOCKET, SO_ERROR, [0], [4]) = 0</span><br><span class="line">writev(15, [&#123;"GET /?key=testxxxx HTTP/1.0<span class="symbol">\r</span><span class="symbol">\n</span>Hos"..., 219&#125;], 1) = 219</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=69027489, u64=140003117975201&#125;&#125;], 512, 60000) = 1</span><br><span class="line">recvfrom(15, "HTTP/1.1 200 OK<span class="symbol">\r</span><span class="symbol">\n</span>Content-Type: t"..., 3723, 0, NULL, NULL) = 3723</span><br><span class="line">close(14) = 0</span><br><span class="line">readv(15, [&#123;"a.qnssl.com/images/265818/Fntncr"..., 4096&#125;], 1) = 4096</span><br><span class="line">readv(15, [&#123;"w-card-price&#123;color: #004aa0;&#125;.s-"..., 4096&#125;], 1) = 4096</span><br><span class="line">readv(15, [&#123;" &#123;<span class="symbol">\n</span> font-family: <span class="symbol">\"</span>Open Sans"..., 4096&#125;], 1) = 2565</span><br><span class="line">open("/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2.0000014051", O_RDWR|O_CREAT|O_EXCL, 0600) = 14</span><br><span class="line">pwritev(14, [&#123;"<span class="symbol">\5</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span>(<span class="symbol">\2</span>52M[<span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span><span class="symbol">\0</span>"..., 4096&#125;, &#123;"a.qnssl.com/images/265818/Fntncr"..., 4096&#125;, &#123;"w-card-price&#123;color: #004aa0;&#125;.s-"..., 4096&#125;], 3, 0) = 12288</span><br><span class="line">writev(11, [&#123;"HTTP/1.1 200 OK<span class="symbol">\r</span><span class="symbol">\n</span>Server: nginx/1"..., 321&#125;], 1) = 321</span><br><span class="line">sendfile(11, 14, [636] =&gt; [12288], 11652) = 11652</span><br><span class="line">epoll_wait(8, [&#123;EPOLLOUT, &#123;u32=69027489, u64=140003117975201&#125;&#125;], 512, 59955) = 1</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=69027489, u64=140003117975201&#125;&#125;], 512, 59953) = 1</span><br><span class="line">readv(15, [&#123;"rc=<span class="symbol">\"</span>//nzr2ybsda.qnssl.com/images"..., 1531&#125;, &#123;"lass=<span class="symbol">\"</span>s-nav-item<span class="symbol">\"</span> target=<span class="symbol">\"</span>_self<span class="symbol">\"</span>"..., 4096&#125;, &#123;"lign: left; font-size: 160<span class="variable">%;\"&gt;\302\240"..., 4096&#125;, &#123;"OQswmpPvoA0.jpg?imageMogr2/strip"..., 4096&#125;], 4) = 10136</span></span><br><span class="line"><span class="variable">pwritev(14, [&#123;" &#123;\n font-family: \"Open Sans"..., 4096&#125;, &#123;"lass=\"s-nav-item\" target=\"_self\""..., 4096&#125;, &#123;"lign: left; font-size: 160%</span>;<span class="symbol">\"</span>&gt;<span class="symbol">\3</span>02<span class="symbol">\2</span>40"..., 4096&#125;], 3, 12288) = 12288</span><br><span class="line">sendfile(11, 14, [12288] =&gt; [24576], 12288) = 12288</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=69027489, u64=140003117975201&#125;&#125;], 512, 59948) = 1</span><br><span class="line">readv(15, [&#123;"olor-custom1<span class="symbol">\"</span>&gt;<span class="symbol">\3</span>47<span class="symbol">\2</span>54<span class="symbol">\2</span>54<span class="symbol">\3</span>44<span class="symbol">\2</span>70<span class="symbol">\2</span>11<span class="symbol">\3</span>46<span class="symbol">\2</span>26<span class="symbol">\2</span>71<span class="symbol">\3</span>45"..., 3683&#125;, &#123;"container title-group-container<span class="symbol">\"</span>"..., 4096&#125;, &#123;";cs=srgb&amp;s=f71a6adc1e5953a52"..., 4096&#125;, &#123;")<span class="symbol">\"</span> data-bg=<span class="symbol">\"</span>//nzr2ybsda.qnssl.co"..., 4096&#125;], 4) = 15971</span><br><span class="line">readv(15, [&#123;"<span class="symbol">\2</span>30<span class="symbol">\2</span>63<span class="symbol">\3</span>45<span class="symbol">\2</span>24<span class="symbol">\2</span>57<span class="symbol">\3</span>46<span class="symbol">\2</span>31<span class="symbol">\2</span>37<span class="symbol">\"</span> title=<span class="symbol">\"</span><span class="symbol">\3</span>46<span class="symbol">\2</span>62<span class="symbol">\2</span>10<span class="symbol">\3</span>51<span class="symbol">\2</span>30<span class="symbol">\2</span>63<span class="symbol">\3</span>45<span class="symbol">\2</span>24<span class="symbol">\2</span>57<span class="symbol">\3</span>46<span class="symbol">\2</span>31<span class="symbol">\2</span>37<span class="symbol">\3</span>45<span class="symbol">\2</span>25<span class="symbol">\2</span>06"..., 4096&#125;], 1) = 2853</span><br><span class="line">pwritev(14, [&#123;"OQswmpPvoA0.jpg?imageMogr2/strip"..., 4096&#125;, &#123;"container title-group-container<span class="symbol">\"</span>"..., 4096&#125;, &#123;";cs=srgb&amp;s=f71a6adc1e5953a52"..., 4096&#125;, &#123;")<span class="symbol">\"</span> data-bg=<span class="symbol">\"</span>//nzr2ybsda.qnssl.co"..., 4096&#125;], 4, 24576) = 16384</span><br><span class="line">sendfile(11, 14, [24576] =&gt; [40960], 16384) = 16384</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=69027489, u64=140003117975201&#125;&#125;], 512, 59947) = 1</span><br><span class="line">readv(15, [&#123;"</span><br><span class="line"></span><br><span class="line">&lt;d"..., 1243&#125;, &#123;"<span class="symbol">\2</span>32<span class="symbol">\2</span>04<span class="symbol">\3</span>44<span class="symbol">\2</span>70<span class="symbol">\2</span>32<span class="symbol">\3</span>47<span class="symbol">\2</span>73<span class="symbol">\2</span>51<span class="symbol">\3</span>44<span class="symbol">\2</span>71<span class="symbol">\2</span>37<span class="symbol">\3</span>45<span class="symbol">\2</span>34<span class="symbol">\2</span>50<span class="symbol">\3</span>44<span class="symbol">\2</span>70<span class="symbol">\2</span>15<span class="symbol">\3</span>46<span class="symbol">\2</span>26<span class="symbol">\2</span>55<span class="symbol">\3</span>46<span class="symbol">\2</span>24<span class="symbol">\2</span>00<span class="symbol">\3</span>45<span class="symbol">\2</span>15<span class="symbol">\2</span>07<span class="symbol">\3</span>43<span class="symbol">\2</span>00<span class="symbol">\2</span>02&lt;/d"..., 4096&#125;, &#123;"", 4096&#125;, &#123;"", 4096&#125;, &#123;"", 4096&#125;], 5) = 2937</span><br><span class="line">pwritev(14, [&#123;"<span class="symbol">\2</span>30<span class="symbol">\2</span>63<span class="symbol">\3</span>45<span class="symbol">\2</span>24<span class="symbol">\2</span>57<span class="symbol">\3</span>46<span class="symbol">\2</span>31<span class="symbol">\2</span>37<span class="symbol">\"</span> title=<span class="symbol">\"</span><span class="symbol">\3</span>46<span class="symbol">\2</span>62<span class="symbol">\2</span>10<span class="symbol">\3</span>51<span class="symbol">\2</span>30<span class="symbol">\2</span>63<span class="symbol">\3</span>45<span class="symbol">\2</span>24<span class="symbol">\2</span>57<span class="symbol">\3</span>46<span class="symbol">\2</span>31<span class="symbol">\2</span>37<span class="symbol">\3</span>45<span class="symbol">\2</span>25<span class="symbol">\2</span>06"..., 4096&#125;, &#123;"<span class="symbol">\2</span>32<span class="symbol">\2</span>04<span class="symbol">\3</span>44<span class="symbol">\2</span>70<span class="symbol">\2</span>32<span class="symbol">\3</span>47<span class="symbol">\2</span>73<span class="symbol">\2</span>51<span class="symbol">\3</span>44<span class="symbol">\2</span>71<span class="symbol">\2</span>37<span class="symbol">\3</span>45<span class="symbol">\2</span>34<span class="symbol">\2</span>50<span class="symbol">\3</span>44<span class="symbol">\2</span>70<span class="symbol">\2</span>15<span class="symbol">\3</span>46<span class="symbol">\2</span>26<span class="symbol">\2</span>55<span class="symbol">\3</span>46<span class="symbol">\2</span>24<span class="symbol">\2</span>00<span class="symbol">\3</span>45<span class="symbol">\2</span>15<span class="symbol">\2</span>07<span class="symbol">\3</span>43<span class="symbol">\2</span>00<span class="symbol">\2</span>02&lt;/d"..., 1694&#125;], 2, 40960) = 5790 sendfile(11, 14, [40960] =&gt; [46750], 5790) = 5790</span><br><span class="line">chmod("/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2.0000014051", 0600) = 0</span><br><span class="line">rename("/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2.0000014051", "/etc/nginx/china_cache/2/7d/2ac65d1f9080e2baff45a4332f9017d2") = 0</span><br><span class="line">fstat(14, &#123;st_dev=makedev(253, 1), st_ino=655502, st_mode=S_IFREG|0600, st_nlink=1, st_uid=101, st_gid=101, st_blksize=4096, st_blocks=96, st_size=46750, st_atime=2018/07/17-16:34:43.967698739, st_mtime=2018/07/17-16:34:43.966698736, st_ctime=2018/07/17-16:34:43.967698739&#125;) = 0</span><br><span class="line">close(15) = 0</span><br><span class="line">write(5, "&#123; <span class="symbol">\"</span>time<span class="symbol">\"</span>: <span class="symbol">\"</span>2018-07-17T08:34:43+0"..., 386) = 386</span><br><span class="line">close(14) = 0</span><br><span class="line">setsockopt(11, SOL_TCP, TCP_NODELAY, [1], 4) = 0</span><br><span class="line">epoll_wait(8, [&#123;EPOLLIN|EPOLLOUT|EPOLLRDHUP, &#123;u32=69027248, u64=140003117974960&#125;&#125;], 512, 65000) = 1</span><br><span class="line">recvfrom(11, "", 1024, 0, NULL, NULL) = 0</span><br><span class="line">close(11) = 0</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;用户自定义站点502问题分析&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;现象：自定义域名用户反馈，打开网站返回502，如图&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;/images/img_5b5183b84d4dd.png&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt; 根据respons
      
    
    </summary>
    
    
      <category term="linux" scheme="https://www.xiemx.com/categories/linux/"/>
    
      <category term="nginx" scheme="https://www.xiemx.com/categories/linux/nginx/"/>
    
      <category term="debug" scheme="https://www.xiemx.com/categories/linux/nginx/debug/"/>
    
    
      <category term="debug" scheme="https://www.xiemx.com/tags/debug/"/>
    
      <category term="linux" scheme="https://www.xiemx.com/tags/linux/"/>
    
      <category term="nginx" scheme="https://www.xiemx.com/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>TCP状态机</title>
    <link href="https://www.xiemx.com//2018/01/23/tcp-state/"/>
    <id>https://www.xiemx.com//2018/01/23/tcp-state/</id>
    <published>2018-01-23T03:01:20.000Z</published>
    <updated>2019-10-21T06:57:42.714Z</updated>
    
    <content type="html"><![CDATA[<h3 id="TCP状态分析"><a href="#TCP状态分析" class="headerlink" title="TCP状态分析"></a>TCP状态分析</h3><ul><li>listen／close</li><li>syn-sent/syn-revd</li><li>established</li><li>fin_wait_1/close_wait</li><li>fin_wait_2/last_ack</li><li>time_wait/close</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">LISTEN</span>        <span class="string">等待来自远程TCP应用程序的请求</span></span><br><span class="line"><span class="attr">SYN_SENT</span><span class="string">发送连接请求后等待来自远程端点的确认。TCP第一次握手后客户端所处的状态</span></span><br><span class="line"><span class="meta">SYN-RECEIVED</span><span class="string">该端点已经接收到连接请求并发送确认。该端点正在等待最终确认。TCP第二次握手后服务端所处的状态</span></span><br><span class="line"><span class="attr">ESTABLISHED</span><span class="string">代表连接已经建立起来了。这是连接数据传输阶段的正常状态</span></span><br><span class="line"><span class="attr">FIN_WAIT_1</span><span class="string">等待来自远程TCP的终止连接请求或终止请求的确认</span></span><br><span class="line"><span class="attr">FIN_WAIT_2</span><span class="string">在此端点发送终止连接请求后，等待来自远程TCP的连接终止请求</span></span><br><span class="line"><span class="attr">CLOSE_WAIT</span><span class="string">该端点已经收到来自远程端点的关闭请求，此TCP正在等待本地应用程序的连接终止请求</span></span><br><span class="line"><span class="attr">CLOSING</span>        <span class="string">等待来自远程TCP的连接终止请求确认</span></span><br><span class="line"><span class="attr">LAST_ACK</span><span class="string">等待先前发送到远程TCP的连接终止请求的确认</span></span><br><span class="line"><span class="attr">TIME_WAIT</span><span class="string">等待足够的时间来确保远程TCP接收到其连接终止请求的确认</span></span><br></pre></td></tr></table></figure><p>以上大致为一个Tcp从三次握手建立连接到四次挥手断开连接的整个过程C/S对应的TCP状态。</p><h3 id="详细流程"><a href="#详细流程" class="headerlink" title="详细流程"></a>详细流程</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 客户端(close)发送syn连接请求给服务端(<span class="section">listen</span>),客户端等待服务端ack(syn_sent)</span><br><span class="line"><span class="number">2.</span> 服务端收到syn请求,发送ack/syn(syn_rec)</span><br><span class="line"><span class="number">3.</span> 客户端收到ack(establelished)</span><br><span class="line"><span class="number">4.</span> 传输数据</span><br><span class="line"><span class="number">5.</span> 客户端数据交互完成请求关闭连接，发送fin请求(fin_wait_1)</span><br><span class="line"><span class="number">6.</span> 服务端收到fin请求,发送ack(close_wait)</span><br><span class="line"><span class="number">7.</span> 服务端数据交互完成,发送fin请求关闭连接(last_ack)</span><br><span class="line"><span class="number">8.</span> 客户端收到服务端的ack请求(fin_wait_2)</span><br><span class="line"><span class="number">9.</span> 客户端收到服务端的fin请求,发送ack确认断开(time_wait)</span><br><span class="line"><span class="number">10.</span> 服务端收到客户端的ack,关闭连接(close)</span><br><span class="line"><span class="number">11.</span> 客户端维护<span class="number">2</span>个msl时间后回收socket</span><br></pre></td></tr></table></figure><p>引用网上的一张图：</p><p><img src="/images/img_5a66a577176c8.png" alt="img"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;TCP状态分析&quot;&gt;&lt;a href=&quot;#TCP状态分析&quot; class=&quot;headerlink&quot; title=&quot;TCP状态分析&quot;&gt;&lt;/a&gt;TCP状态分析&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;listen／close&lt;/li&gt;
&lt;li&gt;syn-sent/syn-revd&lt;/li&gt;
      
    
    </summary>
    
    
      <category term="linux" scheme="https://www.xiemx.com/categories/linux/"/>
    
    
      <category term="linux" scheme="https://www.xiemx.com/tags/linux/"/>
    
      <category term="tcp" scheme="https://www.xiemx.com/tags/tcp/"/>
    
  </entry>
  
  <entry>
    <title>TCP TIME_WAIT</title>
    <link href="https://www.xiemx.com//2018/01/23/tcp-time_wait/"/>
    <id>https://www.xiemx.com//2018/01/23/tcp-time_wait/</id>
    <published>2018-01-23T02:01:21.000Z</published>
    <updated>2019-10-19T07:40:03.304Z</updated>
    
    <content type="html"><![CDATA[<h4 id="维持TIME-WAIT有两个原因："><a href="#维持TIME-WAIT有两个原因：" class="headerlink" title="维持TIME_WAIT有两个原因："></a>维持TIME_WAIT有两个原因：</h4><ol><li><p>可靠地实现TCP的全双工连接终止</p><p> 在四次挥手中，假设最后的ACK丢失了，被动关闭方会重发FIN。主动关闭端必须维护状态，来允许被动关闭方重发最后的ACK；如果它没有维护这个状态，将会对重发FIN返回RST，被动关闭方会认为这是个错误。如果TCP正在执行彻底终止数据流的两个方向所需的所有工作（即全双工关闭），则必须正确处理这四个段中任何一个的丢失。所以执行主动关闭的一方必须在结束时保持TIME_WAIT状态：因为它可能必须重传最后的ACK。</p></li><li><p>允许旧的重复数据段在网络中过期</p><p> 假设在主机1.1.1.1的1111端口和2.2.2.2的2222端口之间有一个TCP连接。此连接关闭后，相同的地址和端口建立了一个新连接。由于IP地址和端口相同，TCP必须防止旧连接的数据包再次出现，被新的连接误收。为此，TCP将不会启动当前处于TIME_WAIT状态的连接。由于TIME_WAIT状态的持续时间是两倍的MSL，因此TCP允许一个方向的数据在MSL秒内丢失，也允许回复在一个MSL秒内丢失。通过此规则来保证当一个TCP连接成功建立时，来自先前连接的所有旧的副本在网络中已过期。</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;维持TIME-WAIT有两个原因：&quot;&gt;&lt;a href=&quot;#维持TIME-WAIT有两个原因：&quot; class=&quot;headerlink&quot; title=&quot;维持TIME_WAIT有两个原因：&quot;&gt;&lt;/a&gt;维持TIME_WAIT有两个原因：&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;可
      
    
    </summary>
    
    
      <category term="linux" scheme="https://www.xiemx.com/categories/linux/"/>
    
    
      <category term="linux" scheme="https://www.xiemx.com/tags/linux/"/>
    
      <category term="tcp" scheme="https://www.xiemx.com/tags/tcp/"/>
    
  </entry>
  
  <entry>
    <title>zabbix distrubuted monitor</title>
    <link href="https://www.xiemx.com//2017/09/21/zabbix-distrubuted-monitor/"/>
    <id>https://www.xiemx.com//2017/09/21/zabbix-distrubuted-monitor/</id>
    <published>2017-09-20T18:09:37.000Z</published>
    <updated>2019-10-21T06:57:42.570Z</updated>
    
    <content type="html"><![CDATA[<p>zabbix 分布式监控2种模式</p><ul><li>node模式</li><li>proxy模式</li></ul><p>PS: node模式官方在2.4版本之后已经弃用，重点讨论proxy模式</p><h3 id="proxy-模式"><a href="#proxy-模式" class="headerlink" title="proxy 模式"></a>proxy 模式</h3><p>Zabbix proxy可以代替Zabbix服务器收集性能和可用性数据，一个代理可以承担一些收集数据的负载。使用代理是实现集中式和分布式监控的最简单方法。proxy需要使用单独的数据库来缓存agent数据，在发给server防止出现因网络问题造成的数据丢失。zabbix proxy只是一个数据收集组件，不会触发任何trigger／alert.</p><p><img src="/images/img_59c35cd9ab71b.png" alt="img"></p><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul><li>Monitor remote locations</li><li>Monitor locations having unreliable communications</li><li>Offload the Zabbix server when monitoring thousands of devices</li><li>Simplify the maintenance of distributed monitoring</li></ul><h3 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">同安装zabbix server 类似，不赘述,需要其他功能也可以在编译时自行开启。</span></span><br><span class="line"></span><br><span class="line">./configure --prefix=/opt/zabbix_proxy/ --enable-proxy --with-mysql --with-libcurl</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">create databases zabbix</span><br><span class="line">grant all to zabbix.* to zabbix@'%' identified by "zabbix";</span><br><span class="line"><span class="meta">#</span><span class="bash">导入schema.sql</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置文件中hostname需要和zabbix上添加的保持一致</span></span><br><span class="line"><span class="meta">#</span><span class="bash">其它参考server设置参数</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">ps：设置适当的配置同步时间，默认一小时。建议设置短一点，这样如果有新机器加入配置修改都可以快速同步并监控。</span></span><br><span class="line">ConfigFrequency=600</span><br></pre></td></tr></table></figure><p>zabbix server 配置</p><p><img src="/images/img_59c35d1d930c1.png" alt="img"></p><p>添加主机时选择指定的proxy</p><p><img src="/images/img_59c35d389b1c5.png" alt="img"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;zabbix 分布式监控2种模式&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;node模式&lt;/li&gt;
&lt;li&gt;proxy模式&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;PS: node模式官方在2.4版本之后已经弃用，重点讨论proxy模式&lt;/p&gt;
&lt;h3 id=&quot;proxy-模式&quot;&gt;&lt;a href=&quot;#
      
    
    </summary>
    
    
      <category term="zabbix" scheme="https://www.xiemx.com/categories/zabbix/"/>
    
    
      <category term="zabbix" scheme="https://www.xiemx.com/tags/zabbix/"/>
    
  </entry>
  
  <entry>
    <title>graphite_relay sharding</title>
    <link href="https://www.xiemx.com//2017/09/08/graphite_relay-sharding/"/>
    <id>https://www.xiemx.com//2017/09/08/graphite_relay-sharding/</id>
    <published>2017-09-07T22:09:47.000Z</published>
    <updated>2019-10-21T06:57:43.060Z</updated>
    
    <content type="html"><![CDATA[<p>当statsd发送超量的metrics到graphite中，graphite单节点无法负载的情况，可以使用consistent-hashing的模式来将数据分片到backend中。同样的consistent-hashing模式下可以自动剔除／加入节点。</p><p>官方文档：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">carbon-relay.py serves two distinct purposes: replication and sharding.</span><br><span class="line"></span><br><span class="line">When running <span class="keyword">with</span> RELAY_METHOD = <span class="keyword">rules</span>, a carbon-relay.py <span class="keyword">instance</span> can run <span class="keyword">in</span> place <span class="keyword">of</span> a carbon-cache.py <span class="keyword">server</span> <span class="keyword">and</span> relay <span class="keyword">all</span> incoming metrics <span class="keyword">to</span> multiple backend carbon-cache.py‘s running <span class="keyword">on</span> different ports <span class="keyword">or</span> hosts.</span><br><span class="line"></span><br><span class="line"><span class="keyword">In</span> RELAY_METHOD = <span class="keyword">consistent</span>-hashing <span class="keyword">mode</span>, a DESTINATIONS setting defines a sharding strategy across multiple carbon-cache.py backends. The same <span class="keyword">consistent</span> hashing <span class="keyword">list</span> can be provided <span class="keyword">to</span> the graphite webapp via CARBONLINK_HOSTS <span class="keyword">to</span> spread <span class="keyword">reads</span> across the multiple backends.</span><br><span class="line">本例模拟一个双后端的carbon-<span class="keyword">cache</span> instance.单机器运行,使用carbon-cache.py 的<span class="keyword">instance</span>功能</span><br><span class="line"></span><br><span class="line">config文件：</span><br><span class="line"><span class="comment">#####carbon.conf</span></span><br><span class="line">[<span class="keyword">cache</span>:a]</span><br><span class="line">LINE_RECEIVER_PORT = <span class="number">2203</span></span><br><span class="line">PICKLE_RECEIVER_PORT = <span class="number">2204</span></span><br><span class="line">CACHE_QUERY_PORT = <span class="number">7102</span></span><br><span class="line">LOCAL_DATA_DIR = /opt/graphite/<span class="keyword">storage</span>/whisper_a/</span><br><span class="line">[<span class="keyword">cache</span>:b]</span><br><span class="line">LINE_RECEIVER_PORT = <span class="number">2205</span></span><br><span class="line">PICKLE_RECEIVER_PORT = <span class="number">2206</span></span><br><span class="line">CACHE_QUERY_PORT = <span class="number">7202</span></span><br><span class="line">LOCAL_DATA_DIR = /opt/graphite/<span class="keyword">storage</span>/whisper_b/</span><br><span class="line">[relay]</span><br><span class="line">LINE_RECEIVER_INTERFACE = <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">LINE_RECEIVER_PORT = <span class="number">2003</span></span><br><span class="line">PICKLE_RECEIVER_INTERFACE = <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">PICKLE_RECEIVER_PORT = <span class="number">2004</span></span><br><span class="line">DESTINATIONS = <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a, <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b </span><br><span class="line">启动服务：</span><br><span class="line"></span><br><span class="line">启动<span class="keyword">instance</span>:a</span><br><span class="line">xmx@xiemx-<span class="keyword">test</span>:/opt/graphisudo ./carbon-cache.py <span class="comment">--instance=a --config=/opt/graphite/conf/carbon.conf start</span></span><br><span class="line"><span class="keyword">Starting</span> carbon-<span class="keyword">cache</span> (<span class="keyword">instance</span> a)</span><br><span class="line"></span><br><span class="line">启动<span class="keyword">instance</span>:b</span><br><span class="line">xmx@xiemx-<span class="keyword">test</span>:/opt/graphite/<span class="keyword">bin</span>$ sudo ./carbon-cache.py <span class="comment">--instance=b --config=/opt/graphite/conf/carbon.conf start</span></span><br><span class="line"><span class="keyword">Starting</span> carbon-<span class="keyword">cache</span> (<span class="keyword">instance</span> b)</span><br><span class="line"></span><br><span class="line">启动relay:</span><br><span class="line">xmx@xiemx-<span class="keyword">test</span>:/opt/graphite/conf$ sudo /opt/graphite/<span class="keyword">bin</span>/carbon-relay.py <span class="comment">--debug --config=/opt/graphite/conf/carbon.conf start</span></span><br><span class="line"><span class="keyword">Starting</span> carbon-relay (<span class="keyword">instance</span> a)</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] <span class="keyword">Using</span> sorted write strategy <span class="keyword">for</span> <span class="keyword">cache</span></span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] connecting <span class="keyword">to</span> carbon daemon <span class="keyword">at</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] connecting <span class="keyword">to</span> carbon daemon <span class="keyword">at</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] twistd <span class="number">16.4</span><span class="number">.1</span> (/usr/<span class="keyword">bin</span>/python <span class="number">2.7</span><span class="number">.6</span>) <span class="keyword">starting</span> up.</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] reactor <span class="keyword">class</span>: twisted.internet.epollreactor.EPollReactor.</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] <span class="keyword">Starting</span> factory CarbonClientFactory(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b)</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] CarbonClientFactory(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b)::startedConnecting (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>)</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] <span class="keyword">Starting</span> factory CarbonClientFactory(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a)</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] CarbonClientFactory(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a)::startedConnecting (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>)</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] CarbonReceiverFactory <span class="keyword">starting</span> <span class="keyword">on</span> <span class="number">2003</span></span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] <span class="keyword">Starting</span> factory </span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] CarbonReceiverFactory <span class="keyword">starting</span> <span class="keyword">on</span> <span class="number">2004</span></span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [console] <span class="keyword">Starting</span> factory </span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] CarbonClientProtocol(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b)::connectionMade</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] CarbonClientFactory(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b)::connectionMade (CarbonClientProtocol(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b))</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] Destination <span class="keyword">is</span> up: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2206</span>:b</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] CarbonClientProtocol(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a)::connectionMade</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] CarbonClientFactory(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a)::connectionMade (CarbonClientProtocol(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a))</span><br><span class="line"><span class="number">08</span>/<span class="number">09</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">16</span> :: [clients] Destination <span class="keyword">is</span> up: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2204</span>:a</span><br></pre></td></tr></table></figure><p>测试：</p><p>模拟5个客户端同时发送100个key</p><p><img src="/images/img_59b26b3126991.png" alt="img"></p><p><img src="/images/img_59b26b4437729.png" alt="img"></p><p>模拟node掉线重连</p><p><img src="/images/img_59b26b60dc7e7.png" alt="img"></p><p>graphite-web数据聚合展示</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">修改local_settings.py</span><br><span class="line">CARBONLINK_HOSTS = [<span class="string">"127.0.0.1:7102:a"</span>, <span class="string">"127.0.0.1:7202:b"</span>]</span><br><span class="line"></span><br><span class="line">启动django</span><br><span class="line">sudo PYTHONPATH=/opt/graphite/webapp django-admin<span class="selector-class">.py</span> runserver <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">5000</span> --settings</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;当statsd发送超量的metrics到graphite中，graphite单节点无法负载的情况，可以使用consistent-hashing的模式来将数据分片到backend中。同样的consistent-hashing模式下可以自动剔除／加入节点。&lt;/p&gt;
&lt;p&gt;官方文
      
    
    </summary>
    
    
      <category term="statsd" scheme="https://www.xiemx.com/categories/statsd/"/>
    
      <category term="graphite" scheme="https://www.xiemx.com/categories/statsd/graphite/"/>
    
    
  </entry>
  
  <entry>
    <title>statsd cluster proxy</title>
    <link href="https://www.xiemx.com//2017/09/08/statsd-cluster-proxy/"/>
    <id>https://www.xiemx.com//2017/09/08/statsd-cluster-proxy/</id>
    <published>2017-09-07T21:09:37.000Z</published>
    <updated>2019-10-21T06:57:42.329Z</updated>
    
    <content type="html"><![CDATA[<p>通过UDP proxy程序将前端的数据通过一定的hash算法将相同的metric发送的固定的后aggregation数据。proxy代理支持健康检测自动剔除／加入后端statsd。</p><p>1.配置<br>本例展示一个3节点的statsd后端且将聚合数据发送到standout方便观测。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">node1</span><br><span class="line"><span class="comment">######config文件：</span></span><br><span class="line">&#123;</span><br><span class="line"> port: 8127</span><br><span class="line">, mgmt_port: 8227</span><br><span class="line">, backends: [ <span class="string">"./backends/console"</span> ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">启动:</span><br><span class="line">xiemx➜  statsd : master ✘ :✹✭ ᐅ  node stats.js config8127.js</span><br><span class="line">8 Sep 11:06:36 - [81604] reading<span class="built_in"> config </span>file: config8127.js</span><br><span class="line">8 Sep 11:06:36 -<span class="built_in"> server </span>is up INFO</span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">node2</span><br><span class="line"><span class="comment">######config文件：</span></span><br><span class="line">&#123;</span><br><span class="line"> port: 8128</span><br><span class="line">, mgmt_port: 8228</span><br><span class="line">, backends: [ <span class="string">"./backends/console"</span> ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">启动：</span><br><span class="line">xiemx➜  statsd : master ✘ :✹✭ ᐅ  node stats.js config8128.js</span><br><span class="line">8 Sep 11:07:09 - [81665] reading<span class="built_in"> config </span>file: config8128.js</span><br><span class="line">8 Sep 11:07:09 -<span class="built_in"> server </span>is up INFO</span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">node3</span><br><span class="line"><span class="comment">######config文件：</span></span><br><span class="line">&#123;</span><br><span class="line"> port: 8129</span><br><span class="line">, mgmt_port: 8229</span><br><span class="line">, backends: [ <span class="string">"./backends/console"</span> ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">启动：</span><br><span class="line">xiemx➜  statsd : master ✘ :✹✭ ᐅ  node stats.js config8129.js</span><br><span class="line">8 Sep 11:07:45 - [81723] reading<span class="built_in"> config </span>file: config8129.js</span><br><span class="line">8 Sep 11:07:45 -<span class="built_in"> server </span>is up INFO</span><br></pre></td></tr></table></figure><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">proxy</span></span><br><span class="line">#####<span class="selector-id">#config</span>文件：</span><br><span class="line">&#123;</span><br><span class="line"><span class="attribute">nodes</span>: [</span><br><span class="line">&#123;<span class="attribute">host</span>: <span class="string">'127.0.0.1'</span>, <span class="attribute">port</span>: <span class="number">8127</span>, <span class="attribute">adminport</span>: <span class="number">8227</span>&#125;,</span><br><span class="line">&#123;<span class="attribute">host</span>: <span class="string">'127.0.0.1'</span>, <span class="attribute">port</span>: <span class="number">8128</span>, <span class="attribute">adminport</span>: <span class="number">8228</span>&#125;,</span><br><span class="line">&#123;<span class="attribute">host</span>: <span class="string">'127.0.0.1'</span>, <span class="attribute">port</span>: <span class="number">8129</span>, <span class="attribute">adminport</span>: <span class="number">8229</span>&#125;</span><br><span class="line">],</span><br><span class="line"><span class="attribute">server</span>: <span class="string">'./servers/udp'</span>,</span><br><span class="line"><span class="attribute">host</span>:  <span class="string">'0.0.0.0'</span>,</span><br><span class="line"><span class="attribute">port</span>: <span class="number">8125</span>,</span><br><span class="line"><span class="attribute">mgmt_port</span>: <span class="number">8126</span>,</span><br><span class="line"><span class="attribute">forkCount</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attribute">checkInterval</span>: <span class="number">1000</span>,</span><br><span class="line"><span class="attribute">cacheSize</span>: <span class="number">10000</span>,</span><br><span class="line"><span class="attribute">deleteIdleStats</span>: true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">启动：</span><br><span class="line"><span class="selector-tag">xiemx</span>➜  <span class="selector-tag">statsd</span> : <span class="selector-tag">master</span> ✘ :✹✭ ᐅ  <span class="selector-tag">node</span> <span class="selector-tag">proxy</span><span class="selector-class">.js</span> <span class="selector-tag">proxyconfig</span><span class="selector-class">.js</span></span><br><span class="line"><span class="selector-tag">8</span> <span class="selector-tag">Sep</span> <span class="selector-tag">11</span><span class="selector-pseudo">:09</span><span class="selector-pseudo">:02</span> <span class="selector-tag">-</span> <span class="selector-attr">[81938]</span> <span class="selector-tag">reading</span> <span class="selector-tag">config</span> <span class="selector-tag">file</span>: <span class="selector-tag">proxyconfig</span><span class="selector-class">.js</span></span><br><span class="line"><span class="selector-tag">8</span> <span class="selector-tag">Sep</span> <span class="selector-tag">11</span><span class="selector-pseudo">:09</span><span class="selector-pseudo">:02</span> <span class="selector-tag">-</span> <span class="selector-tag">INFO</span>: <span class="selector-attr">[81938]</span> <span class="selector-tag">server</span> <span class="selector-tag">is</span> <span class="selector-tag">up</span></span><br></pre></td></tr></table></figure><p>测试：<br>5个线程同时推送500个metric到代理查看分片情况</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">测试命令：</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq <span class="number">1</span> <span class="number">500</span>);<span class="keyword">do</span> echo <span class="string">"Ezbuy-$i:1|c"</span> | nc -u -w0 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">8125</span>;done</span><br></pre></td></tr></table></figure><p><img src="/images/img_59b269634a216.png" alt="img"></p><p><img src="/images/img_59b2697b89208.png" alt="img"></p><p>节点自动剔除和加入：</p><p><img src="/images/img_59b2698d5658f.png" alt="img"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;通过UDP proxy程序将前端的数据通过一定的hash算法将相同的metric发送的固定的后aggregation数据。proxy代理支持健康检测自动剔除／加入后端statsd。&lt;/p&gt;
&lt;p&gt;1.配置&lt;br&gt;本例展示一个3节点的statsd后端且将聚合数据发送到stan
      
    
    </summary>
    
    
      <category term="statsd" scheme="https://www.xiemx.com/categories/statsd/"/>
    
      <category term="graphite" scheme="https://www.xiemx.com/categories/statsd/graphite/"/>
    
    
      <category term="database" scheme="https://www.xiemx.com/tags/database/"/>
    
      <category term="statsd" scheme="https://www.xiemx.com/tags/statsd/"/>
    
      <category term="graphite" scheme="https://www.xiemx.com/tags/graphite/"/>
    
      <category term="monitor" scheme="https://www.xiemx.com/tags/monitor/"/>
    
  </entry>
  
  <entry>
    <title>redis 淘汰策略</title>
    <link href="https://www.xiemx.com//2017/07/14/redis-maxmemory-policy/"/>
    <id>https://www.xiemx.com//2017/07/14/redis-maxmemory-policy/</id>
    <published>2017-07-14T02:07:44.000Z</published>
    <updated>2019-10-19T09:11:22.213Z</updated>
    
    <content type="html"><![CDATA[<p>redis 内存数据使用到maxmemory的时候，就会根据maxmemory_policy设定的淘汰策略进行内存整理数据回收。选择不同的策略，要根据redis的用途来区分。</p><p>redis 提供 6种数据淘汰策略：</p><ul><li>volatile-lru：从已设置过期时间的数据集中挑选最近最少使用的数据淘汰</li><li>volatile-ttl：从已设置过期时间的数据集中挑选将要过期的数据淘汰</li><li>volatile-random：从已设置过期时间的数据集中任意选择数据淘汰</li><li>allkeys-lru：从数据集中挑选最近最少使用的数据淘汰</li><li>allkeys-random：从数据集中任意选择数据淘汰</li><li>noenviction：禁止删除数据</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;redis 内存数据使用到maxmemory的时候，就会根据maxmemory_policy设定的淘汰策略进行内存整理数据回收。选择不同的策略，要根据redis的用途来区分。&lt;/p&gt;
&lt;p&gt;redis 提供 6种数据淘汰策略：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;volatile-l
      
    
    </summary>
    
    
      <category term="redis" scheme="https://www.xiemx.com/categories/redis/"/>
    
    
      <category term="redis" scheme="https://www.xiemx.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>iptables count计数</title>
    <link href="https://www.xiemx.com//2017/04/11/iptables-count/"/>
    <id>https://www.xiemx.com//2017/04/11/iptables-count/</id>
    <published>2017-04-10T21:04:23.000Z</published>
    <updated>2019-10-21T06:57:42.886Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">两个参数：</span><br><span class="line">  --verbose-vverbose mode</span><br><span class="line">  --zero    -Z [chain [rulenum]]  Zero counters <span class="keyword">in</span> chain <span class="keyword">or</span> all chains</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p-hsg-cache<span class="number">-6</span>% sudo iptables -nL -v -t nat</span><br><span class="line">Chain PREROUTING (policy ACCEPT <span class="number">50741</span> packets, <span class="number">2370</span>K bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line">  <span class="number">436</span> <span class="number">22672</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6379</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.82</span>:<span class="number">6379</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6380</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6380</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6381</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6381</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6382</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6382</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6383</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6383</span></span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT <span class="number">18988</span> packets, <span class="number">1082</span>K bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT <span class="number">10532</span> packets, <span class="number">549</span>K bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT <span class="number">0</span> packets, <span class="number">0</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line"><span class="number">10968</span>  <span class="number">572</span>K MASQUERADE  all  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line"></span><br><span class="line">p-hsg-cache<span class="number">-6</span>% sudo iptables -Z -t nat</span><br><span class="line"></span><br><span class="line">p-hsg-cache<span class="number">-6</span>% sudo iptables -nL -v -t nat</span><br><span class="line">Chain PREROUTING (policy ACCEPT <span class="number">12</span> packets, <span class="number">624</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line">    <span class="number">1</span>    <span class="number">52</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6379</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.82</span>:<span class="number">6379</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6380</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6380</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6381</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6381</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6382</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6382</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DNAT       tcp  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">192.168</span><span class="number">.10</span><span class="number">.226</span>       tcp dpt:<span class="number">6383</span> to:<span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>:<span class="number">6383</span></span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT <span class="number">12</span> packets, <span class="number">624</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT <span class="number">6</span> packets, <span class="number">312</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT <span class="number">0</span> packets, <span class="number">0</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     <span class="keyword">out</span>     source               destination</span><br><span class="line">    <span class="number">7</span>   <span class="number">364</span> MASQUERADE  all  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">p-hsg-cache<span class="number">-6</span>%</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight angelscript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span
      
    
    </summary>
    
    
      <category term="linux" scheme="https://www.xiemx.com/categories/linux/"/>
    
    
      <category term="linux" scheme="https://www.xiemx.com/tags/linux/"/>
    
      <category term="iptables" scheme="https://www.xiemx.com/tags/iptables/"/>
    
  </entry>
  
  <entry>
    <title>iis备份还原</title>
    <link href="https://www.xiemx.com//2017/03/31/iis-backup-restore/"/>
    <id>https://www.xiemx.com//2017/03/31/iis-backup-restore/</id>
    <published>2017-03-31T02:03:43.000Z</published>
    <updated>2019-10-21T06:57:43.060Z</updated>
    
    <content type="html"><![CDATA[<ol><li>打开我们的IIS管理器，在功能视图里找到共享的配置这个功能然后双击进入。</li></ol><p><img src="/images/img_58ddc18a1993a.png" alt="img"></p><ol start="2"><li>进入后单机右上方的“导出配置”选项，选择导出配置文件的物理路径，然后设置一个密码，密码必须是包含数字、符号、大小写字母组合并且至少为8个字符长的强密码，确定导出后会在你导出配置文件目录下生成administration.config、applicationHost.config和configEncKey.key共3个文件，这3个文件就是我们备份的IIS站点配置信息文件。</li></ol><p><img src="/images/img_58ddc1b2d8078.png" alt="img"></p><ol start="3"><li>现在是还原IIS的配置信息，首先将你导出后的administration.config、applicationHost.config和configEncKey.key这个3个文件复制到你需要恢复IIS配置信息的电脑或服务器上，然后打开IIS，同样在功能视图里找到“共享的配置”并打开。</li></ol><p><img src="/images/img_58ddc20c6f8c3.png" alt="img"></p><ol start="4"><li>把“启用共享的配置”勾选上，物理路径就选择你备份的文件所在目录，用户名、密码输入框都不需要填写，直接点击右上方的应用，然后它要你输入密码，确定后重启下我们的IIS 就可以看到以前的站点信息都还原了。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ol&gt;
&lt;li&gt;打开我们的IIS管理器，在功能视图里找到共享的配置这个功能然后双击进入。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;/images/img_58ddc18a1993a.png&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;进入后单机
      
    
    </summary>
    
    
      <category term="windows" scheme="https://www.xiemx.com/categories/windows/"/>
    
      <category term="iis" scheme="https://www.xiemx.com/categories/windows/iis/"/>
    
    
      <category term="webserver" scheme="https://www.xiemx.com/tags/webserver/"/>
    
      <category term="iis" scheme="https://www.xiemx.com/tags/iis/"/>
    
      <category term="windows" scheme="https://www.xiemx.com/tags/windows/"/>
    
  </entry>
  
  <entry>
    <title>进程状态</title>
    <link href="https://www.xiemx.com//2017/03/29/linux-process-status/"/>
    <id>https://www.xiemx.com//2017/03/29/linux-process-status/</id>
    <published>2017-03-29T02:03:05.000Z</published>
    <updated>2019-10-21T06:57:42.805Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">D</span>  <span class="string">不能中断的进程（通常为IO）</span></span><br><span class="line"><span class="attr">R</span>  <span class="string">正在运行中的进程</span></span><br><span class="line"><span class="attr">S</span>  <span class="string">已经中断的进程，通常情况下，系统中大部分进程都是这个状态</span></span><br><span class="line"><span class="attr">T</span>  <span class="string">已经停止或者暂停的进程，如果我们正在运行一个命令，比如说sleep 10，如果我们按一下ctrl -z 让他暂停，那么我们用ps查看就会显示T这个状态</span></span><br><span class="line"><span class="attr">W</span> <span class="string">这个好像是说，从内核2.6xx 以后，表示为没有足够的内存页分配</span></span><br><span class="line"><span class="attr">X</span>  <span class="string">已经死掉的进程（这个好像从来不会出现）</span></span><br><span class="line"><span class="attr">Z</span>  <span class="string">僵尸进程</span></span><br><span class="line"></span><br><span class="line"><span class="attr">下面一些是BSD风格的参数</span></span><br><span class="line"><span class="meta">&lt;</span>  <span class="string">高优先级进程</span></span><br><span class="line"><span class="attr">N</span>  <span class="string">低优先级进程</span></span><br><span class="line"><span class="attr">L</span>   <span class="string">在内存中被锁了内存分页</span></span><br><span class="line"><span class="attr">s</span>   <span class="string">主进程</span></span><br><span class="line"><span class="attr">l</span>   <span class="string">多线程进程</span></span><br><span class="line"><span class="meta">+</span>  <span class="string">代表在前台运行的进程</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight properties&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span 
      
    
    </summary>
    
    
      <category term="linux" scheme="https://www.xiemx.com/categories/linux/"/>
    
    
      <category term="linux" scheme="https://www.xiemx.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>redis repl_diskless_replication</title>
    <link href="https://www.xiemx.com//2017/03/06/redis-repl_diskless_replication/"/>
    <id>https://www.xiemx.com//2017/03/06/redis-repl_diskless_replication/</id>
    <published>2017-03-05T20:03:55.000Z</published>
    <updated>2019-10-21T06:57:42.620Z</updated>
    
    <content type="html"><![CDATA[<p>redis diskless replication</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># Replication</span><br><span class="line">role:slave</span><br><span class="line">master_host:192.168.10.226</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:down</span><br><span class="line">master_last_io_seconds_ago:-1</span><br><span class="line">master_sync_in_progress:1</span><br><span class="line">slave_repl_offset:1</span><br><span class="line">master_sync_left_bytes:-4022404224</span><br><span class="line">master_sync_last_io_seconds_ago:37</span><br><span class="line">master_link_down_since_seconds:1488785860</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_repl_offset:0</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=192.168.10.192,port=6379,state=online,offset=1134556373255,lag=1</span><br><span class="line">slave1:ip=192.168.10.82,port=6379,state=wait_bgsave,offset=0,lag=0</span><br><span class="line">master_repl_offset:1134556812751</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1134555764176</span><br><span class="line">repl_backlog_histlen:1048576</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">6581:C 06 Mar 15:28:27.766 * DB saved on disk</span><br><span class="line">26581:C 06 Mar 15:28:27.990 * RDB: 212 MB of memory used by copy-on-write</span><br><span class="line">2251:M 06 Mar 15:28:28.379 * Background saving terminated with success</span><br><span class="line">2251:M 06 Mar 15:29:08.687 * Synchronization with slave 192.168.10.82:6379 succeeded</span><br><span class="line">2251:M 06 Mar 15:29:47.093 # Client id=314558845 addr=192.168.10.82:58002 fd=16 name= age=194 idle=1 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=3617 omem=95797745 events=rw cmd=psync scheduled to be closed ASAP for overcoming of output buffer limits.</span><br><span class="line">2251:M 06 Mar 15:29:47.093 # Connection with slave 192.168.10.82:6379 lost.</span><br><span class="line">2251:M 06 Mar 15:30:15.999 * Slave 192.168.10.82:6379 asks for synchronization</span><br><span class="line">2251:M 06 Mar 15:30:15.999 * Unable to partial resync with slave 192.168.10.82:6379 for lack of backlog (Slave request was: 1134354232038).</span><br><span class="line">2251:M 06 Mar 15:30:15.999 * Starting BGSAVE for SYNC with target: disk</span><br><span class="line">2251:M 06 Mar 15:30:16.232 * Background saving started by pid 30494</span><br><span class="line">30494:C 06 Mar 15:31:52.413 * DB saved on disk</span><br><span class="line">30494:C 06 Mar 15:31:52.597 * RDB: 223 MB of memory used by copy-on-write</span><br><span class="line">2251:M 06 Mar 15:31:52.950 * Background saving terminated with success</span><br><span class="line">2251:M 06 Mar 15:32:33.375 * Synchronization with slave 192.168.10.82:6379 succeeded</span><br><span class="line">2251:M 06 Mar 15:33:08.106 # Client id=314561307 addr=192.168.10.82:38644 fd=16 name= age=173 idle=1 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=4325 omem=102199438 events=rw cmd=psync scheduled to be closed ASAP for overcoming of output buffer limits.</span><br><span class="line">2251:M 06 Mar 15:33:08.106 # Connection with slave 192.168.10.82:6379 lost.</span><br><span class="line">2251:M 06 Mar 15:33:40.471 * Slave 192.168.10.82:6379 asks for synchronization</span><br><span class="line">2251:M 06 Mar 15:33:40.471 * Unable to partial resync with slave 192.168.10.82:6379 for lack of backlog (Slave request was: 1134453799057).</span><br><span class="line">2251:M 06 Mar 15:33:40.471 * Starting BGSAVE for SYNC with target: disk</span><br><span class="line">2251:M 06 Mar 15:33:40.715 * Background saving started by pid 1440</span><br><span class="line">2251:M 06 Mar 15:35:14.354 # Connection with slave 192.168.10.82:6379 lost.</span><br><span class="line">1440:C 06 Mar 15:35:20.564 * DB saved on disk</span><br><span class="line">1440:C 06 Mar 15:35:20.743 * RDB: 296 MB of memory used by copy-on-write</span><br><span class="line">2251:M 06 Mar 15:35:21.013 * Background saving terminated with success</span><br></pre></td></tr></table></figure><h3 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h3><p>如果设置了一个slave，不管是在第一次链接还是重新链接master的时候，slave会发送一个同步命令<br>然后master开始后台保存，收集所有对修改数据的命令。当后台保存完成，master会将这个数据文件传送到slave，<br>然后保存在磁盘，加载到内存中，master接着发送收集到的所有的修改数据的命令。</p><p>Redis为避免输出缓冲区过度耗用内存，使用client-output-buffer-limit参数限制客户端输出缓冲区内存使用量。<br>Redis数据复制过程中，Slave有个flags=S的客户端连接到Master; 它和其他客户端一样有输出缓冲区和缓冲区大小限制。<br><code>client-output-buffer-limit slave 256mb 64mb 60</code><br>当缓冲区使用超过256mb,Master会尽快杀掉它；<br>当缓冲区使用大于64mb,且小于256mb的soft limit值时，并持续时间达60秒，也会被Master尽快杀掉。</p><p>通过以上的原理分析我们可以得到一个解决方法：扩大buffer和timeout，但对于一个数据量比较大的db且服务器本身内存不足的情况下。<br>我们可以采用diskless replication，直接通过网络将数据更新过去，不再让服务器去同步到disk再从disk输出到内存导致output报错</p><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>开启redis diskless replication</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; CONFIG set repl-diskless-sync yes</span><br><span class="line">OK</span><br><span class="line">(1.97s)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2251:M 06 Mar 15:35:34.896 * Slave 192.168.10.82:6379 asks for synchronization</span><br><span class="line">2251:M 06 Mar 15:35:34.896 * Full resync requested by slave 192.168.10.82:6379</span><br><span class="line">2251:M 06 Mar 15:35:34.896 * Delay next BGSAVE for SYNC</span><br><span class="line">2251:M 06 Mar 15:35:40.203 * Starting BGSAVE for SYNC with target: slaves sockets</span><br><span class="line">2251:M 06 Mar 15:35:40.469 * Background RDB transfer started by pid 3351</span><br><span class="line">3351:C 06 Mar 15:37:03.206 * RDB: 233 MB of memory used by copy-on-write</span><br><span class="line">2251:M 06 Mar 15:37:03.473 * Background RDB transfer terminated with success</span><br><span class="line">2251:M 06 Mar 15:37:03.473 # Slave 192.168.10.82:6379 correctly received the streamed RDB file.</span><br><span class="line">2251:M 06 Mar 15:37:03.473 * Streamed RDB transfer with slave 192.168.10.82:6379 succeeded (socket). Waiting for REPLCONF ACK from slave to enable streaming</span><br><span class="line">2251:M 06 Mar 15:37:24.848 * 50000 changes in 60 seconds. Saving...</span><br><span class="line">2251:M 06 Mar 15:37:25.097 * Background saving started by pid 5916</span><br><span class="line">2251:M 06 Mar 15:38:10.510 * Synchronization with slave 192.168.10.82:6379 succeeded</span><br><span class="line">5916:C 06 Mar 15:39:06.535 * DB saved on disk</span><br><span class="line">5916:C 06 Mar 15:39:06.742 * RDB: 250 MB of memory used by copy-on-write</span><br><span class="line">2251:M 06 Mar 15:39:07.093 * Background saving terminated with success</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># Replication</span><br><span class="line">role:slave</span><br><span class="line">master_host:192.168.10.226</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:1</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:1134697190334</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_repl_offset:0</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line"></span><br><span class="line"># Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=192.168.10.192,port=6379,state=online,offset=1135553694283,lag=1</span><br><span class="line">slave1:ip=192.168.10.82,port=6379,state=online,offset=1135553653727,lag=1</span><br><span class="line">master_repl_offset:1135554186742</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1135553138167</span><br><span class="line">repl_backlog_histlen:1048576</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;redis diskless replication&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span cl
      
    
    </summary>
    
    
      <category term="redis" scheme="https://www.xiemx.com/categories/redis/"/>
    
    
      <category term="redis" scheme="https://www.xiemx.com/tags/redis/"/>
    
  </entry>
  
</feed>
